<div class="main-content">
    <div class="admin-dashboard">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-content">
                <div class="header-title">
                    <div class="title-icon">üì¶</div>
                    <div>
                        <h1>QU·∫¢N L√ù S·∫¢N PH·∫®M</h1>
                        <p>Theo d√µi v√† qu·∫£n l√Ω s·∫£n ph·∫©m trong c·ª≠a h√†ng</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn-primary" id="addProductBtn">
                        <i class="fas fa-plus"></i>
                        <span>Th√™m s·∫£n ph·∫©m</span>
                    </button>
                    <button class="btn-primary" id="manageBrandsBtn">
                        <i class="fas fa-tags"></i>
                        <span>Qu·∫£n l√Ω Th∆∞∆°ng hi·ªáu</span>
                    </button>
                    <button class="btn-primary" id="manageCategoriesBtn">
                        <i class="fas fa-layer-group"></i>
                        <span>Qu·∫£n l√Ω Danh m·ª•c</span>
                    </button>
                    <button class="btn-secondary" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i>
                        <span>L√†m m·ªõi</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-icon total">
                    <i class="fas fa-box"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalProducts">0</h3>
                    <p>T·ªïng s·∫£n ph·∫©m</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon available">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                    <h3 id="countActive">0</h3>
                    <p>ƒêang b√°n</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon busy">
                    <i class="fas fa-pause-circle"></i>
                </div>
                <div class="stat-info">
                    <h3 id="countInactive">0</h3>
                    <p>Ng·ª´ng b√°n</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon premium">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalRevenue">0‚Ç´</h3>
                    <p>T·ªïng doanh s·ªë</p>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="search-filter-bar">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m theo t√™n, SKU...">
            </div>
            <div class="filter-controls">
                <select class="filter-select" id="statusFilter">
                    <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                    <option value="1">üü¢ ƒêang b√°n</option>
                    <option value="0">üî¥ Ng·ª´ng b√°n</option>
                </select>
                <select class="filter-select" id="regionFilter">
                    <option value="">üåç T·∫•t c·∫£ v√πng</option>
                    {{#each regions}}
                    <option value="{{this.ma_vung}}">üìç {{this.ten_vung}}</option>
                    {{/each}}
                </select>
                <select class="filter-select" id="categoryFilter">
                    <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                    {{#each categories}}
                    <option value="{{this.id}}">{{this.ten_danh_muc}}</option>
                    {{/each}}
                </select>
                <select class="filter-select" id="brandFilter">
                    <option value="">T·∫•t c·∫£ th∆∞∆°ng hi·ªáu</option>
                    {{#each brands}}
                    <option value="{{this.id}}">{{this.ten_thuong_hieu}}</option>
                    {{/each}}
                </select>
                <button class="clear-filters" id="clearFilters">
                    <i class="fas fa-times"></i>
                    X√≥a l·ªçc
                </button>
            </div>
        </div>

        <!-- Brand Management Modal -->
        <div class="modal fade modal-premium" id="brandModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xxl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-tags"></i>
                            <span id="brandModalTitle">Qu·∫£n l√Ω Th∆∞∆°ng hi·ªáu</span>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="container-fluid">
                            <div class="row">
                                <!-- Form Section -->
                                <div class="col-lg-5">
                                    <div class="form-section-container">
                                        <div class="form-section">
                                            <h4 class="section-title">
                                                <i class="fas fa-edit"></i>
                                                <span id="brandFormTitle">Th√™m th∆∞∆°ng hi·ªáu m·ªõi</span>
                                            </h4>

                                            <form id="brandForm" class="brand-form">
                                                <input type="hidden" id="brandId">

                                                <div class="form-grid-2">
                                                    <div class="form-group">
                                                        <label for="brandName" class="form-label">
                                                            <i class="fas fa-font"></i>
                                                            T√™n th∆∞∆°ng hi·ªáu *
                                                        </label>
                                                        <input type="text" class="form-control form-control-lg"
                                                            id="brandName" required
                                                            placeholder="Nh·∫≠p t√™n th∆∞∆°ng hi·ªáu (t·ªëi ƒëa 100 k√Ω t·ª±)">
                                                        <div class="form-text">T√™n th∆∞∆°ng hi·ªáu l√† b·∫Øt bu·ªôc v√† duy nh·∫•t</div>
                                                    </div>

                                                    <div class="form-group">
                                                        <label for="brandStatus" class="form-label">
                                                            <i class="fas fa-toggle-on"></i>
                                                            Tr·∫°ng th√°i
                                                        </label>
                                                        <select class="form-select form-select-lg" id="brandStatus">
                                                            <option value="1">üü¢ ƒêang ho·∫°t ƒë·ªông</option>
                                                            <option value="0">üî¥ Ng·ª´ng ho·∫°t ƒë·ªông</option>
                                                        </select>
                                                    </div>
                                                </div>

                                                <!-- Thay th·∫ø URL Logo b·∫±ng File Upload -->
                                                <div class="form-group">
                                                    <label class="form-label">
                                                        <i class="fas fa-image"></i>
                                                        Logo th∆∞∆°ng hi·ªáu
                                                    </label>
                                                    <div class="file-upload-container brand-file-upload">
                                                        <input type="file" class="form-control" id="brandLogoInput" accept="image/*" style="display: none;">
                                                        <div class="file-upload-area" id="brandLogoUploadArea">
                                                            <div class="upload-placeholder">
                                                                    <button type="button" class="btn btn-secondary" id="chooseBrandLogoBtn">
                                                                        <i class="fas fa-upload"></i>
                                                                        &nbsp;Ch·ªçn logo
                                                                    </button>
                                                                    <div class="form-text mt-2">ƒê·ªãnh d·∫°ng: JPG, PNG, GIF (T·ªëi ƒëa 5MB)</div>
                                                                </div>
                                                            <div class="upload-preview" id="brandLogoPreview" style="display: none;">
                                                                <img id="brandLogoPreviewImg" src="" alt="Preview">
                                                                <button type="button" class="btn-change-image" id="changeBrandLogoBtn">
                                                                    <i class="fas fa-sync-alt"></i> Thay ƒë·ªïi
                                                                </button>
                                                            </div>
                                                        </div>

                                                        <!-- Logo preview container (shows existing logo in edit mode) -->
                                                        <div class="logo-preview-container">
                                                            <div class="logo-preview" id="logoPreview">
                                                                <div class="preview-placeholder">
                                                                    <i class="fas fa-image fa-2x"></i>
                                                                    <span>Logo s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <input type="hidden" id="brandLogo" name="brandLogo">
                                                </div>

                                                

                                                <div class="form-group mt-3">
                                                    <label for="brandDescription" class="form-label">
                                                        <i class="fas fa-align-left"></i>
                                                        M√¥ t·∫£ th∆∞∆°ng hi·ªáu
                                                    </label>
                                                    <textarea class="form-control form-control-lg" id="brandDescription"
                                                        rows="4"
                                                        placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ th∆∞∆°ng hi·ªáu (t·ªëi ƒëa 500 k√Ω t·ª±)..."></textarea>
                                                    <div class="form-text">
                                                        <span id="charCount">0</span>/500 k√Ω t·ª±
                                                    </div>
                                                </div>
                                            </form>
                                        </div>

                                        <!-- Action Buttons (Gi·ªØ nguy√™n) -->
                                        <div class="form-actions mt-4">
                                            <button type="button" class="btn btn-secondary btn-lg me-2"
                                                id="resetBrandForm">
                                                <i class="fas fa-undo"></i>
                                                L√†m m·ªõi form
                                            </button>
                                            <button type="button" class="btn btn-primary btn-lg" id="saveBrandBtn">
                                                <i class="fas fa-save"></i>
                                                <span id="saveBrandText">Th√™m th∆∞∆°ng hi·ªáu</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- List Section -->
                                <div class="col-lg-7">
                                    <div class="table-section-container">
                                        <div class="table-section-header">
                                            <h4 class="section-title">
                                                <i class="fas fa-list"></i>
                                                Danh s√°ch th∆∞∆°ng hi·ªáu
                                            </h4>
                                            <div class="table-controls">
                                                <div class="search-box-sm">
                                                    <i class="fas fa-search"></i>
                                                    <input type="text" id="brandSearch"
                                                        placeholder="T√¨m ki·∫øm th∆∞∆°ng hi·ªáu...">
                                                </div>
                                                <button class="btn btn-outline-primary btn-sm" id="refreshBrandsBtn">
                                                    <i class="fas fa-sync-alt"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <div class="table-container">
                                            <div class="table-responsive">
                                                <table class="products-table" id="brandsTable">
                                                    <thead>
                                                        <tr>
                                                            <th width="45%">T√™n th∆∞∆°ng hi·ªáu</th>
                                                            <th width="15%">Logo</th>
                                                            <th width="20%">Tr·∫°ng th√°i</th>
                                                            <th width="10%">Ng√†y t·∫°o</th>
                                                            <th width="10%">Thao t√°c</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="brandsTableBody">
                                                        <!-- Dynamic brands will be loaded here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>

                                        <!-- Table Footer -->
                                        <div class="table-footer">
                                            <div class="table-info">
                                                Hi·ªÉn th·ªã <span id="brandsCurrentCount">0</span> trong t·ªïng s·ªë <span
                                                    id="brandsTotalCount">0</span> th∆∞∆°ng hi·ªáu
                                            </div>
                                            <div class="table-pagination">
                                                <button class="pagination-btn" id="brandsPrevPage" disabled>
                                                    <i class="fas fa-chevron-left"></i>
                                                </button>
                                                <span class="pagination-info">Trang 1/1</span>
                                                <button class="pagination-btn" id="brandsNextPage" disabled>
                                                    <i class="fas fa-chevron-right"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Empty State -->
                                        <div class="empty-state-sm" id="brandsEmptyState">
                                            <div class="empty-icon">üè∑Ô∏è</div>
                                            <div class="empty-content">
                                                <h5>Kh√¥ng c√≥ th∆∞∆°ng hi·ªáu n√†o</h5>
                                                <p>Th·ª≠ th√™m th∆∞∆°ng hi·ªáu m·ªõi ho·∫∑c thay ƒë·ªïi b·ªô l·ªçc</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i>
                            ƒê√≥ng
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Management Modal -->
        <div class="modal fade modal-premium" id="categoryModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xxl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-layer-group"></i>
                            <span id="categoryModalTitle">Qu·∫£n l√Ω Danh m·ª•c</span>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="container-fluid">
                            <div class="row">
                                <!-- Form Section -->
                                <div class="col-lg-5">
                                    <div class="form-section-container">
                                        <div class="form-section">
                                            <h4 class="section-title">
                                                <i class="fas fa-edit"></i>
                                                <span id="categoryFormTitle">Th√™m danh m·ª•c m·ªõi</span>
                                            </h4>

                                            <form id="categoryForm" class="category-form">
                                                <input type="hidden" id="categoryId">

                                                <div class="form-grid-2">
                                                    <div class="form-group">
                                                        <label for="categoryName" class="form-label">
                                                            <i class="fas fa-font"></i>
                                                            T√™n danh m·ª•c *
                                                        </label>
                                                        <input type="text" class="form-control form-control-lg"
                                                            id="categoryName" required
                                                            placeholder="Nh·∫≠p t√™n danh m·ª•c (t·ªëi ƒëa 100 k√Ω t·ª±)">
                                                        <div class="form-text">T√™n danh m·ª•c l√† b·∫Øt bu·ªôc v√† duy nh·∫•t</div>
                                                    </div>

                                                    <div class="form-group">
                                                        <label for="categoryStatus" class="form-label">
                                                            <i class="fas fa-toggle-on"></i>
                                                            Tr·∫°ng th√°i
                                                        </label>
                                                        <select class="form-select form-select-lg" id="categoryStatus">
                                                            <option value="1">üü¢ ƒêang ho·∫°t ƒë·ªông</option>
                                                            <option value="0">üî¥ Ng·ª´ng ho·∫°t ƒë·ªông</option>
                                                        </select>
                                                    </div>
                                                </div>

                                                <div class="form-grid-2">
                                                    <div class="form-group">
                                                        <label for="parentCategory" class="form-label">
                                                            <i class="fas fa-sitemap"></i>
                                                            Danh m·ª•c cha
                                                        </label>
                                                        <select class="form-select form-select-lg" id="parentCategory">
                                                            <option value="">-- Kh√¥ng c√≥ --</option>
                                                            <!-- Categories will be populated here -->
                                                        </select>
                                                    </div>

                                                    <div class="form-group">
                                                        <label for="categoryOrder" class="form-label">
                                                            <i class="fas fa-sort-numeric-down"></i>
                                                            Th·ª© t·ª±
                                                        </label>
                                                        <input type="number" class="form-control form-control-lg"
                                                            id="categoryOrder" placeholder="0" min="0" value="0">
                                                        {{!-- <div class="form-text">S·ªë nh·ªè h∆°n s·∫Ω hi·ªÉn th·ªã tr∆∞·ªõc</div> --}}
                                                    </div>
                                                </div>

                                                <!-- Thay th·∫ø URL ·∫¢nh b·∫±ng File Upload -->
                                                <div class="form-group">
                                                    <label class="form-label">
                                                        <i class="fas fa-image"></i>
                                                        ·∫¢nh danh m·ª•c
                                                    </label>
                                                    <div class="file-upload-container">
                                                        <input type="file" class="form-control" id="categoryImageInput" accept="image/*" style="display: none;">
                                                        <div class="file-upload-area" id="categoryImageUploadArea">
                                                            <div class="upload-placeholder">
                                                                <button type="button" class="btn btn-secondary" id="chooseCategoryImageBtn">
                                                                    <i class="fas fa-upload"></i>
                                                                    &nbsp;Ch·ªçn ·∫£nh
                                                                </button>
                                                                <div class="form-text mt-2">ƒê·ªãnh d·∫°ng: JPG, PNG, GIF (T·ªëi ƒëa 5MB)</div>
                                                            </div>

                                                            <div class="upload-preview" id="categoryImagePreview" style="display: none;">
                                                                <img id="categoryImagePreviewImg" src="" alt="Preview">
                                                                <button type="button" class="btn-change-image" id="changeCategoryImageBtn">
                                                                    <i class="fas fa-sync-alt"></i> Thay ƒë·ªïi
                                                                </button>
                                                            </div>
                                                        </div>

                                                        <!-- Image preview container (shows existing image in edit mode) -->
                                                        <div class="logo-preview-container">
                                                            <div class="logo-preview" id="categoryImagePreviewContainer">
                                                                <div class="preview-placeholder">
                                                                    <i class="fas fa-image fa-2x"></i>
                                                                    <span>·∫¢nh s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <input type="hidden" id="categoryImage" name="categoryImage">
                                                </div>

                                                <div class="form-group mt-3">
                                                    <label for="categoryDescription" class="form-label">
                                                        <i class="fas fa-align-left"></i>
                                                        M√¥ t·∫£ danh m·ª•c
                                                    </label>
                                                    <textarea class="form-control form-control-lg" id="categoryDescription"
                                                        rows="4"
                                                        placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ danh m·ª•c (t·ªëi ƒëa 500 k√Ω t·ª±)..."></textarea>
                                                    <div class="form-text">
                                                        <span id="categoryCharCount">0</span>/500 k√Ω t·ª±
                                                    </div>
                                                </div>
                                            </form>
                                        </div>

                                        <!-- Action Buttons (Gi·ªØ nguy√™n) -->
                                        <div class="form-actions mt-4">
                                            <button type="button" class="btn btn-secondary btn-lg me-2"
                                                id="resetCategoryForm">
                                                <i class="fas fa-undo"></i>
                                                L√†m m·ªõi form
                                            </button>
                                            <button type="button" class="btn btn-primary btn-lg" id="saveCategoryBtn">
                                                <i class="fas fa-save"></i>
                                                <span id="saveCategoryText"></span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- List Section -->
                                <div class="col-lg-7">
                                    <div class="table-section-container">
                                        <div class="table-section-header">
                                            <h4 class="section-title">
                                                <i class="fas fa-list"></i>
                                                Danh s√°ch danh m·ª•c
                                            </h4>
                                            <div class="table-controls">
                                                <div class="search-box-sm">
                                                    <i class="fas fa-search"></i>
                                                    <input type="text" id="categorySearch"
                                                        placeholder="T√¨m ki·∫øm danh m·ª•c...">
                                                </div>
                                                <button class="btn btn-outline-primary btn-sm" id="refreshCategoriesBtn">
                                                    <i class="fas fa-sync-alt"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <div class="table-container">
                                            <div class="table-responsive">
                                                <table class="products-table" id="categoriesTable">
                                                    <thead>
                                                        <tr>
                                                            <th width="35%">T√™n danh m·ª•c</th>
                                                            <th width="15%">Danh m·ª•c cha</th>
                                                            <th width="5%">Th·ª© t·ª±</th>
                                                            <th width="15%">·∫¢nh</th>
                                                            <th width="20%">Tr·∫°ng th√°i</th>
                                                            <th width="10%">Thao t√°c</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="categoriesTableBody">
                                                        <!-- Dynamic categories will be loaded here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>

                                        <!-- Table Footer -->
                                        <div class="table-footer">
                                            <div class="table-info">
                                                Hi·ªÉn th·ªã <span id="categoriesCurrentCount">0</span> trong t·ªïng s·ªë <span
                                                    id="categoriesTotalCount">0</span> danh m·ª•c
                                            </div>
                                            <div class="table-pagination">
                                                <button class="pagination-btn" id="categoriesPrevPage" disabled>
                                                    <i class="fas fa-chevron-left"></i>
                                                </button>
                                                <span class="pagination-info">Trang 1/1</span>
                                                <button class="pagination-btn" id="categoriesNextPage" disabled>
                                                    <i class="fas fa-chevron-right"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Empty State -->
                                        <div class="empty-state-sm" id="categoriesEmptyState">
                                            <div class="empty-icon">üìÅ</div>
                                            <div class="empty-content">
                                                <h5>Kh√¥ng c√≥ danh m·ª•c n√†o</h5>
                                                <p>Th·ª≠ th√™m danh m·ª•c m·ªõi ho·∫∑c thay ƒë·ªïi b·ªô l·ªçc</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i>
                            ƒê√≥ng
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Table -->
        <div class="table-container">
            <div class="table-header">
                <h3>Danh s√°ch s·∫£n ph·∫©m</h3>
                <div class="table-actions">
                    <button class="btn-export" id="exportBtn">
                        <i class="fas fa-download"></i>
                        Xu·∫•t Excel
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="products-table" id="productsTable">
                    <thead>
                        <tr>
                            {{!-- <th class="col-checkbox">
                                <input type="checkbox" id="selectAll">
                            </th> --}}
                            <th class="col-image">H√¨nh ·∫£nh</th>
                            <th class="col-name">T√™n s·∫£n ph·∫©m</th>
                            <th class="col-sku">SKU</th>
                            <th class="col-price">Gi√°</th>
                            <th class="col-category">Danh m·ª•c</th>
                            <th class="col-brand">Th∆∞∆°ng hi·ªáu</th>
                            <th class="col-status">Tr·∫°ng th√°i</th>
                            {{!-- <th class="col-featured">N·ªïi b·∫≠t</th> --}}
                            <th class="col-actions">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each sanphams}}
                        <tr data-id="{{this.id}}" data-status="{{this.trang_thai}}" data-category="{{this.danh_muc_id}}"
                            data-brand="{{this.thuong_hieu_id}}">
                            {{!-- <td class="col-checkbox">
                                <input type="checkbox" class="row-checkbox" value="{{this.id}}">
                            </td> --}}
                            <td class="col-image">
                                <div class="product-table-image">
                                    <img src="{{this.link_anh}}" alt="{{this.ten_san_pham}}">
                                </div>
                            </td>
                            <td class="col-name">
                                <div class="product-name">{{this.ten_san_pham}}</div>
                            </td>
                            <td class="col-sku">
                                <div class="product-sku">#{{this.ma_sku}}</div>
                            </td>
                            <td class="col-price">
                                <div class="price-info">
                                    {{#if this.gia_niem_yet}}
                                    <div class="original-price">{{formatCurrency this.gia_niem_yet}}</div>
                                    {{/if}}
                                    <div class="current-price">{{formatCurrency this.gia_ban}}</div>
                                </div>
                            </td>
                            <td class="col-category">
                                <span class="category-badge">{{this.ten_danh_muc}}</span>
                            </td>
                            <td class="col-brand">
                                <span class="brand-badge">{{this.ten_thuong_hieu}}</span>
                            </td>
                            <td class="col-status">
                                <span class="status-badge {{#if (eq this.trang_thai true)}}active{{else}}inactive{{/if}}">
                                    {{#if (eq this.trang_thai true)}}üü¢ ƒêang b√°n{{else}}üî¥ Ng·ª´ng b√°n{{/if}}
                                </span>
                            </td>
                            {{!-- <td class="col-featured">
                                {{#if this.san_pham_noi_bat}}
                                <i class="fas fa-star featured-icon"></i>
                                {{else}}
                                <i class="far fa-star"></i>
                                {{/if}}
                            </td> --}}
                            <td class="col-actions">
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-primary btn-action-modern btn-edit" data-id="{{this.id}}" title="Ch·ªânh s·ª≠a s·∫£n ph·∫©m">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning btn-action-modern btn-toggle-status" data-id="{{this.id}}"
                                        data-status="{{this.trang_thai}}" data-name="{{this.ten_san_pham}}"
                                        title="{{#if (eq this.trang_thai 1)}}Ng·ª´ng b√°n s·∫£n ph·∫©m{{else}}M·ªü b√°n s·∫£n ph·∫©m{{/if}}">
                                        <i class="fas {{#if (eq this.trang_thai 1)}}fa-eye-slash{{else}}fa-eye{{/if}}"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger btn-action-modern btn-delete-product" data-id="{{this.id}}"
                                        data-name="{{this.ten_san_pham}}" title="X√≥a s·∫£n ph·∫©m">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>

            <!-- Table Footer -->
            <div class="table-footer">
                <div class="table-info">
                    Hi·ªÉn th·ªã <span id="currentCount">{{sanphams.length}}</span> trong t·ªïng s·ªë <span
                        id="totalCount">{{sanphams.length}}</span> s·∫£n ph·∫©m
                </div>
                <div class="table-pagination">
                    <button class="pagination-btn" id="prevPage" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="pagination-info">Trang 1/1</span>
                    <button class="pagination-btn" id="nextPage" disabled>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState"
            style="{{#if sanphams.length}}display: none;{{else}}display: flex;{{/if}}">
            <div class="empty-icon">üì¶</div>
            <div class="empty-content">
                <h3>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</h3>
                <p>Th·ª≠ thay ƒë·ªïi b·ªô l·ªçc ho·∫∑c th√™m s·∫£n ph·∫©m m·ªõi</p>
                <button class="btn-primary" id="addProductEmptyBtn">
                    <i class="fas fa-plus"></i>
                    Th√™m s·∫£n ph·∫©m ƒë·∫ßu ti√™n
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading-state" id="loadingState" style="display: none;">
            <div class="loading-spinner"></div>
            <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal fade modal-premium" id="productModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-cube"></i>
                        <span id="modalTitle">Th√™m s·∫£n ph·∫©m m·ªõi</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">

                        <div class="form-sections">
                            <!-- Basic Information -->
                            <div class="form-section">
                                <h4 class="section-title">
                                    <i class="fas fa-info-circle"></i>
                                    Th√¥ng tin c∆° b·∫£n
                                </h4>
                                <input type="hidden" id="mongoDetailId" name="mongoDetailId">
                                <div class="form-grid-3">
                                    <div class="form-group">
                                        <label for="productName" class="form-label">T√™n s·∫£n ph·∫©m *</label>
                                        <input type="text" class="form-control" id="productName" required
                                            placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m">
                                    </div>
                                    <div class="form-group">
                                        <label for="productCategory" class="form-label">Danh m·ª•c *</label>
                                        <select class="form-select" id="productCategory" required>
                                            <option value="">Ch·ªçn danh m·ª•c</option>
                                            {{#each categories}}
                                            <option value="{{this.id}}">{{this.ten_danh_muc}}</option>
                                            {{/each}}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="productBrand" class="form-label">Th∆∞∆°ng hi·ªáu *</label>
                                        <select class="form-select" id="productBrand" required>
                                            <option value="">Ch·ªçn th∆∞∆°ng hi·ªáu</option>
                                            {{#each brands}}
                                            <option value="{{this.id}}">{{this.ten_thuong_hieu}}</option>
                                            {{/each}}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Site Origin & Status -->
                            <div class="form-section">
                                <h4 class="section-title">
                                    <i class="fas fa-cog"></i>
                                    Th√¥ng tin h·ªá th·ªëng
                                </h4>
                                <div class="form-grid-2">
                                    <div class="form-group">
                                        <label for="productSiteOrigin" class="form-label">
                                            <i class="fas fa-server"></i>
                                            Khu v·ª±c *
                                        </label>
                                        <select class="form-select" id="productSiteOrigin" required>
                                            <option value="bac">üåç Mi·ªÅn B·∫Øc</option>
                                            <option value="trung">üåç Mi·ªÅn Trung</option>
                                            <option value="nam">üåç Mi·ªÅn Nam</option>
                                        </select>
                                        <div class="form-text">Khu v·ª±c l∆∞u tr·ªØ d·ªØ li·ªáu s·∫£n ph·∫©m</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="productStatus" class="form-label">
                                            <i class="fas fa-toggle-on"></i>
                                            Tr·∫°ng th√°i
                                        </label>
                                        <select class="form-select" id="productStatus">
                                            <option value="1">üü¢ ƒêang b√°n</option>
                                            <option value="0">üî¥ Ng·ª´ng b√°n</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Pricing - CH·ªà D√ôNG CHO VARIANT M·∫∂C ƒê·ªäNH -->
                            <!-- Technical Specifications -->
                            <div class="form-section">
                                <h4 class="section-title">
                                    <i class="fas fa-cogs"></i>
                                    Th√¥ng s·ªë k·ªπ thu·∫≠t
                                    <small class="text-muted">(K√©o th·∫£ ƒë·ªÉ s·∫Øp x·∫øp th·ª© t·ª±)</small>
                                </h4>
                                <div class="specs-management">
                                    <div class="specs-table-container">
                                        <table class="specs-table" id="productSpecsTable">
                                            <thead>
                                                <tr>
                                                    <th width="5%"></th>
                                                    <th width="35%">Th√¥ng s·ªë</th>
                                                    <th width="50%">Gi√° tr·ªã</th>
                                                    <th width="10%">Thao t√°c</th>
                                                </tr>
                                            </thead>
                                            <tbody id="productSpecsBody">
                                                <!-- Dynamic specs will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="specs-actions">
                                        <button type="button" class="btn btn-primary" id="addProductSpecBtn">
                                            <i class="fas fa-plus"></i> Th√™m th√¥ng s·ªë
                                        </button>
                                        <div class="specs-hint">
                                            <i class="fas fa-info-circle"></i>
                                            K√©o th·∫£ bi·ªÉu t∆∞·ª£ng <i class="fas fa-bars"></i> ƒë·ªÉ s·∫Øp x·∫øp th·ª© t·ª±
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Product Variants -->
                            <div class="form-section">
                                <h4 class="section-title">
                                    <i class="fas fa-boxes"></i>
                                    Bi·∫øn th·ªÉ s·∫£n ph·∫©m
                                    <button type="button" class="btn btn-sm btn-primary ms-2" id="addVariantTypeBtn">
                                        <i class="fas fa-plus"></i> Th√™m lo·∫°i bi·∫øn th·ªÉ
                                    </button>
                                </h4>
                                
                                <div class="variants-management">
                                    <!-- B·∫£ng danh s√°ch lo·∫°i bi·∫øn th·ªÉ -->
                                    <div class="variant-options-table-wrapper" id="variantOptionsSection" style="display: none;">
                                        <table class="variant-options-table">
                                            <thead>
                                                <tr>
                                                    <th style="width: 25%">T√™n lo·∫°i</th>
                                                    <th style="width: 65%">Gi√° tr·ªã</th>
                                                    <th style="width: 10%">X√≥a</th>
                                                </tr>
                                            </thead>
                                            <tbody id="variantOptionsBody">
                                                <!-- Variant options will be added here -->
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- B·∫£ng t·ªï h·ª£p bi·∫øn th·ªÉ -->
                                    <div class="variant-combinations-section" id="variantCombinationsSection" style="display: none;">
                                        <div class="combinations-header">
                                            <h5><i class="fas fa-th"></i> T·ªï h·ª£p bi·∫øn th·ªÉ & ƒê·ªãnh gi√°</h5>
                                            <span class="combinations-count" id="combinationsCount">0 t·ªï h·ª£p</span>
                                        </div>
                                        <div class="variant-combinations-table-wrapper">
                                            <table class="variant-combinations-table">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 4%">#</th>
                                                        <th style="width: 16%">Bi·∫øn th·ªÉ</th>
                                                        <th style="width: 10%">SKU</th>
                                                        <th style="width: 11%">Gi√° ni√™m y·∫øt (‚Ç´)</th>
                                                        <th style="width: 11%">Gi√° b√°n (‚Ç´)</th>
                                                        <th style="width: 8%">T·ªìn kho</th>
                                                        <th style="width: 8%">V√πng</th>
                                                        <th style="width: 15%">·∫¢nh ƒë·∫°i di·ªán</th>
                                                        <th style="width: 8%">Tr·∫°ng th√°i</th>
                                                        <th style="width: 4%">X√≥a</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="variantCombinationsBody">
                                                    <!-- Combinations will be added here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Info (Th√¥ng tin kh√°c) -->
                            <div class="form-section">
                                <h4 class="section-title">
                                    <i class="fas fa-list"></i>
                                    Th√¥ng tin kh√°c
                                    <small class="text-muted">(Th√¥ng tin b·ªï sung t√πy ch·ªçn)</small>
                                </h4>
                                <div class="additional-info-management">
                                    <div class="additional-info-toolbar">
                                        <button type="button" class="btn btn-sm btn-success" id="addAdditionalInfoBtn">
                                            <i class="fas fa-plus"></i> Th√™m th√¥ng tin
                                        </button>
                                        <div class="specs-hint">
                                            <i class="fas fa-info-circle"></i>
                                            V√≠ d·ª•: B·∫£o h√†nh (12 th√°ng), Xu·∫•t x·ª© (Vi·ªát Nam)
                                        </div>
                                    </div>
                                    <div id="additionalInfoContainer" class="additional-info-container">
                                        <!-- Additional info items will be added here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Media -->
                            <div class="form-section">
                                <h4 class="section-title">
                                    <i class="fas fa-image"></i>
                                    H√¨nh ·∫£nh s·∫£n ph·∫©m
                                </h4>
                                
                                <!-- PH·∫¶N 1: N√öT CH·ªåN T·ªÜP -->
                                <div class="file-selector-section">
                                    <input type="file" class="form-control" id="productImages" accept="image/*" multiple style="display: none;">
                                    <button type="button" class="btn btn-primary btn-select-files" id="chooseProductImagesBtn">
                                        <i class="fas fa-folder-open"></i>
                                        Ch·ªçn h√¨nh ·∫£nh t·ª´ m√°y t√≠nh
                                    </button>
                                    <div class="file-info-text">
                                        <i class="fas fa-info-circle"></i>
                                        H·ªó tr·ª£: JPG, PNG, GIF, WebP ‚Ä¢ T·ªëi ƒëa 10 ·∫£nh ‚Ä¢ M·ªói ·∫£nh kh√¥ng qu√° 5MB
                                    </div>
                                </div>

                                <!-- PH·∫¶N 2: KHU V·ª∞C PREVIEW -->
                                <div class="preview-section" id="productImagesPreview">
                                    <div class="preview-header">
                                        <h5 class="preview-title">
                                            <i class="fas fa-images"></i>
                                            ·∫¢nh ƒë√£ ch·ªçn
                                        </h5>
                                        <span class="preview-hint">Ch·ªçn ·∫£nh ch√≠nh b·∫±ng radio button</span>
                                    </div>
                                    <div class="preview-content" id="productImagesPreviewGrid">
                                        <!-- C√°c ·∫£nh preview s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                                    </div>
                                    <div class="preview-empty" id="productImagesUploadArea">
                                        <div class="empty-icon">
                                            <i class="fas fa-image"></i>
                                        </div>
                                        <p class="empty-message">Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn</p>
                                        <p class="empty-hint">Nh·∫•n n√∫t "Ch·ªçn h√¨nh ·∫£nh" ·ªü tr√™n ƒë·ªÉ th√™m ·∫£nh</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Video -->
                            <div class="form-section">
                                <h4 class="section-title">
                                    <i class="fas fa-video"></i>
                                    Video s·∫£n ph·∫©m
                                </h4>
                                
                                <!-- PH·∫¶N 1: N√öT CH·ªåN T·ªÜP -->
                                <div class="file-selector-section">
                                    <input type="file" class="form-control" id="productVideosInput" accept="video/*" multiple style="display: none;">
                                    <button type="button" class="btn btn-primary btn-select-files" id="chooseProductVideosBtn">
                                        <i class="fas fa-folder-open"></i>
                                        Ch·ªçn video t·ª´ m√°y t√≠nh
                                    </button>
                                    <div class="file-info-text">
                                        <i class="fas fa-info-circle"></i>
                                        H·ªó tr·ª£: MP4, MOV, AVI, WebM ‚Ä¢ T·ªëi ƒëa 5 video ‚Ä¢ M·ªói video kh√¥ng qu√° 50MB
                                    </div>
                                </div>

                                <!-- PH·∫¶N 2: KHU V·ª∞C PREVIEW -->
                                <div class="preview-section" id="productVideosPreview">
                                    <div class="preview-header">
                                        <h5 class="preview-title">
                                            <i class="fas fa-video"></i>
                                            Video ƒë√£ ch·ªçn
                                        </h5>
                                    </div>
                                    <div class="preview-content video-preview-content" id="productVideosPreviewGrid">
                                        <!-- C√°c video preview s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                                    </div>
                                    <div class="preview-empty" id="productVideosUploadArea">
                                        <div class="empty-icon">
                                            <i class="fas fa-video"></i>
                                        </div>
                                        <p class="empty-message">Ch∆∞a c√≥ video n√†o ƒë∆∞·ª£c ch·ªçn</p>
                                        <p class="empty-hint">Nh·∫•n n√∫t "Ch·ªçn video" ·ªü tr√™n ƒë·ªÉ th√™m video</p>
                                    </div>
                                </div>

                                <!-- PH·∫¶N 3: LINK VIDEO T·ª™ C√ÅC N·∫æN T·∫¢NG KH√ÅC -->
                                <div class="video-links-section">
                                    <div class="video-links-header">
                                        <h5 class="section-subtitle">
                                            <i class="fas fa-link"></i>
                                            Video t·ª´ n·ªÅn t·∫£ng kh√°c
                                        </h5>
                                        <p class="section-description">Th√™m link video t·ª´ YouTube, Vimeo, TikTok, Facebook...</p>
                                    </div>
                                    
                                    <div class="video-link-input-group">
                                        <input 
                                            type="url" 
                                            class="form-control video-link-input" 
                                            id="videoLinkInput" 
                                            placeholder="Nh·∫≠p link video (VD: https://www.youtube.com/watch?v=...)"
                                        >
                                        <button type="button" class="btn btn-success btn-add-link" id="addVideoLinkBtn">
                                            <i class="fas fa-plus-circle"></i>
                                            Th√™m link
                                        </button>
                                    </div>

                                    <div class="video-links-list" id="videoLinksList">
                                        <!-- Danh s√°ch link video s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                                    </div>

                                    <div class="video-links-empty hidden" id="videoLinksEmpty">
                                        <i class="fas fa-link"></i>
                                        <p>Ch∆∞a c√≥ link video n√†o</p>
                                    </div>
                                </div>
                            </div>


                            <!-- Status & Features -->
                            <div class="form-section">
                                <h4 class="section-title">
                                    <i class="fas fa-cog"></i>
                                    Tr·∫°ng th√°i & T√≠nh nƒÉng
                                </h4>
                                <div class="form-grid-2">
                                    <div class="form-group">
                                        <label class="form-label">T√≠nh nƒÉng</label>
                                        <div class="checkbox-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" id="productFeatured">
                                                <span class="checkmark"></span>
                                                <i class="fas fa-star"></i>
                                                S·∫£n ph·∫©m n·ªïi b·∫≠t
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Description -->
                            <div class="form-section">
                                <h4 class="section-title">
                                    <i class="fas fa-align-left"></i>
                                    M√¥ t·∫£ s·∫£n ph·∫©m
                                </h4>
                                <div class="form-group">
                                    <textarea class="form-control" id="productDescription" rows="4"
                                        placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ s·∫£n ph·∫©m..."></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i>
                        H·ªßy b·ªè
                    </button>
                    <button type="button" class="btn btn-primary" id="saveProductBtn">
                        <i class="fas fa-save"></i>
                        <span id="saveButtonText">Th√™m s·∫£n ph·∫©m</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Technical Specifications Modal -->

</div>



<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
    // Utility Functions
    const Utils = {
        formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount || 0);
        },

        formatCompactCurrency(amount) {
            if (!amount || amount === 0) return '0‚Ç´';
            
            const billion = 1000000000;
            const million = 1000000;
            const thousand = 1000;
            
            if (amount >= billion) {
                return (amount / billion).toFixed(1) + ' t·ª∑';
            } else if (amount >= million) {
                return (amount / million).toFixed(1) + ' tr';
            } else if (amount >= thousand) {
                return (amount / thousand).toFixed(0) + ' K';
            } else {
                return amount.toLocaleString('vi-VN') + '‚Ç´';
            }
        },

        debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        },

        generateSlug(text) {
            return text
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[ƒëƒê]/g, 'd')
                .replace(/[^a-z0-9 -]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-');
        },

        validateImageUrl(url) {
            return new Promise((resolve) => {
                if (!url) {
                    resolve(false);
                    return;
                }
                const img = new Image();
                img.onload = () => resolve(true);
               
                img.src = url;
            });
        },

        escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    };

    // API Service
    class ProductAPIService {
        static async getProducts() {
            try {
                const response = await fetch('/api/sanpham');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'API request failed');
                }

                if (!data.data || !data.data.sanphams) {
                    return [];
                }

                return data.data.sanphams;

            } catch (error) {
                console.error('‚ùå API Error:', error);
                throw new Error('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server: ' + error.message);
            }
        }

        // ========== PRODUCT APIs (B·∫£ng products) ==========
        static async createProduct(productData) {
            try {
                const response = await fetch('/api/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'L·ªói khi th√™m s·∫£n ph·∫©m');
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        static async updateProduct(id, productData) {
            try {
                console.log('üîç DEBUG UPDATE PRODUCT:');
                console.log('üì§ ID:', id, 'Type:', typeof id);
                console.log('üì¶ Data:', JSON.stringify(productData, null, 2));

                const response = await fetch(`/api/products/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'L·ªói khi c·∫≠p nh·∫≠t s·∫£n ph·∫©m');
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        static async deleteProduct(id) {
            try {
                const response = await fetch(`/api/products/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'L·ªói khi x√≥a s·∫£n ph·∫©m');
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // ========== VARIANT APIs (B·∫£ng product_variants) ==========
        static async createVariant(productId, variantData) {
            try {
                const response = await fetch(`/api/products/${productId}/variants`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(variantData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'L·ªói khi th√™m bi·∫øn th·ªÉ');
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        static async updateVariant(variantId, variantData) {
            try {
                const response = await fetch(`/api/variants/${variantId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(variantData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'L·ªói khi c·∫≠p nh·∫≠t bi·∫øn th·ªÉ');
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        static async deleteVariant(variantId) {
            try {
                const response = await fetch(`/api/variants/${variantId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'L·ªói khi x√≥a bi·∫øn th·ªÉ');
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        static async upsertInventory(inventoryData) {
            try {
                const response = await fetch('/api/inventory/upsert', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(inventoryData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'L·ªói khi c·∫≠p nh·∫≠t inventory');
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        static async deleteAllProductVariants(productId) {
            try {
                const response = await fetch(`/api/products/${productId}/variants`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'L·ªói khi x√≥a t·∫•t c·∫£ bi·∫øn th·ªÉ');
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        static async getProductVariants(productId) {
            try {
                const response = await fetch(`/api/products/${productId}/variants`);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'L·ªói khi l·∫•y danh s√°ch bi·∫øn th·ªÉ');
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        static async toggleProductStatus(id, currentStatus) {
            try {
                const newStatus = currentStatus === 1 ? 0 : 1;
                const response = await fetch(`/admin/sanpham/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ trang_thai: newStatus })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'L·ªói khi chuy·ªÉn tr·∫°ng th√°i s·∫£n ph·∫©m');
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        static async updateProductSpecs(productId, specs) {
            try {
                const response = await fetch(`/admin/sanpham/${productId}/chitiet`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(specs)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'L·ªói khi c·∫≠p nh·∫≠t chi ti·∫øt s·∫£n ph·∫©m');
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }
        static async updateProductStatus(id, status) {
            try {
                const response = await fetch(`/api/sanpham/${id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ trang_thai: status })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i s·∫£n ph·∫©m');
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }
        // T·∫°o document MongoDB m·ªõi
        // Trong ProductAPIService, s·ª≠a h√†m createProductMongoDetail
        static async createProductMongoDetail(sql_product_id, specsData, mo_ta_chi_tiet, slug, hinh_anh, link_avatar = '', videos = [], variants = [], video_links = [], trang_thai = 1, san_pham_noi_bat = false, thong_tin_khac = {}) {
            try {
                console.log('üì§ Creating MongoDB document with:', {
                    sql_product_id,
                    specsData,
                    mo_ta_chi_tiet,
                    slug,
                    hinh_anh,
                    link_avatar,
                    videos,
                    variants,
                    video_links,
                    thong_tin_khac
                });

                const requestBody = {
                    sql_product_id: sql_product_id
                };

                // Ch·ªâ th√™m c√°c field c√≥ d·ªØ li·ªáu
                if (specsData && Object.keys(specsData).length > 0) {
                    requestBody.thong_so_ky_thuat = specsData;
                }
                if (hinh_anh && hinh_anh.length > 0) {
                    requestBody.hinh_anh = hinh_anh;
                }
                if (videos && videos.length > 0) {
                    requestBody.videos = videos;
                }
                if (variants && typeof variants === 'object') {
                    // G·ª≠i variants object ch·ª©a c·∫£ variant_options v√† variant_combinations
                    requestBody.variants = variants;
                    console.log('üìä Sending variants:', variants);
                }
                if (video_links && video_links.length > 0) {
                    requestBody.video_links = video_links;
                }
                if (thong_tin_khac && Object.keys(thong_tin_khac).length > 0) {
                    requestBody.thong_tin_khac = thong_tin_khac;
                }
                if (link_avatar) {
                    requestBody.link_avatar = link_avatar;
                }
                if (mo_ta_chi_tiet && mo_ta_chi_tiet.trim()) {
                    requestBody.mo_ta_chi_tiet = mo_ta_chi_tiet;
                }
                if (slug) {
                    requestBody.slug = slug;
                }
                if (trang_thai !== undefined && trang_thai !== null) {
                    requestBody.trang_thai = trang_thai;
                }
                if (san_pham_noi_bat !== undefined && san_pham_noi_bat !== null) {
                    requestBody.san_pham_noi_bat = san_pham_noi_bat;
                }

                console.log('üöÄ Sending MongoDB create request:', requestBody);

                const response = await fetch('/api/mongo/sanpham', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                console.log('üì® MongoDB create response status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('‚ùå MongoDB create error:', errorData);
                    throw new Error(errorData.message || 'L·ªói khi t·∫°o document MongoDB');
                }

                const result = await response.json();
                console.log('‚úÖ MongoDB create result:', result);
                
                // Ki·ªÉm tra n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu MongoDB v√† b·ªã skip
                if (result.skipped) {
                    console.log('‚ö†Ô∏è MongoDB document creation skipped - no data to save');
                }
                
                return result;

            } catch (error) {
                console.error('‚ùå API Error creating MongoDB document:', error);
                throw error;
            }
        }


        // C·∫≠p nh·∫≠t document MongoDB
        static async updateProductMongoDetail(mongoId, updateData) {
            try {
                console.log('üîß API: Updating MongoDB document with ID:', mongoId);
                console.log('üì§ Original update data:', JSON.stringify(updateData, null, 2));

                // L·ªçc b·ªè c√°c field r·ªóng/kh√¥ng c√≥ d·ªØ li·ªáu
                const filteredData = {};
                
                for (const [key, value] of Object.entries(updateData)) {
                    // B·ªè qua n·∫øu gi√° tr·ªã l√† undefined ho·∫∑c null
                    if (value === undefined || value === null) {
                        continue;
                    }
                    
                    // B·ªè qua n·∫øu l√† string r·ªóng
                    if (typeof value === 'string' && value.trim() === '') {
                        continue;
                    }
                    
                    // B·ªè qua n·∫øu l√† array r·ªóng
                    if (Array.isArray(value) && value.length === 0) {
                        continue;
                    }
                    
                    // B·ªè qua n·∫øu l√† object r·ªóng (tr·ª´ sql_product_id)
                    if (typeof value === 'object' && !Array.isArray(value) && Object.keys(value).length === 0) {
                        continue;
                    }
                    
                    // Gi·ªØ l·∫°i field c√≥ d·ªØ li·ªáu
                    filteredData[key] = value;
                }
                
                console.log('üì§ Filtered update data (only fields with data):', JSON.stringify(filteredData, null, 2));
                
                // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu g√¨ ƒë·ªÉ c·∫≠p nh·∫≠t, b·ªè qua
                if (Object.keys(filteredData).length === 0) {
                    console.log('‚ö†Ô∏è No data to update, skipping MongoDB update');
                    return { success: true, skipped: true, message: 'No data to update' };
                }

                const response = await fetch(`/api/mongo/sanpham/${mongoId}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(filteredData)
                });

                console.log('üì® Response status:', response.status);
                
                if (!response.ok) {
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                        console.error('‚ùå Server error response:', errorData);
                    } catch (e) {
                        const errorText = await response.text();
                        errorMessage = errorText || errorMessage;
                        console.error('‚ùå Server error text:', errorText);
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log('‚úÖ MongoDB update successful:', result);
                return result;

            } catch (error) {
                console.error('‚ùå API Error updating MongoDB document:', error);
                throw new Error('L·ªói server khi c·∫≠p nh·∫≠t document MongoDB: ' + error.message);
            }
        }

        // L·∫•y document MongoDB b·∫±ng sql_product_id
        static async getProductMongoDetail(sql_product_id) {
            try {
                const response = await fetch(`/api/mongo/sanpham/sql/${sql_product_id}`);

                if (!response.ok) {
                    throw new Error('L·ªói khi l·∫•y document MongoDB');
                }

                return await response.json();
            } catch (error) {
                console.error('API Error getting MongoDB document:', error);
                throw error;
            }
        }

        // C·∫≠p nh·∫≠t tham chi·∫øu sql_product_id trong MongoDB
        static async updateMongoSqlReference(mongoId, sql_product_id) {
            try {
                const response = await fetch(`/api/mongo/sanpham/${mongoId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sql_product_id: sql_product_id })
                });

                if (!response.ok) {
                    throw new Error('L·ªói khi c·∫≠p nh·∫≠t tham chi·∫øu SQL trong MongoDB');
                }

                return await response.json();
            } catch (error) {
                console.error('API Error updating MongoDB reference:', error);
                throw error;
            }
        }
    }

    // Product Manager Class
    class ProductManager {
        constructor() {
            this.products = [];
            this.currentEditId = null;
            this.isSaving = false;
            // Ph√¢n trang
            this.currentPage = 1;
            this.itemsPerPage = 5;
            this.totalPages = 1;
            this.init();
        }

        async init() {
            await this.loadProducts();
            this.bindEvents();
            this.setupImagePreview();
        }

        async loadProducts() {
            try {
                this.showLoading(true);
                this.products = await ProductAPIService.getProducts();
                
                // Debug: Log tr·∫°ng th√°i c·ªßa 3 s·∫£n ph·∫©m ƒë·∫ßu
                console.log('üì¶ Loaded products sample (trang_thai check):');
                this.products.slice(0, 3).forEach(p => {
                    console.log(`  - ${p.ten_san_pham}:`, {
                        id: p.id,
                        trang_thai: p.trang_thai,
                        type: typeof p.trang_thai,
                        is_truthy: !!p.trang_thai
                    });
                });
                
                this.showLoading(false);
                this.renderProductsTable();  // Render table tr∆∞·ªõc
                this.updateStats();           // Sau ƒë√≥ update stats t·ª´ this.products
                this.filterProducts();        // Cu·ªëi c√πng apply filters
            } catch (error) {
                this.showLoading(false);
                this.showError('Kh√¥ng th·ªÉ t·∫£i danh s√°ch s·∫£n ph·∫©m: ' + error.message);
            }
        }

        renderProductsTable() {
            console.log('üîÑ Rendering products table...');
            
            const tbody = document.querySelector('#productsTable tbody');
            if (!tbody) {
                console.error('‚ùå Products table body not found');
                return;
            }

            // X√≥a n·ªôi dung c≈©
            tbody.innerHTML = '';

            if (this.products.length === 0) {
                this.toggleEmptyState(true);
                this.renderPagination();
                return;
            }

            this.toggleEmptyState(false);

            // T√≠nh to√°n ph√¢n trang
            this.totalPages = Math.ceil(this.products.length / this.itemsPerPage);
            const startIndex = (this.currentPage - 1) * this.itemsPerPage;
            const endIndex = startIndex + this.itemsPerPage;
            const paginatedProducts = this.products.slice(startIndex, endIndex);

            console.log(`üìä Page ${this.currentPage}/${this.totalPages} - Showing ${paginatedProducts.length} products`);

            // Render t·ª´ng s·∫£n ph·∫©m trong trang hi·ªán t·∫°i
            paginatedProducts.forEach(product => {
                const row = document.createElement('tr');
                row.setAttribute('data-id', product.id);
                
                // Normalize trang_thai: convert v·ªÅ 0 ho·∫∑c 1
                const statusValue = (product.trang_thai === true || product.trang_thai === 1 || product.trang_thai === '1') ? '1' : '0';
                row.setAttribute('data-status', statusValue);
                
                row.setAttribute('data-category', product.danh_muc_id);
                row.setAttribute('data-brand', product.thuong_hieu_id);
                row.setAttribute('data-featured', product.san_pham_noi_bat ? 'true' : 'false');

                // X·ª≠ l√Ω gi√° t·ª´ b·∫£ng products
                let priceDisplay = '';
                const productPrice = product.gia_ban || 0;
                const productOriginalPrice = product.gia_niem_yet || 0;
                
                // Debug: Log to√†n b·ªô product data
                console.log(`üí∞ Product ID ${product.id}:`, {
                    gia_ban: product.gia_ban,
                    gia_niem_yet: product.gia_niem_yet,
                    gia_ban_min: product.gia_ban_min,
                    gia_ban_max: product.gia_ban_max,
                    gia_niem_yet_min: product.gia_niem_yet_min,
                    so_bien_the: product.so_bien_the,
                    has_variants: !!(product.variants && product.variants.length > 0)
                });
                
                if (productPrice > 0) {
                    priceDisplay = Utils.formatCurrency(productPrice);
                } else {
                    priceDisplay = '<span class="text-muted">Ch∆∞a c√≥ gi√°</span>';
                }

                // Hi·ªÉn th·ªã SKU - l·∫•y t·ª´ variant ƒë·∫ßu ti√™n ho·∫∑c m√£ s·∫£n ph·∫©m
                let skuDisplay = product.ma_san_pham || 'N/A';
                
                // Debug: Ki·ªÉm tra region_icons
                console.log('üîç Product:', product.ten_san_pham);
                console.log('   - region_icons:', product.region_icons);
                console.log('   - regions_available:', product.regions_available);
                console.log('   - so_bien_the:', product.so_bien_the);
                console.log('   - variants count:', product.variants?.length);
                
                // Hi·ªÉn th·ªã SKU c·ªßa variant ƒë·∫ßu ti√™n
                if (product.variants && product.variants.length > 0) {
                    skuDisplay = product.variants[0].ma_sku;
                    if (product.variants.length > 1) {
                        skuDisplay += ` <small>(+${product.variants.length - 1})</small>`;
                    }
                }
                
                // S·ª≠ d·ª•ng region_icons t·ª´ backend (ƒë√£ ƒë∆∞·ª£c t√≠nh s·∫µn)
                let regionBadges = '';
                if (product.region_icons && product.region_icons.length > 0) {
                    const regionLabels = product.region_icons.map(r => r.site_origin.toUpperCase()).join(', ');
                    regionBadges = ` ‚Ä¢ <i class="fas fa-map-marker-alt"></i> ${regionLabels}`;
                    console.log('   ‚úÖ Region badges:', regionBadges);
                } else {
                    console.log('   ‚ùå No region_icons found');
                }

                row.innerHTML = `
                    <td class="col-image">
                        <div class="product-table-image">
                            <img src="${product.link_anh_dai_dien || '/icon/default-product.png'}" alt="${product.ten_san_pham}">
                        </div>
                    </td>
                    <td class="col-name">
                        <div class="product-name">${Utils.escapeHtml(product.ten_san_pham)}</div>
                        <div class="product-meta">
                            <small class="text-muted">
                                <i class="fas fa-layer-group"></i> ${product.so_bien_the || 0} bi·∫øn th·ªÉ
                                ${regionBadges}
                                ${product.site_created ? ` ‚Ä¢ <i class="fas fa-server"></i> T·∫°o t·ª´: ${product.site_created.toUpperCase()}` : ''}
                            </small>
                        </div>
                    </td>
                    <td class="col-sku">
                        <div class="product-sku">#${skuDisplay}</div>
                    </td>
                    <td class="col-price">
                        <div class="price-info">
                            ${productOriginalPrice > 0 ? `<div class="original-price">${Utils.formatCurrency(productOriginalPrice)}</div>` : ''}
                            <div class="current-price">${priceDisplay}</div>
                        </div>
                    </td>
                    <td class="col-category">
                        <span class="category-badge">${product.ten_danh_muc}</span>
                    </td>
                    <td class="col-brand">
                        <span class="brand-badge">${product.ten_thuong_hieu}</span>
                    </td>
                    <td class="col-status">
                        <span class="status-badge ${statusValue === '1' ? 'active' : 'inactive'}">
                            ${statusValue === '1' ? 'üü¢ ƒêang b√°n' : 'üî¥ Ng·ª´ng b√°n'}
                        </span>
                    </td>
                    <td class="col-actions">
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary btn-action-modern btn-edit" data-id="${product.id}" title="Ch·ªânh s·ª≠a s·∫£n ph·∫©m">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-warning btn-action-modern btn-toggle-status" data-id="${product.id}"
                                data-status="${statusValue}" data-name="${product.ten_san_pham}"
                                title="${statusValue === '1' ? 'Ng·ª´ng b√°n s·∫£n ph·∫©m' : 'M·ªü b√°n s·∫£n ph·∫©m'}">
                                <i class="fas ${statusValue === '1' ? 'fa-eye-slash' : 'fa-eye'}"></i>
                            </button>
                            <button class="btn btn-sm btn-danger btn-action-modern btn-delete-product" data-id="${product.id}"
                                data-name="${product.ten_san_pham}" title="X√≥a s·∫£n ph·∫©m">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // T√≠nh t·ªïng s·∫£n ph·∫©m hi·ªÉn th·ªã
            const displayCount = paginatedProducts.length;
            console.log(`‚úÖ Rendered ${displayCount} products for page ${this.currentPage}`);
            this.updateTableInfo(displayCount);
            this.renderPagination();
        }

        renderPagination() {
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            const paginationContainer = prevBtn?.closest('.table-pagination');
            const paginationInfo = paginationContainer?.querySelector('.pagination-info');

            if (!paginationInfo || !prevBtn || !nextBtn) return;

            // C·∫≠p nh·∫≠t th√¥ng tin trang (scope ƒë√∫ng block s·∫£n ph·∫©m)
            const displayTotalPages = this.totalPages === 0 ? 1 : this.totalPages;
            paginationInfo.textContent = `Trang ${this.currentPage}/${displayTotalPages}`;

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t
            prevBtn.disabled = this.currentPage === 1;
            nextBtn.disabled = this.currentPage === this.totalPages || this.totalPages === 0;
        }

        goToPage(page) {
            if (page < 1 || page > this.totalPages) return;
            this.currentPage = page;
            this.renderProductsTable();
        }


        async refreshProducts() {
            const refreshBtn = document.getElementById('refreshBtn');
            const originalHtml = refreshBtn?.innerHTML || '<i class="fas fa-sync-alt"></i> L√†m m·ªõi';
            
            try {
                console.log('üîÑ Refreshing products data...');
                
                // üÜï QUAN TR·ªåNG: ƒê√≥ng t·∫•t c·∫£ modal ƒëang m·ªü tr∆∞·ªõc khi refresh
                this.closeAllModals();
                
                // Set tr·∫°ng th√°i loading
                if (refreshBtn) {
                    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang l√†m m·ªõi...';
                    refreshBtn.disabled = true;
                }
                
                // Reset v√† reload
                this.clearFilters();
                this.showLoading(true);
                await this.loadProducts();
                this.renderProductsTable();
                this.filterProducts();
                this.updateStats();
                
                console.log('‚úÖ Products data refreshed successfully');
                
            } catch (error) {
                console.error('‚ùå Error refreshing products:', error);
                this.showError('Kh√¥ng th·ªÉ l√†m m·ªõi d·ªØ li·ªáu: ' + error.message);
            } finally {
                // Reset n√∫t refresh
                if (refreshBtn) {
                    refreshBtn.innerHTML = originalHtml;
                    refreshBtn.disabled = false;
                }
                
                this.showLoading(false);
            }
        }

        // üÜï Th√™m ph∆∞∆°ng th·ª©c ƒë√≥ng t·∫•t c·∫£ modal
        closeAllModals() {
            // ƒê√≥ng modal s·∫£n ph·∫©m
            const productModal = document.getElementById('productModal');
            if (productModal) {
                const modalInstance = bootstrap.Modal.getInstance(productModal);
                if (modalInstance) {
                    modalInstance.hide();
                }
            }
            
            console.log('üö™ ƒê√£ ƒë√≥ng modal s·∫£n ph·∫©m');
        }

        // Ph∆∞∆°ng th·ª©c reset n√∫t refresh
        resetRefreshButton(refreshBtn, originalHtml) {
            if (refreshBtn) {
                // Reset ngay l·∫≠p t·ª©c, kh√¥ng c·∫ßn setTimeout
                refreshBtn.innerHTML = originalHtml || '<i class="fas fa-sync-alt"></i> L√†m m·ªõi';
                refreshBtn.disabled = false;
                
                console.log('üîÑ Reset refresh button completed');
            }
        }




        bindEvents() {
            // Product Management
            document.getElementById('addProductBtn')?.addEventListener('click', () => this.openProductModal());
            document.getElementById('addProductEmptyBtn')?.addEventListener('click', () => this.openProductModal());
            document.getElementById('saveProductBtn')?.addEventListener('click', () => this.saveProduct());
            document.getElementById('refreshBtn')?.addEventListener('click', () => this.refreshProducts());

            // Pagination
            document.getElementById('prevPage')?.addEventListener('click', () => this.goToPage(this.currentPage - 1));
            document.getElementById('nextPage')?.addEventListener('click', () => this.goToPage(this.currentPage + 1));

            // Search and Filter - Auto search/filter
            document.getElementById('searchInput')?.addEventListener('input',
                Utils.debounce(() => this.filterProducts(), 300)
            );
            document.getElementById('statusFilter')?.addEventListener('change', () => this.filterProducts());
            document.getElementById('categoryFilter')?.addEventListener('change', () => this.filterProducts());
            document.getElementById('brandFilter')?.addEventListener('change', () => this.filterProducts());
            document.getElementById('clearFilters')?.addEventListener('click', () => this.clearFilters());

            // Event Delegation for Table
            document.addEventListener('click', (e) => {
                if (e.target.closest('.btn-edit')) {
                    this.handleEditProduct(e.target.closest('.btn-edit'));
                }
                if (e.target.closest('.btn-delete-product')) {
                    this.handleDeleteProduct(e.target.closest('.btn-delete-product'));
                }
                if (e.target.closest('.btn-toggle-status')) {
                    this.handleToggleStatus(e.target.closest('.btn-toggle-status'));
                }
            });

            // Technical Specifications Management
            // Select All Checkbox
            document.getElementById('selectAll')?.addEventListener('change', (e) => {
                this.toggleSelectAll(e.target.checked);
            });
        }

        setupImagePreview() {
            const imageInput = document.getElementById('productImage');
            if (imageInput) {
                imageInput.addEventListener('input', Utils.debounce((e) => {
                    this.updateImagePreview(e.target.value);
                }, 500));
            }
        }

        updateImagePreview(imageUrl) {
            const preview = document.getElementById('imagePreview');
            if (!preview) return;

            preview.innerHTML = '';

            if (imageUrl && imageUrl.trim() !== '') {
                Utils.validateImageUrl(imageUrl).then(isValid => {
                    if (isValid) {
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.alt = 'Product Preview';
                        preview.appendChild(img);
                        preview.classList.add('has-image');
                    } else {
                        this.showImageError(preview);
                    }
                });
            } else {
                this.showImagePlaceholder(preview);
            }
        }

        showImagePlaceholder(preview) {
            preview.innerHTML = `
                <div class="preview-placeholder">
                <i class="fas fa-image"></i>
                <span>Preview h√¨nh ·∫£nh</span>
                </div>
            `;
            preview.classList.remove('has-image');
        }

        showImageError(preview) {
            preview.innerHTML = `
                <div class="preview-placeholder">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Kh√¥ng th·ªÉ t·∫£i ·∫£nh</span>
                </div>
            `;
            preview.classList.remove('has-image');
        }

        updateStats() {
            const total = this.products.length;
            const active = this.products.filter(p => p.trang_thai == 1).length;
            const inactive = this.products.filter(p => p.trang_thai == 0).length;
            
            // T√≠nh t·ªïng doanh s·ªë (gi√° b√°n √ó s·ªë l∆∞·ª£ng ƒë√£ b√°n)
            const totalRevenue = this.products.reduce((sum, p) => {
                const soldQuantity = p.luot_ban || 0;
                const price = p.gia_ban || 0;
                return sum + (soldQuantity * price);
            }, 0);

            console.log('üìä Stats:', { total, active, inactive, totalRevenue });

            document.getElementById('totalProducts').textContent = total;
            document.getElementById('countActive').textContent = active;
            document.getElementById('countInactive').textContent = inactive;
            document.getElementById('totalRevenue').textContent = Utils.formatCompactCurrency(totalRevenue);
        }

        updateStatsWithCounts(total, active, inactive, totalRevenue) {
            document.getElementById('totalProducts').textContent = total;
            document.getElementById('countActive').textContent = active;
            document.getElementById('countInactive').textContent = inactive;
            document.getElementById('totalRevenue').textContent = Utils.formatCompactCurrency(totalRevenue);
        }

        filterProducts() {
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('statusFilter')?.value || '';
            const categoryFilter = document.getElementById('categoryFilter')?.value || '';
            const brandFilter = document.getElementById('brandFilter')?.value || '';

            const rows = document.querySelectorAll('#productsTable tbody tr');
            let visibleCount = 0;
            let visibleActive = 0;
            let visibleInactive = 0;
            let visibleRevenue = 0;

            rows.forEach((row, index) => {
                const name = row.querySelector('.product-name')?.textContent.toLowerCase() || '';
                const sku = row.querySelector('.product-sku')?.textContent.toLowerCase() || '';
                const status = row.getAttribute('data-status') || '';
                const category = row.getAttribute('data-category') || '';
                const brand = row.getAttribute('data-brand') || '';
                const productId = row.getAttribute('data-id') || '';

                const matchesSearch = name.includes(searchTerm) || sku.includes(searchTerm);
                const matchesStatus = !statusFilter || status === statusFilter;
                const matchesCategory = !categoryFilter || category === categoryFilter;
                const matchesBrand = !brandFilter || brand === brandFilter;

                // Status filter only affects visual styling, not visibility
                if (matchesSearch && matchesCategory && matchesBrand) {
                    row.style.display = '';
                    visibleCount++;
                    
                    // Apply visual styling based on status filter
                    if (statusFilter && !matchesStatus) {
                        row.style.opacity = '0.4';
                        row.style.backgroundColor = '#f9fafb';
                    } else {
                        row.style.opacity = '1';
                        row.style.backgroundColor = '';
                    }
                    
                    // ƒê·∫øm stats cho s·∫£n ph·∫©m hi·ªÉn th·ªã
                    if (status === '1') visibleActive++;
                    if (status === '0') visibleInactive++;
                    
                    // T√≠nh doanh s·ªë c·ªßa s·∫£n ph·∫©m n√†y
                    const product = this.products.find(p => p.id == productId);
                    if (product) {
                        const soldQuantity = product.luot_ban || 0;
                        const price = product.gia_ban || 0;
                        visibleRevenue += (soldQuantity * price);
                    }
                } else {
                    row.style.display = 'none';
                    row.style.opacity = '1';
                    row.style.backgroundColor = '';
                }
            });

            console.log('üîç Filter Stats:', { visibleCount, visibleActive, visibleInactive, visibleRevenue });

            this.toggleEmptyState(visibleCount === 0);
            this.updateTableInfo(visibleCount);
            
            // KH√îNG c·∫≠p nh·∫≠t stats khi filter - gi·ªØ nguy√™n stats t·ªïng th·ªÉ
            // Stats lu√¥n hi·ªÉn th·ªã th√¥ng tin t·ªïng th·ªÉ t·ª´ this.products
        }

        clearFilters() {
            const searchInput = document.getElementById('searchInput');
            const statusFilter = document.getElementById('statusFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            const brandFilter = document.getElementById('brandFilter');

            if (searchInput) searchInput.value = '';
            if (statusFilter) statusFilter.value = '';
            if (categoryFilter) categoryFilter.value = '';
            if (brandFilter) brandFilter.value = '';

            console.log('üßπ ƒê√£ x√≥a t·∫•t c·∫£ b·ªô l·ªçc');
            
            // Render l·∫°i d·ªØ li·ªáu g·ªëc
            this.filterProducts();
        }

        toggleEmptyState(show) {
            const emptyState = document.getElementById('emptyState');
            const tableContainer = document.querySelector('.table-container');

            if (emptyState && tableContainer) {
                emptyState.style.display = show ? 'flex' : 'none';
                tableContainer.style.display = show ? 'none' : 'block';
            }
        }

        showLoading(show) {
            const loadingState = document.getElementById('loadingState');
            const tableContainer = document.querySelector('.table-container');
            const emptyState = document.getElementById('emptyState');

            if (loadingState && tableContainer && emptyState) {
                if (show) {
                    loadingState.style.display = 'flex';
                    tableContainer.style.display = 'none';
                    emptyState.style.display = 'none';
                } else {
                    loadingState.style.display = 'none';
                    tableContainer.style.display = 'block';
                    
                    // Ki·ªÉm tra xem c√≥ s·∫£n ph·∫©m n√†o kh√¥ng ƒë·ªÉ hi·ªÉn th·ªã empty state
                    const visibleCount = document.querySelectorAll('#productsTable tbody tr:not([style*="display: none"])').length;
                    this.toggleEmptyState(visibleCount === 0);
                }
            }
        }

        updateTableInfo(visibleCount) {
            const currentCount = document.getElementById('currentCount');
            const totalCount = document.getElementById('totalCount');

            if (totalCount) totalCount.textContent = this.products.length;
            
            if (currentCount) {
                const startIndex = (this.currentPage - 1) * this.itemsPerPage + 1;
                const endIndex = Math.min(startIndex + visibleCount - 1, this.products.length);
                
                if (this.products.length === 0) {
                    currentCount.textContent = '0';
                } else {
                    currentCount.textContent = `${startIndex}-${endIndex}`;
                }
            }
        }

        toggleSelectAll(checked) {
            document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                checkbox.checked = checked;
            });
        }

        // Product Modal Methods
        openProductModal(product = null) {
            try {
                this.currentEditId = product ? product.id : null;

                // üÜï ƒê·∫£m b·∫£o modal t·ªìn t·∫°i trong DOM
                let modalElement = document.getElementById('productModal');
                if (!modalElement) {
                    console.error('‚ùå Product modal kh√¥ng t·ªìn t·∫°i trong DOM');
                    this.showError('L·ªói: Modal kh√¥ng t·ªìn t·∫°i. Vui l√≤ng t·∫£i l·∫°i trang.');
                    return;
                }

                // üÜï Lu√¥n t·∫°o modal instance m·ªõi ƒë·ªÉ ƒë·∫£m b·∫£o fresh state
                const modal = new bootstrap.Modal(modalElement);
                
                // üÜï T√¨m c√°c element v·ªõi fallback
                let titlez = document.getElementById('modalTitle');
                let saveText = document.getElementById('saveButtonText');

                const title = modalElement.querySelector('.modal-title');
                const saveBtn = document.getElementById('saveProductBtn');

                // N·∫øu kh√¥ng t√¨m th·∫•y element, th·ª≠ t√¨m b·∫±ng c√°ch kh√°c
                if (!title) {
                    title = modalElement.querySelector('.modal-title');
                    if (title) title.id = 'modalTitle';
                }
                
                if (!saveText) {
                    const saveBtn = modalElement.querySelector('#saveProductBtn');
                    if (saveBtn) {
                        saveText = saveBtn.querySelector('span') || document.createElement('span');
                        saveText.id = 'saveButtonText';
                        if (!saveBtn.contains(saveText)) {
                            saveBtn.appendChild(saveText);
                        }
                    }
                }

                if (!title || !saveText) {
                    console.error('‚ùå Kh√¥ng th·ªÉ t√¨m th·∫•y element modal sau nhi·ªÅu l·∫ßn th·ª≠');
                    this.showError('L·ªói hi·ªÉn th·ªã form. Vui l√≤ng t·∫£i l·∫°i trang.');
                    return;
                }

                if (product) {
                    title.textContent = 'Ch·ªânh s·ª≠a s·∫£n ph·∫©m';
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> C·∫≠p nh·∫≠t s·∫£n ph·∫©m';
                    // L∆∞u slug v√†o bi·∫øn to√†n c·ª•c ƒë·ªÉ d√πng cho upload
                    window.currentProductSlug = null; // S·∫Ω load t·ª´ MongoDB
                    this.fillProductForm(product);
                } else {
                    title.textContent = 'Th√™m s·∫£n ph·∫©m m·ªõi';
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Th√™m s·∫£n ph·∫©m';
                    window.currentProductSlug = null;
                    this.resetProductForm();
                }

                // üÜï X·ª≠ l√Ω s·ª± ki·ªán khi modal ho√†n to√†n hi·ªÉn th·ªã
                modalElement.addEventListener('shown.bs.modal', () => {
                    console.log('‚úÖ Modal ƒë√£ hi·ªÉn th·ªã ho√†n to√†n');
                }, { once: true });

                modal.show();
                
            } catch (error) {
                console.error('‚ùå L·ªói nghi√™m tr·ªçng trong openProductModal:', error);
                this.showError('L·ªói h·ªá th·ªëng: ' + error.message);
            }
        }

        async fillProductForm(product) {

            this.resetProductForm();
            this.currentEditId = product.id;

            console.log('Filling product form with data:', product);

            const productIdEl = document.getElementById('productId');
            const mongoDetailIdEl = document.getElementById('mongoDetailId');
            const productNameEl = document.getElementById('productName');
            const productSiteOriginEl = document.getElementById('productSiteOrigin');
            const productCategoryEl = document.getElementById('productCategory');
            const productBrandEl = document.getElementById('productBrand');
            const productStatusEl = document.getElementById('productStatus');
            const productDescriptionEl = document.getElementById('productDescription');
            const productFeaturedEl = document.getElementById('productFeatured');

            if (productIdEl) productIdEl.value = product.id || '';
            if (mongoDetailIdEl) mongoDetailIdEl.value = product.mongo_detail_id || '';
            if (productNameEl) productNameEl.value = product.ten_san_pham || '';
            
            // Site created (ƒë√£ chuy·ªÉn t·ª´ site_origin sang site_created trong product)
            if (productSiteOriginEl) {
                productSiteOriginEl.value = product.site_created || 'bac';
            }
            if (productCategoryEl) productCategoryEl.value = product.danh_muc_id || '';
            if (productBrandEl) productBrandEl.value = product.thuong_hieu_id || '';
            
            // Normalize trang_thai: convert v·ªÅ '0' ho·∫∑c '1'
            const normalizedStatus = (product.trang_thai === true || product.trang_thai === 1 || product.trang_thai === '1') ? '1' : '0';
            
            console.log('üîç DEBUG fillProductForm - trang_thai:', {
                original: product.trang_thai,
                type: typeof product.trang_thai,
                normalized: normalizedStatus,
                productName: product.ten_san_pham
            });
            
            if (productStatusEl) {
                productStatusEl.value = normalizedStatus;
                console.log('‚úÖ Set productStatus select to:', normalizedStatus, 'Element value now:', productStatusEl.value);
            }
            
            if (productDescriptionEl) productDescriptionEl.value = product.mo_ta || '';
            if (productFeaturedEl) productFeaturedEl.checked = product.san_pham_noi_bat || false;

            console.log ('ƒê√£ v√†o ƒëc: ', product.mongo_detail_id);
            // Load th√¥ng tin t·ª´ MongoDB n·∫øu c√≥ mongo_detail_id
            if (product.mongo_detail_id) {
                try {
                    console.log ('ƒê√£ v√†o ƒëc');
                    const mongoResult = await ProductAPIService.getProductMongoDetail(product.id);
                    if (mongoResult.success && mongoResult.data) {
                        const mongoData = mongoResult.data;
                        console.log('üì• Loaded MongoDB data:', mongoData);
                        console.log('üîç Debug - video_links:', mongoData.video_links);
                        console.log('üîç Debug - variants:', mongoData.variants);
                        
                        // Load th√¥ng s·ªë k·ªπ thu·∫≠t
                        if (window.productSpecsManager && mongoData.thong_so_ky_thuat) {
                            window.productSpecsManager.loadSpecsData(mongoData.thong_so_ky_thuat);
                        }

                        // üü¢ LOAD ·∫¢NH HI·ªÜN C√ì T·ª™ MONGODB
                        if (mongoData.hinh_anh && mongoData.hinh_anh.length > 0) {
                            console.log('üñºÔ∏è Loading existing images from MongoDB with avatar:', {
                                hinh_anh: mongoData.hinh_anh,
                                link_avatar: mongoData.link_avatar
                            });
                            if (window.simpleImageUploadManager) {
                                window.simpleImageUploadManager.loadExistingImages({
                                    hinh_anh: mongoData.hinh_anh,
                                    link_avatar: mongoData.link_avatar
                                });
                            }
                        }

                        if (mongoData.videos && mongoData.videos.length > 0) {
                            console.log('üé¨ Loading existing videos from MongoDB:', mongoData.videos);
                            if (window.simpleImageUploadManager) {
                                window.simpleImageUploadManager.loadExistingVideos({
                                    videos: mongoData.videos
                                });
                            }
                        }

                        // üîó LOAD VIDEO LINKS N·∫æU C√ì
                        if (mongoData.video_links && mongoData.video_links.length > 0) {
                            console.log('üîó Loading existing video links from MongoDB:', mongoData.video_links);
                            if (window.videoLinksManager) {
                                window.videoLinksManager.loadVideoLinksData(mongoData.video_links);
                            }
                        }

                        // üì¶ LOAD VARIANTS N·∫æU C√ì
                        // MongoDB variants c√≥ c·∫•u tr√∫c: { variants: { variant_options: [...], variant_combinations: [...] } }
                        
                        let variantsData = null;
                        
                        // Load variants t·ª´ MongoDB
                        if (mongoData.variants && typeof mongoData.variants === 'object') {
                            console.log('üì¶ Loading variants from MongoDB:', mongoData.variants);
                            variantsData = mongoData.variants; // variantsData = { variant_options: [...], variant_combinations: [...] }
                        }
                        
                        if (variantsData && window.productVariantsManager) {
                            window.productVariantsManager.loadVariantsData(variantsData);
                            
                            // üîÑ Sync tr·∫°ng th√°i t·ª´ SQL product_variants
                            await window.productVariantsManager.syncVariantStatusFromSQL(product.id);
                        }
                        
                        // Thu th·∫≠p t·∫•t c·∫£ ·∫£nh t·ª´ variants v√† th√™m v√†o hinh_anh n·∫øu ch∆∞a c√≥
                        if (variantsData?.variant_combinations && window.simpleImageUploadManager) {
                            const allImages = mongoData.hinh_anh ? [...mongoData.hinh_anh] : [];
                            
                            variantsData.variant_combinations.forEach(combo => {
                                if (combo.image && !allImages.includes(combo.image)) {
                                    allImages.push(combo.image);
                                    console.log('‚úÖ Added variant image to preview:', combo.image);
                                }
                            });
                            
                            // Reload images v·ªõi t·∫•t c·∫£ ·∫£nh (bao g·ªìm c·∫£ variant images)
                            if (allImages.length > 0) {
                                window.simpleImageUploadManager.loadExistingImages({
                                    hinh_anh: allImages,
                                    link_avatar: mongoData.link_avatar
                                });
                            }
                        }

                        // üìã LOAD TH√îNG TIN KH√ÅC N·∫æU C√ì
                        if (mongoData.thong_tin_khac && Object.keys(mongoData.thong_tin_khac).length > 0) {
                            console.log('üìã Loading existing additional info from MongoDB:', mongoData.thong_tin_khac);
                            if (window.additionalInfoManager) {
                                window.additionalInfoManager.loadInfoData(mongoData.thong_tin_khac);
                            }
                        }

                        // üìÑ LOAD M√î T·∫¢, TR·∫†NG TH√ÅI, N·ªîI B·∫¨T
                        const productDescEl = document.getElementById('productDescription');
                        const productStatusEl = document.getElementById('productStatus');
                        const productFeaturedEl = document.getElementById('productFeatured');
                        
                        if (mongoData.mo_ta_chi_tiet && productDescEl) {
                            productDescEl.value = mongoData.mo_ta_chi_tiet;
                        }
                        
                        // ‚ùå KH√îNG load trang_thai t·ª´ MongoDB v√¨ SQL l√† ngu·ªìn ch√≠nh x√°c
                        // MongoDB c√≥ th·ªÉ ch·ª©a d·ªØ li·ªáu c≈©, ƒë√£ set t·ª´ SQL ·ªü tr√™n r·ªìi
                        console.log('‚ö†Ô∏è Skipping MongoDB trang_thai, using SQL value already set');
                        
                        if (mongoData.san_pham_noi_bat !== undefined && productFeaturedEl) {
                            productFeaturedEl.checked = mongoData.san_pham_noi_bat;
                        }
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not load MongoDB data:', error.message);
                    if (window.productSpecsManager) {
                        window.productSpecsManager.clearSpecs();
                    }
                    if (window.productVariantsManager) {
                        window.productVariantsManager.clearVariants();
                    }
                    if (window.additionalInfoManager) {
                        window.additionalInfoManager.clearInfo();
                    }
                    if (window.videoLinksManager) {
                        window.videoLinksManager.clearVideoLinks();
                    }
                    if (window.simpleImageUploadManager) {
                        window.simpleImageUploadManager.resetProductImages();
                        window.simpleImageUploadManager.resetProductVideos();
                    }
                }
            } else {
                if (window.productSpecsManager) {
                    window.productSpecsManager.clearSpecs();
                }
                if (window.productVariantsManager) {
                    window.productVariantsManager.clearVariants();
                }
                if (window.additionalInfoManager) {
                    window.additionalInfoManager.clearInfo();
                }
                if (window.videoLinksManager) {
                    window.videoLinksManager.clearVideoLinks();
                }

                // Reset ·∫£nh v√† video n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu MongoDB
                if (window.simpleImageUploadManager) {
                    window.simpleImageUploadManager.resetProductImages();
                    window.simpleImageUploadManager.resetProductVideos();
                }
            }
        }



        resetProductForm() {
            console.log('üîÑ Resetting product form - clearing all data');
            this.currentEditId = null;
            
            // RESET ·∫¢NH ƒê·∫¶U TI√äN V√Ä LU√îN LU√îN
            if (window.simpleImageUploadManager) {
                console.log('üóëÔ∏è Force resetting product images');
                window.simpleImageUploadManager.productImages = [];
                window.simpleImageUploadManager.mainImageIndex = 0;
                window.simpleImageUploadManager.productVideos = [];
                window.simpleImageUploadManager.renderProductImagesPreview();
                window.simpleImageUploadManager.renderProductVideosPreview();
            }
            
            // S·ª≠ d·ª•ng optional chaining cho an to√†n
            const productFormEl = document.getElementById('productForm');
            const productStatusEl = document.getElementById('productStatus');
            
            if (productFormEl) productFormEl.reset();
            if (productStatusEl) productStatusEl.value = '1';
            
            if (window.productSpecsManager) {
                window.productSpecsManager.clearSpecs();
            }
            
            console.log('‚úÖ Product form reset complete');
        }

        // S·ª≠a l·∫°i h√†m saveProduct cho SCHEMA M·ªöI (products + product_variants)
        async saveProduct() {
            if (this.isSaving) {
                console.log('üõë ƒêang trong qu√° tr√¨nh l∆∞u, b·ªè qua');
                return;
            }

            this.isSaving = true;
            try {
                const saveBtn = document.getElementById('saveProductBtn');
                const originalText = saveBtn ? saveBtn.innerHTML : null;
                
                if (saveBtn) {
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
                    saveBtn.disabled = true;
                }

                // L·∫•y d·ªØ li·ªáu t·ª´ form
                const productData = this.getProductFormData();  // D·ªØ li·ªáu b·∫£ng products
                const variantsFormData = this.getVariantsFormData();  // D·ªØ li·ªáu b·∫£ng product_variants (SQL)
                const variantsManagerData = window.productVariantsManager ? window.productVariantsManager.getVariantsData() : { variant_options: [], variant_combinations: [] };  // D·ªØ li·ªáu cho MongoDB
                const specsData = window.productSpecsManager ? window.productSpecsManager.getSpecsData() : {};
                const additionalInfoData = window.additionalInfoManager ? window.additionalInfoManager.getInfoData() : {};
                const videoLinksData = window.videoLinksManager ? window.videoLinksManager.getVideoLinksData() : [];

                console.log('üì¶ Product Data (b·∫£ng products):', productData);
                console.log('üì¶ Variants Data for SQL (product_variants table):', variantsFormData);
                console.log('üì¶ Variants Data for MongoDB (variant_options + combinations):', variantsManagerData);
                console.log('üîß Technical Specs for MongoDB:', specsData);
                console.log('üìã Additional Info for MongoDB:', additionalInfoData);
                console.log('üîó Video Links for MongoDB:', videoLinksData);

                // Validate
                if (!this.validateProductForm(productData)) {
                    if (saveBtn) {
                        saveBtn.innerHTML = originalText;
                        saveBtn.disabled = false;
                    }
                    this.isSaving = false;
                    return;
                }

                let productId, mongoDetailId;

                // ============================================
                // LU·ªíNG X·ª¨ L√ù: SQL (products) ‚Üí Upload Media ‚Üí Variants ‚Üí MongoDB
                // ============================================

                if (this.currentEditId) {
                    // ========== C·∫¨P NH·∫¨T S·∫¢N PH·∫®M ==========
                    productId = this.currentEditId;
                    mongoDetailId = document.getElementById('mongoDetailId')?.value;
                    console.log('üîÑ Updating Product ID:', productId, 'MongoDB ID:', mongoDetailId);
                    
                    // T√≠nh gi√° t·ª´ variants
                    const calculatedPrices = this.calculateProductPriceFromVariants(variantsFormData);
                    productData.gia_ban = calculatedPrices.gia_ban;
                    productData.gia_niem_yet = calculatedPrices.gia_niem_yet;
                    
                    // B∆Ø·ªöC 1: C·∫≠p nh·∫≠t th√¥ng tin s·∫£n ph·∫©m trong SQL (ch∆∞a c√≥ ·∫£nh)
                    console.log('üìù Step 1: Updating product in SQL...');
                    await ProductAPIService.updateProduct(productId, productData);
                    console.log('‚úÖ Step 1 complete: Product updated in SQL');

                    // B∆Ø·ªöC 1.5: C·∫≠p nh·∫≠t variants trong product_variants b·∫±ng sql_variant_id
                    console.log('üìù Step 1.5: Updating variants in product_variants table...');
                    
                    // Duy·ªát qua t·ª´ng combination v√† update v√†o SQL b·∫±ng sql_variant_id
                    if (variantsManagerData.variant_combinations && variantsManagerData.variant_combinations.length > 0) {
                        for (const combo of variantsManagerData.variant_combinations) {
                            if (combo.sql_variant_id) {
                                // ƒê√£ c√≥ sql_variant_id ‚Üí UPDATE ch·ªâ c√°c field c√≥ gi√° tr·ªã
                                try {
                                    const updateData = {};
                                    
                                    // Lu√¥n update t√™n hi·ªÉn th·ªã
                                    if (combo.name !== undefined && combo.name !== null) {
                                        updateData.ten_hien_thi = combo.name;
                                    }
                                    
                                    // Ch·ªâ update n·∫øu c√≥ gi√° tr·ªã
                                    if (combo.sku !== undefined && combo.sku !== null) {
                                        updateData.ma_sku = combo.sku;
                                    }
                                    
                                    if (combo.price !== undefined && combo.price !== null) {
                                        updateData.gia_ban = parseFloat(combo.price);
                                    }
                                    
                                    if (combo.original_price !== undefined && combo.original_price !== null) {
                                        updateData.gia_niem_yet = parseFloat(combo.original_price);
                                    }
                                    
                                    if (combo.stock !== undefined && combo.stock !== null) {
                                        updateData.so_luong_ton_kho = parseInt(combo.stock);
                                    }
                                    
                                    if (combo.vung !== undefined && combo.vung !== null) {
                                        updateData.site_origin = combo.vung;
                                    }
                                    
                                    // Update tr·∫°ng th√°i t·ª´ combo.active
                                    if (combo.active !== undefined && combo.active !== null) {
                                        updateData.trang_thai = combo.active ? 1 : 0;
                                    }
                                    
                                    // Ch·ªâ g·ªçi API n·∫øu c√≥ field n√†o c·∫ßn update
                                    if (Object.keys(updateData).length > 0) {
                                        await ProductAPIService.updateVariant(combo.sql_variant_id, updateData);
                                        console.log(`‚úÖ Updated variant ${combo.sql_variant_id}:`, combo.sku);
                                    }
                                } catch (error) {
                                    console.error(`‚ùå Error updating variant ${combo.sql_variant_id}:`, error);
                                }
                            } else {
                                // Ch∆∞a c√≥ sql_variant_id ‚Üí CREATE m·ªõi
                                try {
                                    const variantData = {
                                        ma_sku: combo.sku || `SKU-${Date.now()}`,
                                        ten_hien_thi: combo.name || 'N/A',
                                        gia_ban: parseFloat(combo.price) || 0,
                                        gia_niem_yet: parseFloat(combo.original_price) || parseFloat(combo.price) || 0,
                                        so_luong_ton_kho: parseInt(combo.stock) || 0,
                                        site_origin: combo.vung || 'bac',
                                        anh_dai_dien: combo.image || null,
                                        trang_thai: combo.active !== undefined ? (combo.active ? 1 : 0) : 1
                                    };
                                    
                                    const result = await ProductAPIService.createVariant(productId, variantData);
                                    const sqlVariantId = result.data.id;
                                    combo.sql_variant_id = sqlVariantId;
                                    console.log(`‚úÖ Created new variant ${sqlVariantId}:`, combo.sku);
                                } catch (error) {
                                    console.error(`‚ùå Error creating variant ${combo.sku}:`, error);
                                }
                            }
                        }
                    }
                    console.log('‚úÖ Step 1.5 complete: Variants updated in SQL');

                    // B∆Ø·ªöC 2: Chu·∫©n b·ªã d·ªØ li·ªáu MongoDB (ch∆∞a c√≥ ·∫£nh/video)
                    console.log('üìù Step 2: Preparing MongoDB data (without media)...');
                    const mongoUpdateData = {
                        sql_product_id: productId,
                        thong_so_ky_thuat: specsData,
                        thong_tin_khac: additionalInfoData,
                        video_links: videoLinksData,
                        mo_ta_chi_tiet: document.getElementById('productDescription')?.value.trim() || '',
                        trang_thai: parseInt(document.getElementById('productStatus')?.value || 1),
                        san_pham_noi_bat: document.getElementById('productFeatured')?.checked || false,
                        slug: Utils.generateSlug(productData.ten_san_pham)
                    };
                    
                    // Th√™m variants data
                    if (variantsManagerData.variant_options || variantsManagerData.variant_combinations) {
                        mongoUpdateData.variants = {
                            variant_options: variantsManagerData.variant_options || [],
                            variant_combinations: variantsManagerData.variant_combinations || []
                        };
                        console.log('üìä Sending variants object:', mongoUpdateData.variants);
                    }

                    if (mongoDetailId) {
                        await ProductAPIService.updateProductMongoDetail(mongoDetailId, mongoUpdateData);
                        console.log('‚úÖ Step 2 complete: MongoDB document updated');
                    } else {
                        const mongoResult = await ProductAPIService.createProductMongoDetail(
                            productId,
                            specsData,
                            mongoUpdateData.mo_ta_chi_tiet,
                            mongoUpdateData.slug,
                            [],  // hinh_anh - empty for now
                            '',  // link_avatar - empty for now
                            [],  // videos - empty for now
                            variantsManagerData,  // G·ª≠i c·∫•u tr√∫c variant_options + variant_combinations
                            videoLinksData,
                            mongoUpdateData.trang_thai,
                            mongoUpdateData.san_pham_noi_bat,
                            additionalInfoData
                        );
                        
                        if (!mongoResult.skipped) {
                            mongoDetailId = mongoResult.data._id;
                            await ProductAPIService.updateProduct(productId, {
                                mongo_detail_id: mongoDetailId
                            });
                            console.log('‚úÖ Step 2 complete: New MongoDB document created');
                        }
                    }

                    // B∆Ø·ªöC 3: X√≥a ·∫£nh/video ƒë√£ ƒë√°nh d·∫•u
                    console.log('üìù Step 3: Deleting marked images/videos...');
                    if (window.simpleImageUploadManager.imagesToDelete && window.simpleImageUploadManager.imagesToDelete.length > 0) {
                        console.log('üóëÔ∏è Deleting marked images from Cloudinary:', window.simpleImageUploadManager.imagesToDelete);
                        for (const imageUrl of window.simpleImageUploadManager.imagesToDelete) {
                            try {
                                await window.simpleImageUploadManager.deleteImageFromCloudinary(imageUrl);
                                console.log('‚úÖ Deleted image:', imageUrl);
                            } catch (error) {
                                console.warn('‚ö†Ô∏è Could not delete image:', imageUrl, error);
                            }
                        }
                        // Reset danh s√°ch
                        window.simpleImageUploadManager.imagesToDelete = [];
                    }
                    
                    if (window.simpleImageUploadManager.videosToDelete && window.simpleImageUploadManager.videosToDelete.length > 0) {
                        console.log('üóëÔ∏è Deleting marked videos from Cloudinary:', window.simpleImageUploadManager.videosToDelete);
                        for (const videoUrl of window.simpleImageUploadManager.videosToDelete) {
                            try {
                                await window.simpleImageUploadManager.deleteVideoFromCloudinary(videoUrl);
                                console.log('‚úÖ Deleted video:', videoUrl);
                            } catch (error) {
                                console.warn('‚ö†Ô∏è Could not delete video:', videoUrl, error);
                            }
                        }
                        // Reset danh s√°ch
                        window.simpleImageUploadManager.videosToDelete = [];
                    }

                    // B∆Ø·ªöC 4: Upload ·∫£nh/video (b∆∞·ªõc cu·ªëi c√πng)
                    console.log('üìù Step 4: Uploading media (final step)...');
                    let hinhAnhArray = [];
                    let videoUrls = [];
                    let updatedVariantsData = null; // Khai b√°o ·ªü ƒë√¢y ƒë·ªÉ d√πng sau

                    // Upload variant images and update SQL + MongoDB
                    if (window.productVariantsManager && window.productVariantsManager.combinations) {
                        console.log('üñºÔ∏è Step 4a: Uploading variant images FIRST...');
                        for (const combo of window.productVariantsManager.combinations) {
                            if (combo.imageFile && combo.sql_variant_id) {
                                try {
                                    console.log(`üì§ Uploading image for variant ${combo.sku}...`);
                                    const uploadedUrl = await window.simpleImageUploadManager.uploadSingleImage(combo.imageFile);
                                    
                                    // L∆∞u file c≈© ƒë·ªÉ t√¨m trong preview
                                    const oldFile = combo.imageFile;
                                    
                                    combo.image = uploadedUrl; // Replace data URL with Cloudinary URL
                                    delete combo.imageFile; // Remove file object
                                    console.log(`‚úÖ Variant image uploaded: ${uploadedUrl}`);
                                    
                                    // C·∫≠p nh·∫≠t preview v·ªõi Cloudinary URL (thay data URL b·∫±ng Cloudinary URL)
                                    const previewIdx = window.simpleImageUploadManager.productImages.findIndex(
                                        img => img.file === oldFile
                                    );
                                    if (previewIdx !== -1) {
                                        window.simpleImageUploadManager.productImages[previewIdx] = {
                                            url: uploadedUrl,
                                            name: oldFile.name,
                                            type: 'variant',
                                            isExisting: true
                                        };
                                        console.log('‚úÖ Updated preview with Cloudinary URL for variant image');
                                    }
                                    
                                    // Update anh_dai_dien trong product_variants (SQL) b·∫±ng sql_variant_id
                                    try {
                                        await ProductAPIService.updateVariant(combo.sql_variant_id, { anh_dai_dien: uploadedUrl });
                                        console.log(`‚úÖ Updated variant ID ${combo.sql_variant_id} with image in SQL`);
                                    } catch (error) {
                                        console.error(`‚ùå Error updating variant ${combo.sql_variant_id} in SQL:`, error);
                                    }
                                } catch (error) {
                                    console.error(`‚ùå Error uploading variant image for ${combo.sku}:`, error);
                                }
                            }
                        }
                        
                        // Update MongoDB v·ªõi link_anh v√† sql_variant_id
                        updatedVariantsData = window.productVariantsManager.getVariantsData();
                        if (mongoDetailId && updatedVariantsData) {
                            try {
                                await ProductAPIService.updateProductMongoDetail(mongoDetailId, {
                                    variants: updatedVariantsData
                                });
                                console.log('‚úÖ Updated MongoDB with variant image links and SQL IDs');
                            } catch (error) {
                                console.error('‚ùå Error updating MongoDB:', error);
                            }
                        }
                    }

                    // B√¢y gi·ªù upload product images (·∫£nh variant ƒë√£ c√≥ Cloudinary URL)
                    console.log('üñºÔ∏è Step 4b: Uploading product images...');
                    if (window.simpleImageUploadManager && window.simpleImageUploadManager.productImages.length > 0) {
                        try {
                            console.log('üñºÔ∏è Uploading product images...');
                            const uploadResult = await window.simpleImageUploadManager.uploadProductImages();
                            
                            if (uploadResult.mainImageUrl && !hinhAnhArray.includes(uploadResult.mainImageUrl)) {
                                hinhAnhArray.push(uploadResult.mainImageUrl);
                            }
                            if (uploadResult.additionalImages && uploadResult.additionalImages.length > 0) {
                                uploadResult.additionalImages.forEach(imgUrl => {
                                    if (!hinhAnhArray.includes(imgUrl)) {
                                        hinhAnhArray.push(imgUrl);
                                    }
                                });
                            }
                        } catch (uploadError) {
                            console.error('‚ùå L·ªói upload ·∫£nh:', uploadError);
                        }
                    }
                    
                    // Thu th·∫≠p t·∫•t c·∫£ ·∫£nh t·ª´ variants ƒë√£ upload (ki·ªÉm tra duplicate)
                    if (updatedVariantsData?.variant_combinations) {
                        updatedVariantsData.variant_combinations.forEach(combo => {
                            if (combo.image && !hinhAnhArray.includes(combo.image)) {
                                hinhAnhArray.push(combo.image);
                                console.log('‚úÖ Added variant image to hinh_anh:', combo.image);
                            }
                        });
                    }

                    if (window.simpleImageUploadManager && window.simpleImageUploadManager.productVideos.length > 0) {
                        try {
                            console.log('üé¨ Uploading videos...');
                            videoUrls = await window.simpleImageUploadManager.uploadProductVideos();
                        } catch (uploadError) {
                            console.error('‚ùå L·ªói upload video:', uploadError);
                        }
                    }
                    
                    // Filter data URLs kh·ªèi hinhAnhArray tr∆∞·ªõc khi l∆∞u
                    const validHinhAnh = hinhAnhArray.filter(url => url && !url.startsWith('data:'));
                    // link_avatar v√† link_anh_dai_dien lu√¥n l·∫•y ·∫£nh ƒë·∫ßu ti√™n t·ª´ hinh_anh array
                    const link_anh_dai_dien = validHinhAnh.length > 0 ? validHinhAnh[0] : null;
                    console.log('‚úÖ Step 4 complete: Media uploaded');
                    console.log('üìä Valid images (filtered data URLs):', validHinhAnh);
                    console.log('üì∏ Main image (link_avatar/link_anh_dai_dien):', link_anh_dai_dien);

                    // B∆Ø·ªöC 5: C·∫≠p nh·∫≠t MongoDB v√† SQL v·ªõi links ·∫£nh/video
                    console.log('üìù Step 5: Updating database with media links...');
                    
                    // Lu√¥n c·∫≠p nh·∫≠t MongoDB v·ªõi hinh_anh array v√† link_avatar
                    const mediaUpdateData = {
                        hinh_anh: validHinhAnh.length > 0 ? validHinhAnh : [],
                        link_avatar: link_anh_dai_dien  // ·∫¢nh ƒë·∫ßu ti√™n ho·∫∑c null
                    };
                    
                    if (videoUrls.length > 0) {
                        mediaUpdateData.videos = videoUrls;
                    }
                    
                    // Update variants trong MongoDB v·ªõi link_anh m·ªõi nh·∫•t
                    if (updatedVariantsData) {
                        mediaUpdateData.variants = updatedVariantsData;
                    }

                    if (mongoDetailId) {
                        await ProductAPIService.updateProductMongoDetail(mongoDetailId, mediaUpdateData);
                        console.log('‚úÖ MongoDB updated - link_avatar:', link_anh_dai_dien);
                        console.log('‚úÖ MongoDB updated - variants with link_anh');
                    }

                    // C·∫≠p nh·∫≠t SQL products v·ªõi link_anh_dai_dien
                    await ProductAPIService.updateProduct(productId, { 
                        link_anh_dai_dien: link_anh_dai_dien  // ·∫¢nh ƒë·∫ßu ti√™n ho·∫∑c null
                    });
                    console.log('‚úÖ SQL products updated - link_anh_dai_dien:', link_anh_dai_dien);
                    
                    // C·∫≠p nh·∫≠t anh_dai_dien trong SQL product_variants t·ª´ link_anh c·ªßa variant
                    if (updatedVariantsData?.variant_combinations) {
                        console.log('üìù Updating anh_dai_dien in SQL product_variants...');
                        for (const combo of updatedVariantsData.variant_combinations) {
                            if (combo.sql_variant_id) {
                                const anhDaiDien = combo.image || null;
                                try {
                                    await ProductAPIService.updateVariant(combo.sql_variant_id, { 
                                        anh_dai_dien: anhDaiDien 
                                    });
                                    console.log(`‚úÖ Updated variant ${combo.sql_variant_id} - anh_dai_dien:`, anhDaiDien);
                                } catch (error) {
                                    console.error(`‚ùå Error updating variant ${combo.sql_variant_id}:`, error);
                                }
                            }
                        }
                    }
                    
                    // C·∫≠p nh·∫≠t inventory cho t·ª´ng variant
                    if (updatedVariantsData?.variant_combinations) {
                        console.log('üìù Updating inventory for variants...');
                        for (const combo of updatedVariantsData.variant_combinations) {
                            if (combo.sql_variant_id) {
                                try {
                                    // T·∫°o ho·∫∑c update inventory record
                                    const inventoryData = {
                                        bien_the_san_pham_id: combo.sql_variant_id,
                                        so_luong_ton_kho: parseInt(combo.stock) || 0,
                                        so_luong_da_ban: 0, // Gi·ªØ nguy√™n ho·∫∑c l·∫•y t·ª´ DB n·∫øu ƒë√£ c√≥
                                        ngay_cap_nhat: new Date()
                                    };
                                    
                                    await ProductAPIService.upsertInventory(inventoryData);
                                    console.log(`‚úÖ Updated inventory for variant ${combo.sql_variant_id} - stock: ${combo.stock}`);
                                } catch (error) {
                                    console.error(`‚ùå Error updating inventory for variant ${combo.sql_variant_id}:`, error);
                                }
                            }
                        }
                    }
                    
                    console.log('‚úÖ Step 5 complete: Database updated with media links');

                } else {
                    // ========== TH√äM S·∫¢N PH·∫®M M·ªöI ==========
                    
                    // T√≠nh gi√° t·ª´ variants
                    const calculatedPrices = this.calculateProductPriceFromVariants(variantsFormData);
                    productData.gia_ban = calculatedPrices.gia_ban;
                    productData.gia_niem_yet = calculatedPrices.gia_niem_yet;
                    
                    // B∆Ø·ªöC 1: T·∫°o product trong b·∫£ng products (KH√îNG C√ì link_anh_dai_dien v√† mongo_detail_id)
                    console.log('üìù Step 1: Creating product in products table...');
                    const createProductData = { ...productData };
                    delete createProductData.link_anh_dai_dien;
                    delete createProductData.mongo_detail_id;
                    
                    const result = await ProductAPIService.createProduct(createProductData);
                    
                    if (!result.success || !result.data || !result.data.id) {
                        throw new Error('Kh√¥ng th·ªÉ t·∫°o s·∫£n ph·∫©m trong b·∫£ng products');
                    }
                    
                    productId = result.data.id;
                    console.log('‚úÖ Step 1 complete: Product created with ID:', productId);
                    
                    // B∆Ø·ªöC 2: T·∫°o variants trong b·∫£ng product_variants v√† l∆∞u sql_variant_id
                    console.log('üìù Step 2: Creating variants in product_variants table...');
                    if (variantsFormData.length > 0) {
                        for (let i = 0; i < variantsFormData.length; i++) {
                            const variantData = variantsFormData[i];
                            try {
                                const result = await ProductAPIService.createVariant(productId, variantData);
                                const sqlVariantId = result.data.id; // L·∫•y id t·ª´ SQL
                                console.log('‚úÖ Variant created in SQL:', variantData.ma_sku, 'ID:', sqlVariantId);
                                
                                // L∆∞u sql_variant_id v√†o combination t∆∞∆°ng ·ª©ng trong productVariantsManager
                                const combo = window.productVariantsManager.combinations.find(c => 
                                    c.sku === variantData.ma_sku && c.vung === variantData.site_origin
                                );
                                if (combo) {
                                    combo.sql_variant_id = sqlVariantId;
                                    console.log('‚úÖ Saved sql_variant_id to combo:', combo.sku, 'ID:', sqlVariantId);
                                }
                                
                                // C·∫≠p nh·∫≠t v√†o variantsManagerData ƒë·ªÉ l∆∞u v√†o MongoDB
                                if (variantsManagerData.variant_combinations) {
                                    const comboInData = variantsManagerData.variant_combinations.find(c => 
                                        c.sku === variantData.ma_sku && c.vung === variantData.site_origin
                                    );
                                    if (comboInData) {
                                        comboInData.sql_variant_id = sqlVariantId;
                                        console.log('‚úÖ Saved sql_variant_id to MongoDB data:', comboInData.sku, 'ID:', sqlVariantId);
                                    }
                                }
                            } catch (error) {
                                console.error('‚ùå Error creating variant:', error);
                            }
                        }
                    }
                    console.log('‚úÖ Step 2 complete: Variants created with SQL IDs');
                    
                    // B∆Ø·ªöC 3: T·∫°o MongoDB document (ch∆∞a c√≥ ·∫£nh/video)
                    console.log('üìù Step 3: Creating MongoDB document (without media)...');
                    const mongoData = {
                        sql_product_id: productId,
                        thong_so_ky_thuat: specsData,
                        thong_tin_khac: additionalInfoData,
                        video_links: videoLinksData,
                        mo_ta_chi_tiet: document.getElementById('productDescription')?.value.trim() || '',
                        trang_thai: parseInt(document.getElementById('productStatus')?.value || 1),
                        san_pham_noi_bat: document.getElementById('productFeatured')?.checked || false,
                        slug: Utils.generateSlug(productData.ten_san_pham)
                    };
                    
                    const mongoResult = await ProductAPIService.createProductMongoDetail(
                        productId,
                        specsData,
                        mongoData.mo_ta_chi_tiet,
                        mongoData.slug,
                        [],  // hinh_anh - empty for now
                        '',  // link_avatar - empty for now
                        [],  // videos - empty for now
                        variantsManagerData,  // G·ª≠i c·∫•u tr√∫c variant_options + variant_combinations
                        videoLinksData,
                        mongoData.trang_thai,
                        mongoData.san_pham_noi_bat,
                        additionalInfoData
                    );
                    
                    if (!mongoResult.skipped) {
                        mongoDetailId = mongoResult.data._id;
                        console.log('‚úÖ Step 3 complete: MongoDB document created with _id:', mongoDetailId);
                    } else {
                        mongoDetailId = null;
                        console.log('‚ö†Ô∏è Step 3: MongoDB document creation skipped');
                    }
                    
                    // B∆Ø·ªöC 4: C·∫≠p nh·∫≠t product v·ªõi mongo_detail_id
                    console.log('üìù Step 4: Updating product with MongoDB reference...');
                    if (mongoDetailId) {
                        await ProductAPIService.updateProduct(productId, { mongo_detail_id: mongoDetailId });
                        console.log('‚úÖ Step 4 complete: Product updated with MongoDB reference');
                    }
                    
                    // B∆Ø·ªöC 5: Upload ·∫£nh/video (b∆∞·ªõc cu·ªëi c√πng)
                    console.log('üìù Step 5: Uploading media (final step)...');
                    let hinhAnhArray = [];
                    let videoUrls = [];
                    let updatedVariantsData = null; // Khai b√°o ·ªü ƒë√¢y ƒë·ªÉ d√πng sau

                    // Upload variant images and update SQL + MongoDB
                    if (window.productVariantsManager && window.productVariantsManager.combinations) {
                        console.log('üñºÔ∏è Uploading variant images...');
                        for (const combo of window.productVariantsManager.combinations) {
                            if (combo.imageFile && combo.sql_variant_id) {
                                try {
                                    console.log(`üì§ Uploading image for variant ${combo.sku}...`);
                                    const uploadedUrl = await window.simpleImageUploadManager.uploadSingleImage(combo.imageFile);
                                    combo.image = uploadedUrl; // Replace data URL with Cloudinary URL
                                    delete combo.imageFile; // Remove file object
                                    console.log(`‚úÖ Variant image uploaded: ${uploadedUrl}`);
                                    
                                    // Update anh_dai_dien trong product_variants (SQL) b·∫±ng sql_variant_id
                                    try {
                                        await ProductAPIService.updateVariant(combo.sql_variant_id, { anh_dai_dien: uploadedUrl });
                                        console.log(`‚úÖ Updated variant ID ${combo.sql_variant_id} with image in SQL`);
                                    } catch (error) {
                                        console.error(`‚ùå Error updating variant ${combo.sql_variant_id} in SQL:`, error);
                                    }
                                } catch (error) {
                                    console.error(`‚ùå Error uploading variant image for ${combo.sku}:`, error);
                                }
                            }
                        }
                        
                        // Update MongoDB v·ªõi link_anh v√† sql_variant_id
                        updatedVariantsData = window.productVariantsManager.getVariantsData();
                        if (mongoDetailId && updatedVariantsData) {
                            try {
                                await ProductAPIService.updateProductMongoDetail(mongoDetailId, {
                                    variants: updatedVariantsData
                                });
                                console.log('‚úÖ Updated MongoDB with variant image links and SQL IDs');
                            } catch (error) {
                                console.error('‚ùå Error updating MongoDB:', error);
                            }
                        }
                    }

                    if (window.simpleImageUploadManager && window.simpleImageUploadManager.productImages.length > 0) {
                        try {
                            const uploadResult = await window.simpleImageUploadManager.uploadProductImages();
                            
                            if (uploadResult.mainImageUrl && !hinhAnhArray.includes(uploadResult.mainImageUrl)) {
                                hinhAnhArray.push(uploadResult.mainImageUrl);
                            }
                            if (uploadResult.additionalImages && uploadResult.additionalImages.length > 0) {
                                uploadResult.additionalImages.forEach(imgUrl => {
                                    if (!hinhAnhArray.includes(imgUrl)) {
                                        hinhAnhArray.push(imgUrl);
                                    }
                                });
                            }
                        } catch (uploadError) {
                            console.error('‚ùå L·ªói upload ·∫£nh:', uploadError);
                        }
                    }
                    
                    // Thu th·∫≠p t·∫•t c·∫£ ·∫£nh t·ª´ variants ƒë√£ upload (ki·ªÉm tra duplicate)
                    if (updatedVariantsData?.variant_combinations) {
                        updatedVariantsData.variant_combinations.forEach(combo => {
                            if (combo.image && !hinhAnhArray.includes(combo.image)) {
                                hinhAnhArray.push(combo.image);
                                console.log('‚úÖ Added variant image to hinh_anh:', combo.image);
                            }
                        });
                    }

                    if (window.simpleImageUploadManager && window.simpleImageUploadManager.productVideos.length > 0) {
                        try {
                            videoUrls = await window.simpleImageUploadManager.uploadProductVideos();
                        } catch (uploadError) {
                            console.error('‚ùå L·ªói upload video:', uploadError);
                        }
                    }
                    
                    // Filter data URLs kh·ªèi hinhAnhArray tr∆∞·ªõc khi l∆∞u
                    const validHinhAnh = hinhAnhArray.filter(url => url && !url.startsWith('data:'));
                    // link_avatar v√† link_anh_dai_dien lu√¥n l·∫•y ·∫£nh ƒë·∫ßu ti√™n t·ª´ hinh_anh array
                    const link_anh_dai_dien = validHinhAnh.length > 0 ? validHinhAnh[0] : null;
                    console.log('‚úÖ Step 5 complete: Media uploaded');
                    console.log('üìä Valid images (filtered data URLs):', validHinhAnh);
                    console.log('üì∏ Main image (link_avatar/link_anh_dai_dien):', link_anh_dai_dien);
                    
                    // B∆Ø·ªöC 6: C·∫≠p nh·∫≠t MongoDB v√† SQL v·ªõi links ·∫£nh/video
                    console.log('üìù Step 6: Updating database with media links...');
                    
                    // Lu√¥n c·∫≠p nh·∫≠t MongoDB v·ªõi hinh_anh array v√† link_avatar
                    const mediaUpdateData = {
                        hinh_anh: validHinhAnh.length > 0 ? validHinhAnh : [],
                        link_avatar: link_anh_dai_dien  // ·∫¢nh ƒë·∫ßu ti√™n ho·∫∑c null
                    };
                    
                    if (videoUrls.length > 0) {
                        mediaUpdateData.videos = videoUrls;
                    }
                    
                    // Update variants trong MongoDB v·ªõi link_anh m·ªõi nh·∫•t
                    if (updatedVariantsData) {
                        mediaUpdateData.variants = updatedVariantsData;
                    }

                    if (mongoDetailId) {
                        await ProductAPIService.updateProductMongoDetail(mongoDetailId, mediaUpdateData);
                        console.log('‚úÖ MongoDB updated - link_avatar:', link_anh_dai_dien);
                        console.log('‚úÖ MongoDB updated - variants with link_anh');
                    }

                    // C·∫≠p nh·∫≠t SQL products v·ªõi link_anh_dai_dien
                    await ProductAPIService.updateProduct(productId, { 
                        link_anh_dai_dien: link_anh_dai_dien  // ·∫¢nh ƒë·∫ßu ti√™n ho·∫∑c null
                    });
                    console.log('‚úÖ SQL products updated - link_anh_dai_dien:', link_anh_dai_dien);
                    
                    // C·∫≠p nh·∫≠t anh_dai_dien trong SQL product_variants t·ª´ link_anh c·ªßa variant
                    if (updatedVariantsData?.variant_combinations) {
                        console.log('üìù Updating anh_dai_dien in SQL product_variants...');
                        for (const combo of updatedVariantsData.variant_combinations) {
                            if (combo.sql_variant_id) {
                                const anhDaiDien = combo.image || null;
                                try {
                                    await ProductAPIService.updateVariant(combo.sql_variant_id, { 
                                        anh_dai_dien: anhDaiDien 
                                    });
                                    console.log(`‚úÖ Updated variant ${combo.sql_variant_id} - anh_dai_dien:`, anhDaiDien);
                                } catch (error) {
                                    console.error(`‚ùå Error updating variant ${combo.sql_variant_id}:`, error);
                                }
                            }
                        }
                    }
                    
                    // C·∫≠p nh·∫≠t inventory cho t·ª´ng variant (Create flow)
                    if (updatedVariantsData?.variant_combinations) {
                        console.log('üìù Updating inventory for variants (Create)...');
                        for (const combo of updatedVariantsData.variant_combinations) {
                            if (combo.sql_variant_id) {
                                try {
                                    const inventoryData = {
                                        bien_the_san_pham_id: combo.sql_variant_id,
                                        so_luong_ton_kho: parseInt(combo.stock) || 0,
                                        ngay_cap_nhat: new Date()
                                    };
                                    
                                    await ProductAPIService.upsertInventory(inventoryData);
                                    console.log(`‚úÖ Updated inventory for variant ${combo.sql_variant_id} - stock: ${combo.stock}`);
                                } catch (error) {
                                    console.error(`‚ùå Error updating inventory for variant ${combo.sql_variant_id}:`, error);
                                }
                            }
                        }
                    }
                    
                    console.log('‚úÖ Step 6 complete: Database updated with media links');
                }

                // HI·ªÇN TH·ªä TH√îNG B√ÅO V√Ä ƒê√ìNG MODAL
                console.log('üéâ All steps completed successfully!');
                this.showSuccess(this.currentEditId ? 'C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng' : 'Th√™m s·∫£n ph·∫©m th√†nh c√¥ng');

                bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
                await this.refreshProducts();

            } catch (error) {
                console.error('‚ùå Error saving product:', error);
                this.showError('Kh√¥ng th·ªÉ l∆∞u s·∫£n ph·∫©m: ' + error.message);
            } finally {
                this.isSaving = false;  
                const saveBtn = document.getElementById('saveProductBtn');
                if (saveBtn) {
                    saveBtn.innerHTML = this.currentEditId ? 
                        '<i class="fas fa-save"></i> C·∫≠p nh·∫≠t s·∫£n ph·∫©m' : 
                        '<i class="fas fa-save"></i> Th√™m s·∫£n ph·∫©m';
                    saveBtn.disabled = false;
                }
            }
        }


        getProductFormData() {
            console.log('üîç DEBUG: Getting product form data...');
            
            // Debug: Ki·ªÉm tra t·ª´ng element
            const productNameEl = document.getElementById('productName');
            const productCategoryEl = document.getElementById('productCategory');
            const productBrandEl = document.getElementById('productBrand');
            const productDescriptionEl = document.getElementById('productDescription');
            const productStatusEl = document.getElementById('productStatus');
            const productSiteOriginEl = document.getElementById('productSiteOrigin');
            
            console.log('üîç Elements check:', {
                productNameEl: !!productNameEl,
                productCategoryEl: !!productCategoryEl,
                productBrandEl: !!productBrandEl,
                productDescriptionEl: !!productDescriptionEl,
                productStatusEl: !!productStatusEl,
                productSiteOriginEl: !!productSiteOriginEl
            });
            
            const productName = productNameEl?.value?.trim() || '';
            
            // T·ª± ƒë·ªông t·∫°o m√£ s·∫£n ph·∫©m
            let ma_san_pham = 'SP' + Date.now();

            // Ch·ªâ l·∫•y c√°c tr∆∞·ªùng c·ªßa b·∫£ng products (KH√îNG C√ì ma_sku, gia_ban, gia_niem_yet)
            const formData = {
                ma_san_pham: ma_san_pham,
                ten_san_pham: productName,
                danh_muc_id: productCategoryEl?.value || '',
                thuong_hieu_id: productBrandEl?.value || '',
                mo_ta_ngan: productDescriptionEl?.value?.trim() || '',
                trang_thai: parseInt(productStatusEl?.value || '1'),
                site_created: productSiteOriginEl?.value || 'bac'
            };

            // N·∫øu ƒëang edit, th√™m id
            if (this.currentEditId) {
                formData.id = this.currentEditId;
            }

            console.log('üì¶ Product Form Data (ch·ªâ d√†nh cho b·∫£ng products):', formData);
            return formData;
        }

        // H√†m m·ªõi: L·∫•y d·ªØ li·ªáu variants ƒë·ªÉ l∆∞u v√†o product_variants table
        getVariantsFormData() {
            const variantsData = [];
            
            // L·∫•y t√™n s·∫£n ph·∫©m
            const productName = document.getElementById('productName')?.value?.trim() || '';
            
            // L·∫•y d·ªØ li·ªáu t·ª´ variant manager n·∫øu c√≥
            if (window.productVariantsManager) {
                const variantsManagerData = window.productVariantsManager.getVariantsData();
                
                console.log('üîç DEBUG getVariantsFormData - variantsManagerData:', JSON.stringify(variantsManagerData, null, 2));
                
                // variantsManagerData b√¢y gi·ªù c√≥ c·∫•u tr√∫c: { variant_options: [...], variant_combinations: [...] }
                // C·∫ßn flatten t·∫•t c·∫£ combinations th√†nh format cho product_variants table
                
                if (variantsManagerData.variant_combinations && Array.isArray(variantsManagerData.variant_combinations)) {
                    console.log('‚úÖ Found variant_combinations (flat array), processing...');
                    variantsManagerData.variant_combinations.forEach((combo, index) => {
                        console.log(`üì¶ [${index}] Processing combination:`, combo);
                        // ∆Øu ti√™n ·∫£nh ƒë√£ upload (combo.image) > link_anh t·ª´ MongoDB > null
                        const anhDaiDien = combo.image || combo.link_anh || null;
                        
                        // combo.name ƒë√£ c√≥ t√™n s·∫£n ph·∫©m t·ª´ getVariantsData()
                        variantsData.push({
                            ma_sku: combo.sku || 'SKU' + Date.now(),
                            ten_hien_thi: combo.name,  // ƒê√£ c√≥ t√™n s·∫£n ph·∫©m r·ªìi
                            gia_niem_yet: parseInt(combo.original_price || combo.price || 0),
                            gia_ban: parseInt(combo.price) || 0,
                            so_luong_ton_kho: parseInt(combo.stock) || 0,
                            luot_ban: 0,  // M·∫∑c ƒë·ªãnh 0 khi t·∫°o m·ªõi
                            anh_dai_dien: anhDaiDien,  // L·∫•y t·ª´ image ho·∫∑c link_anh
                            site_origin: combo.vung || 'bac',  // L·∫•y t·ª´ field vung
                            trang_thai: combo.active !== undefined ? (combo.active ? 1 : 0) : 1,
                            attributes: combo.attributes || {}
                        });
                    });
                } else if (variantsManagerData.regional_variants && typeof variantsManagerData.regional_variants === 'object') {
                    console.log('‚úÖ Found regional_variants (old structure), processing...');
                    // Duy·ªát qua t·∫•t c·∫£ c√°c v√πng (fallback cho c·∫•u tr√∫c c≈©)
                    Object.keys(variantsManagerData.regional_variants).forEach(region => {
                        const regionData = variantsManagerData.regional_variants[region];
                        console.log(`üó∫Ô∏è Processing region ${region}:`, regionData);
                        if (regionData.variant_combinations && Array.isArray(regionData.variant_combinations)) {
                            console.log(`üì¶ Found ${regionData.variant_combinations.length} combinations in region ${region}`);
                            regionData.variant_combinations.forEach(combo => {
                                // ∆Øu ti√™n ·∫£nh ƒë√£ upload (combo.image) > link_anh t·ª´ MongoDB > null
                                const anhDaiDien = combo.image || combo.link_anh || null;
                                
                                // combo.name ƒë√£ c√≥ t√™n s·∫£n ph·∫©m t·ª´ getVariantsData()
                                // N√™n d√πng tr·ª±c ti·∫øp
                                variantsData.push({
                                    ma_sku: combo.sku || 'SKU' + Date.now(),
                                    ten_hien_thi: combo.name,  // ƒê√£ c√≥ t√™n s·∫£n ph·∫©m r·ªìi
                                    gia_niem_yet: parseInt(combo.original_price || combo.price || 0),
                                    gia_ban: parseInt(combo.price) || 0,
                                    so_luong_ton_kho: parseInt(combo.stock) || 0,
                                    luot_ban: 0,  // M·∫∑c ƒë·ªãnh 0 khi t·∫°o m·ªõi
                                    anh_dai_dien: anhDaiDien,  // L·∫•y t·ª´ image ho·∫∑c link_anh
                                    site_origin: region,  // L·∫•y t·ª´ key c·ªßa regional_variants
                                    trang_thai: combo.active !== undefined ? (combo.active ? 1 : 0) : 1,
                                    attributes: combo.attributes || {}
                                });
                            });
                        }
                    });
                } else if (variantsManagerData.variant_combinations && Array.isArray(variantsManagerData.variant_combinations)) {
                    // Fallback: C·∫•u tr√∫c c≈© {variant_options, variant_combinations}
                    variantsManagerData.variant_combinations.forEach(combo => {
                        let variantName = combo.name || '';
                        
                        // N·∫øu combo.name ƒë√£ c√≥ t√™n s·∫£n ph·∫©m (t·ª´ getVariantsData), l·∫•y l·∫°i t√™n g·ªëc
                        if (productName && variantName.startsWith(productName)) {
                            variantName = variantName.substring(productName.length).trim();
                        }
                        
                        // T·∫°o t√™n hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß
                        const ten_hien_thi = productName ? `${productName} ${variantName}` : variantName;
                        
                        variantsData.push({
                            ma_sku: combo.sku || 'SKU' + Date.now(),
                            ten_hien_thi: ten_hien_thi,
                            gia_niem_yet: parseInt(combo.original_price || combo.price || 0),
                            gia_ban: parseInt(combo.price) || 0,
                            so_luong_ton_kho: parseInt(combo.stock) || 0,
                            luot_ban: 0,  // M·∫∑c ƒë·ªãnh 0 khi t·∫°o m·ªõi
                            anh_dai_dien: combo.link_anh || combo.image || null,  // ∆Øu ti√™n link_anh, fallback sang image
                            site_origin: combo.site_origin || 'bac',
                            trang_thai: combo.active !== undefined ? (combo.active ? 1 : 0) : 1,
                            attributes: combo.attributes || {}
                        });
                    });
                } else {
                    console.warn('‚ö†Ô∏è No variant_combinations found in old structure');
                }
            } else {
                console.warn('‚ö†Ô∏è window.productVariantsManager not found');
            }

            console.log('üì¶ Variants Form Data for product_variants table (final):', variantsData);
            console.log(`üìä Total variants to insert: ${variantsData.length}`);
            return variantsData;
        }

        // T√≠nh gi√° b√°n v√† gi√° ni√™m y·∫øt cho product t·ª´ variant c√≥ gi√° b√°n th·∫•p nh·∫•t
        calculateProductPriceFromVariants(variantsData) {
            if (!variantsData || variantsData.length === 0) {
                return { gia_ban: 0, gia_niem_yet: 0 };
            }

            // T√¨m variant c√≥ gi√° b√°n th·∫•p nh·∫•t
            const minPriceVariant = variantsData.reduce((min, variant) => {
                const variantPrice = parseInt(variant.gia_ban) || 0;
                const minPrice = parseInt(min.gia_ban) || 0;
                return variantPrice < minPrice ? variant : min;
            });

            const gia_ban = parseInt(minPriceVariant.gia_ban) || 0;
            const gia_niem_yet = parseInt(minPriceVariant.gia_niem_yet) || gia_ban;

            console.log('üí∞ Calculated prices from variants:', {
                gia_ban,
                gia_niem_yet,
                from_variant: minPriceVariant.ma_sku
            });

            return { gia_ban, gia_niem_yet };
        }
        
        
        // C·∫≠p nh·∫≠t h√†m validateProductForm cho schema m·ªõi
        validateProductForm(formData) {
            const errors = [];

            if (!formData.ten_san_pham) {
                errors.push('Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m');
            }
            if (!formData.danh_muc_id) {
                errors.push('Vui l√≤ng ch·ªçn danh m·ª•c');
            }
            if (!formData.thuong_hieu_id) {
                errors.push('Vui l√≤ng ch·ªçn th∆∞∆°ng hi·ªáu');
            }

            // Ki·ªÉm tra variants (n·∫øu c√≥ variant manager ho·∫∑c form ƒë∆°n gi·∫£n c√≥ gi√°)
            const variantsData = this.getVariantsFormData();
            if (variantsData.length === 0) {
                errors.push('Vui l√≤ng th√™m √≠t nh·∫•t 1 bi·∫øn th·ªÉ s·∫£n ph·∫©m (ho·∫∑c nh·∫≠p gi√° b√°n)');
            } else {
                // Validate t·ª´ng variant
                variantsData.forEach((variant, index) => {
                    if (!variant.gia_ban || variant.gia_ban <= 0) {
                        errors.push(`Bi·∫øn th·ªÉ ${index + 1}: Gi√° b√°n kh√¥ng h·ª£p l·ªá`);
                    }
                    if (!variant.ma_sku) {
                        errors.push(`Bi·∫øn th·ªÉ ${index + 1}: Thi·∫øu m√£ SKU`);
                    }
                });
            }

            if (errors.length > 0) {
                this.showError(errors.join('<br>'));
                return false;
            }

            return true;
        }

        // Product Actions
        handleEditProduct(button) {
            const productId = button.getAttribute('data-id');
            const product = this.products.find(p => p.id === productId);
            if (product) {
                this.openProductModal(product);
            }
        }

        async handleDeleteProduct(button) {
            const productId = button.getAttribute('data-id');
            const productName = button.getAttribute('data-name');

            const result = await Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                html: `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a <strong>${productName}</strong>?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#667eea',
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            });

            if (result.isConfirmed) {
                try {
                    await ProductAPIService.deleteProduct(productId);
                    this.showSuccess('X√≥a s·∫£n ph·∫©m th√†nh c√¥ng');
                    
                    // Refresh d·ªØ li·ªáu sau khi x√≥a
                    await this.refreshProducts();
                    
                } catch (error) {
                    this.showError('Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m: ' + error.message);
                }
            }
        }

        async handleToggleStatus(button) {
            const productId = button.getAttribute('data-id');
            const currentStatus = parseInt(button.getAttribute('data-status'));
            const productName = button.getAttribute('data-name');

            const actionText = currentStatus === 1 ? 'ng·ª´ng b√°n' : 'b√°n';

            const result = await Swal.fire({
                title: 'X√°c nh·∫≠n chuy·ªÉn tr·∫°ng th√°i?',
                html: `B·∫°n c√≥ ch·∫Øc mu·ªën ${actionText} s·∫£n ph·∫©m <strong>${productName}</strong>?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#f59e0b',
                cancelButtonColor: '#667eea',
                confirmButtonText: `ƒê·ªìng √Ω ${actionText}`,
                cancelButtonText: 'H·ªßy'
            });

            if (result.isConfirmed) {
                try {
                    await ProductAPIService.toggleProductStatus(productId, currentStatus);
                    this.showSuccess(`ƒê√£ ${actionText} s·∫£n ph·∫©m th√†nh c√¥ng`);
                    
                    // Refresh d·ªØ li·ªáu sau khi chuy·ªÉn tr·∫°ng th√°i
                    await this.refreshProducts();
                    
                } catch (error) {
                    this.showError('Kh√¥ng th·ªÉ chuy·ªÉn tr·∫°ng th√°i s·∫£n ph·∫©m: ' + error.message);
                }
            }
        }



        formatSpecKey(key) {
            return key
                .replace(/([A-Z])/g, ' $1')
                .replace(/_/g, ' ')
                .replace(/^./, str => str.toUpperCase())
                .trim();
        }

        // Notification Methods
        showSuccess(message) {
            Swal.fire({
                icon: 'success',
                title: 'Th√†nh c√¥ng!',
                text: message,
                timer: 2000,
                showConfirmButton: false
            });
        }

        showError(message) {
            Swal.fire({
                icon: 'error',
                title: 'L·ªói!',
                html: message,
                confirmButtonColor: '#667eea'
            });
        }
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function () {
        new ProductManager();
    });
    // Brand Management
    class BrandManager {
        constructor() {
            this.currentEditId = null;
            this.brands = []; // Th√™m m·∫£ng brands ƒë·ªÉ l∆∞u to√†n b·ªô d·ªØ li·ªáu
            this.currentPage = 1; // Trang hi·ªán t·∫°i
            this.itemsPerPage = 6; // S·ªë item m·ªói trang
            this.totalPages = 0; // T·ªïng s·ªë trang
            this.searchKeyword = ''; // Th√™m bi·∫øn l∆∞u t·ª´ kh√≥a t√¨m ki·∫øm
            this.simpleImageUpload = null; // Th√™m reference
            this.bindEvents();
        }

        bindEvents() {
            // M·ªü modal th∆∞∆°ng hi·ªáu
            document.getElementById('manageBrandsBtn')?.addEventListener('click', () => {
                this.openBrandModal();
            });

            // L∆∞u th∆∞∆°ng hi·ªáu
            document.getElementById('saveBrandBtn')?.addEventListener('click', () => {
                this.saveBrand();
            });

            // Event delegation cho c√°c n√∫t trong b·∫£ng
            document.addEventListener('click', (e) => {
                if (e.target.closest('.btn-edit-brand')) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.handleEditBrand(e.target.closest('.btn-edit-brand'));
                }
                if (e.target.closest('.btn-delete-brand')) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.handleDeleteBrand(e.target.closest('.btn-delete-brand'));
                }
            });

            document.getElementById('brandsPrevPage')?.addEventListener('click', () => {
                this.goToPage(this.currentPage - 1);
            });

            document.getElementById('brandsNextPage')?.addEventListener('click', () => {
                this.goToPage(this.currentPage + 1);
            });

            document.getElementById('brandSearch')?.addEventListener('input',
                Utils.debounce((e) => {
                    this.searchBrands(e.target.value);
                }, 300)
            );

            // Auto refresh khi ƒë√≥ng modal
            const brandModal = document.getElementById('brandModal');
            if (brandModal) {
                brandModal.addEventListener('hidden.bs.modal', async () => {
                    // Refresh dropdown th∆∞∆°ng hi·ªáu trong product form
                    await this.refreshBrandDropdown();
                    // Refresh filter dropdown
                    await this.refreshBrandFilterDropdown();
                });
            }

            document.getElementById('refreshBrandsBtn')?.addEventListener('click', () => {
                this.refreshBrands();
            });
        }

        async refreshBrands() {
            try {
                // Hi·ªÉn th·ªã tr·∫°ng th√°i loading
                const refreshBtn = document.getElementById('refreshBrandsBtn');
                if (refreshBtn) {
                    const originalHtml = refreshBtn.innerHTML;
                    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    refreshBtn.disabled = true;


                    this.currentPage = 1;
                    this.searchKeyword = ''; // Reset t·ª´ kh√≥a t√¨m ki·∫øm
                    await this.loadBrands();

                    // Reset √¥ t√¨m ki·∫øm
                    const searchInput = document.getElementById('brandSearch');
                    if (searchInput) {
                        searchInput.value = '';
                    }

                    // Kh√¥i ph·ª•c tr·∫°ng th√°i ban ƒë·∫ßu sau 500ms
                    setTimeout(() => {
                        refreshBtn.innerHTML = originalHtml;
                        refreshBtn.disabled = false;
                    }, 500);
                } else {
                    await this.loadBrands();
                    this.currentPage = 1;
                    this.searchKeyword = '';

                    const searchInput = document.getElementById('brandSearch');
                    if (searchInput) {
                        searchInput.value = '';
                    }
                }
            } catch (error) {
                console.error('L·ªói khi l√†m m·ªõi danh s√°ch th∆∞∆°ng hi·ªáu:', error);
                this.showError('Kh√¥ng th·ªÉ l√†m m·ªõi danh s√°ch th∆∞∆°ng hi·ªáu');
            }
        }

        async refreshBrandDropdown() {
            try {
                const response = await fetch('/api/thuonghieu');
                const data = await response.json();
                
                if (data && Array.isArray(data)) {
                    const brandSelect = document.getElementById('productBrand');
                    if (brandSelect) {
                        const currentValue = brandSelect.value;
                        brandSelect.innerHTML = '<option value="">Ch·ªçn th∆∞∆°ng hi·ªáu</option>';
                        
                        data.forEach(brand => {
                            const option = document.createElement('option');
                            option.value = brand.id;
                            option.textContent = brand.ten_thuong_hieu;
                            if (brand.id == currentValue) {
                                option.selected = true;
                            }
                            brandSelect.appendChild(option);
                        });
                        
                        console.log('‚úÖ Refreshed brand dropdown with', data.length, 'brands');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error refreshing brand dropdown:', error);
            }
        }

        async refreshBrandFilterDropdown() {
            try {
                const response = await fetch('/api/thuonghieu');
                const data = await response.json();
                
                if (data && Array.isArray(data)) {
                    const brandFilter = document.getElementById('brandFilter');
                    if (brandFilter) {
                        const currentValue = brandFilter.value;
                        brandFilter.innerHTML = '<option value="">T·∫•t c·∫£ th∆∞∆°ng hi·ªáu</option>';
                        
                        data.forEach(brand => {
                            const option = document.createElement('option');
                            option.value = brand.id;
                            option.textContent = brand.ten_thuong_hieu;
                            if (brand.id == currentValue) {
                                option.selected = true;
                            }
                            brandFilter.appendChild(option);
                        });
                        
                        console.log('‚úÖ Refreshed brand filter dropdown with', data.length, 'brands');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error refreshing brand filter dropdown:', error);
            }
        }


        // Th√™m v√†o class BrandManager
        setupBrandEvents() {
            // Character counter for description
            const description = document.getElementById('brandDescription');
            const charCount = document.getElementById('charCount');

            if (description && charCount) {
                description.addEventListener('input', () => {
                    const length = description.value.length;
                    charCount.textContent = length;

                    if (length > 450) {
                        charCount.classList.add('char-count-warning');
                    } else {
                        charCount.classList.remove('char-count-warning');
                    }

                    if (length > 500) {
                        charCount.classList.add('char-count-error');
                    } else {
                        charCount.classList.remove('char-count-error');
                    }
                });
            }

            // Auto-generate slug from brand name
            const brandName = document.getElementById('brandName');
            const brandSlug = document.getElementById('brandSlug');

            if (brandName && brandSlug) {
                brandName.addEventListener('input', Utils.debounce(() => {
                    const slug = Utils.generateSlug(brandName.value);
                    brandSlug.value = slug;
                }, 300));
            }

            // Logo preview
            const logoInput = document.getElementById('brandLogo');
            const previewBtn = document.getElementById('previewLogoBtn');
            const logoPreview = document.getElementById('logoPreview');

            if (logoInput && previewBtn && logoPreview) {
                logoInput.addEventListener('input', Utils.debounce(() => {
                    this.updateLogoPreview(logoInput.value);
                }, 500));

                previewBtn.addEventListener('click', () => {
                    this.updateLogoPreview(logoInput.value);
                });
            }

            // Reset form
            document.getElementById('resetBrandForm')?.addEventListener('click', () => {
                this.resetBrandForm();
            });
        }

        updateLogoPreview(logoUrl) {
            const previewElement = document.getElementById('logoPreview');
            if (!previewElement) return;

            previewElement.innerHTML = '';

            if (logoUrl && logoUrl.trim() !== '') {
                Utils.validateImageUrl(logoUrl).then(isValid => {
                    if (isValid) {
                        const img = document.createElement('img');
                        img.src = logoUrl;
                        img.alt = 'Brand Logo Preview';
                        img.onload = () => {
                            previewElement.appendChild(img);
                            previewElement.parentElement.classList.add('has-logo');
                        };                 
                    } else {
                        this.showLogoError(previewElement);
                    }
                });
            } else {
                this.showLogoPlaceholder(previewElement);
            }
        }

        showLogoPlaceholder(previewElement) {
            previewElement.innerHTML = `
            <div class="preview-placeholder">
                <i class="fas fa-image"></i>
                <span>Logo s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y</span>
            </div>
        `;
            previewElement.parentElement.classList.remove('has-logo');
        }

        showLogoError(previewElement) {
            previewElement.innerHTML = `
            <div class="preview-placeholder">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Kh√¥ng th·ªÉ t·∫£i logo</span>
            </div>
        `;
            previewElement.parentElement.classList.remove('has-logo');
        }

        async openBrandModal(brand = null) {
            this.currentEditId = brand ? brand.id : null;
            this.searchKeyword = '';

            const modalElement = document.getElementById('brandModal');
            const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);

            // Kh·ªüi t·∫°o image upload manager n·∫øu ch∆∞a c√≥
            // Use the shared global image upload manager instance to avoid duplicate instances
            if (!this.simpleImageUpload) {
                if (window && window.simpleImageUploadManager) {
                    this.simpleImageUpload = window.simpleImageUploadManager;
                } else {
                    this.simpleImageUpload = new SimpleImageUploadManager();
                    // expose globally so other parts reuse the same instance
                    window.simpleImageUploadManager = this.simpleImageUpload;
                }
            }

            // Reset search
            const searchInput = document.getElementById('brandSearch');
            if (searchInput) {
                searchInput.value = '';
            }

            this.updateFormUI();

            if (brand) {
                this.fillBrandForm(brand);
                console.log('Form filled for editing brand:', brand.ten_thuong_hieu);
                
                // Load existing image for edit mode
                if (brand.logo_url) {
                    this.simpleImageUpload.loadBrandImageForEdit(brand.logo_url);
                }
            } else {
                this.resetBrandForm();
                if (!modalElement.classList.contains('show')) {
                    modal.show();
                }
            }

            this.setupBrandEvents();
            await this.loadBrands();
        }

        // Ph∆∞∆°ng th·ª©c m·ªõi ƒë·ªÉ c·∫≠p nh·∫≠t UI form
        updateFormUI() {
            const title = document.getElementById('brandFormTitle');
            const saveText = document.getElementById('saveBrandText');
            const saveBtn = document.getElementById('saveBrandBtn');

            if (this.currentEditId) {
                if (title) title.textContent = 'Ch·ªânh s·ª≠a th∆∞∆°ng hi·ªáu';
                if (saveText) {
                    saveText.textContent = 'C·∫≠p nh·∫≠t th∆∞∆°ng hi·ªáu';
                } else if (saveBtn) {
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> C·∫≠p nh·∫≠t th∆∞∆°ng hi·ªáu';
                }
            } else {
                if (title) title.textContent = 'Th√™m th∆∞∆°ng hi·ªáu m·ªõi';
                if (saveText) {
                    saveText.textContent = 'Th√™m th∆∞∆°ng hi·ªáu';
                } else if (saveBtn) {
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Th√™m th∆∞∆°ng hi·ªáu';
                }
            }
        }

        // Ph∆∞∆°ng th·ª©c fillBrandForm ch·ªâ ƒëi·ªÅn d·ªØ li·ªáu, kh√¥ng thay ƒë·ªïi UI
        fillBrandForm(brand) {
            console.log('Filling brand form with data:', brand);

            document.getElementById('brandId').value = brand.id || '';
            document.getElementById('brandName').value = brand.ten_thuong_hieu || '';
            document.getElementById('brandLogo').value = brand.logo_url || '';
            document.getElementById('brandDescription').value = brand.mo_ta || '';
            {{!-- document.getElementById('brandStatus').value = brand.trang_thai || '1'; --}}

            const statusValue = brand.trang_thai === true ? '1' : 
                       brand.trang_thai === false ? '0' : 
                       (brand.trang_thai || '1').toString();
            document.getElementById('brandStatus').value = statusValue;


            // C·∫≠p nh·∫≠t logo preview n·∫øu c√≥
            this.updateLogoPreview(brand.logo_url);

            // C·∫≠p nh·∫≠t character count
            const description = document.getElementById('brandDescription');
            const charCount = document.getElementById('charCount');
            if (charCount && description) {
                charCount.textContent = description.value.length;
            }

            // C·∫≠p nh·∫≠t slug n·∫øu c√≥
            const slugInput = document.getElementById('brandSlug');
            if (slugInput) {
                slugInput.value = brand.slug || Utils.generateSlug(brand.ten_thuong_hieu);
            }
        }

        resetBrandForm() {
            this.currentEditId = null;
            const brandForm = document.getElementById('brandForm');
            if (brandForm) brandForm.reset();

            const brandIdEl = document.getElementById('brandId');
            if (brandIdEl) brandIdEl.value = '';

            const brandStatusEl = document.getElementById('brandStatus');
            if (brandStatusEl) brandStatusEl.value = '1';

            const charCountEl = document.getElementById('charCount');
            if (charCountEl) charCountEl.textContent = '0';

            if (this.simpleImageUpload) {
                this.simpleImageUpload.resetBrandImage();
            }
            this.updateFormUI(); // C·∫≠p nh·∫≠t UI v·ªÅ ch·∫ø ƒë·ªô th√™m m·ªõi
        }

        async loadBrands() {
            try {
                // Hi·ªÉn th·ªã loading state cho b·∫£ng
                const tbody = document.getElementById('brandsTableBody');
                const emptyState = document.getElementById('brandsEmptyState');
                const tableContainer = document.querySelector('.table-section-container .table-responsive');

                if (tbody && tableContainer) {
                    tbody.innerHTML = `
                    <tr class="table-loading">
                        <td colspan="5" style="text-align: center; padding: 40px;">
                            <div class="loading-spinner"></div>
                            <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
                        </td>
                    </tr>
                `;
                    emptyState.style.display = 'none';
                }

                const response = await fetch('/api/thuonghieu');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                // X·ª≠ l√Ω c·∫£ hai ƒë·ªãnh d·∫°ng response
                let brands = [];
                if (Array.isArray(result)) {
                    brands = result;
                } else if (result.data && Array.isArray(result.data)) {
                    brands = result.data;
                } else if (result.success && Array.isArray(result.data)) {
                    brands = result.data;
                } else {
                    console.warn('Unexpected API response format:', result);
                    brands = [];
                }

                this.brands = brands; // L∆∞u to√†n b·ªô brands
                this.totalPages = Math.ceil(brands.length / this.itemsPerPage);
                this.renderBrandsTable();
                this.updateBrandsTableInfo();
                this.updatePaginationControls();

            } catch (error) {
                console.error('L·ªói t·∫£i th∆∞∆°ng hi·ªáu:', error);

                const tbody = document.getElementById('brandsTableBody');
                if (tbody) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: var(--danger);">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Kh√¥ng th·ªÉ t·∫£i danh s√°ch th∆∞∆°ng hi·ªáu</p>
                            <button class="btn btn-sm btn-primary mt-2" onclick="brandManager.refreshBrands()">
                                Th·ª≠ l·∫°i
                            </button>
                        </td>
                    </tr>
                `;
                }

                this.showError('Kh√¥ng th·ªÉ t·∫£i danh s√°ch th∆∞∆°ng hi·ªáu: ' + error.message);
            }
        }

        searchBrands(keyword) {
            this.searchKeyword = keyword.toLowerCase().trim();
            this.currentPage = 1; // Reset v·ªÅ trang 1 khi t√¨m ki·∫øm
            this.renderBrandsTable();
            this.updateBrandsTableInfo();
            this.updatePaginationControls();
        }

        getCurrentPageBrands() {
            let filteredBrands = this.brands;

            // L·ªçc theo t·ª´ kh√≥a t√¨m ki·∫øm n·∫øu c√≥
            if (this.searchKeyword) {
                filteredBrands = this.brands.filter(brand =>
                    brand.ten_thuong_hieu.toLowerCase().includes(this.searchKeyword) ||
                    (brand.mo_ta && brand.mo_ta.toLowerCase().includes(this.searchKeyword)) ||
                    (brand.slug && brand.slug.toLowerCase().includes(this.searchKeyword))
                );
            }

            this.totalPages = Math.ceil(filteredBrands.length / this.itemsPerPage);

            const startIndex = (this.currentPage - 1) * this.itemsPerPage;
            const endIndex = startIndex + this.itemsPerPage;
            return filteredBrands.slice(startIndex, endIndex);
        }

        // Ph∆∞∆°ng th·ª©c c·∫≠p nh·∫≠t ƒëi·ªÅu khi·ªÉn ph√¢n trang
        updatePaginationControls() {
            const prevPageBtn = document.getElementById('brandsPrevPage');
            const nextPageBtn = document.getElementById('brandsNextPage');
            const paginationInfo = document.querySelector('#brandModal .table-pagination .pagination-info');

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t Previous
            if (prevPageBtn) {
                prevPageBtn.disabled = this.currentPage === 1;
            }

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t Next
            if (nextPageBtn) {
                nextPageBtn.disabled = this.currentPage === this.totalPages || this.totalPages === 0;
            }

            // C·∫≠p nh·∫≠t th√¥ng tin trang
            if (paginationInfo) {
                const displayTotalPages = this.totalPages === 0 ? 1 : this.totalPages;
                paginationInfo.textContent = `Trang ${this.currentPage}/${displayTotalPages}`;
            }
        }

        // Ph∆∞∆°ng th·ª©c chuy·ªÉn trang
        goToPage(page) {
            if (page < 1 || page > this.totalPages) return;

            this.currentPage = page;
            this.renderBrandsTable();
            this.updateBrandsTableInfo();
            this.updatePaginationControls();
        }

        // Th√™m ph∆∞∆°ng th·ª©c c·∫≠p nh·∫≠t th√¥ng tin b·∫£ng
        updateBrandsTableInfo() {
            const currentCount = document.getElementById('brandsCurrentCount');
            const totalCount = document.getElementById('brandsTotalCount');

            let filteredBrands = this.brands;
            if (this.searchKeyword) {
                filteredBrands = this.brands.filter(brand =>
                    brand.ten_thuong_hieu.toLowerCase().includes(this.searchKeyword) ||
                    (brand.mo_ta && brand.mo_ta.toLowerCase().includes(this.searchKeyword)) ||
                    (brand.slug && brand.slug.toLowerCase().includes(this.searchKeyword))
                );
            }

            const currentBrands = this.getCurrentPageBrands();

            if (totalCount) totalCount.textContent = filteredBrands.length;
            
            if (currentCount) {
                const startIndex = (this.currentPage - 1) * this.itemsPerPage + 1;
                const endIndex = Math.min(startIndex + currentBrands.length - 1, filteredBrands.length);
                
                if (filteredBrands.length === 0) {
                    currentCount.textContent = '0';
                } else {
                    currentCount.textContent = `${startIndex}-${endIndex}`;
                }
            }
        }

        renderBrandsTable() {
            const tbody = document.getElementById('brandsTableBody');
            const emptyState = document.getElementById('brandsEmptyState');
            const tableContainer = document.querySelector('.table-section-container .table-responsive');

            if (!tbody) return;

            tbody.innerHTML = '';

            const currentBrands = this.getCurrentPageBrands();

            if (!currentBrands || currentBrands.length === 0) {
                if (tableContainer) tableContainer.style.display = 'none';
                if (emptyState) emptyState.style.display = 'block';
                return;
            }

            if (tableContainer) tableContainer.style.display = 'block';
            if (emptyState) emptyState.style.display = 'none';

            currentBrands.forEach(brand => {
                const row = document.createElement('tr');
                row.innerHTML = `
                <td>
                    <div class="product-name">${Utils.escapeHtml(brand.ten_thuong_hieu)}</div>
                    ${brand.mo_ta ? `<div class="product-sku">${Utils.escapeHtml(brand.mo_ta)}</div>` : ''}
                </td>
                <td>
                    ${brand.logo_url ? `
                        <div class="product-table-image">
                            <img src="${brand.logo_url}" alt="${Utils.escapeHtml(brand.ten_thuong_hieu)}">
                        </div>
                    ` : '---'}
                </td>
                <td>
                    <span class="status-badge ${brand.trang_thai ? 'active' : 'inactive'}">
                        ${brand.trang_thai ? 'üü¢ K√≠ch ho·∫°t' : 'üî¥ ·∫®n'}
                    </span>
                </td>
                <td>
                    ${brand.ngay_tao ? new Date(brand.ngay_tao).toLocaleDateString('vi-VN') : '---'}
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-action btn-edit btn-edit-brand" data-id="${brand.id}" title="Ch·ªânh s·ª≠a">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-action btn-delete btn-delete-brand" data-id="${brand.id}" 
                                data-name="${Utils.escapeHtml(brand.ten_thuong_hieu)}" title="X√≥a">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
                tbody.appendChild(row);
            });
        }

        async saveBrand() {
            const saveBtn = document.getElementById('saveBrandBtn');
            const originalText = saveBtn ? saveBtn.innerHTML : null;
            try {
                const formData = this.getBrandFormData();
                console.log('Brand Data (before upload):', formData);

                if (!this.validateBrandForm(formData)) {
                    return;
                }

                // Show loading state on save button
                if (saveBtn) {
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
                    saveBtn.disabled = true;
                }

                // B∆Ø·ªöC 1: L∆ØU TH√îNG TIN TH∆Ø∆†NG HI·ªÜU (KH√îNG C√ì ·∫¢NH) ƒê·ªÇ L·∫§Y ID
                let result, brandId;
                if (this.currentEditId) {
                    // N·∫øu ƒëang edit v√† kh√¥ng c√≥ ·∫£nh m·ªõi, gi·ªØ nguy√™n URL c≈©
                    if (!(this.simpleImageUpload && this.simpleImageUpload.brandImageFile)) {
                        const currentBrand = this.brands.find(b => b.id === this.currentEditId);
                        if (currentBrand && currentBrand.logo_url) {
                            formData.logo_url = currentBrand.logo_url;
                        }
                    } else {
                        // N·∫øu c√≥ ·∫£nh m·ªõi, t·∫°m th·ªùi ƒë·ªÉ logo_url r·ªóng, s·∫Ω c·∫≠p nh·∫≠t sau khi upload
                        formData.logo_url = '';
                    }
                    result = await this.updateBrand(this.currentEditId, formData);
                    brandId = this.currentEditId;
                } else {
                    // Th√™m m·ªõi: ban ƒë·∫ßu l∆∞u kh√¥ng c√≥ ·∫£nh (logo_url r·ªóng)
                    formData.logo_url = '';
                    result = await this.createBrand(formData);
                    // L·∫•y ID c·ªßa th∆∞∆°ng hi·ªáu m·ªõi t·∫°o
                    brandId = result && result.data && result.data.id ? result.data.id : (result.id || null);
                    if (!brandId) {
                        throw new Error('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ID th∆∞∆°ng hi·ªáu sau khi t·∫°o');
                    }
                }

                // B∆Ø·ªöC 2: N·∫æU C√ì ·∫¢NH M·ªöI, UPLOAD ·∫¢NH V√Ä C·∫¨P NH·∫¨T L·∫†I TH∆Ø∆†NG HI·ªÜU
                if (this.simpleImageUpload && this.simpleImageUpload.brandImageFile && brandId) {
                    try {
                        const oldImageUrl = this.currentEditId ? 
                            this.brands.find(b => b.id === this.currentEditId)?.logo_url : null;
                        const uploadedImageUrl = await this.simpleImageUpload.uploadBrandImage(oldImageUrl);
                        if (uploadedImageUrl) {
                            // C·∫≠p nh·∫≠t th∆∞∆°ng hi·ªáu v·ªõi ·∫£nh m·ªõi
                            await this.updateBrand(brandId, { ...formData, logo_url: uploadedImageUrl });
                            console.log('‚úÖ Brand image uploaded and updated successfully:', uploadedImageUrl);
                            this.simpleImageUpload.brandImageFile = null;
                        }
                    } catch (uploadError) {
                        this.showError('L·ªói upload logo: ' + uploadError.message);
                        // N·∫øu upload ·∫£nh th·∫•t b·∫°i, v·∫´n hi·ªÉn th·ªã th√†nh c√¥ng nh∆∞ng c·∫£nh b√°o v·ªÅ ·∫£nh
                        this.showSuccess(this.currentEditId ? 'C·∫≠p nh·∫≠t th∆∞∆°ng hi·ªáu th√†nh c√¥ng (l·ªói upload ·∫£nh)' : 'Th√™m th∆∞∆°ng hi·ªáu th√†nh c√¥ng (l·ªói upload ·∫£nh)');
                        // Load l·∫°i d·ªØ li·ªáu v√† reset form
                        await this.loadBrands();
                        this.renderBrandsTable();
                        this.updateBrandsTableInfo();
                        this.updatePaginationControls();
                        this.resetBrandForm();
                        return;
                    }
                }

                this.showSuccess(this.currentEditId ? 'C·∫≠p nh·∫≠t th∆∞∆°ng hi·ªáu th√†nh c√¥ng' : 'Th√™m th∆∞∆°ng hi·ªáu th√†nh c√¥ng');

                // Load l·∫°i d·ªØ li·ªáu
                await this.loadBrands();
                this.renderBrandsTable();
                this.updateBrandsTableInfo();
                this.updatePaginationControls();
                this.resetBrandForm();

            } catch (error) {
                this.showError('Kh√¥ng th·ªÉ l∆∞u th∆∞∆°ng hi·ªáu: ' + error.message);
            } finally {
                // Kh√¥i ph·ª•c n√∫t
                if (saveBtn) {
                    saveBtn.innerHTML = this.currentEditId ? 
                        '<i class="fas fa-save"></i> C·∫≠p nh·∫≠t th∆∞∆°ng hi·ªáu' : 
                        '<i class="fas fa-save"></i> Th√™m th∆∞∆°ng hi·ªáu';
                    saveBtn.disabled = false;
                }
            }
        }

        getBrandFormData() {
            return {
                ten_thuong_hieu: document.getElementById('brandName').value.trim(),
                logo_url: '',
                mo_ta: document.getElementById('brandDescription').value.trim(),
                trang_thai: parseInt(document.getElementById('brandStatus').value),
                slug: Utils.generateSlug(document.getElementById('brandName').value.trim())
            };
        }

        validateBrandForm(formData) {
            if (!formData.ten_thuong_hieu) {
                this.showError('Vui l√≤ng nh·∫≠p t√™n th∆∞∆°ng hi·ªáu');
                return false;
            }
            return true;
        }

        async createBrand(brandData) {
            const response = await fetch('/api/thuonghieu', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(brandData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'L·ªói khi th√™m th∆∞∆°ng hi·ªáu');
            }

            return await response.json();
        }

        async updateBrand(id, brandData) {
            const response = await fetch(`/api/thuonghieu/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(brandData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'L·ªói khi c·∫≠p nh·∫≠t th∆∞∆°ng hi·ªáu');
            }

            return await response.json();
        }

        async handleEditBrand(button) {
            const brandId = button.getAttribute('data-id');
            this.currentEditId = brandId; // Set currentEditId tr∆∞·ªõc

            // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
            this.updateFormUI();

            // Load chi ti·∫øt th∆∞∆°ng hi·ªáu
            await this.loadBrandDetail(brandId);

            // Show modal for editing (ensure it appears)
            const modalElement = document.getElementById('brandModal');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                if (!modalElement.classList.contains('show')) {
                    modal.show();
                }
            }
        }

        async loadBrandDetail(brandId) {
            try {
                console.log('Loading brand details for ID:', brandId);
                const response = await fetch(`/api/thuonghieu/${brandId}`);

                if (!response.ok) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin th∆∞∆°ng hi·ªáu');
                }

                const result = await response.json();

                // Ki·ªÉm tra c·∫•u tr√∫c response
                const brand = result.data || result;
                console.log('Brand data received:', brand);

                if (!brand) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y th√¥ng tin th∆∞∆°ng hi·ªáu');
                }

                // G·ªçi ph∆∞∆°ng th·ª©c fill form
                this.fillBrandForm(brand);

            } catch (error) {
                console.error('Error loading brand detail:', error);
                this.showError('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin th∆∞∆°ng hi·ªáu: ' + error.message);
            }
        }

        async handleDeleteBrand(button) {
            const brandId = button.getAttribute('data-id');
            const brandName = button.getAttribute('data-name');

            const result = await Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                html: `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th∆∞∆°ng hi·ªáu <strong>${brandName}</strong>?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#667eea',
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            });

            if (result.isConfirmed) {
                try {
                    await fetch(`/api/thuonghieu/${brandId}`, { method: 'DELETE' });
                    this.showSuccess('X√≥a th∆∞∆°ng hi·ªáu th√†nh c√¥ng');

                    // Load l·∫°i d·ªØ li·ªáu nh∆∞ng gi·ªØ nguy√™n tr·∫°ng th√°i t√¨m ki·∫øm
                    await this.loadBrands();

                    // N·∫øu trang hi·ªán t·∫°i kh√¥ng c√≤n d·ªØ li·ªáu, quay l·∫°i trang tr∆∞·ªõc
                    const currentBrands = this.getCurrentPageBrands();
                    if (currentBrands.length === 0 && this.currentPage > 1) {
                        this.currentPage--;
                    }

                    this.renderBrandsTable();
                    this.updateBrandsTableInfo();
                    this.updatePaginationControls();

                } catch (error) {
                    this.showError('Kh√¥ng th·ªÉ x√≥a th∆∞∆°ng hi·ªáu: ' + error.message);
                }
            }
        }

        showSuccess(message) {
            Swal.fire({
                icon: 'success',
                title: 'Th√†nh c√¥ng!',
                text: message,
                timer: 2000,
                showConfirmButton: false
            });
        }

        showError(message) {
            Swal.fire({
                icon: 'error',
                title: 'L·ªói!',
                text: message,
                confirmButtonColor: '#667eea'
            });
        }
    }

    // Category Manager (T∆∞∆°ng t·ª± nh∆∞ BrandManager)
    // Category Manager
    class CategoryManager {
        constructor() {
            this.currentEditId = null;
            this.categories = [];
            this.currentPage = 1;
            this.itemsPerPage = 7;
            this.totalPages = 0;
            this.searchKeyword = '';
            // Always use the global instance
            if (!window.simpleImageUploadManager) {
                window.simpleImageUploadManager = new SimpleImageUploadManager();
            }
            this.simpleImageUpload = window.simpleImageUploadManager;
            this.bindEvents();
        }

        bindEvents() {
            // M·ªü modal danh m·ª•c
            document.getElementById('manageCategoriesBtn')?.addEventListener('click', () => {
                this.openCategoryModal();
            });

            // L∆∞u danh m·ª•c
            document.getElementById('saveCategoryBtn')?.addEventListener('click', () => {
                this.saveCategory();
            });

            // Event delegation cho c√°c n√∫t trong b·∫£ng
            document.addEventListener('click', (e) => {
                if (e.target.closest('.btn-edit-category')) {
                    e.preventDefault();
                    e.stopPropagation();
                    const button = e.target.closest('.btn-edit-category');
                    this.handleEditCategory(button);
                }
                if (e.target.closest('.btn-delete-category')) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.handleDeleteCategory(e.target.closest('.btn-delete-category'));
                }
            });

            // Ph√¢n trang
            document.getElementById('categoriesPrevPage')?.addEventListener('click', () => {
                this.goToPage(this.currentPage - 1);
            });

            document.getElementById('categoriesNextPage')?.addEventListener('click', () => {
                this.goToPage(this.currentPage + 1);
            });

            // T√¨m ki·∫øm
            document.getElementById('categorySearch')?.addEventListener('input',
                Utils.debounce((e) => {
                    this.searchCategories(e.target.value);
                }, 300)
            );

            // Auto refresh khi ƒë√≥ng modal
            const categoryModal = document.getElementById('categoryModal');
            if (categoryModal) {
                categoryModal.addEventListener('hidden.bs.modal', async () => {
                    // Refresh dropdown danh m·ª•c trong product form
                    await this.refreshCategoryDropdown();
                    // Refresh filter dropdown
                    await this.refreshCategoryFilterDropdown();
                });
            }

            // Refresh danh s√°ch
            document.getElementById('refreshCategoriesBtn')?.addEventListener('click', () => {
                this.refreshCategories();
            });
        }

        setupCategoryEvents() {
            // Character counter for description
            const description = document.getElementById('categoryDescription');
            const charCount = document.getElementById('categoryCharCount');

            if (description && charCount) {
                description.addEventListener('input', () => {
                    const length = description.value.length;
                    charCount.textContent = length;

                    if (length > 450) {
                        charCount.classList.add('char-count-warning');
                    } else {
                        charCount.classList.remove('char-count-warning');
                    }

                    if (length > 500) {
                        charCount.classList.add('char-count-error');
                    } else {
                        charCount.classList.remove('char-count-error');
                    }
                });
            }

            // Auto-generate slug from category name
            const categoryName = document.getElementById('categoryName');
            const categorySlug = document.getElementById('categorySlug');

            if (categoryName && categorySlug) {
                categoryName.addEventListener('input', Utils.debounce(() => {
                    const slug = Utils.generateSlug(categoryName.value);
                    if (categorySlug) categorySlug.value = slug;
                }, 300));
            }

            // Image preview
            const imageInput = document.getElementById('categoryImage');
            const previewBtn = document.getElementById('previewCategoryImageBtn');
            const imagePreview = document.getElementById('categoryImagePreview');

            if (imageInput && previewBtn && imagePreview) {
                imageInput.addEventListener('input', Utils.debounce(() => {
                    this.updateImagePreview(imageInput.value);
                }, 500));

                previewBtn.addEventListener('click', () => {
                    this.updateImagePreview(imageInput.value);
                });
            }

            // TH√äM S·ª∞ KI·ªÜN CHO DANH M·ª§C CHA
            const parentCategorySelect = document.getElementById('parentCategory');
            if (parentCategorySelect) {
                parentCategorySelect.addEventListener('change', (e) => {
                    this.handleParentCategoryChange(e.target.value);
                });
            }

            // Reset form
            document.getElementById('resetCategoryForm')?.addEventListener('click', () => {
                this.resetCategoryForm();
            });
        }

        // TH√äM PH∆Ø∆†NG TH·ª®C X·ª¨ L√ù KHI CH·ªåN DANH M·ª§C CHA
        handleParentCategoryChange(selectedParentId) {
            if (!selectedParentId) {
                // N·∫øu kh√¥ng ch·ªçn danh m·ª•c cha, gi·ªØ nguy√™n gi√° tr·ªã hi·ªán t·∫°i ho·∫∑c set v·ªÅ 0
                const currentOrder = document.getElementById('categoryOrder').value;
                if (!currentOrder || currentOrder === '0') {
                    document.getElementById('categoryOrder').value = '0';
                }
                return;
            }

            // T√¨m danh m·ª•c cha trong danh s√°ch
            const parentCategory = this.categories.find(cat => 
                cat.id === selectedParentId || cat.id.toString() === selectedParentId.toString()
            );

            if (parentCategory) {
                // L·∫•y th·ª© t·ª± c·ªßa danh m·ª•c cha v√† +1
                const parentOrder = parentCategory.thu_tu || 0;
                const newOrder = parentOrder + 1;
                
                document.getElementById('categoryOrder').value = newOrder;
                
                console.log(`‚úÖ T·ª± ƒë·ªông set th·ª© t·ª±: ${parentOrder} + 1 = ${newOrder}`);
            } else {
                console.warn('‚ùå Kh√¥ng t√¨m th·∫•y th√¥ng tin danh m·ª•c cha');
            }
        }

        updateImagePreview(imageUrl) {
            // Always update the external preview container (logo-preview)
            const previewElement = document.getElementById('categoryImagePreviewContainer');
            if (!previewElement) return;

            previewElement.innerHTML = '';

            if (imageUrl && imageUrl.trim() !== '') {
                Utils.validateImageUrl(imageUrl).then(isValid => {
                    if (isValid) {
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.alt = 'Category Image Preview';
                        img.style.maxWidth = '100%';
                        img.style.maxHeight = '100px';
                        img.style.objectFit = 'contain';
                        img.onload = () => {
                            previewElement.appendChild(img);
                            previewElement.parentElement.classList.add('has-logo');
                            previewElement.style.display = '';
                        };
                    } else {
                        this.showImageError(previewElement);
                    }
                });
            } else {
                this.showImagePlaceholder(previewElement);
            }
        }

        showImagePlaceholder(previewElement) {
            previewElement.innerHTML = `
                <div class="preview-placeholder">
                    <i class="fas fa-image"></i>
                    <span>·∫¢nh s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y</span>
                </div>
            `;
            previewElement.parentElement.classList.remove('has-logo');
        }

        showImageError(previewElement) {
            previewElement.innerHTML = `
                <div class="preview-placeholder">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Kh√¥ng th·ªÉ t·∫£i ·∫£nh</span>
                </div>
            `;
            previewElement.parentElement.classList.remove('has-logo');
        }

        async refreshCategories() {
            try {
                const refreshBtn = document.getElementById('refreshCategoriesBtn');
                if (refreshBtn) {
                    const originalHtml = refreshBtn.innerHTML;
                    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    refreshBtn.disabled = true;

                    this.currentPage = 1;
                    this.searchKeyword = '';
                    await this.loadCategories();

                    const searchInput = document.getElementById('categorySearch');
                    if (searchInput) {
                        searchInput.value = '';
                    }

                    setTimeout(() => {
                        refreshBtn.innerHTML = originalHtml;
                        refreshBtn.disabled = false;
                    }, 500);
                } else {
                    await this.loadCategories();
                    await this.loadParentCategories();
                    this.currentPage = 1;
                    this.searchKeyword = '';

                    const searchInput = document.getElementById('categorySearch');
                    if (searchInput) {
                        searchInput.value = '';
                    }
                }
            } catch (error) {
                console.error('L·ªói khi l√†m m·ªõi danh s√°ch danh m·ª•c:', error);
                this.showError('Kh√¥ng th·ªÉ l√†m m·ªõi danh s√°ch danh m·ª•c');
            }
        }

        async refreshCategoryDropdown() {
            try {
                const response = await fetch('/api/danhmuc');
                const data = await response.json();
                
                let categories = [];
                if (Array.isArray(data)) {
                    categories = data;
                } else if (data.data && Array.isArray(data.data)) {
                    categories = data.data;
                }
                
                if (categories.length > 0) {
                    const categorySelect = document.getElementById('productCategory');
                    if (categorySelect) {
                        const currentValue = categorySelect.value;
                        categorySelect.innerHTML = '<option value="">Ch·ªçn danh m·ª•c</option>';
                        
                        categories.forEach(category => {
                            const option = document.createElement('option');
                            option.value = category.id;
                            option.textContent = category.ten_danh_muc;
                            if (category.id == currentValue) {
                                option.selected = true;
                            }
                            categorySelect.appendChild(option);
                        });
                        
                        console.log('‚úÖ Refreshed category dropdown with', categories.length, 'categories');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error refreshing category dropdown:', error);
            }
        }

        async refreshCategoryFilterDropdown() {
            try {
                const response = await fetch('/api/danhmuc');
                const data = await response.json();
                
                let categories = [];
                if (Array.isArray(data)) {
                    categories = data;
                } else if (data.data && Array.isArray(data.data)) {
                    categories = data.data;
                }
                
                if (categories.length > 0) {
                    const categoryFilter = document.getElementById('categoryFilter');
                    if (categoryFilter) {
                        const currentValue = categoryFilter.value;
                        categoryFilter.innerHTML = '<option value="">T·∫•t c·∫£ danh m·ª•c</option>';
                        
                        categories.forEach(category => {
                            const option = document.createElement('option');
                            option.value = category.id;
                            option.textContent = category.ten_danh_muc;
                            if (category.id == currentValue) {
                                option.selected = true;
                            }
                            categoryFilter.appendChild(option);
                        });
                        
                        console.log('‚úÖ Refreshed category filter dropdown with', categories.length, 'categories');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error refreshing category filter dropdown:', error);
            }
        }

        async openCategoryModal(category = null) {
            this.currentEditId = category ? category.id : null;
            this.searchKeyword = '';

            const modalElement = document.getElementById('categoryModal');
            const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);

            // Always use the global instance
            this.simpleImageUpload = window.simpleImageUploadManager;

            // Reset search
            const searchInput = document.getElementById('categorySearch');
            if (searchInput) {
                searchInput.value = '';
            }

            // Load data tr∆∞·ªõc khi fill form
            await Promise.all([
                this.loadCategories(),
                this.loadParentCategories()
            ]);

            if (category) {
                this.fillCategoryForm(category);
                // Always update preview for edit mode
                this.updateImagePreview(category.anh_url);
                // Always force edit UI and update save button text
                this.updateFormUI(true, false);
                const saveText = document.getElementById('saveCategoryText');
                if (saveText) saveText.textContent = 'C·∫≠p nh·∫≠t danh m·ª•c';
                console.log('Form filled for editing category:', category.ten_danh_muc);
            } else {
                this.resetCategoryForm();
                if (!modalElement.classList.contains('show')) {
                    modal.show();
                }
            }

            this.setupCategoryEvents();
        }

        updateFormUI(forceEdit = false, forceAdd = false) {
            const title = document.getElementById('categoryFormTitle');
            const saveText = document.getElementById('saveCategoryText');
            
            // X√°c ƒë·ªãnh tr·∫°ng th√°i d·ª±a tr√™n currentEditId l√† ch√≠nh
            let isEdit = this.currentEditId !== null && this.currentEditId !== '';
            
            // ∆Øu ti√™n tham s·ªë force n·∫øu ƒë∆∞·ª£c truy·ªÅn
            if (forceEdit) isEdit = true;
            if (forceAdd) isEdit = false;
            
            console.log('üîÑ Updating form UI - Edit mode:', isEdit, 'Current ID:', this.currentEditId);
            
            if (title) {
                title.textContent = isEdit ? 'Ch·ªânh s·ª≠a danh m·ª•c' : 'Th√™m danh m·ª•c m·ªõi';
            }
            
            if (saveText) {
                saveText.textContent = isEdit ? 'C·∫≠p nh·∫≠t danh m·ª•c' : 'Th√™m danh m·ª•c';
            }
            
            // ƒê·∫£m b·∫£o n√∫t save c≈©ng ƒë∆∞·ª£c c·∫≠p nh·∫≠t (kh√¥ng ghi ƒë√® innerHTML n·∫øu c√≥ span)
            const saveBtn = document.getElementById('saveCategoryBtn');
            if (saveBtn) {
                const iconHtml = '<i class="fas fa-save"></i>';
                // Try to find existing span used by other code
                let span = saveBtn.querySelector('#saveCategoryText');
                const text = isEdit ? 'C·∫≠p nh·∫≠t danh m·ª•c' : 'Th√™m danh m·ª•c';

                if (span) {
                    // Update text only, keep span and any event listeners on the button
                    span.textContent = text;
                    // Ensure icon exists
                    if (!saveBtn.querySelector('i')) {
                        saveBtn.insertAdjacentHTML('afterbegin', iconHtml + ' ');
                    }
                } else {
                    // Create a consistent structure with icon + span so other code can target the span
                    saveBtn.innerHTML = `${iconHtml} <span id=\"saveCategoryText\">${text}</span>`;
                }
            }
        }

        fillCategoryForm(category) {
            console.log('Filling category form with data:', category);

            document.getElementById('categoryId').value = category.id || '';
            document.getElementById('categoryName').value = category.ten_danh_muc || '';
            document.getElementById('categoryImage').value = category.anh_url || '';
            document.getElementById('categoryDescription').value = category.mo_ta || '';

            // S·ª¨A: Ch·ªâ set th·ª© t·ª± n·∫øu ch∆∞a c√≥ gi√° tr·ªã (gi·ªØ nguy√™n gi√° tr·ªã hi·ªán t·∫°i n·∫øu ƒëang edit)
            const currentOrderValue = document.getElementById('categoryOrder').value;
            if (!currentOrderValue || currentOrderValue === '0') {
                document.getElementById('categoryOrder').value = category.thu_tu !== undefined ? category.thu_tu : 0;
            }

            document.getElementById('parentCategory').value = category.danh_muc_cha_id || '';

            const statusValue = category.trang_thai === true ? '1' :
                category.trang_thai === false ? '0' :
                (category.trang_thai || '1').toString();
            document.getElementById('categoryStatus').value = statusValue;

            // Always update preview for edit mode
            this.updateImagePreview(category.anh_url);
            // ƒê·∫£m b·∫£o preview lu√¥n hi·ªÉn th·ªã khi c√≥ ·∫£nh
            const previewElement = document.getElementById('categoryImagePreviewContainer');
            if (previewElement && category.anh_url && category.anh_url.trim() !== '') {
                previewElement.style.display = '';
            }

            const description = document.getElementById('categoryDescription');
            const charCount = document.getElementById('categoryCharCount');
            if (charCount && description) {
                charCount.textContent = description.value.length;
            }

            const slugInput = document.getElementById('categorySlug');
            if (slugInput) {
                slugInput.value = category.slug || Utils.generateSlug(category.ten_danh_muc);
            }

            // Always force edit UI when filling form for edit
            this.updateFormUI(true, false);
            // Ensure save button text is always correct after filling form
            const saveText = document.getElementById('saveCategoryText');
            if (saveText) saveText.textContent = 'C·∫≠p nh·∫≠t danh m·ª•c';
        }

        resetCategoryForm() {
            this.currentEditId = null;
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryId').value = '';
            document.getElementById('categoryStatus').value = '1';
            document.getElementById('categoryOrder').value = '0'; // Reset v·ªÅ 0
            document.getElementById('parentCategory').value = '';
            document.getElementById('categoryCharCount').textContent = '0';
            if (this.simpleImageUpload) {
                this.simpleImageUpload.resetCategoryImage();
            }
            // Always force add UI when resetting form
            this.updateFormUI(false, true);
        }

        async loadCategories() {
            try {
                const tbody = document.getElementById('categoriesTableBody');
                const emptyState = document.getElementById('categoriesEmptyState');
                const tableContainer = document.querySelector('#categoryModal .table-section-container .table-responsive');

                if (tbody && tableContainer) {
                    tbody.innerHTML = `
                        <tr class="table-loading">
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                <div class="loading-spinner"></div>
                                <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
                            </td>
                        </tr>
                    `;
                    emptyState.style.display = 'none';
                }

                const response = await fetch('/api/danhmuc');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                let categories = [];
                if (Array.isArray(result)) {
                    categories = result;
                } else if (result.data && Array.isArray(result.data)) {
                    categories = result.data;
                } else if (result.success && Array.isArray(result.data)) {
                    categories = result.data;
                } else {
                    console.warn('Unexpected API response format:', result);
                    categories = [];
                }

                this.categories = categories;
                this.totalPages = Math.ceil(categories.length / this.itemsPerPage);
                this.renderCategoriesTable();
                this.updateCategoriesTableInfo();
                this.updatePaginationControls();

            } catch (error) {
                console.error('L·ªói t·∫£i danh m·ª•c:', error);

                const tbody = document.getElementById('categoriesTableBody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--danger);">
                                <i class="fas fa-exclamation-triangle"></i>
                                <p>Kh√¥ng th·ªÉ t·∫£i danh s√°ch danh m·ª•c</p>
                                <button class="btn btn-sm btn-primary mt-2" onclick="categoryManager.refreshCategories()">
                                    Th·ª≠ l·∫°i
                                </button>
                            </td>
                        </tr>
                    `;
                }

                this.showError('Kh√¥ng th·ªÉ t·∫£i danh s√°ch danh m·ª•c: ' + error.message);
            }
        }

        async loadParentCategories() {
            try {
                const response = await fetch('/api/danhmuc');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                let categories = [];
                
                if (Array.isArray(result)) {
                    categories = result;
                } else if (result.data && Array.isArray(result.data)) {
                    categories = result.data;
                } else if (result.success && Array.isArray(result.data)) {
                    categories = result.data;
                }

                this.renderParentCategories(categories);
            } catch (error) {
                console.error('L·ªói t·∫£i danh m·ª•c cha:', error);
            }
        }

        renderParentCategories(categories) {
            const select = document.getElementById('parentCategory');
            if (!select) {
                console.error('‚ùå Kh√¥ng t√¨m th·∫•y select box parentCategory');
                return;
            }

            // L∆∞u gi√° tr·ªã ƒëang ƒë∆∞·ª£c ch·ªçn
            const currentValue = select.value;
            
            // Gi·ªØ l·∫°i option ƒë·∫ßu ti√™n
            const firstOption = select.options[0];
            select.innerHTML = '';
            select.appendChild(firstOption);

            // L·ªçc danh m·ª•c ƒëang ho·∫°t ƒë·ªông
            const activeCategories = categories.filter(cat => cat.trang_thai !== false && cat.trang_thai !== 0);

            activeCategories.forEach(category => {
                // Kh√¥ng cho ph√©p ch·ªçn ch√≠nh n√≥ khi ƒëang edit
                if (this.currentEditId && category.id === this.currentEditId) {
                    return;
                }

                const option = document.createElement('option');
                option.value = category.id;
                
                // TH√äM TH·ª® T·ª∞ V√ÄO TEXT ƒê·ªÇ HI·ªÇN TH·ªä
                const orderText = category.thu_tu ? ` (Th·ª© t·ª±: ${category.thu_tu})` : '';
                option.textContent = `${category.ten_danh_muc}${orderText}`;
                
                // Th√™m th√¥ng tin th·ª© t·ª± ƒë·ªÉ s·∫Øp x·∫øp
                option.setAttribute('data-order', category.thu_tu || 0);
                
                select.appendChild(option);
            });

            // S·∫Øp x·∫øp options theo th·ª© t·ª±
            this.sortCategoryOptions(select);

            // Kh√¥i ph·ª•c gi√° tr·ªã ƒëang ch·ªçn n·∫øu v·∫´n t·ªìn t·∫°i
            if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                select.value = currentValue;
            }

            console.log(`‚úÖ Updated parent category dropdown with ${activeCategories.length} items`);
        }

        sortCategoryOptions(selectElement) {
            const options = Array.from(selectElement.options);
            
            // Gi·ªØ option ƒë·∫ßu ti√™n (-- Kh√¥ng c√≥ --)
            const firstOption = options[0];
            const otherOptions = options.slice(1);
            
            // S·∫Øp x·∫øp c√°c option c√≤n l·∫°i theo th·ª© t·ª± v√† t√™n
            otherOptions.sort((a, b) => {
                const orderA = parseInt(a.getAttribute('data-order')) || 0;
                const orderB = parseInt(b.getAttribute('data-order')) || 0;
                
                if (orderA !== orderB) {
                    return orderA - orderB;
                }
                
                // N·∫øu c√πng th·ª© t·ª± th√¨ s·∫Øp x·∫øp theo t√™n
                return a.textContent.localeCompare(b.textContent);
            });
            
            // C·∫≠p nh·∫≠t l·∫°i select
            selectElement.innerHTML = '';
            selectElement.appendChild(firstOption);
            otherOptions.forEach(option => selectElement.appendChild(option));
        }

        searchCategories(keyword) {
            this.searchKeyword = keyword.toLowerCase().trim();
            this.currentPage = 1;
            this.renderCategoriesTable();
            this.updateCategoriesTableInfo();
            this.updatePaginationControls();
        }

        getCurrentPageCategories() {
            let filteredCategories = this.categories;

            if (this.searchKeyword) {
                filteredCategories = this.categories.filter(category =>
                    category.ten_danh_muc.toLowerCase().includes(this.searchKeyword) ||
                    (category.mo_ta && category.mo_ta.toLowerCase().includes(this.searchKeyword)) ||
                    (category.slug && category.slug.toLowerCase().includes(this.searchKeyword))
                );
            }

            this.totalPages = Math.ceil(filteredCategories.length / this.itemsPerPage);

            const startIndex = (this.currentPage - 1) * this.itemsPerPage;
            const endIndex = startIndex + this.itemsPerPage;
            return filteredCategories.slice(startIndex, endIndex);
        }

        updatePaginationControls() {
            const prevPageBtn = document.getElementById('categoriesPrevPage');
            const nextPageBtn = document.getElementById('categoriesNextPage');
            const paginationInfo = document.querySelector('#categoryModal .table-pagination .pagination-info');

            if (prevPageBtn) {
                prevPageBtn.disabled = this.currentPage === 1;
            }

            if (nextPageBtn) {
                nextPageBtn.disabled = this.currentPage === this.totalPages || this.totalPages === 0;
            }

            if (paginationInfo) {
                const displayTotalPages = this.totalPages === 0 ? 1 : this.totalPages;
                paginationInfo.textContent = `Trang ${this.currentPage}/${displayTotalPages}`;
            }
        }

        goToPage(page) {
            if (page < 1 || page > this.totalPages) return;

            this.currentPage = page;
            this.renderCategoriesTable();
            this.updateCategoriesTableInfo();
            this.updatePaginationControls();
        }

        updateCategoriesTableInfo() {
            const currentCount = document.getElementById('categoriesCurrentCount');
            const totalCount = document.getElementById('categoriesTotalCount');

            let filteredCategories = this.categories;
            if (this.searchKeyword) {
                filteredCategories = this.categories.filter(category =>
                    category.ten_danh_muc.toLowerCase().includes(this.searchKeyword) ||
                    (category.mo_ta && category.mo_ta.toLowerCase().includes(this.searchKeyword)) ||
                    (category.slug && category.slug.toLowerCase().includes(this.searchKeyword))
                );
            }

            const currentCategories = this.getCurrentPageCategories();

            if (totalCount) totalCount.textContent = filteredCategories.length;
            
            if (currentCount) {
                const startIndex = (this.currentPage - 1) * this.itemsPerPage + 1;
                const endIndex = Math.min(startIndex + currentCategories.length - 1, filteredCategories.length);
                
                if (filteredCategories.length === 0) {
                    currentCount.textContent = '0';
                } else {
                    currentCount.textContent = `${startIndex}-${endIndex}`;
                }
            }
        }

        renderCategoriesTable() {
            const tbody = document.getElementById('categoriesTableBody');
            const emptyState = document.getElementById('categoriesEmptyState');
            const tableContainer = document.querySelector('#categoryModal .table-section-container .table-responsive');

            if (!tbody) return;

            tbody.innerHTML = '';

            const currentCategories = this.getCurrentPageCategories();

            if (!currentCategories || currentCategories.length === 0) {
                if (tableContainer) tableContainer.style.display = 'none';
                if (emptyState) emptyState.style.display = 'block';
                return;
            }

            if (tableContainer) tableContainer.style.display = 'block';
            if (emptyState) emptyState.style.display = 'none';

            // T·∫°o map ƒë·ªÉ t√¨m t√™n danh m·ª•c cha
            const categoryMap = new Map();
            this.categories.forEach(cat => categoryMap.set(cat.id, cat.ten_danh_muc));

            currentCategories.forEach(category => {
                const parentName = category.danh_muc_cha_id ? 
                    (categoryMap.get(category.danh_muc_cha_id) || 'N/A') : '---';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="product-name">${Utils.escapeHtml(category.ten_danh_muc)}</div>
                        ${category.mo_ta ? `<div class="product-sku">${Utils.escapeHtml(category.mo_ta)}</div>` : ''}
                    </td>
                    <td>${Utils.escapeHtml(parentName)}</td>
                    <td>${category.thu_tu || 0}</td>
                    <td>
                        ${category.anh_url ? `
                            <div class="product-table-image">
                                <img src="${category.anh_url}" alt="${Utils.escapeHtml(category.ten_danh_muc)}">
                            </div>
                        ` : '---'}
                    </td>
                    <td>
                        <span class="status-badge ${category.trang_thai ? 'active' : 'inactive'}">
                            ${category.trang_thai ? 'üü¢ K√≠ch ho·∫°t' : 'üî¥ ·∫®n'}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-edit btn-edit-category" data-id="${category.id}" title="Ch·ªânh s·ª≠a">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action btn-delete btn-delete-category" data-id="${category.id}" 
                                    data-name="${Utils.escapeHtml(category.ten_danh_muc)}" title="X√≥a">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async saveCategory() {
            const saveBtn = document.getElementById('saveCategoryBtn');
            const originalText = saveBtn ? saveBtn.innerHTML : null;
            try {
                const formData = this.getCategoryFormData();
                console.log('Category Data (before upload):', formData);

                if (!this.validateCategoryForm(formData)) {
                    return;
                }

                // Show loading state on save button
                if (saveBtn) {
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
                    saveBtn.disabled = true;
                }

                // If editing and no new image chosen, keep existing URL
                if (this.currentEditId && !(this.simpleImageUpload && this.simpleImageUpload.categoryImageFile)) {
                    const currentCategory = this.categories.find(c => c.id === this.currentEditId);
                    if (currentCategory && currentCategory.anh_url) {
                        formData.anh_url = currentCategory.anh_url;
                    }
                }

                // Save to DB first
                let result, categoryId;
                if (this.currentEditId) {
                    result = await this.updateCategory(this.currentEditId, formData);
                    categoryId = this.currentEditId;
                } else {
                    result = await this.createCategory(formData);
                    // L·∫•y id m·ªõi t·∫°o n·∫øu c√≥
                    categoryId = result && result.data && result.data.id ? result.data.id : (result.id || null);
                }

                // Only upload image if DB save succeeded and there is a new file
                if (this.simpleImageUpload && this.simpleImageUpload.categoryImageFile && categoryId) {
                    try {
                        const oldImageUrl = this.currentEditId ?
                            this.categories.find(c => c.id === this.currentEditId)?.anh_url : null;
                        const uploadedImageUrl = await this.simpleImageUpload.uploadCategoryImage(oldImageUrl);
                        if (uploadedImageUrl) {
                            // Update category with new image URL
                            await this.updateCategory(categoryId, { ...formData, anh_url: uploadedImageUrl });
                            console.log('‚úÖ Category image uploaded after DB save:', uploadedImageUrl);
                            this.showSuccess(this.currentEditId ? 'C·∫≠p nh·∫≠t danh m·ª•c th√†nh c√¥ng' : 'Th√™m danh m·ª•c th√†nh c√¥ng');
                            this.simpleImageUpload.categoryImageFile = null;
                        }
                    } catch (uploadError) {
                        this.showError('L·ªói upload ·∫£nh danh m·ª•c: ' + uploadError.message);
                        if (saveBtn) {
                            saveBtn.innerHTML = originalText;
                            saveBtn.disabled = false;
                        }
                        return;
                    }
                } else {
                    this.showSuccess(this.currentEditId ? 'C·∫≠p nh·∫≠t danh m·ª•c th√†nh c√¥ng' : 'Th√™m danh m·ª•c th√†nh c√¥ng');
                }

                // C·∫¨P NH·∫¨T C·∫¢ HAI SAU KHI L∆ØU
                await Promise.all([
                    this.loadCategories(),
                    this.loadParentCategories()
                ]);

                this.renderCategoriesTable();
                this.updateCategoriesTableInfo();
                this.updatePaginationControls();
                this.resetCategoryForm();

                // Restore save button
                if (saveBtn) {
                    saveBtn.innerHTML = this.currentEditId ?
                        '<i class="fas fa-save"></i> C·∫≠p nh·∫≠t danh m·ª•c' :
                        '<i class="fas fa-save"></i> Th√™m danh m·ª•c';
                    saveBtn.disabled = false;
                }

            } catch (error) {
                this.showError('Kh√¥ng th·ªÉ l∆∞u danh m·ª•c: ' + error.message);
                if (saveBtn) {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }
            }
        }

        getCategoryFormData() {
            return {
                ten_danh_muc: document.getElementById('categoryName').value.trim(),
                anh_url: document.getElementById('categoryImage').value.trim(),
                mo_ta: document.getElementById('categoryDescription').value.trim(),
                thu_tu: parseInt(document.getElementById('categoryOrder').value) || 0,
                danh_muc_cha_id: document.getElementById('parentCategory').value || null,
                trang_thai: parseInt(document.getElementById('categoryStatus').value),
                slug: Utils.generateSlug(document.getElementById('categoryName').value.trim())
            };
        }

        validateCategoryForm(formData) {
            if (!formData.ten_danh_muc) {
                this.showError('Vui l√≤ng nh·∫≠p t√™n danh m·ª•c');
                return false;
            }
            return true;
        }

        async createCategory(categoryData) {
            const response = await fetch('/api/danhmuc', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(categoryData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'L·ªói khi th√™m danh m·ª•c');
            }

            return await response.json();
        }

        async updateCategory(id, categoryData) {
            const response = await fetch(`/api/danhmuc/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(categoryData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'L·ªói khi c·∫≠p nh·∫≠t danh m·ª•c');
            }

            return await response.json();
        }

        // S·ª≠a ph∆∞∆°ng th·ª©c handleEditCategory
        async handleEditCategory(button) {
            const categoryId = button.getAttribute('data-id');
            this.currentEditId = categoryId;
            
            // C·∫≠p nh·∫≠t UI NGAY L·∫¨P T·ª®C tr∆∞·ªõc khi load d·ªØ li·ªáu
            this.updateFormUI(true, false);
            const saveText = document.getElementById('saveCategoryText');
            if (saveText) saveText.textContent = 'C·∫≠p nh·∫≠t danh m·ª•c';
            
            console.log('üîÑ Starting edit for category ID:', categoryId);
            
            // Load chi ti·∫øt danh m·ª•c
            await this.loadCategoryDetail(categoryId);
            
            // ƒê·∫£m b·∫£o modal ƒë∆∞·ª£c m·ªü
            const modalElement = document.getElementById('categoryModal');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                if (!modalElement.classList.contains('show')) {
                    modal.show();
                }
            }
        }

        // S·ª≠a ph∆∞∆°ng th·ª©c loadCategoryDetail ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªìng b·ªô
        async loadCategoryDetail(categoryId) {
            try {
                console.log('üì• Loading category details for ID:', categoryId);
                const response = await fetch(`/api/danhmuc/${categoryId}`);

                if (!response.ok) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin danh m·ª•c');
                }

                const result = await response.json();
                const category = result.data || result;

                console.log('‚úÖ Category data received:', category);

                if (!category) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y th√¥ng tin danh m·ª•c');
                }

                // G·ªçi ph∆∞∆°ng th·ª©c fill form v√† ƒê·∫¢M B·∫¢O UI ƒë∆∞·ª£c c·∫≠p nh·∫≠t
                this.fillCategoryForm(category);
                
                // C·∫¨P NH·∫¨T L·∫†I UI SAU KHI FILL FORM (ƒë·ªÅ ph√≤ng)
                this.updateFormUI(true, false);
                const saveText = document.getElementById('saveCategoryText');
                if (saveText) saveText.textContent = 'C·∫≠p nh·∫≠t danh m·ª•c';

            } catch (error) {
                console.error('‚ùå Error loading category detail:', error);
                this.showError('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin danh m·ª•c: ' + error.message);
            }
        }

        // Th√™m ph∆∞∆°ng th·ª©c m·ªõi ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªìng b·ªô
        async openCategoryModalForEdit(categoryId) {
            this.currentEditId = categoryId;
            this.searchKeyword = '';

            const modalElement = document.getElementById('categoryModal');
            const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);

            // C·∫¨P NH·∫¨T UI TR∆Ø·ªöC KHI M·ªû MODAL
            this.updateFormUI(true, false);
            const saveText = document.getElementById('saveCategoryText');
            if (saveText) saveText.textContent = 'C·∫≠p nh·∫≠t danh m·ª•c';

            // Load data
            await Promise.all([
                this.loadCategories(),
                this.loadParentCategories()
            ]);

            // Load chi ti·∫øt danh m·ª•c
            await this.loadCategoryDetail(categoryId);

            // M·ªü modal
            modal.show();
            
            this.setupCategoryEvents();
        }

        async handleDeleteCategory(button) {
            const categoryId = button.getAttribute('data-id');
            const categoryName = button.getAttribute('data-name');

            const result = await Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                html: `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a danh m·ª•c <strong>${categoryName}</strong>?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#667eea',
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            });

            if (result.isConfirmed) {
                try {
                    const response = await fetch(`/api/danhmuc/${categoryId}`, { 
                        method: 'DELETE' 
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'L·ªói khi x√≥a danh m·ª•c');
                    }

                    await response.json();
                    
                    // Th√†nh c√¥ng - hi·ªÉn th·ªã th√¥ng b√°o nhanh v·ªõi n√∫t ƒê√≥ng
                    await Swal.fire({
                        icon: 'success',
                        title: 'Th√†nh c√¥ng!',
                        text: 'X√≥a danh m·ª•c th√†nh c√¥ng',
                        confirmButtonText: 'ƒê√≥ng',
                        confirmButtonColor: '#667eea'
                    });

                    // C·∫≠p nh·∫≠t danh s√°ch sau khi x√≥a
                    await Promise.all([
                        this.loadCategories(),
                        this.loadParentCategories()
                    ]);

                    const currentCategories = this.getCurrentPageCategories();
                    if (currentCategories.length === 0 && this.currentPage > 1) {
                        this.currentPage--;
                    }

                    this.renderCategoriesTable();
                    this.updateCategoriesTableInfo();
                    this.updatePaginationControls();

                } catch (error) {
                    // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói v·ªõi n√∫t ƒê√≥ng v√† g·ª£i √Ω ·∫©n ƒëi
                    await Swal.fire({
                        icon: 'error',
                        title: 'Kh√¥ng th·ªÉ x√≥a!',
                        html: `
                            <div style="text-align: left;">
                                <p><strong>${error.message}</strong></p>
                                <p style="margin-top: 15px; color: #6b7280; font-size: 14px;">
                                    <i class="fas fa-lightbulb" style="color: #f59e0b;"></i>
                                    <strong>G·ª£i √Ω:</strong> B·∫°n c√≥ th·ªÉ chuy·ªÉn tr·∫°ng th√°i sang "Ng·ª´ng ho·∫°t ƒë·ªông" ƒë·ªÉ ·∫©n danh m·ª•c n√†y ƒëi thay v√¨ x√≥a.
                                </p>
                            </div>
                        `,
                        confirmButtonText: 'ƒê√≥ng',
                        confirmButtonColor: '#667eea',
                        showCancelButton: true,
                        cancelButtonText: '·∫®n danh m·ª•c',
                        cancelButtonColor: '#f59e0b'
                    }).then((result) => {
                        if (result.dismiss === Swal.DismissReason.cancel) {
                            // Ng∆∞·ªùi d√πng click "·∫®n danh m·ª•c" - chuy·ªÉn sang ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
                            this.handleEditCategory(button);
                        }
                    });
                }
            }
        }

        // Ph∆∞∆°ng th·ª©c ki·ªÉm tra tr∆∞·ªõc khi x√≥a (c√≥ th·ªÉ d√πng ƒë·ªÉ hi·ªÉn th·ªã c·∫£nh b√°o s·ªõm)
        async checkCategoryBeforeDelete(categoryId) {
            try {
                // G·ªçi API ƒë·ªÉ ki·ªÉm tra ƒëi·ªÅu ki·ªán x√≥a
                const response = await fetch(`/api/danhmuc/${categoryId}/check-delete`);
                if (!response.ok) {
                    throw new Error('Kh√¥ng th·ªÉ ki·ªÉm tra ƒëi·ªÅu ki·ªán x√≥a');
                }
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('L·ªói khi ki·ªÉm tra ƒëi·ªÅu ki·ªán x√≥a:', error);
                return { canDelete: false, message: 'L·ªói khi ki·ªÉm tra ƒëi·ªÅu ki·ªán x√≥a' };
            }
        }

        showSuccess(message) {
            Swal.fire({
                icon: 'success',
                title: 'Th√†nh c√¥ng!',
                text: message,
                timer: 2000,
                showConfirmButton: false
            });
        }

        showError(message) {
            Swal.fire({
                icon: 'error',
                title: 'L·ªói!',
                text: message,
                confirmButtonColor: '#667eea'
            });
        }
    }
        
    // Kh·ªüi t·∫°o managers
    document.addEventListener('DOMContentLoaded', function () {
        
        // Always create and assign the global instance for category image upload
        if (!window.simpleImageUploadManager) {
            window.simpleImageUploadManager = new SimpleImageUploadManager();
        }
        new BrandManager();
        new CategoryManager();
    });
    // File Upload Manager
    class FileUploadManager {
        constructor() {
            this.mainImageFile = null;
            this.additionalImages = [];
            this.videos = [];
            this.init();
        }

        init() {
            this.bindEvents();
        }

        bindEvents() {
            // Main Image Upload
            const mainImageUploadArea = document.getElementById('mainImageUploadArea');
            const mainImageInput = document.getElementById('productMainImage');
            const changeMainImageBtn = document.getElementById('changeMainImageBtn');

            mainImageUploadArea?.addEventListener('click', () => mainImageInput.click());
            mainImageUploadArea?.addEventListener('dragover', this.handleDragOver.bind(this));
            mainImageUploadArea?.addEventListener('dragleave', this.handleDragLeave.bind(this));
            mainImageUploadArea?.addEventListener('drop', this.handleMainImageDrop.bind(this));
            
            mainImageInput?.addEventListener('change', (e) => this.handleMainImageSelect(e));
            changeMainImageBtn?.addEventListener('click', () => mainImageInput.click());

            // Additional Images Upload
            const additionalImagesUploadArea = document.getElementById('additionalImagesUploadArea');
            const additionalImagesInput = document.getElementById('productAdditionalImages');

            additionalImagesUploadArea?.addEventListener('click', () => additionalImagesInput.click());
            additionalImagesUploadArea?.addEventListener('dragover', this.handleDragOver.bind(this));
            additionalImagesUploadArea?.addEventListener('dragleave', this.handleDragLeave.bind(this));
            additionalImagesUploadArea?.addEventListener('drop', this.handleAdditionalImagesDrop.bind(this));
            
            additionalImagesInput?.addEventListener('change', (e) => this.handleAdditionalImagesSelect(e));

            // Videos Upload
            const videosUploadArea = document.getElementById('videosUploadArea');
            const videosInput = document.getElementById('productVideos');

            videosUploadArea?.addEventListener('click', () => videosInput.click());
            videosUploadArea?.addEventListener('dragover', this.handleDragOver.bind(this));
            videosUploadArea?.addEventListener('dragleave', this.handleDragLeave.bind(this));
            videosUploadArea?.addEventListener('drop', this.handleVideosDrop.bind(this));
            
            videosInput?.addEventListener('change', (e) => this.handleVideosSelect(e));
        }

        handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        // Main Image Handlers
        handleMainImageDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && this.isImageFile(files[0])) {
                this.processMainImage(files[0]);
            }
        }

        handleMainImageSelect(e) {
            const file = e.target.files[0];
            if (file && this.isImageFile(file)) {
                this.processMainImage(file);
            }
        }

        processMainImage(file) {
            if (this.validateImageFile(file)) {
                this.mainImageFile = file;
                this.displayMainImagePreview(file);
                this.uploadMainImage(file);
            }
        }

        displayMainImagePreview(file) {
            const previewArea = document.getElementById('mainImageUploadArea');
            const placeholder = previewArea.querySelector('.upload-placeholder');
            const preview = document.getElementById('mainImagePreview');
            const previewImg = document.getElementById('mainImagePreviewImg');

            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
                placeholder.style.display = 'none';
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        // Additional Images Handlers
        handleAdditionalImagesDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files).filter(file => this.isImageFile(file));
            if (files.length > 0) {
                this.processAdditionalImages(files);
            }
        }

        handleAdditionalImagesSelect(e) {
            const files = Array.from(e.target.files).filter(file => this.isImageFile(file));
            if (files.length > 0) {
                this.processAdditionalImages(files);
            }
        }

        processAdditionalImages(files) {
            const validFiles = files.filter(file => this.validateImageFile(file));
            const remainingSlots = 10 - this.additionalImages.length;
            
            if (validFiles.length > remainingSlots) {
                this.showError(`Ch·ªâ c√≥ th·ªÉ th√™m t·ªëi ƒëa 10 ·∫£nh. B·∫°n ƒë√£ ch·ªçn ${validFiles.length} nh∆∞ng ch·ªâ c√≤n ${remainingSlots} ch·ªó tr·ªëng.`);
                validFiles.splice(remainingSlots);
            }

            validFiles.forEach(file => {
                if (this.additionalImages.length < 10) {
                    this.additionalImages.push(file);
                    this.displayAdditionalImagePreview(file);
                    this.uploadAdditionalImage(file);
                }
            });
        }

        displayAdditionalImagePreview(file) {
            const previewContainer = document.getElementById('additionalImagesPreview');
            const placeholder = document.querySelector('#additionalImagesUploadArea .upload-placeholder');

            // Hide placeholder when first image is added
            if (this.additionalImages.length === 1) {
                placeholder.style.display = 'none';
                previewContainer.style.display = 'grid';
            }

            const imageItem = document.createElement('div');
            imageItem.className = 'additional-image-item';
            
            const img = document.createElement('img');
            const reader = new FileReader();
            reader.onload = (e) => {
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-image-btn';
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.title = 'X√≥a ·∫£nh';
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.removeAdditionalImage(file, imageItem);
            });

            imageItem.appendChild(img);
            imageItem.appendChild(removeBtn);
            previewContainer.appendChild(imageItem);
        }

        removeAdditionalImage(file, element) {
            const index = this.additionalImages.indexOf(file);
            if (index > -1) {
                this.additionalImages.splice(index, 1);
            }
            element.remove();

            // Show placeholder if no images left
            const previewContainer = document.getElementById('additionalImagesPreview');
            const placeholder = document.querySelector('#additionalImagesUploadArea .upload-placeholder');
            
            if (this.additionalImages.length === 0) {
                previewContainer.style.display = 'none';
                placeholder.style.display = 'block';
            }
        }

        // Videos Handlers
        handleVideosDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files).filter(file => this.isVideoFile(file));
            if (files.length > 0) {
                this.processVideos(files);
            }
        }

        handleVideosSelect(e) {
            const files = Array.from(e.target.files).filter(file => this.isVideoFile(file));
            if (files.length > 0) {
                this.processVideos(files);
            }
        }

        processVideos(files) {
            const validFiles = files.filter(file => this.validateVideoFile(file));
            
            validFiles.forEach(file => {
                this.videos.push(file);
                this.displayVideoPreview(file);
                this.uploadVideo(file);
            });
        }

        displayVideoPreview(file) {
            const previewContainer = document.getElementById('videosPreview');
            const placeholder = document.querySelector('#videosUploadArea .upload-placeholder');

            // Hide placeholder when first video is added
            if (this.videos.length === 1) {
                placeholder.style.display = 'none';
                previewContainer.style.display = 'block';
            }

            const videoItem = document.createElement('div');
            videoItem.className = 'video-item';
            
            const videoInfo = document.createElement('div');
            videoInfo.className = 'video-info';
            
            const videoIcon = document.createElement('div');
            videoIcon.className = 'video-icon';
            videoIcon.innerHTML = '<i class="fas fa-film"></i>';
            
            const videoDetails = document.createElement('div');
            videoDetails.className = 'video-details';
            
            const videoName = document.createElement('div');
            videoName.className = 'video-name';
            videoName.textContent = file.name;
            
            const videoSize = document.createElement('div');
            videoSize.className = 'video-size';
            videoSize.textContent = this.formatFileSize(file.size);
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-video-btn';
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.title = 'X√≥a video';
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.removeVideo(file, videoItem);
            });

            videoDetails.appendChild(videoName);
            videoDetails.appendChild(videoSize);
            videoInfo.appendChild(videoIcon);
            videoInfo.appendChild(videoDetails);
            videoItem.appendChild(videoInfo);
            videoItem.appendChild(removeBtn);
            previewContainer.appendChild(videoItem);
        }

        removeVideo(file, element) {
            const index = this.videos.indexOf(file);
            if (index > -1) {
                this.videos.splice(index, 1);
            }
            element.remove();

            // Show placeholder if no videos left
            const previewContainer = document.getElementById('videosPreview');
            const placeholder = document.querySelector('#videosUploadArea .upload-placeholder');
            
            if (this.videos.length === 0) {
                previewContainer.style.display = 'none';
                placeholder.style.display = 'block';
            }
        }

        // File Validation
        isImageFile(file) {
            return file.type.startsWith('image/');
        }

        isVideoFile(file) {
            return file.type.startsWith('video/');
        }

        validateImageFile(file) {
            const maxSize = 5 * 1024 * 1024; // 5MB
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];

            if (!allowedTypes.includes(file.type)) {
                this.showError('Ch·ªâ ch·∫•p nh·∫≠n file ·∫£nh ƒë·ªãnh d·∫°ng JPG, PNG, GIF ho·∫∑c WebP');
                return false;
            }

            if (file.size > maxSize) {
                this.showError('K√≠ch th∆∞·ªõc file ·∫£nh kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB');
                return false;
            }

            return true;
        }

        validateVideoFile(file) {
            const maxSize = 50 * 1024 * 1024; // 50MB
            const allowedTypes = ['video/mp4', 'video/avi', 'video/mov', 'video/quicktime'];

            if (!allowedTypes.includes(file.type)) {
                this.showError('Ch·ªâ ch·∫•p nh·∫≠n file video ƒë·ªãnh d·∫°ng MP4, MOV ho·∫∑c AVI');
                return false;
            }

            if (file.size > maxSize) {
                this.showError('K√≠ch th∆∞·ªõc file video kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 50MB');
                return false;
            }

            return true;
        }

        // Upload Methods (Simulated - You'll need to implement actual upload logic)
        async uploadMainImage(file) {
            try {
                // Simulate upload process
                console.log('Uploading main image:', file.name);
                
                // Here you would implement actual file upload to your server
                // Example:
                // const formData = new FormData();
                // formData.append('image', file);
                // const response = await fetch('/api/upload', { method: 'POST', body: formData });
                // const result = await response.json();
                // document.getElementById('productImage').value = result.url;

                // For now, we'll just store the file object
                document.getElementById('productImage').value = file.name;
                
            } catch (error) {
                this.showError('L·ªói khi upload h√¨nh ·∫£nh ch√≠nh: ' + error.message);
            }
        }

        async uploadAdditionalImage(file) {
            try {
                console.log('Uploading additional image:', file.name);
                // Implement actual upload logic here
            } catch (error) {
                this.showError('L·ªói khi upload ·∫£nh ph·ª•: ' + error.message);
            }
        }

        async uploadVideo(file) {
            try {
                console.log('Uploading video:', file.name);
                // Implement actual upload logic here
            } catch (error) {
                this.showError('L·ªói khi upload video: ' + error.message);
            }
        }

        // Utility Methods
        formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        showError(message) {
            Swal.fire({
                icon: 'error',
                title: 'L·ªói!',
                text: message,
                confirmButtonColor: '#667eea'
            });
        }

        // Reset all file inputs
        reset() {
            this.mainImageFile = null;
            this.additionalImages = [];
            this.videos = [];

            // Reset main image
            const mainImagePreview = document.getElementById('mainImagePreview');
            const mainImagePlaceholder = document.querySelector('#mainImageUploadArea .upload-placeholder');
            if (mainImagePreview && mainImagePlaceholder) {
                mainImagePreview.style.display = 'none';
                mainImagePlaceholder.style.display = 'block';
            }

            // Reset additional images
            const additionalImagesPreview = document.getElementById('additionalImagesPreview');
            const additionalImagesPlaceholder = document.querySelector('#additionalImagesUploadArea .upload-placeholder');
            if (additionalImagesPreview && additionalImagesPlaceholder) {
                additionalImagesPreview.innerHTML = '';
                additionalImagesPreview.style.display = 'none';
                additionalImagesPlaceholder.style.display = 'block';
            }

            // Reset videos
            const videosPreview = document.getElementById('videosPreview');
            const videosPlaceholder = document.querySelector('#videosUploadArea .upload-placeholder');
            if (videosPreview && videosPlaceholder) {
                videosPreview.innerHTML = '';
                videosPreview.style.display = 'none';
                videosPlaceholder.style.display = 'block';
            }

            // Reset hidden inputs
            document.getElementById('productImage').value = '';
            document.getElementById('productAdditionalImagesData').value = '';
            document.getElementById('productVideosData').value = '';
        }

        // Get uploaded data (for form submission)
        getUploadData() {
            return {
                mainImage: this.mainImageFile,
                additionalImages: this.additionalImages,
                videos: this.videos
            };
        }
    }

    // Initialize file upload manager when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        window.fileUploadManager = new FileUploadManager();
    });

class SimpleImageUploadManager {
    constructor() {
        this.brandImageFile = null;
        this.categoryImageFile = null;
        this.productImages = []; // M·∫£ng ch·ª©a t·∫•t c·∫£ ·∫£nh s·∫£n ph·∫©m
        this.mainImageIndex = 0; // Index c·ªßa ·∫£nh ch√≠nh
        this.isProcessing = false;
        
        // Event binding flags
        this.brandEventsBound = false;
        this.categoryEventsBound = false;
        this.productEventsBound = false; // ‚Üê TH√äM D√íNG N√ÄY
        
        // Event handler references
        this.brandClickHandler = null;
        this.brandChangeHandler = null;
        this.brandInputHandler = null;
        this.categoryClickHandler = null;
        this.categoryChangeHandler = null;
        this.categoryInputHandler = null;
        
        // Product event handler references ‚Üê TH√äM C√ÅC D√íNG N√ÄY
        this.mainImageClickHandler = null;
        this.mainImageChangeHandler = null;
        this.mainImageInputHandler = null;
        this.additionalImagesClickHandler = null;
        this.additionalImagesInputHandler = null;
        
        this.productMainImageFile = null;
        this.productAdditionalImages = [];

        this.productVideos = []; 
        this.videoEventsBound = false;
        
        this.init();
    }

    init() {
        this.bindBrandEvents();
        this.bindCategoryEvents();
        this.bindProductEvents();
        this.bindVideoEvents();
    }

    showSuccess(message) {
        Swal.fire({
            icon: 'success',
            title: 'Th√†nh c√¥ng!',
            text: message,
            timer: 2000,
            showConfirmButton: false
        });
    }

    showError(message) {
        Swal.fire({
            icon: 'error',
            title: 'L·ªói!',
            text: message,
            confirmButtonColor: '#667eea'
        });
    }

    // Product Image Upload Events
    bindProductEvents() {
        if (this.productEventsBound) return;

        const imagesUploadArea = document.getElementById('productImagesUploadArea');
        const imagesInput = document.getElementById('productImages');
        const chooseBtn = document.getElementById('chooseProductImagesBtn');

        if (imagesUploadArea && imagesInput) {
            console.log('‚úÖ Binding product events...');

            // Remove any existing event listeners by cloning
            const newImagesUploadArea = imagesUploadArea.cloneNode(true);
            imagesUploadArea.parentNode.replaceChild(newImagesUploadArea, imagesUploadArea);

            const newImagesInput = imagesInput.cloneNode(true);
            imagesInput.parentNode.replaceChild(newImagesInput, imagesInput);

            // Clone n√∫t ch·ªçn t·ªáp ƒë·ªÉ x√≥a event listeners c≈©
            if (chooseBtn) {
                const newChooseBtn = chooseBtn.cloneNode(true);
                chooseBtn.parentNode.replaceChild(newChooseBtn, chooseBtn);
            }

            // Get new references
            const currentImagesUploadArea = document.getElementById('productImagesUploadArea');
            const currentImagesInput = document.getElementById('productImages');
            const currentChooseBtn = document.getElementById('chooseProductImagesBtn');

            // Drag and drop events only (kh√¥ng c√≥ click v√†o v√πng upload)
            currentImagesUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                currentImagesUploadArea.classList.add('dragover');
            });

            currentImagesUploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                currentImagesUploadArea.classList.remove('dragover');
            });

            currentImagesUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                currentImagesUploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files).filter(file => this.isImageFile(file));
                if (files.length > 0) {
                    this.processProductImages(files);
                }
            });

            // Choose button
            if (currentChooseBtn) {
                currentChooseBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üîò Choose product images button clicked');
                    currentImagesInput.click();
                });
            }

            // Input change
            currentImagesInput.addEventListener('change', (e) => {
                console.log('üì§ Product images input changed');
                if (!e.target.files || e.target.files.length === 0) {
                    return; // Kh√¥ng c√≥ file n√†o ƒë∆∞·ª£c ch·ªçn
                }
                const files = Array.from(e.target.files).filter(file => this.isImageFile(file));
                if (files.length > 0) {
                    this.processProductImages(files);
                }
                // Reset value ƒë·ªÉ c√≥ th·ªÉ ch·ªçn l·∫°i c√πng file
                e.target.value = null;
            });

            this.productEventsBound = true;
        }
    }

    processProductImages(files) {
        const validFiles = files.filter(file => this.validateImageFile(file));
        const remainingSlots = 10 - this.productImages.length;
        
        if (validFiles.length > remainingSlots) {
            this.showError(`Ch·ªâ c√≥ th·ªÉ th√™m t·ªëi ƒëa 10 ·∫£nh. B·∫°n ƒë√£ ch·ªçn ${validFiles.length} nh∆∞ng ch·ªâ c√≤n ${remainingSlots} ch·ªó tr·ªëng.`);
            validFiles.splice(remainingSlots);
        }

        validFiles.forEach(file => {
            if (this.productImages.length < 10) {
                this.productImages.push(file);
            }
        });

        this.renderProductImagesPreview();
        console.log(`‚úÖ Added ${validFiles.length} images, total: ${this.productImages.length}`);
    }
    

    renderProductImagesPreview() {
        const previewSection = document.getElementById('productImagesPreview');
        const previewGrid = document.getElementById('productImagesPreviewGrid');
        const emptyState = document.getElementById('productImagesUploadArea');

        if (!previewGrid || !previewSection || !emptyState) return;

        previewGrid.innerHTML = '';

        // N·∫øu kh√¥ng c√≥ ·∫£nh, hi·ªán empty state
        if (this.productImages.length === 0) {
            previewSection.classList.add('hidden');
            emptyState.classList.remove('hidden');
            return;
        }

        // C√≥ ·∫£nh, hi·ªán preview section
        previewSection.classList.remove('hidden');
        emptyState.classList.add('hidden');

        this.productImages.forEach((file, index) => {
            const imageItem = document.createElement('div');
            imageItem.className = `image-preview-item ${index === this.mainImageIndex ? 'main-image' : ''}`;
            
            // üéØ X·ª≠ l√Ω c·∫£ File th·∫≠t v√† mock file t·ª´ MongoDB
            if (file instanceof File) {
                // ·∫¢nh m·ªõi ƒë∆∞·ª£c ch·ªçn t·ª´ m√°y t√≠nh
                const reader = new FileReader();
                reader.onload = (e) => {
                    imageItem.innerHTML = this.getImagePreviewHTML(e.target.result, index, file);
                };
                reader.readAsDataURL(file);
            } else if (file.url) {
                // ·∫¢nh hi·ªán c√≥ t·ª´ MongoDB - s·ª≠ d·ª•ng tr·ª±c ti·∫øp URL
                imageItem.innerHTML = this.getImagePreviewHTML(file.url, index, file);
            } else {
                console.warn('Invalid file object:', file);
                return;
            }
            
            previewGrid.appendChild(imageItem);
        });
    }

    setMainImage(index) {
        this.mainImageIndex = index;
        this.renderProductImagesPreview();
        console.log(`‚úÖ ƒê√£ ch·ªçn ·∫£nh ch√≠nh: index ${index}`);
    }

    
    removeProductEventListeners() {
        const mainImageUploadArea = document.getElementById('mainImageUploadArea');
        const mainImageInput = document.getElementById('productMainImage');
        const changeMainImageBtn = document.getElementById('changeMainImageBtn');
        const additionalImagesUploadArea = document.getElementById('additionalImagesUploadArea');
        const additionalImagesInput = document.getElementById('productAdditionalImages');

        // Remove main image event listeners
        if (mainImageUploadArea && this.mainImageClickHandler) {
            mainImageUploadArea.removeEventListener('click', this.mainImageClickHandler);
            this.mainImageClickHandler = null;
        }

        if (changeMainImageBtn && this.mainImageChangeHandler) {
            changeMainImageBtn.removeEventListener('click', this.mainImageChangeHandler);
            this.mainImageChangeHandler = null;
        }

        if (mainImageInput && this.mainImageInputHandler) {
            mainImageInput.removeEventListener('change', this.mainImageInputHandler);
            this.mainImageInputHandler = null;
        }

        // Remove additional images event listeners
        if (additionalImagesUploadArea && this.additionalImagesClickHandler) {
            additionalImagesUploadArea.removeEventListener('click', this.additionalImagesClickHandler);
            this.additionalImagesClickHandler = null;
        }

        if (additionalImagesInput && this.additionalImagesInputHandler) {
            additionalImagesInput.removeEventListener('change', this.additionalImagesInputHandler);
            this.additionalImagesInputHandler = null;
        }

        console.log('üßπ Removed product event listeners');
    }


    async uploadProductImages() {
        if (this.productImages.length === 0) {
            console.log('‚ÑπÔ∏è No images to upload');
            return { mainImageUrl: '', additionalImages: [] };
        }

        try {
            console.log(`‚¨ÜÔ∏è Starting upload for ${this.productImages.length} images...`);
            
            const mainImage = this.productImages[this.mainImageIndex];
            const additionalImages = this.productImages.filter((_, index) => index !== this.mainImageIndex);

            let mainImageUrl = '';
            let additionalImageUrls = [];

            // Upload ·∫£nh ch√≠nh (n·∫øu l√† file m·ªõi)
            if (mainImage && mainImage instanceof File) {
                console.log('üì§ Uploading main image:', mainImage.name);
                mainImageUrl = await this.uploadMainImage(mainImage);
            } else if (mainImage && mainImage.url) {
                // N·∫øu l√† ·∫£nh hi·ªán c√≥, d√πng URL c≈©
                mainImageUrl = mainImage.url;
                console.log('üîÑ Using existing main image:', mainImageUrl);
            }

            // Upload ·∫£nh ph·ª• (ch·ªâ upload file m·ªõi)
            const newAdditionalImages = additionalImages.filter(img => img instanceof File);
            if (newAdditionalImages.length > 0) {
                console.log(`üì§ Uploading ${newAdditionalImages.length} additional images`);
                additionalImageUrls = await this.uploadAdditionalImages(newAdditionalImages);
            }

            // Th√™m ·∫£nh hi·ªán c√≥ v√†o danh s√°ch ·∫£nh ph·ª•
            const existingAdditionalImages = additionalImages
                .filter(img => img && img.url && !(img instanceof File))
                .map(img => img.url);
            
            additionalImageUrls = additionalImageUrls.concat(existingAdditionalImages);

            console.log('‚úÖ Upload completed:', {
                mainImageUrl,
                additionalImages: additionalImageUrls
            });

            return {
                mainImageUrl,
                additionalImages: additionalImageUrls
            };
            
        } catch (error) {
            console.error('‚ùå Error uploading product images:', error);
            throw error;
        }
    }

    // Upload ·∫£nh ƒë∆°n l·∫ª (cho variant) - t·ª± ƒë·ªông th√™m v√†o danh s√°ch ·∫£nh s·∫£n ph·∫©m
    async uploadSingleImage(file) {
        try {
            console.log('üì§ Uploading single image for variant:', file.name);
            
            // L·∫•y th√¥ng tin s·∫£n ph·∫©m
            const productId = window.currentEditId || document.getElementById('productId')?.value || null;
            const productName = document.getElementById('productName')?.value?.trim() || 'product';
            // T·∫°o folder name: ten-san-pham-productId
            const folderName = productId ? `${productName.toLowerCase().replace(/\s+/g, '-')}-${productId}` : `${productName.toLowerCase().replace(/\s+/g, '-')}-${Date.now()}`;
            
            const formData = new FormData();
            formData.append('productAdditionalImages', file);
            formData.append('productId', folderName); // G·ª≠i folder name

            const response = await fetch('/api/upload/product-additional-images', {
                method: 'POST',
                body: formData
            });

            console.log('üì° Upload response status:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå Upload error response:', errorText);
                throw new Error(`Upload failed: ${response.status} - ${errorText}`);
            }

            const result = await response.json();
            console.log('üì¶ Upload result:', result);
            
            if (result.success && result.data && result.data.length > 0) {
                const imageUrl = result.data[0].url;
                console.log('‚úÖ Image uploaded:', imageUrl);
                
                // T·ª± ƒë·ªông th√™m v√†o productImages array n·∫øu ch∆∞a c√≥
                const existingImage = this.productImages.find(img => 
                    (img.url && img.url === imageUrl) || 
                    (img instanceof File && img.name === file.name)
                );
                
                if (!existingImage && this.productImages.length < 10) {
                    // Th√™m ·∫£nh v√†o array d∆∞·ªõi d·∫°ng object v·ªõi URL
                    this.productImages.push({ 
                        url: imageUrl,
                        name: file.name,
                        type: 'uploaded'
                    });
                    
                    // Render l·∫°i preview ƒë·ªÉ hi·ªÉn th·ªã ·∫£nh m·ªõi
                    this.renderProductImagesPreview();
                    console.log(`‚úÖ Added variant image to product images (total: ${this.productImages.length})`);
                }
                
                return imageUrl;
            } else {
                throw new Error('No URL returned from upload');
            }
        } catch (error) {
            console.error('‚ùå Error uploading single image:', error);
            throw error;
        }
    }

    async uploadMainImage(file) {
            try {
                console.log('üì§ Uploading main image via API...');
                
                // L·∫•y th√¥ng tin s·∫£n ph·∫©m
                const productId = window.currentEditId || document.getElementById('productId')?.value || null;
                const productName = document.getElementById('productName')?.value?.trim() || 'product';
                // T·∫°o folder name: ten-san-pham-productId
                const folderName = productId ? `${productName.toLowerCase().replace(/\s+/g, '-')}-${productId}` : `${productName.toLowerCase().replace(/\s+/g, '-')}-${Date.now()}`;
                
                console.log('üì¶ Upload main image to folder:', folderName);
                
                const formData = new FormData();
                formData.append('productMainImage', file);
                formData.append('productId', folderName); // G·ª≠i folder name

                const response = await fetch('/api/upload/product-main-image', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `Upload failed with status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success && result.data && result.data.url) {
                    console.log('‚úÖ Main image uploaded successfully:', result.data.url);
                    return result.data.url;
                } else {
                    throw new Error(result.message || 'Upload failed - no URL returned');
                }

            } catch (error) {
                console.error('‚ùå Main image upload error:', error);
                throw error;
            }
        }

        // H√†m upload ·∫£nh ph·ª•
        async uploadAdditionalImages(files) {
            try {
                console.log(`üì§ Uploading ${files.length} additional images via API`);
                
                // L·∫•y th√¥ng tin s·∫£n ph·∫©m
                const productId = window.currentEditId || document.getElementById('productId')?.value || null;
                const productName = document.getElementById('productName')?.value?.trim() || 'product';
                // T·∫°o folder name: ten-san-pham-productId
                const folderName = productId ? `${productName.toLowerCase().replace(/\s+/g, '-')}-${productId}` : `${productName.toLowerCase().replace(/\s+/g, '-')}-${Date.now()}`;
                
                console.log('üì¶ Upload additional images to folder:', folderName);

                const formData = new FormData();
                files.forEach(file => {
                    formData.append('productAdditionalImages', file);
                });
                formData.append('productId', folderName); // G·ª≠i folder name

                const response = await fetch('/api/upload/product-additional-images', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `Upload failed with status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success && result.data && Array.isArray(result.data)) {
                    const imageUrls = result.data.map(item => item.url);
                    console.log('‚úÖ Additional images uploaded successfully:', imageUrls);
                    return imageUrls;
                } else {
                    throw new Error(result.message || 'Upload failed - no URLs returned');
                }

            } catch (error) {
                console.error('‚ùå Additional images upload error:', error);
                throw error;
            }
        }

    

    // Trong SimpleImageUploadManager
    loadExistingImages(existingData = {}) {
        const { hinh_anh = [], link_avatar = '' } = existingData;
        
        if (hinh_anh.length === 0) return;

        console.log('üì• Loading existing images with avatar:', { hinh_anh, link_avatar });
        
        this.productImages = [];
        this.mainImageIndex = 0;

        // T√¨m index c·ªßa ·∫£nh ch√≠nh (link_avatar) trong m·∫£ng hinh_anh
        if (link_avatar) {
            const avatarIndex = hinh_anh.findIndex(url => url === link_avatar);
            if (avatarIndex !== -1) {
                this.mainImageIndex = avatarIndex;
                console.log('‚úÖ Found main image at index:', this.mainImageIndex);
            } else {
                console.log('‚ö†Ô∏è Main image not found in images array, using first image');
                this.mainImageIndex = 0;
            }
        }

        // T·∫°o mock files t·ª´ URLs
        hinh_anh.forEach((url, index) => {
            const mockFile = {
                name: `existing_image_${index + 1}.jpg`,
                type: 'image/jpeg',
                size: 0,
                url: url,
                isExisting: true
            };
            this.productImages.push(mockFile);
        });

        this.renderProductImagesPreview();
        console.log(`‚úÖ Loaded ${this.productImages.length} images, main image index: ${this.mainImageIndex}`);
    }
    
    resetProductImages() {
        this.productImages = [];
        this.mainImageIndex = 0;
        
        const previewContainer = document.getElementById('productImagesPreview');
        const previewGrid = document.getElementById('productImagesPreviewGrid');
        const placeholder = document.querySelector('#productImagesUploadArea .upload-placeholder');

        if (previewContainer) previewContainer.style.display = 'none';
        if (previewGrid) previewGrid.innerHTML = '';
        if (placeholder) placeholder.style.display = 'block';

        const imagesInput = document.getElementById('productImages');
        if (imagesInput) imagesInput.value = '';

        console.log('üîÑ Reset product images');
    }



    // Process Product Images
    processProductMainImage(file) {
        if (this.validateImageFile(file)) {
            console.log('‚úÖ Processing product main image preview:', file.name);
            this.productMainImageFile = file;
            this.displayProductMainImagePreview(file);
        }
    }

    processProductAdditionalImages(files) {
        const validFiles = files.filter(file => this.validateImageFile(file));
        const remainingSlots = 10 - this.productAdditionalImages.length;
        
        if (validFiles.length > remainingSlots) {
            this.showError(`Ch·ªâ c√≥ th·ªÉ th√™m t·ªëi ƒëa 10 ·∫£nh. B·∫°n ƒë√£ ch·ªçn ${validFiles.length} nh∆∞ng ch·ªâ c√≤n ${remainingSlots} ch·ªó tr·ªëng.`);
            validFiles.splice(remainingSlots);
        }

        validFiles.forEach(file => {
            if (this.productAdditionalImages.length < 10) {
                this.productAdditionalImages.push(file);
                this.displayProductAdditionalImagePreview(file);
                // KH√îNG g·ªçi upload ·ªü ƒë√¢y - ch·ªâ upload khi save
            }
        });
        
        console.log(`‚úÖ Added ${validFiles.length} additional images, total: ${this.productAdditionalImages.length}`);
    }

    // Display Product Image Previews
    displayProductMainImagePreview(file) {
        const previewArea = document.getElementById('mainImageUploadArea');
        const placeholder = previewArea?.querySelector('.upload-placeholder');
        const preview = document.getElementById('mainImagePreview');
        const previewImg = document.getElementById('mainImagePreviewImg');

        if (!previewArea || !previewImg) {
            console.error('‚ùå Product main image preview elements not found');
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            console.log('üñºÔ∏è Product main image preview loaded');
            previewImg.src = e.target.result;
            if (placeholder) placeholder.style.display = 'none';
            if (preview) preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    displayProductAdditionalImagePreview(file) {
        const previewContainer = document.getElementById('additionalImagesPreview');
        const placeholder = document.querySelector('#additionalImagesUploadArea .upload-placeholder');

        // Hide placeholder when first image is added
        if (this.productAdditionalImages.length === 1) {
            placeholder.style.display = 'none';
            previewContainer.style.display = 'grid';
        }

        const imageItem = document.createElement('div');
        imageItem.className = 'additional-image-item';
        
        const img = document.createElement('img');
        const reader = new FileReader();
        reader.onload = (e) => {
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);

        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-image-btn';
        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
        removeBtn.title = 'X√≥a ·∫£nh';
        removeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.removeProductAdditionalImage(file, imageItem);
        });

        imageItem.appendChild(img);
        imageItem.appendChild(removeBtn);
        previewContainer.appendChild(imageItem);
    }

    removeProductAdditionalImage(file, element) {
        const index = this.productAdditionalImages.indexOf(file);
        if (index > -1) {
            this.productAdditionalImages.splice(index, 1);
        }
        element.remove();

        // Show placeholder if no images left
        const previewContainer = document.getElementById('additionalImagesPreview');
        const placeholder = document.querySelector('#additionalImagesUploadArea .upload-placeholder');
        
        if (this.productAdditionalImages.length === 0) {
            previewContainer.style.display = 'none';
            placeholder.style.display = 'block';
        }
    }
    

    // Brand Image Upload - Fixed single click
    bindBrandEvents() {
        if (this.brandEventsBound) return;
        
        const brandUploadArea = document.getElementById('brandLogoUploadArea');
        const brandInput = document.getElementById('brandLogoInput');
        const changeBrandBtn = document.getElementById('changeBrandLogoBtn');

        if (brandUploadArea && brandInput) {
            console.log('‚úÖ Binding brand events (first time)...');

            // Remove any existing event listeners by cloning
            const newBrandUploadArea = brandUploadArea.cloneNode(true);
            brandUploadArea.parentNode.replaceChild(newBrandUploadArea, brandUploadArea);

            const newBrandInput = brandInput.cloneNode(true);
            brandInput.parentNode.replaceChild(newBrandInput, brandInput);

            // Get new references
            const currentBrandUploadArea = document.getElementById('brandLogoUploadArea');
            const currentBrandInput = document.getElementById('brandLogoInput');
            const currentChangeBtn = document.getElementById('changeBrandLogoBtn');
            const currentChooseBtn = document.getElementById('chooseBrandLogoBtn');

            // Single click handler
            const handleBrandClick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('üñ±Ô∏è Brand area clicked');
                currentBrandInput.click();
            };

            currentBrandUploadArea.addEventListener('click', handleBrandClick);

            currentBrandUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                currentBrandUploadArea.classList.add('dragover');
            });

            currentBrandUploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                currentBrandUploadArea.classList.remove('dragover');
            });

            currentBrandUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                currentBrandUploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0 && this.isImageFile(files[0])) {
                    this.processBrandImage(files[0]);
                }
            });

            // Change button
            if (currentChangeBtn) {
                currentChangeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üîÅ Change brand button clicked');
                    currentBrandInput.click();
                });
            }

            // Choose button (single button to open file picker)
            if (currentChooseBtn) {
                currentChooseBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üîò Choose brand logo button clicked');
                    currentBrandInput.click();
                });
            }

            // Input change - FIXED: Only process once
            currentBrandInput.addEventListener('change', (e) => {
                console.log('üì§ Brand input changed');
                const file = e.target.files[0];
                if (file && this.isImageFile(file)) {
                    this.processBrandImage(file);
                }
                // Reset input but don't prevent future uploads
                setTimeout(() => {
                    e.target.value = '';
                }, 100);
            });

            this.brandEventsBound = true;
        }
    }

    // Category Image Upload - Fixed preview
    bindCategoryEvents() {
        if (this.categoryEventsBound) return;

        const categoryUploadArea = document.getElementById('categoryImageUploadArea');
        const categoryInput = document.getElementById('categoryImageInput');
        const changeCategoryBtn = document.getElementById('changeCategoryImageBtn');

        if (categoryUploadArea && categoryInput) {
            console.log('‚úÖ Binding category events (first time)...');

            // Remove any existing event listeners by cloning
            const newCategoryUploadArea = categoryUploadArea.cloneNode(true);
            categoryUploadArea.parentNode.replaceChild(newCategoryUploadArea, categoryUploadArea);

            const newCategoryInput = categoryInput.cloneNode(true);
            categoryInput.parentNode.replaceChild(newCategoryInput, categoryInput);

            // Get new references
            const currentCategoryUploadArea = document.getElementById('categoryImageUploadArea');
            const currentCategoryInput = document.getElementById('categoryImageInput');
            const currentChangeBtn = document.getElementById('changeCategoryImageBtn');
            const currentChooseBtn = document.getElementById('chooseCategoryImageBtn');

            // Single click handler
            const handleCategoryClick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('üñ±Ô∏è Category area clicked');
                currentCategoryInput.click();
            };

            currentCategoryUploadArea.addEventListener('click', handleCategoryClick);

            currentCategoryUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                currentCategoryUploadArea.classList.add('dragover');
            });

            currentCategoryUploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                currentCategoryUploadArea.classList.remove('dragover');
            });

            currentCategoryUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                currentCategoryUploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0 && this.isImageFile(files[0])) {
                    this.processCategoryImage(files[0]);
                }
            });

            // Change button
            if (currentChangeBtn) {
                currentChangeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üîÅ Change category button clicked');
                    currentCategoryInput.click();
                });
            }

            // Choose button (single button to open file picker)
            if (currentChooseBtn) {
                currentChooseBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üîò Choose category image button clicked');
                    currentCategoryInput.click();
                });
            }

            // Input change - FIXED: Only process once
            currentCategoryInput.addEventListener('change', (e) => {
                console.log('üì§ Category input changed');
                const file = e.target.files[0];
                if (file && this.isImageFile(file)) {
                    this.processCategoryImage(file);
                }
                // Reset input but don't prevent future uploads
                setTimeout(() => {
                    e.target.value = '';
                }, 100);
            });

            this.categoryEventsBound = true;
        }
    }

    // Process images - ONLY PREVIEW, NO UPLOAD
    processBrandImage(file) {
        if (this.validateImageFile(file)) {
            console.log('‚úÖ Processing brand image preview:', file.name);
            // Store selected file and show preview. Upload will happen on Save.
            this.brandImageFile = file;
            // Clear any previously stored uploaded URL to avoid stale data
            this.brandImageUploadedUrl = null;
            this.displayBrandImagePreview(file);
        }
    }

    processCategoryImage(file) {
        if (this.validateImageFile(file)) {
            console.log('‚úÖ Processing category image preview:', file.name);
            this.categoryImageFile = file;
            this.displayCategoryImagePreview(file);
        }
    }

    // Display previews - FIXED CATEGORY PREVIEW
    displayBrandImagePreview(file) {
        const previewArea = document.getElementById('brandLogoUploadArea');
        const placeholder = previewArea?.querySelector('.upload-placeholder');
        const preview = document.getElementById('brandLogoPreview');
        const previewImg = document.getElementById('brandLogoPreviewImg');

        if (!previewArea || !previewImg) {
            console.error('‚ùå Brand preview elements not found');
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            console.log('üñºÔ∏è Brand preview loaded');
            previewImg.src = e.target.result;
            if (placeholder) placeholder.style.display = 'none';
            if (preview) preview.style.display = 'block';
            
            // Update the external preview container
            this.updateBrandLogoPreview(e.target.result);
        };
        reader.readAsDataURL(file);
    }

    displayCategoryImagePreview(file) {
        const previewArea = document.getElementById('categoryImageUploadArea');
        const placeholder = previewArea?.querySelector('.upload-placeholder');
        const preview = document.getElementById('categoryImagePreview');
        let previewImg = document.getElementById('categoryImagePreviewImg');

        console.log('üîç Category preview elements:', {
            previewArea: !!previewArea,
            placeholder: !!placeholder,
            preview: !!preview,
            previewImg: !!previewImg
        });

        if (!previewArea) {
            console.error('‚ùå Category preview area not found');
            return;
        }

        // Ensure preview wrapper exists; create fallback if necessary
        let previewWrapper = preview;
        if (!previewWrapper) {
            previewWrapper = document.createElement('div');
            previewWrapper.id = 'categoryImagePreview';
            previewWrapper.className = 'upload-preview';
            previewArea.appendChild(previewWrapper);
        }

        // Ensure an <img> exists inside the preview wrapper
        if (!previewImg) {
            previewImg = document.createElement('img');
            previewImg.id = 'categoryImagePreviewImg';
            previewImg.alt = 'Preview';
            previewWrapper.appendChild(previewImg);
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            console.log('üñºÔ∏è Category preview loaded');
            previewImg.src = e.target.result;
            if (placeholder) placeholder.style.display = 'none';
            if (previewWrapper) previewWrapper.style.display = 'block';

            // Update the external preview container (the larger preview area)
            try {
                this.updateCategoryImagePreview(e.target.result);
            } catch (err) {
                console.warn('‚ö†Ô∏è updateCategoryImagePreview failed:', err);
            }
        };
        reader.readAsDataURL(file);
    }

    updateBrandLogoPreview(imageUrl) {
        const logoPreview = document.getElementById('logoPreview');
        if (logoPreview) {
            console.log('‚úÖ Updating brand logo preview container');
            logoPreview.innerHTML = '';
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = 'Brand Logo Preview';
            img.style.maxWidth = '100%';
            img.style.maxHeight = '80%';
            img.style.objectFit = 'contain';
            logoPreview.appendChild(img);
            logoPreview.parentElement.classList.add('has-logo');
        }
    }

    updateCategoryImagePreview(imageUrl) {
        // FIXED: Use the correct container ID
        const imagePreviewContainer = document.querySelector('.logo-preview-container #categoryImagePreview');
        if (imagePreviewContainer) {
            console.log('‚úÖ Updating category image preview container');
            imagePreviewContainer.innerHTML = '';
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = 'Category Image Preview';
            img.style.maxWidth = '100%';
            img.style.maxHeight = '100px';
            img.style.objectFit = 'contain';
            imagePreviewContainer.appendChild(img);
            imagePreviewContainer.parentElement.classList.add('has-logo');
        } else {
            console.error('‚ùå Category image preview container not found');
            // Try alternative selectors
            const alternativeSelectors = [
                '#categoryImagePreview',
                '.image-preview-section .logo-preview',
                '.logo-preview-container .logo-preview'
            ];
            
            alternativeSelectors.forEach(selector => {
                const element = document.querySelector(selector);
                if (element) {
                    console.log(`‚úÖ Found category preview with selector: ${selector}`);
                    element.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = 'Category Image Preview';
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '100px';
                    img.style.objectFit = 'contain';
                    element.appendChild(img);
                    element.parentElement.classList.add('has-logo');
                }
            });
        }
    }

    // UPLOAD ONLY WHEN CALLED (on save)
     async uploadBrandImage(oldImageUrl = null) {
        // N·∫øu kh√¥ng c√≥ file m·ªõi th√¨ kh√¥ng upload
        if (!this.brandImageFile) {
            console.log('‚ÑπÔ∏è No new brand image to upload');
            return null;
        }

        console.log('‚¨ÜÔ∏è Starting brand image upload to API...');
        
        try {
            const formData = new FormData();
            formData.append('brandLogo', this.brandImageFile);
            
            // G·ª≠i ·∫£nh c≈© ƒë·ªÉ x√≥a n·∫øu c√≥
            if (oldImageUrl) {
                formData.append('oldImageUrl', oldImageUrl);
            }

            const response = await fetch('/api/upload/brand-logo', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `Upload failed with status: ${response.status}`);
            }

            const result = await response.json();
            
            if (result.success && result.data && result.data.url) {
                const imageUrl = result.data.url;
                console.log('‚úÖ Brand image uploaded successfully:', imageUrl);
                return imageUrl; // CH·ªà TR·∫¢ V·ªÄ URL, KH√îNG SET VALUE
            } else {
                throw new Error(result.message || 'Upload failed - no URL returned');
            }
        } catch (error) {
            console.error('‚ùå Brand image upload failed:', error);
            throw error;
        }
    }
    
    
    async uploadCategoryImage(oldImageUrl = null) {
        if (!this.categoryImageFile) {
            console.log('‚ÑπÔ∏è No new category image to upload');
            return document.getElementById('categoryImage').value;
        }

        console.log('‚¨ÜÔ∏è Starting category image upload to API...');
        try {
            const formData = new FormData();
            formData.append('categoryImage', this.categoryImageFile);
            if (oldImageUrl) {
                formData.append('oldImageUrl', oldImageUrl);
            }
            const response = await fetch('/api/upload/category-image', {
                method: 'POST',
                body: formData
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `Upload failed with status: ${response.status}`);
            }
            const result = await response.json();
            if (result.success && result.data && result.data.url) {
                const imageUrl = result.data.url;
                document.getElementById('categoryImage').value = imageUrl;
                console.log('‚úÖ Category image uploaded successfully:', imageUrl);
                return imageUrl;
            } else {
                throw new Error(result.message || 'Upload failed - no URL returned');
            }
        } catch (error) {
            console.error('‚ùå Category image upload failed:', error);
            throw error;
        }
    }

    // Upload Product Main Image
    async uploadProductMainImage(oldImageUrl = null) {
        if (!this.productMainImageFile) {
            console.log('‚ÑπÔ∏è No new product main image to upload');
            return null;
        }

        console.log('‚¨ÜÔ∏è Starting product main image upload to API...');
        
        try {
            const formData = new FormData();
            formData.append('productMainImage', this.productMainImageFile);
            
            if (oldImageUrl) {
                formData.append('oldImageUrl', oldImageUrl);
            }

            const response = await fetch('/api/upload/product-main-image', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `Upload failed with status: ${response.status}`);
            }

            const result = await response.json();
            
            if (result.success && result.data && result.data.url) {
                const imageUrl = result.data.url;
                console.log('‚úÖ Product main image uploaded successfully:', imageUrl);
                this.productMainImageFile = null;
                return imageUrl;
            } else {
                throw new Error(result.message || 'Upload failed - no URL returned');
            }
        } catch (error) {
            console.error('‚ùå Product main image upload failed:', error);
            throw error;
        }
    }

    // Upload Product Additional Images
    async uploadProductAdditionalImages() {
        if (!this.productAdditionalImages || this.productAdditionalImages.length === 0) {
            console.log('‚ÑπÔ∏è No additional images to upload');
            return [];
        }

        console.log(`‚¨ÜÔ∏è Starting ${this.productAdditionalImages.length} additional images upload to API...`);
        
        try {
            const formData = new FormData();
            
            this.productAdditionalImages.forEach((file, index) => {
                formData.append('productAdditionalImages', file);
            });

            const response = await fetch('/api/upload/product-additional-images', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `Upload failed with status: ${response.status}`);
            }

            const result = await response.json();
            
            if (result.success && result.data && Array.isArray(result.data)) {
                const imageUrls = result.data.map(item => item.url);
                console.log('‚úÖ Product additional images uploaded successfully:', imageUrls);
                this.productAdditionalImages = [];
                return imageUrls;
            } else {
                throw new Error(result.message || 'Upload failed - no URLs returned');
            }
        } catch (error) {
            console.error('‚ùå Product additional images upload failed:', error);
            throw error;
        }
    }


    // Reset ·∫£nh s·∫£n ph·∫©m
    resetProductImages() {
        this.productMainImageFile = null;
        this.productAdditionalImages = [];
        
        // Reset UI elements
        const mainImagePreview = document.getElementById('mainImagePreview');
        const mainImagePlaceholder = document.querySelector('#mainImageUploadArea .upload-placeholder');
        const additionalImagesPreview = document.getElementById('additionalImagesPreview');
        const additionalImagesPlaceholder = document.querySelector('#additionalImagesUploadArea .upload-placeholder');

        if (mainImagePreview && mainImagePlaceholder) {
            mainImagePreview.style.display = 'none';
            mainImagePlaceholder.style.display = 'block';
        }

        if (additionalImagesPreview && additionalImagesPlaceholder) {
            additionalImagesPreview.innerHTML = '';
            additionalImagesPreview.style.display = 'none';
            additionalImagesPlaceholder.style.display = 'block';
        }

        // Reset file inputs
        const mainImageInput = document.getElementById('productMainImage');
        const additionalImagesInput = document.getElementById('productAdditionalImages');
        
        if (mainImageInput) mainImageInput.value = '';
        if (additionalImagesInput) additionalImagesInput.value = '';

        {{!-- document.getElementById('productImage').value = ''; --}}
        
        console.log('üîÑ Reset product images');
    }






    // Utility methods
    isImageFile(file) {
        return file && file.type.startsWith('image/');
    }

    validateImageFile(file) {
        const maxSize = 5 * 1024 * 1024;
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];

        if (!file) return false;

        if (!allowedTypes.includes(file.type)) {
            this.showError('Ch·ªâ ch·∫•p nh·∫≠n file ·∫£nh ƒë·ªãnh d·∫°ng JPG, PNG, GIF ho·∫∑c WebP');
            return false;
        }

        if (file.size > maxSize) {
            this.showError('K√≠ch th∆∞·ªõc file ·∫£nh kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB');
            return false;
        }

        return true;
    }

    // Reset methods
    resetBrandImage() {
        this.brandImageFile = null;
        this.brandImageUploadedUrl = null;
        const previewArea = document.getElementById('brandLogoUploadArea');
        const placeholder = previewArea?.querySelector('.upload-placeholder');
        const preview = document.getElementById('brandLogoPreview');
        const logoPreview = document.getElementById('logoPreview');

        if (preview) preview.style.display = 'none';
        if (placeholder) placeholder.style.display = 'block';
        if (logoPreview) {
            logoPreview.innerHTML = `
                <div class="preview-placeholder">
                    <i class="fas fa-image fa-3x"></i>
                    <span>Logo s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y</span>
                </div>
            `;
            logoPreview.parentElement.classList.remove('has-logo');
        }
        document.getElementById('brandLogo').value = '';
        
        const brandInput = document.getElementById('brandLogoInput');
        if (brandInput) brandInput.value = '';
    }

    resetCategoryImage() {
        this.categoryImageFile = null;
        const previewArea = document.getElementById('categoryImageUploadArea');
        const placeholder = previewArea?.querySelector('.upload-placeholder');
        const preview = document.getElementById('categoryImagePreview');
        const imagePreviewContainer = document.querySelector('.logo-preview-container #categoryImagePreview');

        if (preview) preview.style.display = 'none';
        if (placeholder) placeholder.style.display = 'block';
        if (imagePreviewContainer) {
            imagePreviewContainer.innerHTML = `
                <div class="preview-placeholder">
                    <i class="fas fa-image fa-3x"></i>
                    <span>·∫¢nh s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y</span>
                </div>
            `;
            imagePreviewContainer.parentElement.classList.remove('has-logo');
        }
        document.getElementById('categoryImage').value = '';
        
        const categoryInput = document.getElementById('categoryImageInput');
        if (categoryInput) categoryInput.value = '';
    }

    // Load existing images for edit mode
    loadBrandImageForEdit(imageUrl) {
        if (imageUrl) {
            console.log('üì• Loading brand image for edit:', imageUrl);
            this.updateBrandLogoPreview(imageUrl);
            document.getElementById('brandLogo').value = imageUrl;
            
            const previewArea = document.getElementById('brandLogoUploadArea');
            const placeholder = previewArea?.querySelector('.upload-placeholder');
            const preview = document.getElementById('brandLogoPreview');
            const previewImg = document.getElementById('brandLogoPreviewImg');

            if (previewImg && preview && placeholder) {
                previewImg.src = imageUrl;
                placeholder.style.display = 'none';
                preview.style.display = 'block';
            }
        }
    }

    loadCategoryImageForEdit(imageUrl) {
        if (imageUrl) {
            console.log('üì• Loading category image for edit:', imageUrl);
            this.updateCategoryImagePreview(imageUrl);
            document.getElementById('categoryImage').value = imageUrl;
            
            const previewArea = document.getElementById('categoryImageUploadArea');
            const placeholder = previewArea?.querySelector('.upload-placeholder');
            const preview = document.getElementById('categoryImagePreview');
            const previewImg = document.getElementById('categoryImagePreviewImg');

            if (previewImg && preview && placeholder) {
                previewImg.src = imageUrl;
                placeholder.style.display = 'none';
                preview.style.display = 'block';
            }
        }
    }

    showError(message) {
        Swal.fire({
            icon: 'error',
            title: 'L·ªói!',
            text: message,
            confirmButtonColor: '#667eea'
        });
    }

    getBrandImageData() {
        return this.brandImageFile;
    }

    getCategoryImageData() {
        return this.categoryImageFile;
    }

    reinitialize() {
        console.log('üîÑ Reinitializing upload manager...');
        this.brandEventsBound = false;
        this.categoryEventsBound = false;
        this.productEventsBound = false; // ‚Üê TH√äM D√íNG N√ÄY
        this.bindBrandEvents();
        this.bindCategoryEvents();
        this.bindProductEvents(); // ‚Üê TH√äM D√íNG N√ÄY
    }

    // Th√™m v√†o class SimpleImageUploadManager
    async deleteImageFromCloudinary(imageUrl) {
        try {
            console.log('üóëÔ∏è Deleting image from Cloudinary:', imageUrl);
            
            const response = await fetch('/api/upload/image', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ imageUrl: imageUrl })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to delete image');
            }

            const result = await response.json();
            console.log('‚úÖ Image deleted from Cloudinary:', result);
            return result;
            
        } catch (error) {
            console.error('‚ùå Error deleting image from Cloudinary:', error);
            throw error;
        }
    }

    // H√†m xo√° ·∫£nh kh·ªèi MongoDB
    async deleteImageFromMongoDB(productId, imageUrl) {
        try {
            console.log('üóëÔ∏è Removing image from MongoDB:', { productId, imageUrl });
            
            // L·∫•y document hi·ªán t·∫°i
            const mongoDoc = await ProductAPIService.getProductMongoDetail(productId);
            if (!mongoDoc.success || !mongoDoc.data) {
                throw new Error('Kh√¥ng t√¨m th·∫•y document MongoDB');
            }

            const currentData = mongoDoc.data;
            const currentImages = currentData.hinh_anh || [];

            // L·ªçc b·ªè ·∫£nh c·∫ßn xo√°
            const updatedImages = currentImages.filter(img => img !== imageUrl);

            // C·∫≠p nh·∫≠t document MongoDB
            const updateData = {
                hinh_anh: updatedImages,
                updatedAt: new Date()
            };

            const updateResult = await ProductAPIService.updateProductMongoDetail(
                currentData._id, 
                updateData
            );

            console.log('‚úÖ Image removed from MongoDB:', updateResult);
            return updateResult;
            
        } catch (error) {
            console.error('‚ùå Error removing image from MongoDB:', error);
            throw error;
        }
    }

    // H√†m xo√° ·∫£nh ho√†n ch·ªânh
    async deleteProductImage(index) {
        const imageToDelete = this.productImages[index];
        
        if (!imageToDelete) {
            console.error('‚ùå No image found at index:', index);
            return;
        }

        // Hi·ªÉn th·ªã confirm
        const result = await Swal.fire({
            title: 'X√°c nh·∫≠n x√≥a ·∫£nh',
            text: 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh n√†y? ·∫¢nh s·∫Ω ƒë∆∞·ª£c x√≥a kh·ªèi danh s√°ch v√† x√≥a vƒ©nh vi·ªÖn khi b·∫°n l∆∞u s·∫£n ph·∫©m.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'X√≥a',
            cancelButtonText: 'H·ªßy',
            customClass: {
                confirmButton: 'btn btn-danger',
                cancelButton: 'btn btn-secondary'
            }
        });

        if (result.isConfirmed) {
            // ƒê√°nh d·∫•u ·∫£nh c·∫ßn x√≥a (s·∫Ω x√≥a khi Save)
            if (imageToDelete.isExisting && imageToDelete.url) {
                // L∆∞u URL ƒë·ªÉ x√≥a sau khi Save
                if (!this.imagesToDelete) this.imagesToDelete = [];
                this.imagesToDelete.push(imageToDelete.url);
                console.log('üìù Marked image for deletion on save:', imageToDelete.url);
            }
            
            // Xo√° ·∫£nh kh·ªèi m·∫£ng hi·ªán t·∫°i
            this.productImages.splice(index, 1);

            // ƒêi·ªÅu ch·ªânh mainImageIndex n·∫øu c·∫ßn
            if (this.mainImageIndex === index) {
                this.mainImageIndex = 0;
                console.log('üîÑ Main image deleted, setting new main image index to 0');
            } else if (index < this.mainImageIndex) {
                this.mainImageIndex--;
                console.log('üîÑ Adjusted main image index to:', this.mainImageIndex);
            }

            // C·∫≠p nh·∫≠t preview
            this.renderProductImagesPreview();
            
            console.log(`üóëÔ∏è Deleted image index ${index}, remaining: ${this.productImages.length}`);
            this.showSuccess('ƒê√£ x√≥a ·∫£nh kh·ªèi danh s√°ch. Nh·ªõ l∆∞u ƒë·ªÉ x√≥a vƒ©nh vi·ªÖn.');
        }
    }
    
    bindVideoEvents() {
        if (this.videoEventsBound) return;

        const videosUploadArea = document.getElementById('productVideosUploadArea');
        const videosInput = document.getElementById('productVideosInput');
        const chooseBtn = document.getElementById('chooseProductVideosBtn');

        if (videosUploadArea && videosInput) {
            console.log('‚úÖ Binding video events...');

            // Remove any existing event listeners by cloning
            const newVideosUploadArea = videosUploadArea.cloneNode(true);
            videosUploadArea.parentNode.replaceChild(newVideosUploadArea, videosUploadArea);

            const newVideosInput = videosInput.cloneNode(true);
            videosInput.parentNode.replaceChild(newVideosInput, videosInput);

            // Clone n√∫t ch·ªçn t·ªáp ƒë·ªÉ x√≥a event listeners c≈©
            if (chooseBtn) {
                const newChooseBtn = chooseBtn.cloneNode(true);
                chooseBtn.parentNode.replaceChild(newChooseBtn, chooseBtn);
            }

            // Get new references
            const currentVideosUploadArea = document.getElementById('productVideosUploadArea');
            const currentVideosInput = document.getElementById('productVideosInput');
            const currentChooseBtn = document.getElementById('chooseProductVideosBtn');

            // Drag and drop events only (kh√¥ng c√≥ click v√†o v√πng upload)
            currentVideosUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                currentVideosUploadArea.classList.add('dragover');
            });

            currentVideosUploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                currentVideosUploadArea.classList.remove('dragover');
            });

            currentVideosUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                currentVideosUploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files).filter(file => this.isVideoFile(file));
                if (files.length > 0) {
                    this.processProductVideos(files);
                }
            });

            // Choose button
            if (currentChooseBtn) {
                currentChooseBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üîò Choose product videos button clicked');
                    currentVideosInput.click();
                });
            }

            // Input change
            currentVideosInput.addEventListener('change', (e) => {
                console.log('üì§ Product videos input changed');
                if (!e.target.files || e.target.files.length === 0) {
                    return; // Kh√¥ng c√≥ file n√†o ƒë∆∞·ª£c ch·ªçn
                }
                const files = Array.from(e.target.files).filter(file => this.isVideoFile(file));
                if (files.length > 0) {
                    this.processProductVideos(files);
                }
                // Reset value ƒë·ªÉ c√≥ th·ªÉ ch·ªçn l·∫°i c√πng file
                e.target.value = null;
            });

            this.videoEventsBound = true;
        }
    }

    // Th√™m ph∆∞∆°ng th·ª©c x·ª≠ l√Ω video
    processProductVideos(files) {
        console.log('üé¨ Processing videos:', files);
        const validFiles = files.filter(file => this.validateVideoFile(file));
        console.log('‚úÖ Valid videos after filter:', validFiles);
        
        const remainingSlots = 5 - this.productVideos.length; // Gi·ªõi h·∫°n 5 video
        
        if (validFiles.length > remainingSlots) {
            this.showError(`Ch·ªâ c√≥ th·ªÉ th√™m t·ªëi ƒëa 5 video. B·∫°n ƒë√£ ch·ªçn ${validFiles.length} nh∆∞ng ch·ªâ c√≤n ${remainingSlots} ch·ªó tr·ªëng.`);
            validFiles.splice(remainingSlots);
        }

        validFiles.forEach(file => {
            if (this.productVideos.length < 5) {
                this.productVideos.push(file);
                console.log(`‚ûï Added video: ${file.name}`);
            }
        });

        console.log(`üìä Current productVideos array:`, this.productVideos);
        this.renderProductVideosPreview();
        console.log(`‚úÖ Added ${validFiles.length} videos, total: ${this.productVideos.length}`);
    }

    // Th√™m ph∆∞∆°ng th·ª©c hi·ªÉn th·ªã preview video
    renderProductVideosPreview() {
        const previewSection = document.getElementById('productVideosPreview');
        const previewGrid = document.getElementById('productVideosPreviewGrid');
        const emptyState = document.getElementById('productVideosUploadArea');

        if (!previewGrid || !previewSection || !emptyState) {
            console.warn('‚ö†Ô∏è Video preview elements not found:', { previewGrid: !!previewGrid, previewSection: !!previewSection, emptyState: !!emptyState });
            return;
        }

        console.log(`üé¨ Rendering ${this.productVideos.length} product videos`);
        previewGrid.innerHTML = '';

        // N·∫øu kh√¥ng c√≥ video, hi·ªán empty state
        if (this.productVideos.length === 0) {
            console.log('üì≠ No videos - showing empty state');
            previewSection.classList.add('hidden');
            previewSection.style.display = 'none';
            emptyState.classList.remove('hidden');
            emptyState.style.display = '';
            return;
        }

        // C√≥ video, hi·ªán preview section v√† ·∫©n empty state
        console.log('üìπ Has videos - showing preview section');
        previewSection.classList.remove('hidden');
        previewSection.style.display = 'block'; // Force show
        emptyState.classList.add('hidden');
        emptyState.style.display = 'none'; // Force hide

        this.productVideos.forEach((file, index) => {
            const videoItem = document.createElement('div');
            videoItem.className = 'video-preview-item';
            videoItem.style.position = 'relative';
            videoItem.style.marginBottom = '10px';
            videoItem.style.padding = '10px';
            videoItem.style.border = '1px solid #e0e0e0';
            videoItem.style.borderRadius = '8px';
            videoItem.style.backgroundColor = '#f9f9f9';
            
            if (file instanceof File) {
                // Video m·ªõi ƒë∆∞·ª£c ch·ªçn
                console.log(`üìπ Creating preview for new video file: ${file.name}`);
                
                const videoElement = document.createElement('video');
                videoElement.controls = true;
                videoElement.preload = 'metadata';
                videoElement.style.width = '100%';
                videoElement.style.maxHeight = '200px';
                videoElement.style.borderRadius = '8px';
                videoElement.style.backgroundColor = '#000';
                
                const source = document.createElement('source');
                source.src = URL.createObjectURL(file);
                source.type = file.type;
                videoElement.appendChild(source);

                const videoInfo = document.createElement('div');
                videoInfo.className = 'video-info';
                videoInfo.style.marginTop = '8px';
                videoInfo.style.padding = '5px';
                videoInfo.innerHTML = `
                    <div class="video-name" style="font-size: 13px; font-weight: 500; color: #333; margin-bottom: 3px;">${file.name}</div>
                    <div class="video-size" style="font-size: 12px; color: #666;">${this.formatFileSize(file.size)}</div>
                `;

                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-sm btn-danger';
                removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                removeBtn.title = 'X√≥a video';
                removeBtn.type = 'button';
                removeBtn.style.position = 'absolute';
                removeBtn.style.top = '10px';
                removeBtn.style.right = '10px';
                removeBtn.style.zIndex = '10';
                removeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.deleteProductVideo(index);
                });

                videoItem.appendChild(videoElement);
                videoItem.appendChild(videoInfo);
                videoItem.appendChild(removeBtn);
                
            } else if (file.url) {
                // Video hi·ªán c√≥ t·ª´ MongoDB
                videoItem.innerHTML = this.getVideoPreviewHTML(file.url, index, file);
            }

            previewGrid.appendChild(videoItem);
        });

        console.log('‚úÖ Video preview rendered successfully');
        console.log('üìä Preview section display:', previewSection.style.display);
        console.log('üìä Preview grid children count:', previewGrid.children.length);
    }

    // Th√™m ph∆∞∆°ng th·ª©c x√≥a video
    async deleteProductVideo(index) {
        const videoToDelete = this.productVideos[index];
        
        if (!videoToDelete) {
            console.error('‚ùå No video found at index:', index);
            return;
        }

        // Hi·ªÉn th·ªã confirm
        const result = await Swal.fire({
            title: 'X√°c nh·∫≠n x√≥a video',
            text: 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a video n√†y? Video s·∫Ω ƒë∆∞·ª£c x√≥a kh·ªèi danh s√°ch v√† x√≥a vƒ©nh vi·ªÖn khi b·∫°n l∆∞u s·∫£n ph·∫©m.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'X√≥a',
            cancelButtonText: 'H·ªßy',
            customClass: {
                confirmButton: 'btn btn-danger',
                cancelButton: 'btn btn-secondary'
            }
        });

        if (result.isConfirmed) {
            // ƒê√°nh d·∫•u video c·∫ßn x√≥a (s·∫Ω x√≥a khi Save)
            if (videoToDelete.url && !(videoToDelete instanceof File)) {
                // L∆∞u URL ƒë·ªÉ x√≥a sau khi Save
                if (!this.videosToDelete) this.videosToDelete = [];
                this.videosToDelete.push(videoToDelete.url);
                console.log('üìù Marked video for deletion on save:', videoToDelete.url);
            }
            
            // X√≥a video kh·ªèi m·∫£ng
            this.productVideos.splice(index, 1);
            
            console.log(`üóëÔ∏è Deleted video index ${index}, remaining: ${this.productVideos.length}`);
            
            // Re-render preview
            this.renderProductVideosPreview();
            this.showSuccess('ƒê√£ x√≥a video kh·ªèi danh s√°ch. Nh·ªõ l∆∞u ƒë·ªÉ x√≥a vƒ©nh vi·ªÖn.');
        }
    }

    // Th√™m ph∆∞∆°ng th·ª©c upload video
    async uploadProductVideos() {
        if (this.productVideos.length === 0) {
            console.log('‚ÑπÔ∏è No videos to upload');
            return [];
        }

        try {
            console.log(`‚¨ÜÔ∏è Starting upload for ${this.productVideos.length} videos...`);
            
            // Ch·ªâ upload nh·ªØng video m·ªõi (File objects)
            const newVideos = this.productVideos.filter(video => video instanceof File);
            
            if (newVideos.length === 0) {
                // Tr·∫£ v·ªÅ URLs c·ªßa video hi·ªán c√≥
                const existingVideoUrls = this.productVideos
                    .filter(video => video.url && !(video instanceof File))
                    .map(video => video.url);
                return existingVideoUrls;
            }

            const formData = new FormData();
            newVideos.forEach((file, index) => {
                formData.append('productVideos', file);
            });
            
            // L·∫•y th√¥ng tin s·∫£n ph·∫©m
            const productId = window.currentEditId || document.getElementById('productId')?.value || null;
            const productName = document.getElementById('productName')?.value?.trim() || 'product';
            // T·∫°o folder name: ten-san-pham-productId
            const folderName = productId ? `${productName.toLowerCase().replace(/\s+/g, '-')}-${productId}` : `${productName.toLowerCase().replace(/\s+/g, '-')}-${Date.now()}`;
            
            console.log('üé• Upload videos to folder:', folderName);
            
            formData.append('productId', folderName); // G·ª≠i folder name

            const response = await fetch('/api/upload/product-videos', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || `Upload failed with status: ${response.status}`);
            }

            const result = await response.json();
            
            if (result.success && result.data && Array.isArray(result.data)) {
                const videoUrls = result.data.map(item => item.url);
                
                // Th√™m URLs c·ªßa video hi·ªán c√≥
                const existingVideoUrls = this.productVideos
                    .filter(video => video.url && !(video instanceof File))
                    .map(video => video.url);
                
                const allVideoUrls = videoUrls.concat(existingVideoUrls);
                
                console.log('‚úÖ Videos uploaded successfully:', allVideoUrls);
                return allVideoUrls;
            } else {
                throw new Error(result.message || 'Upload failed - no URLs returned');
            }

        } catch (error) {
            console.error('‚ùå Error uploading product videos:', error);
            throw error;
        }
    }

    // Th√™m ph∆∞∆°ng th·ª©c reset video
    resetProductVideos() {
        this.productVideos = [];
        
        const previewContainer = document.getElementById('productVideosPreview');
        const previewGrid = document.getElementById('productVideosPreviewGrid');
        const placeholder = document.querySelector('#productVideosUploadArea .upload-placeholder');

        if (previewContainer) previewContainer.style.display = 'none';
        if (previewGrid) previewGrid.innerHTML = '';
        if (placeholder) placeholder.style.display = 'block';

        const videosInput = document.getElementById('productVideosInput');
        if (videosInput) videosInput.value = '';

        console.log('üîÑ Reset product videos');
    }

    // Th√™m ph∆∞∆°ng th·ª©c ki·ªÉm tra file video
    isVideoFile(file) {
        return file && file.type.startsWith('video/');
    }

    // Th√™m ph∆∞∆°ng th·ª©c validate video
    validateVideoFile(file) {
        const maxSize = 50 * 1024 * 1024; // 50MB
        const allowedTypes = ['video/mp4', 'video/avi', 'video/mov', 'video/quicktime', 'video/webm'];

        console.log('üîç Validating video:', { name: file.name, type: file.type, size: file.size });

        if (!file) {
            console.error('‚ùå No file provided');
            return false;
        }

        if (!allowedTypes.includes(file.type)) {
            console.error('‚ùå Invalid video type:', file.type);
            this.showError(`Ch·ªâ ch·∫•p nh·∫≠n file video ƒë·ªãnh d·∫°ng MP4, MOV, AVI ho·∫∑c WebM. File c·ªßa b·∫°n: ${file.type}`);
            return false;
        }

        if (file.size > maxSize) {
            console.error('‚ùå File too large:', file.size);
            this.showError(`K√≠ch th∆∞·ªõc file video kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 50MB. File c·ªßa b·∫°n: ${this.formatFileSize(file.size)}`);
            return false;
        }

        console.log('‚úÖ Video validated successfully');
        return true;
    }

    // Th√™m ph∆∞∆°ng th·ª©c ƒë·ªãnh d·∫°ng k√≠ch th∆∞·ªõc file
    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Th√™m ph∆∞∆°ng th·ª©c x√≥a video t·ª´ h·ªá th·ªëng
    async deleteVideoFromSystem(videoUrl, productId) {
        try {
            console.log('üóëÔ∏è Deleting video from system:', videoUrl);
            
            // X√≥a t·ª´ Cloudinary
            await this.deleteVideoFromCloudinary(videoUrl);
            
            // X√≥a t·ª´ MongoDB
            await this.deleteVideoFromMongoDB(productId, videoUrl);
            
        } catch (error) {
            console.error('‚ùå Error deleting video from system:', error);
            throw error;
        }
    }

    async deleteVideoFromCloudinary(videoUrl) {
        try {
            const response = await fetch('/api/upload/video', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ videoUrl: videoUrl })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to delete video');
            }

            return await response.json();
        } catch (error) {
            console.error('‚ùå Error deleting video from Cloudinary:', error);
            throw error;
        }
    }

    async deleteVideoFromMongoDB(productId, videoUrl) {
        try {
            const mongoDoc = await ProductAPIService.getProductMongoDetail(productId);
            if (!mongoDoc.success || !mongoDoc.data) {
                throw new Error('Kh√¥ng t√¨m th·∫•y document MongoDB');
            }

            const currentData = mongoDoc.data;
            const currentVideos = currentData.videos || [];

            const updatedVideos = currentVideos.filter(vid => vid !== videoUrl);

            const updateData = {
                videos: updatedVideos,
                updatedAt: new Date()
            };

            await ProductAPIService.updateProductMongoDetail(
                currentData._id, 
                updateData
            );

        } catch (error) {
            console.error('‚ùå Error removing video from MongoDB:', error);
            throw error;
        }
    }

    // Th√™m ph∆∞∆°ng th·ª©c load video hi·ªán c√≥
    loadExistingVideos(existingData = {}) {
        const { videos = [] } = existingData;
        
        if (videos.length === 0) return;

        console.log('üì• Loading existing videos:', videos);
        
        this.productVideos = [];

        videos.forEach((url, index) => {
            const mockVideo = {
                name: `existing_video_${index + 1}.mp4`,
                type: 'video/mp4',
                size: 0,
                url: url,
                isExisting: true
            };
            this.productVideos.push(mockVideo);
        });

        this.renderProductVideosPreview();
        console.log(`‚úÖ Loaded ${this.productVideos.length} videos`);
    }

    // C·∫≠p nh·∫≠t ph∆∞∆°ng th·ª©c reinitialize
    reinitialize() {
        console.log('üîÑ Reinitializing upload manager...');
        this.brandEventsBound = false;
        this.categoryEventsBound = false;
        this.productEventsBound = false;
        this.videoEventsBound = false; // Th√™m d√≤ng n√†y
        this.bindBrandEvents();
        this.bindCategoryEvents();
        this.bindProductEvents();
        this.bindVideoEvents(); // Th√™m d√≤ng n√†y
    }
    
    // C·∫≠p nh·∫≠t h√†m getImagePreviewHTML
    getImagePreviewHTML(imageSrc, index, file) {
        const isExisting = file.isExisting;
        
        return `
            <img src="${imageSrc}" alt="Preview ${index + 1}">
            <div class="image-preview-actions">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="mainImage" 
                        id="mainImage${index}" 
                        ${index === this.mainImageIndex ? 'checked' : ''}
                        onchange="window.simpleImageUploadManager.setMainImage(${index})">
                    <label class="form-check-label" for="mainImage${index}">
                        ·∫¢nh ch√≠nh
                    </label>
                </div>
                <div class="action-buttons">
                    <button type="button" class="btn-view-image" 
                        onclick="window.simpleImageUploadManager.viewFullImage('${imageSrc}')"
                        title="Xem ·∫£nh l·ªõn">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button type="button" class="btn-delete-image" 
                        onclick="window.simpleImageUploadManager.deleteProductImage(${index})"
                        title="${isExisting ? 'X√≥a ·∫£nh vƒ©nh vi·ªÖn' : 'X√≥a ·∫£nh'}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            ${isExisting ? '<div class="existing-badge">ƒêang c√≥</div>' : ''}
        `;
    }

    // H√†m t·∫°o HTML preview cho video
    getVideoPreviewHTML(videoSrc, index, file) {
        const isExisting = file.isExisting;
        
        return `
            <video controls preload="metadata" style="max-width: 100%; max-height: 120px;">
                <source src="${videoSrc}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <div class="video-info">
                <div class="video-name">${file.name || 'existing_video.mp4'}</div>
                ${file.size ? `<div class="video-size">${this.formatFileSize(file.size)}</div>` : ''}
            </div>
            <button type="button" class="btn-delete-video" 
                onclick="window.simpleImageUploadManager.deleteProductVideo(${index})"
                title="${isExisting ? 'X√≥a video vƒ©nh vi·ªÖn' : 'X√≥a video'}">
                <i class="fas fa-trash"></i>
            </button>
            ${isExisting ? '<div class="existing-badge">ƒêang c√≥</div>' : ''}
        `;
    }

    // Th√™m h√†m xem ·∫£nh l·ªõn
    viewFullImage(imageUrl) {
        // T·∫°o modal xem ·∫£nh l·ªõn
        const modalHtml = `
            <div class="modal fade" id="imageViewerModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-image"></i>
                                Xem ·∫£nh
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img src="${imageUrl}" alt="Full size" style="max-width: 100%; max-height: 70vh;">
                        </div>
                        <div class="modal-footer">
                            <a href="${imageUrl}" target="_blank" class="btn btn-primary">
                                <i class="fas fa-external-link-alt"></i>
                                M·ªü ·∫£nh g·ªëc
                            </a>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times"></i>
                                ƒê√≥ng
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Th√™m modal v√†o body n·∫øu ch∆∞a c√≥
        let modal = document.getElementById('imageViewerModal');
        if (!modal) {
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            modal = document.getElementById('imageViewerModal');
        } else {
            // C·∫≠p nh·∫≠t ·∫£nh
            modal.querySelector('img').src = imageUrl;
            modal.querySelector('a').href = imageUrl;
        }

        // Hi·ªÉn th·ªã modal
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    }
    }


const videoPreviewCSS = `
.video-preview-item {
    position: relative;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 8px;
    background: white;
    transition: all 0.2s ease;
}

.video-preview-item:hover {
    border-color: #3b82f6;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
}

.video-preview-item video {
    width: 100%;
    border-radius: 4px;
    background: #000;
}

.video-info {
    margin-top: 8px;
    font-size: 12px;
}

.video-name {
    font-weight: 500;
    color: #374151;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.video-size {
    color: #6b7280;
    font-size: 11px;
}

.btn-delete-video {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 24px;
    height: 24px;
    border: none;
    border-radius: 4px;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 10px;
    transition: all 0.2s ease;
}

.btn-delete-video:hover {
    background: #dc2626;
    transform: scale(1.1);
}

.existing-badge {
    position: absolute;
    top: 8px;
    left: 8px;
    background: rgba(34, 197, 94, 0.9);
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: bold;
    z-index: 10;
}
`;

// Th√™m CSS v√†o document
const styleElements = document.querySelector('style');
if (styleElements) {
    styleElements.textContent += videoPreviewCSS;
} else {
    const style = document.createElement('style');
    style.textContent = videoPreviewCSS;
    document.head.appendChild(style);
}

// C·∫≠p nh·∫≠t s·ª± ki·ªán cho product modal ƒë·ªÉ bind video events
document.addEventListener('DOMContentLoaded', function() {
    const productModal = document.getElementById('productModal');
    if (productModal) {
        productModal.addEventListener('show.bs.modal', () => {
            console.log('üì¶ Product modal shown - initializing upload and video events');
            setTimeout(() => {
                if (window.simpleImageUploadManager) {
                    window.simpleImageUploadManager.removeProductEventListeners();
                    window.simpleImageUploadManager.productEventsBound = false;
                    window.simpleImageUploadManager.videoEventsBound = false; // TH√äM D√íNG N√ÄY
                    window.simpleImageUploadManager.bindProductEvents();
                    window.simpleImageUploadManager.bindVideoEvents(); // TH√äM D√íNG N√ÄY
                }
            }, 300);
        });
    }
});



// Update HTML structure for Category Modal to fix preview issue
const categoryModalHTMLFix = `
<!-- Replace the Image Preview section in Category Modal with this -->
<div class="image-preview-section mt-3">
    <label class="form-label">Preview ·∫¢nh</label>
    <div class="logo-preview-container">
        <div class="logo-preview" id="categoryImagePreviewContainer">
            <div class="preview-placeholder">
                <i class="fas fa-image fa-3x"></i>
                <span>·∫¢nh s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y</span>
            </div>
        </div>
    </div>
</div>
`;

// Update the updateCategoryImagePreview method to use new ID
SimpleImageUploadManager.prototype.updateCategoryImagePreview = function(imageUrl) {
    // Use the new container ID
    const imagePreviewContainer = document.getElementById('categoryImagePreviewContainer');
    if (imagePreviewContainer) {
        console.log('‚úÖ Updating category image preview container');
        imagePreviewContainer.innerHTML = '';
        const img = document.createElement('img');
        img.src = imageUrl;
        img.alt = 'Category Image Preview';
        img.style.maxWidth = '100%';
        img.style.maxHeight = '100px';
        img.style.objectFit = 'contain';
        imagePreviewContainer.appendChild(img);
        imagePreviewContainer.parentElement.classList.add('has-logo');
    } else {
        console.error('‚ùå Category image preview container not found');
    }
};

// Update resetCategoryImage to use new ID
SimpleImageUploadManager.prototype.resetCategoryImage = function() {
    this.categoryImageFile = null;
    const previewArea = document.getElementById('categoryImageUploadArea');
    const placeholder = previewArea?.querySelector('.upload-placeholder');
    const preview = document.getElementById('categoryImagePreview');
    const imagePreviewContainer = document.getElementById('categoryImagePreviewContainer');

    if (preview) preview.style.display = 'none';
    if (placeholder) placeholder.style.display = 'block';
    if (imagePreviewContainer) {
        imagePreviewContainer.innerHTML = `
            <div class="preview-placeholder">
                <i class="fas fa-image fa-3x"></i>
                <span>·∫¢nh s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y</span>
            </div>
        `;
        imagePreviewContainer.parentElement.classList.remove('has-logo');
    }
    document.getElementById('categoryImage').value = '';
    
    const categoryInput = document.getElementById('categoryImageInput');
    if (categoryInput) categoryInput.value = '';
};

// Enhanced CSS for better preview display
const enhancedPreviewCSS = `
/* Ensure preview containers work properly */
.logo-preview-container {
    border: 2px dashed var(--gray-300);
    border-radius: 10px;
    padding: 12px;
    background: white;
    transition: var(--transition);
    min-height: 110px;
    display: inline-block;
    vertical-align: top;
    width: 62%;
    box-sizing: border-box;
}

.logo-preview-container.has-logo {
    border-color: var(--primary);
    background: var(--gray-50);
    padding: 10px;
}

.logo-preview {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.logo-preview img {
    max-width: 100%;
    max-height: 180px;
    border-radius: 6px;
    object-fit: contain;
}

.preview-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    color: var(--gray-500);
    text-align: center;
}

.preview-placeholder i {
    font-size: 2rem;
    color: var(--gray-300);
}

/* Upload area improvements */
.file-upload-area {
    position: relative;
    cursor: pointer;
    min-height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 8px;
}

.upload-preview {
    text-align: center;
}

.upload-preview img {
    max-width: 100%;
    max-height: 70%;
    border-radius: 8px;
    margin-bottom: 10px;
}

.btn-change-image {
    background: var(--primary);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: var(--transition);
}

.btn-change-image:hover {
    background: var(--primary-dark);
}

/* Fix for multiple event binding */
.file-upload-area * {
    pointer-events: none;
}

.btn-change-image {
    pointer-events: all !important;
}

input[type="file"] {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
}

/* Layout: make upload area compact and preview beside it */
.file-upload-container {
    display: grid;
    gap: 6px;
    align-items: center;
    width: 100%;
    box-sizing: border-box;
    min-height: 340px; /* tƒÉng chi·ªÅu cao v√πng upload */
    padding: 0px;
}

.file-upload-container > .file-upload-area {
    width: 22%;
    box-sizing: border-box;
}

.file-upload-container > .logo-preview-container {
    width: 80%;
    box-sizing: border-box;
    margin: 0;
}

/* Smaller choose button for brand logo */
#chooseBrandLogoBtn {
    pointer-events: all !important;
    padding: 6px 8px;
    font-size: 0.85rem;
    border-radius: 6px;
    background: var(--gray-100);
    color: var(--dark);
    border: 1px solid var(--gray-300);
    white-space: nowrap;
}

#chooseBrandLogoBtn i {
    font-size: 0.85rem;
}

/* Smaller choose button for category image (match brand) */
#chooseCategoryImageBtn {
    pointer-events: all !important;
    padding: 6px 8px;
    font-size: 0.85rem;
    border-radius: 6px;
    background: var(--gray-100);
    color: var(--dark);
    border: 1px solid var(--gray-300);
    white-space: nowrap;
}

#chooseCategoryImageBtn i {
    font-size: 0.85rem;
}

/* Ensure preview container sits to the right of upload area when space permits */
.logo-preview-container { margin-left: 12px; }
`;
// C·∫≠p nh·∫≠t CSS - th√™m v√†o ph·∫ßn style hi·ªán c√≥
const updatedImagePreviewCSS = `
    .image-preview-item {
        position: relative;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 8px;
        background: white;
        transition: all 0.2s ease;
    }

    .image-preview-item:hover {
        border-color: #3b82f6;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
    }

    .image-preview-item.main-image {
        border: 2px solid #3b82f6;
        background: #f0f9ff;
    }

    .image-preview-item img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 4px;
    }

    .image-preview-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 8px;
    }

    .action-buttons {
        display: flex;
        gap: 4px;
    }

    .btn-view-image, .btn-delete-image {
        width: 28px;
        height: 28px;
        border: none;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s ease;
    }

    .btn-view-image {
        background: #10b981;
        color: white;
    }

    .btn-view-image:hover {
        background: #059669;
    }

    .btn-delete-image {
        background: #ef4444;
        color: white;
    }

    .btn-delete-image:hover {
        background: #dc2626;
    }

    .existing-badge {
        position: absolute;
        top: 8px;
        left: 8px;
        background: rgba(34, 197, 94, 0.9);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: bold;
        z-index: 10;
    }

    .image-preview-item.main-image .existing-badge {
        background: rgba(59, 130, 246, 0.9);
    }

    .form-check {
        margin: 0;
    }

    .form-check-input {
        margin-right: 4px;
    }

    .form-check-label {
        font-size: 12px;
        color: #6b7280;
    }

    /* Modal xem ·∫£nh l·ªõn */
    #imageViewerModal .modal-body img {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
`;

// C·∫≠p nh·∫≠t CSS
const styleElement = document.querySelector('style');
if (styleElement) {
    styleElement.textContent += updatedImagePreviewCSS;
} else {
    const style = document.createElement('style');
    style.textContent = updatedImagePreviewCSS;
    document.head.appendChild(style);
}

// Add CSS to document
const style = document.createElement('style');
style.textContent = enhancedPreviewCSS;
document.head.appendChild(style);

// Initialize with modal event listeners
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initializing Enhanced Image Upload Manager...');
    window.simpleImageUploadManager = new SimpleImageUploadManager();
    
    // Reinitialize when modals are shown
    const brandModal = document.getElementById('brandModal');
    const categoryModal = document.getElementById('categoryModal');
    
    [brandModal, categoryModal].forEach(modal => {
        if (modal) {
            modal.addEventListener('show.bs.modal', () => {
                setTimeout(() => {
                    window.simpleImageUploadManager?.reinitialize();
                }, 100);
            });
        }
    });
    // Reinitialize when product modal is shown
    const productModal = document.getElementById('productModal');
    if (productModal) {
        productModal.addEventListener('show.bs.modal', () => {
            console.log('üì¶ Product modal shown - initializing upload events');
            setTimeout(() => {
                if (window.simpleImageUploadManager) {
                    window.simpleImageUploadManager.removeProductEventListeners();
                    window.simpleImageUploadManager.productEventsBound = false;
                    window.simpleImageUploadManager.bindProductEvents();
                }
            }, 300); // TƒÉng delay ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ render xong
        });
        
        productModal.addEventListener('hidden.bs.modal', () => {
            console.log('üì¶ Product modal hidden - resetting product images');
            // Reset product images when modal is closed
            if (window.simpleImageUploadManager) {
                window.simpleImageUploadManager.resetProductImages();
            }
        });
    }
});
// JavaScript ƒë·ªÉ qu·∫£n l√Ω th√¥ng s·ªë s·∫£n ph·∫©m v·ªõi k√©o th·∫£
class ProductSpecsManager {
    constructor() {
        this.specs = [];
        this.sortable = null;
        this.init();
    }

    init() {
        this.bindEvents();
        this.initSortable();
    }

    // H√†m auto-resize textarea
    autoResizeTextarea(textarea) {
        // Reset v·ªÅ 0 tr∆∞·ªõc ƒë·ªÉ t√≠nh to√°n ch√≠nh x√°c
        textarea.style.height = '0px';
        textarea.style.height = 'auto';
        
        // T√≠nh chi·ªÅu cao d·ª±a tr√™n scrollHeight (bao g·ªìm t·∫•t c·∫£ n·ªôi dung)
        const scrollHeight = textarea.scrollHeight;
        const minHeight = 38; // Chi·ªÅu cao t·ªëi thi·ªÉu
        textarea.style.height = Math.max(scrollHeight, minHeight) + 'px';
    }

    bindEvents() {
        // Th√™m th√¥ng s·ªë m·ªõi
        document.getElementById('addProductSpecBtn')?.addEventListener('click', () => {
            this.addNewSpec();
        });

        // Event delegation cho c√°c n√∫t x√≥a v√† ch·ªânh s·ª≠a
        document.addEventListener('click', (e) => {
            if (e.target.closest('.btn-edit-spec')) {
                this.enableEditMode(e.target.closest('.btn-edit-spec'));
            }
            if (e.target.closest('.btn-save-spec')) {
                this.saveSpecEdit(e.target.closest('.btn-save-spec'));
            }
            if (e.target.closest('.btn-delete-spec')) {
                this.deleteSpec(e.target.closest('.btn-delete-spec'));
            }
        });

        // T·ª± ƒë·ªông c·∫≠p nh·∫≠t specs khi ng∆∞·ªùi d√πng nh·∫≠p trong c√°c input
        document.addEventListener('input', (e) => {
            if (e.target.classList.contains('spec-key-input') || e.target.classList.contains('spec-value-input')) {
                const row = e.target.closest('tr');
                if (row) {
                    const specId = row.getAttribute('data-spec-id');
                    const keyInput = row.querySelector('.spec-key-input');
                    const valueInput = row.querySelector('.spec-value-input');
                    
                    const spec = this.specs.find(s => s.id == specId);
                    if (spec) {
                        spec.key = keyInput.value;
                        spec.value = valueInput.value;
                    }
                }
            }
            
            // Auto-resize textarea
            if (e.target.classList.contains('auto-resize')) {
                this.autoResizeTextarea(e.target);
            }
        });
    }


    initSortable() {
        const tbody = document.getElementById('productSpecsBody');
        if (!tbody) return;

        this.sortable = Sortable.create(tbody, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            onEnd: (evt) => {
                // C·∫≠p nh·∫≠t th·ª© t·ª± trong m·∫£ng specs
                const items = Array.from(tbody.children);
                this.specs = items.map(item => {
                    const specId = item.getAttribute('data-spec-id');
                    return this.specs.find(spec => spec.id == specId);
                }).filter(spec => spec !== undefined);
                
                console.log('Th·ª© t·ª± m·ªõi:', this.specs);
            }
        });
    }

    addNewSpec(key = '', value = '') {
        const specId = 'spec_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const newSpec = {
            id: specId,
            key: key,
            value: value
        };

        this.specs.push(newSpec);
        this.renderSpecsTable();
        
        console.log('‚ûï Added new spec:', newSpec);
    }

    enableEditMode(button) {
        const row = button.closest('tr');
        const specKey = row.getAttribute('data-spec-key');
        
        if (!specKey) return;

        // L·∫•y cells
        const keyCell = row.querySelector('.spec-key');
        const valueCell = row.querySelector('.spec-value');
        const actionsCell = row.querySelector('.spec-actions');
        
        const currentKey = keyCell.textContent.trim();
        const currentValue = valueCell.textContent.trim();
        
        // Chuy·ªÉn cells th√†nh input
        keyCell.innerHTML = `<input type="text" class="form-control form-control-sm" value="${currentKey}" data-original="${currentKey}">`;
        valueCell.innerHTML = `<input type="text" class="form-control form-control-sm" value="${currentValue}" data-original="${currentValue}">`;
        
        // ƒê·ªïi n√∫t Edit th√†nh Save
        actionsCell.innerHTML = `
            <button class="btn btn-sm btn-success btn-action-modern btn-save-spec" title="L∆∞u">
                <i class="fas fa-check"></i>
            </button>
            <button class="btn btn-sm btn-danger btn-action-modern btn-delete-spec" title="X√≥a">
                <i class="fas fa-trash-alt"></i>
            </button>
        `;
        
        // Focus v√†o input value
        valueCell.querySelector('input')?.focus();
    }

    async saveSpecEdit(button) {
        const row = button.closest('tr');
        const keyCell = row.querySelector('.spec-key');
        const valueCell = row.querySelector('.spec-value');
        const actionsCell = row.querySelector('.spec-actions');
        
        const keyInput = keyCell.querySelector('input');
        const valueInput = valueCell.querySelector('input');
        
        if (!keyInput || !valueInput) return;
        
        const newKey = keyInput.value.trim();
        const newValue = valueInput.value.trim();
        
        if (!newKey || !newValue) {
            alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n v√† gi√° tr·ªã th√¥ng s·ªë');
            return;
        }
        
        // C·∫≠p nh·∫≠t l·∫°i attribute
        row.setAttribute('data-spec-key', newKey);
        
        // Chuy·ªÉn input th√†nh text
        keyCell.innerHTML = newKey;
        valueCell.innerHTML = newValue;
        
        // ƒê·ªïi n√∫t Save th√†nh Edit
        actionsCell.innerHTML = `
            <button class="btn btn-sm btn-primary btn-action-modern btn-edit-spec" title="S·ª≠a th√¥ng s·ªë">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-danger btn-action-modern btn-delete-spec" title="X√≥a">
                <i class="fas fa-trash-alt"></i>
            </button>
        `;
        
        console.log('‚úÖ Spec updated:', { key: newKey, value: newValue });
        
        // N·∫øu ƒëang ch·ªânh s·ª≠a s·∫£n ph·∫©m c√≥ s·∫µn, l∆∞u ngay v√†o MongoDB
        const productIdInput = document.getElementById('productId');
        const mongoDetailIdInput = document.getElementById('mongoDetailId');
        
        console.log('üîç Checking IDs:', {
            productId: productIdInput?.value,
            mongoDetailId: mongoDetailIdInput?.value
        });
        
        if (productIdInput && productIdInput.value && mongoDetailIdInput && mongoDetailIdInput.value) {
            const productId = productIdInput.value;
            try {
                // L·∫•y t·∫•t c·∫£ specs hi·ªán t·∫°i t·ª´ b·∫£ng
                const updatedSpecs = this.getSpecsData();
                
                console.log('üíæ Saving specs to MongoDB...', { productId, updatedSpecs });
                
                // L∆∞u v√†o MongoDB th√¥ng qua API
                await ProductAPIService.updateProductSpecs(productId, updatedSpecs);
                
                console.log('‚úÖ Saved to MongoDB successfully!');
                
                // Hi·ªÉn th·ªã th√¥ng b√°o
                const toast = document.createElement('div');
                toast.className = 'toast-notification success';
                toast.innerHTML = '<i class="fas fa-check-circle"></i> ƒê√£ l∆∞u v√†o MongoDB';
                toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 20px; border-radius: 8px; z-index: 99999; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
            } catch (error) {
                console.error('‚ùå MongoDB save error:', error);
                alert('L·ªói khi l∆∞u v√†o MongoDB: ' + error.message);
            }
        } else {
            console.log('‚ÑπÔ∏è Product ID or MongoDB Detail ID not found - this is a new product, will save when form is submitted');
        }
    }

    deleteSpec(button) {
        const row = button.closest('tr');
        const specId = row.getAttribute('data-spec-id');
        
        this.specs = this.specs.filter(s => s.id != specId);
        this.renderSpecsTable();
    }

    renderSpecsTable() {
        const tbody = document.getElementById('productSpecsBody');
        if (!tbody) return;

        tbody.innerHTML = '';

        if (this.specs.length === 0) {
            tbody.innerHTML = `
                <tr class="specs-empty-state">
                    <td colspan="4">
                        <i class="fas fa-cogs"></i>
                        <p>Ch∆∞a c√≥ th√¥ng s·ªë k·ªπ thu·∫≠t</p>
                        <small>Nh·∫•n "Th√™m th√¥ng s·ªë" ƒë·ªÉ b·∫Øt ƒë·∫ßu</small>
                    </td>
                </tr>
            `;
            return;
        }

        this.specs.forEach(spec => {
            const row = document.createElement('tr');
            row.setAttribute('data-spec-id', spec.id);
            row.innerHTML = `
                <td>
                    <div class="drag-handle" title="K√©o ƒë·ªÉ s·∫Øp x·∫øp">
                        <i class="fas fa-bars"></i>
                    </div>
                </td>
                <td>
                    <textarea class="form-control spec-key-input auto-resize" rows="1"
                        placeholder="Nh·∫≠p t√™n th√¥ng s·ªë (v√≠ d·ª•: M√†n h√¨nh, RAM)">${spec.key || ''}</textarea>
                </td>
                <td>
                    <textarea class="form-control spec-value-input auto-resize" rows="1"
                        placeholder="Nh·∫≠p gi√° tr·ªã (v√≠ d·ª•: 6.7 inch, 8GB)">${spec.value || ''}</textarea>
                </td>
                <td>
                    <div class="d-flex gap-1 justify-content-center">
                        <button type="button" class="btn btn-sm btn-danger btn-action-modern btn-delete-spec" title="X√≥a th√¥ng s·ªë">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });

        // Kh·ªüi t·∫°o l·∫°i Sortable sau khi render
        if (this.sortable) {
            this.sortable.destroy();
        }
        this.initSortable();
        
        // Auto-resize t·∫•t c·∫£ textarea sau khi render
        requestAnimationFrame(() => {
            tbody.querySelectorAll('.auto-resize').forEach(textarea => {
                this.autoResizeTextarea(textarea);
            });
        });
        
        console.log('üîÑ Rendered specs table with', this.specs.length, 'items');
    }

    getSpecsData() {
        console.log('üîß Getting specs data from manager...');
        
        // C√°ch 1: L·∫•y t·ª´ m·∫£ng specs (n·∫øu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t)
        const specsFromArray = this.specs
            .filter(spec => spec.key && spec.key.trim() !== '' && spec.value && spec.value.trim() !== '')
            .reduce((acc, spec) => {
                acc[spec.key.trim()] = spec.value.trim();
                return acc;
            }, {});

        console.log('üìã Specs from array:', specsFromArray);

        // C√°ch 2: L·∫•y tr·ª±c ti·∫øp t·ª´ DOM (ƒë·∫£m b·∫£o c√≥ d·ªØ li·ªáu m·ªõi nh·∫•t)
        const specsFromDOM = {};
        const rows = document.querySelectorAll('#productSpecsBody tr[data-spec-id]');
        
        rows.forEach(row => {
            const keyInput = row.querySelector('.spec-key-input');
            const valueInput = row.querySelector('.spec-value-input');
            
            if (keyInput && valueInput) {
                const key = keyInput.value.trim();
                const value = valueInput.value.trim();
                
                if (key && value) {
                    specsFromDOM[key] = value;
                }
            }
        });

        console.log('üìã Specs from DOM:', specsFromDOM);

        // ∆Øu ti√™n d·ªØ li·ªáu t·ª´ DOM v√¨ n√≥ lu√¥n m·ªõi nh·∫•t
        const finalSpecs = Object.keys(specsFromDOM).length > 0 ? specsFromDOM : specsFromArray;
        console.log('‚úÖ Final specs data:', finalSpecs);
        
        return finalSpecs;
    }

    loadSpecsData(specsData) {
        if (!specsData || typeof specsData !== 'object') return;
        
        this.specs = [];
        Object.entries(specsData).forEach(([key, value]) => {
            // Chuy·ªÉn ƒë·ªïi value v·ªÅ string n·∫øu l√† object ho·∫∑c array
            let displayValue = value;
            if (typeof value === 'object' && value !== null) {
                if (Array.isArray(value)) {
                    displayValue = value.join(', ');
                } else {
                    displayValue = JSON.stringify(value);
                }
            }
            this.addNewSpec(key, displayValue);
        });
        
        // ƒê·∫£m b·∫£o auto-resize sau khi load xong
        setTimeout(() => {
            const tbody = document.getElementById('productSpecsBody');
            if (tbody) {
                tbody.querySelectorAll('.auto-resize').forEach(textarea => {
                    this.autoResizeTextarea(textarea);
                });
            }
        }, 100);
    }

    clearSpecs() {
        this.specs = [];
        this.renderSpecsTable();
    }
}

// =============================================
// PRODUCT VARIANTS MANAGER
// =============================================
class ProductVariantsManager {
    constructor() {
        this.variantTypes = [];
        this.combinations = [];
        this.init();
    }

    init() {
        this.bindEvents();
    }

    bindEvents() {
        document.getElementById('addVariantTypeBtn')?.addEventListener('click', () => {
            this.addVariantType();
        });
    }

    addVariantType(name = '', values = []) {
        const variantId = 'variant_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const newVariant = {
            id: variantId,
            name: name,
            values: values || []
        };

        this.variantTypes.push(newVariant);
        this.renderVariantOptionsTable();
        this.autoGenerateCombinations(); // T·ª± ƒë·ªông t·∫°o t·ªï h·ª£p
        
        console.log('‚ûï Added new variant type:', newVariant);
    }

    removeVariantType(variantId) {
        this.variantTypes = this.variantTypes.filter(v => v.id !== variantId);
        this.renderVariantOptionsTable();
        this.autoGenerateCombinations();
        console.log('üóëÔ∏è Removed variant type:', variantId);
    }

    addVariantValue(variantId, value) {
        const variant = this.variantTypes.find(v => v.id === variantId);
        if (variant && value.trim()) {
            if (!variant.values.includes(value.trim())) {
                variant.values.push(value.trim());
                this.renderVariantOptionsTable();
                // Focus l·∫°i v√†o input sau khi render
                setTimeout(() => {
                    const input = document.querySelector(`.chip-input[data-variant-id="${variantId}"]`);
                    if (input) input.focus();
                }, 0);
                this.autoGenerateCombinations(); // T·ª± ƒë·ªông t·∫°o t·ªï h·ª£p
                console.log('‚ûï Added value to variant:', variantId, value);
            }
        }
    }

    removeVariantValue(variantId, valueIndex) {
        const variant = this.variantTypes.find(v => v.id === variantId);
        if (variant) {
            variant.values.splice(valueIndex, 1);
            this.renderVariantOptionsTable();
            // Focus l·∫°i v√†o input sau khi render
            setTimeout(() => {
                const input = document.querySelector(`.chip-input[data-variant-id="${variantId}"]`);
                if (input) input.focus();
            }, 0);
            this.autoGenerateCombinations();
            console.log('üóëÔ∏è Removed value from variant:', variantId, valueIndex);
        }
    }

    updateVariantValue(variantId, valueIndex, newValue) {
        const variant = this.variantTypes.find(v => v.id === variantId);
        if (variant && variant.values[valueIndex] !== undefined) {
            const oldValue = variant.values[valueIndex];
            variant.values[valueIndex] = newValue.trim();
            
            // C·∫≠p nh·∫≠t t√™n hi·ªÉn th·ªã trong combinations m√† kh√¥ng regenerate
            this.updateCombinationNamesAfterValueChange(variantId, oldValue, newValue.trim());
            
            // Re-render variant options table ƒë·ªÉ hi·ªÉn th·ªã gi√° tr·ªã m·ªõi
            this.renderVariantOptionsTable();
            
            console.log('‚úèÔ∏è Updated value:', variantId, valueIndex, newValue);
        }
    }

    updateVariantName(variantId, newName) {
        const variant = this.variantTypes.find(v => v.id === variantId);
        if (variant) {
            variant.name = newName.trim();
            
            // KH√îNG re-render ƒë·ªÉ tr√°nh m·∫•t focus khi ƒëang nh·∫≠p
            // Ch·ªâ log ƒë·ªÉ debug
            console.log('‚úèÔ∏è Updated variant name:', variantId, newName);
        }
    }

    // Helper: C·∫≠p nh·∫≠t t√™n combinations khi gi√° tr·ªã thay ƒë·ªïi
    updateCombinationNamesAfterValueChange(variantId, oldValue, newValue) {
        const variant = this.variantTypes.find(v => v.id === variantId);
        if (!variant) {
            console.warn('‚ö†Ô∏è Variant not found:', variantId);
            return;
        }
        
        console.log('üîÑ Updating combinations:', { variantId, oldValue, newValue, variantName: variant.name });
        
        let updated = 0;
        this.combinations.forEach(combo => {
            // Duy·ªát qua t·∫•t c·∫£ attributes ƒë·ªÉ t√¨m gi√° tr·ªã c≈©
            if (combo.attributes) {
                Object.keys(combo.attributes).forEach(key => {
                    if (combo.attributes[key] === oldValue) {
                        // T√¨m th·∫•y gi√° tr·ªã c≈©, update sang gi√° tr·ªã m·ªõi
                        combo.attributes[key] = newValue;
                        updated++;
                        
                        // Rebuild name t·ª´ attributes
                        const nameParts = [];
                        this.variantTypes.forEach(v => {
                            const vKey = v.name.toLowerCase().replace(/\s+/g, '_');
                            if (combo.attributes[vKey]) {
                                nameParts.push(combo.attributes[vKey]);
                            }
                        });
                        combo.name = nameParts.join(' - ');
                        
                        console.log('‚úÖ Updated combo:', combo.name);
                    }
                });
            }
        });
        
        console.log(`‚úÖ Updated ${updated} combinations`);
        
        // Re-render combinations v·ªõi t√™n m·ªõi
        this.renderCombinations();
    }

    renderVariantOptionsTable() {
        const tbody = document.getElementById('variantOptionsBody');
        const section = document.getElementById('variantOptionsSection');
        
        if (!tbody || !section) return;

        if (this.variantTypes.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        tbody.innerHTML = '';

        this.variantTypes.forEach(variant => {
            const row = document.createElement('tr');
            row.setAttribute('data-variant-id', variant.id);

            // T·∫°o HTML cho values tags d·∫°ng chips inline
            const valuesHTML = variant.values.map((value, index) => 
                `<span class="variant-chip" data-variant-id="${variant.id}" data-value-index="${index}">
                    <span class="chip-text" contenteditable="true" 
                        data-variant-id="${variant.id}" 
                        data-value-index="${index}">${value}</span>
                    <button type="button" class="chip-remove" 
                        data-variant-id="${variant.id}" 
                        data-value-index="${index}"
                        title="X√≥a">
                        <i class="fas fa-times"></i>
                    </button>
                </span>`
            ).join('');

            row.innerHTML = `
                <td>
                    <input type="text" 
                        class="form-control form-control-sm variant-name-input" 
                        value="${variant.name || ''}" 
                        placeholder="VD: M√†u s·∫Øc, Dung l∆∞·ª£ng"
                        data-variant-id="${variant.id}">
                </td>
                <td>
                    <div class="variant-chips-container" 
                        data-variant-id="${variant.id}">
                        ${valuesHTML}
                        <input type="text" 
                            class="chip-input" 
                            placeholder="Nh·∫≠p gi√° tr·ªã..." 
                            data-variant-id="${variant.id}">
                    </div>
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-danger btn-remove-variant-type" 
                        data-variant-id="${variant.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;

            tbody.appendChild(row);
        });

        // Bind events
        this.bindVariantOptionEvents();
    }

    bindVariantOptionEvents() {
        // Update variant name
        document.querySelectorAll('.variant-name-input').forEach(input => {
            // Input event - ch·ªâ update data, kh√¥ng re-render
            input.addEventListener('input', (e) => {
                const variantId = e.target.getAttribute('data-variant-id');
                this.updateVariantName(variantId, e.target.value);
            });
            
            // Enter key - blur ƒë·ªÉ apply changes
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.target.blur();
                }
            });
            
            // Blur event - re-render ƒë·ªÉ c·∫≠p nh·∫≠t UI
            input.addEventListener('blur', (e) => {
                const variantId = e.target.getAttribute('data-variant-id');
                const variant = this.variantTypes.find(v => v.id === variantId);
                if (variant && variant.name) {
                    // Re-render ƒë·ªÉ hi·ªÉn th·ªã t√™n m·ªõi trong b·∫£ng
                    this.renderVariantOptionsTable();
                    // Re-render combinations ƒë·ªÉ c·∫≠p nh·∫≠t attributes keys
                    this.autoGenerateCombinations();
                }
            });
        });

        // Remove variant type
        document.querySelectorAll('.btn-remove-variant-type').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const variantId = e.currentTarget.getAttribute('data-variant-id');
                this.removeVariantType(variantId);
            });
        });

        // Chip input - Add new chip on Enter or comma
        document.querySelectorAll('.chip-input').forEach(input => {
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    const variantId = e.target.getAttribute('data-variant-id');
                    const value = e.target.value.trim().replace(/,$/, '');
                    if (value) {
                        this.addVariantValue(variantId, value);
                        e.target.value = '';
                    }
                }
                // Backspace to delete last chip if input is empty
                if (e.key === 'Backspace' && e.target.value === '') {
                    const variantId = e.target.getAttribute('data-variant-id');
                    const variant = this.variantTypes.find(v => v.id === variantId);
                    if (variant && variant.values.length > 0) {
                        this.removeVariantValue(variantId, variant.values.length - 1);
                    }
                }
            });
        });

        // Edit chip text inline
        document.querySelectorAll('.chip-text').forEach(span => {
            span.addEventListener('blur', (e) => {
                const variantId = e.target.getAttribute('data-variant-id');
                const valueIndex = parseInt(e.target.getAttribute('data-value-index'));
                const newValue = e.target.textContent.trim();
                if (newValue) {
                    this.updateVariantValue(variantId, valueIndex, newValue);
                } else {
                    // If empty, remove the chip
                    this.removeVariantValue(variantId, valueIndex);
                }
            });

            span.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.target.blur();
                }
            });
        });

        // Remove chip
        document.querySelectorAll('.chip-remove').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const variantId = e.currentTarget.getAttribute('data-variant-id');
                const valueIndex = parseInt(e.currentTarget.getAttribute('data-value-index'));
                this.removeVariantValue(variantId, valueIndex);
            });
        });

        // Click on container to focus input
        document.querySelectorAll('.variant-chips-container').forEach(container => {
            container.addEventListener('click', (e) => {
                if (e.target === container) {
                    const input = container.querySelector('.chip-input');
                    if (input) input.focus();
                }
            });
        });
    }

    // T·ª± ƒë·ªông t·∫°o t·ªï h·ª£p khi c√≥ thay ƒë·ªïi
    autoGenerateCombinations() {
        const validVariants = this.variantTypes.filter(v => v.name && v.values && v.values.length > 0);
        
        if (validVariants.length === 0) {
            this.combinations = [];
            this.renderCombinations();
            return;
        }

        // Cartesian product algorithm
        const cartesian = (...arrays) => {
            return arrays.reduce((acc, array) => {
                return acc.flatMap(x => array.map(y => [...x, y]));
            }, [[]]);
        };

        const valueArrays = validVariants.map(v => v.values);
        const allCombinations = cartesian(...valueArrays);

        // Gi·ªØ l·∫°i data c·ªßa c√°c t·ªï h·ª£p ƒë√£ t·ªìn t·∫°i
        // ∆Øu ti√™n match theo sql_variant_id, fallback v·ªÅ attributes
        const existingCombosByVariantId = {};
        const existingCombosByAttributes = {};
        
        this.combinations.forEach(combo => {
            // Index theo sql_variant_id n·∫øu c√≥
            if (combo.sql_variant_id) {
                existingCombosByVariantId[combo.sql_variant_id] = combo;
            }
            // Index theo attributes ƒë·ªÉ fallback
            const attrValues = Object.values(combo.attributes).sort().join('|');
            existingCombosByAttributes[attrValues] = combo;
        });

        // T·∫°o combinations m·ªõi
        this.combinations = allCombinations.map((combo, index) => {
            const attributes = {};
            const nameParts = [];
            
            validVariants.forEach((variant, i) => {
                const key = variant.name.toLowerCase().replace(/\s+/g, '_');
                attributes[key] = combo[i];
                nameParts.push(combo[i]);
            });

            // T√¨m combination c≈© theo gi√° tr·ªã attributes (kh√¥ng ph·ª• thu·ªôc v√†o t√™n key)
            const attrValues = Object.values(attributes).sort().join('|');
            const existing = existingCombosByAttributes[attrValues];

            // N·∫øu t·ªï h·ª£p ƒë√£ t·ªìn t·∫°i, gi·ªØ nguy√™n t·∫•t c·∫£ data
            if (existing) {
                return {
                    ...existing,
                    name: nameParts.join(' - '),
                    attributes: attributes  // Update attributes v·ªõi t√™n m·ªõi
                };
            }

            // T·ªï h·ª£p m·ªõi - gi√° m·∫∑c ƒë·ªãnh l√† 0, ng∆∞·ªùi d√πng s·∫Ω nh·∫≠p
            const sku = 'VAR-' + Date.now() + '-' + (index + 1);
            const name = nameParts.join(' - ');

            return {
                id: 'comb_' + Date.now() + '_' + index,
                sku: sku,
                name: name,
                original_price: 0,  // Gi√° ni√™m y·∫øt m·∫∑c ƒë·ªãnh, ng∆∞·ªùi d√πng s·∫Ω nh·∫≠p
                price: 0,  // Gi√° b√°n m·∫∑c ƒë·ªãnh, ng∆∞·ªùi d√πng s·∫Ω nh·∫≠p
                stock: 0,
                site_origin: 'bac',  // M·∫∑c ƒë·ªãnh l√† v√πng B·∫Øc
                image: '',  // ·∫¢nh ƒë·∫°i di·ªán c·ªßa variant
                active: true,
                attributes: attributes
            };
        });

        console.log('‚úÖ Auto-generated', this.combinations.length, 'combinations');
        this.renderCombinations();
    }

    renderCombinations() {
        const tbody = document.getElementById('variantCombinationsBody');
        const section = document.getElementById('variantCombinationsSection');
        const countElem = document.getElementById('combinationsCount');
        
        if (!tbody || !section) return;

        if (this.combinations.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        if (countElem) {
            countElem.textContent = this.combinations.length + ' t·ªï h·ª£p';
        }

        tbody.innerHTML = '';

        this.combinations.forEach((combo, index) => {
            const row = document.createElement('tr');
            row.setAttribute('data-combo-id', combo.id);
            
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>
                    <div class="combo-name">${combo.name}</div>
                    <div class="combo-attributes">${Object.entries(combo.attributes).map(([k, v]) => `${k}: ${v}`).join(', ')}</div>
                </td>
                <td>
                    <input type="text" 
                        class="form-control form-control-sm combo-sku" 
                        value="${combo.sku}"
                        data-combo-id="${combo.id}">
                </td>
                <td>
                    <input type="number" 
                        class="form-control form-control-sm combo-original-price" 
                        value="${combo.original_price || 0}"
                        data-combo-id="${combo.id}"
                        placeholder="Gi√° ni√™m y·∫øt"
                        step="1000"
                        min="0">
                </td>
                <td>
                    <input type="number" 
                        class="form-control form-control-sm combo-price" 
                        value="${combo.price}"
                        data-combo-id="${combo.id}"
                        placeholder="Gi√° b√°n"
                        step="1000"
                        min="0">
                </td>
                <td>
                    <input type="number" 
                        class="form-control form-control-sm combo-stock" 
                        value="${combo.stock}"
                        data-combo-id="${combo.id}"
                        min="0">
                </td>
                <td>
                    <select class="form-select form-select-sm combo-site-origin" 
                        data-combo-id="${combo.id}">
                        <option value="bac" ${(combo.site_origin || 'bac') === 'bac' ? 'selected' : ''}>B·∫Øc</option>
                        <option value="trung" ${combo.site_origin === 'trung' ? 'selected' : ''}>Trung</option>
                        <option value="nam" ${combo.site_origin === 'nam' ? 'selected' : ''}>Nam</option>
                    </select>
                </td>
                <td>
                    <div class="d-flex gap-2 align-items-center">
                        ${combo.image ? `
                            <div class="combo-image-container" style="position: relative; display: inline-block;">
                                <img src="${combo.image}" class="combo-image-preview" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; cursor: pointer;" alt="" title="Click ƒë·ªÉ xem l·ªõn">
                                <div class="combo-image-actions" style="position: absolute; top: -5px; right: -5px; display: flex; gap: 2px;">
                                    <button type="button" class="btn-combo-edit-image" data-combo-id="${combo.id}" title="S·ª≠a ·∫£nh" style="width: 20px; height: 20px; padding: 0; border-radius: 50%; background: #007bff; color: white; border: none; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn-combo-delete-image" data-combo-id="${combo.id}" title="X√≥a ·∫£nh" style="width: 20px; height: 20px; padding: 0; border-radius: 50%; background: #dc3545; color: white; border: none; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        ` : `
                            <div class="combo-upload-wrapper">
                                <input type="file" 
                                    class="combo-image-upload" 
                                    data-combo-id="${combo.id}"
                                    accept="image/*"
                                    id="upload-${combo.id}"
                                    style="display: none;">
                                <label for="upload-${combo.id}" class="combo-upload-btn" title="Ch·ªçn ·∫£nh">
                                    <i class="fas fa-camera"></i>
                                </label>
                            </div>
                        `}
                    </div>
                </td>
                <td>
                    <div class="form-check form-switch">
                        <input type="checkbox" 
                            class="form-check-input combo-active" 
                            ${combo.active ? 'checked' : ''}
                            data-combo-id="${combo.id}">
                    </div>
                </td>
                <td>
                    <button type="button" 
                        class="btn btn-sm btn-danger btn-remove-combo"
                        data-combo-id="${combo.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;

            tbody.appendChild(row);
        });

        this.bindCombinationEvents();
    }

    bindCombinationEvents() {
        // Update SKU
        document.querySelectorAll('.combo-sku').forEach(input => {
            input.addEventListener('change', (e) => {
                const comboId = e.target.getAttribute('data-combo-id');
                const combo = this.combinations.find(c => c.id === comboId);
                if (combo) {
                    combo.sku = e.target.value;
                }
            });
        });

        // Update Original Price (Gi√° ni√™m y·∫øt)
        document.querySelectorAll('.combo-original-price').forEach(input => {
            input.addEventListener('change', (e) => {
                const comboId = e.target.getAttribute('data-combo-id');
                const combo = this.combinations.find(c => c.id === comboId);
                if (combo) {
                    combo.original_price = parseInt(e.target.value) || 0;
                }
            });
        });

        // Update Price (Gi√° b√°n)
        document.querySelectorAll('.combo-price').forEach(input => {
            input.addEventListener('change', (e) => {
                const comboId = e.target.getAttribute('data-combo-id');
                const combo = this.combinations.find(c => c.id === comboId);
                if (combo) {
                    combo.price = parseInt(e.target.value) || 0;
                }
            });
        });

        // Update Stock
        document.querySelectorAll('.combo-stock').forEach(input => {
            input.addEventListener('change', (e) => {
                const comboId = e.target.getAttribute('data-combo-id');
                const combo = this.combinations.find(c => c.id === comboId);
                if (combo) {
                    combo.stock = parseInt(e.target.value) || 0;
                }
            });
        });

        // Update Site Origin (V√πng)
        document.querySelectorAll('.combo-site-origin').forEach(select => {
            select.addEventListener('change', (e) => {
                const comboId = e.target.getAttribute('data-combo-id');
                const combo = this.combinations.find(c => c.id === comboId);
                if (combo) {
                    combo.site_origin = e.target.value;
                    console.log(`üó∫Ô∏è Updated site_origin for ${combo.sku}: ${combo.site_origin}`);
                }
            });
        });

        // Upload Image for variant
        document.querySelectorAll('.combo-image-upload').forEach(input => {
            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const comboId = e.target.getAttribute('data-combo-id');
                const combo = this.combinations.find(c => c.id === comboId);
                if (!combo) return;

                // Validate image file
                if (!file.type.startsWith('image/')) {
                    alert('Vui l√≤ng ch·ªçn file ·∫£nh!');
                    return;
                }

                // Create preview URL from local file
                const reader = new FileReader();
                reader.onload = (event) => {
                    combo.image = event.target.result; // Data URL for preview
                    combo.imageFile = file; // Store file object for later upload
                    console.log(`üì∏ Image file selected for ${combo.sku}: ${file.name}`);
                    
                    // Add to product images for preview
                    if (!window.simpleImageUploadManager.productImages.some(img => img.file === file)) {
                        window.simpleImageUploadManager.productImages.push({ 
                            url: event.target.result,
                            file: file,
                            name: file.name,
                            type: 'variant'
                        });
                        window.simpleImageUploadManager.renderProductImagesPreview();
                        console.log('‚úÖ Added variant image to preview');
                    }
                    
                    // Re-render to show preview
                    this.renderCombinations();
                };
                reader.readAsDataURL(file);
            });
        });

        // Click v√†o preview ƒë·ªÉ xem ·∫£nh l·ªõn
        document.querySelectorAll('.combo-image-preview').forEach(img => {
            img.addEventListener('click', (e) => {
                window.open(e.target.src, '_blank');
            });
        });

        // Edit image button
        document.querySelectorAll('.btn-combo-edit-image').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                
                // L·∫•y combo ID t·ª´ button (kh√¥ng ph·∫£i t·ª´ e.target v√¨ c√≥ th·ªÉ click v√†o icon)
                const button = e.currentTarget;
                const comboId = button.getAttribute('data-combo-id');
                
                console.log('üóëÔ∏è Edit image clicked for combo:', comboId);
                
                // Create temporary input
                const tempInput = document.createElement('input');
                tempInput.type = 'file';
                tempInput.accept = 'image/*';
                tempInput.style.display = 'none';
                tempInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const combo = this.combinations.find(c => c.id === comboId);
                    if (!combo) return;

                    // Validate image file
                    if (!file.type.startsWith('image/')) {
                        alert('Vui l√≤ng ch·ªçn file ·∫£nh!');
                        return;
                    }

                    // Create preview URL from local file
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        const oldCloudinaryUrl = combo.image && !combo.image.startsWith('data:') ? combo.image : null;
                        
                        // Remove old image from product images (both file and URL)
                        if (combo.imageFile) {
                            // Remove old file
                            const fileIdx = window.simpleImageUploadManager.productImages.findIndex(img => img.file === combo.imageFile);
                            if (fileIdx !== -1) {
                                window.simpleImageUploadManager.productImages.splice(fileIdx, 1);
                            }
                        } else if (combo.image) {
                            // Remove old Cloudinary URL from preview
                            const urlIdx = window.simpleImageUploadManager.productImages.findIndex(img => img.url === combo.image);
                            if (urlIdx !== -1) {
                                window.simpleImageUploadManager.productImages.splice(urlIdx, 1);
                            }
                        }

                        // ƒê√°nh d·∫•u ·∫£nh c≈© ƒë·ªÉ x√≥a khi Save (n·∫øu l√† ·∫£nh t·ª´ Cloudinary)
                        if (oldCloudinaryUrl) {
                            if (!window.simpleImageUploadManager.imagesToDelete) {
                                window.simpleImageUploadManager.imagesToDelete = [];
                            }
                            if (!window.simpleImageUploadManager.imagesToDelete.includes(oldCloudinaryUrl)) {
                                window.simpleImageUploadManager.imagesToDelete.push(oldCloudinaryUrl);
                                console.log('üìù Marked old variant image for deletion on save:', oldCloudinaryUrl);
                            }
                        }

                        combo.image = evt.target.result; // Data URL for preview
                        combo.imageFile = file; // Store file object for later upload
                        console.log(`üì∏ Image file updated for ${combo.sku}: ${file.name}`);
                        
                        // Add new file to product images
                        window.simpleImageUploadManager.productImages.push({ 
                            url: evt.target.result,
                            file: file,
                            name: file.name,
                            type: 'variant'
                        });
                        window.simpleImageUploadManager.renderProductImagesPreview();
                        
                        this.renderCombinations();
                    };
                    reader.readAsDataURL(file);
                    
                    tempInput.remove();
                });
                document.body.appendChild(tempInput);
                tempInput.click();
            });
        });

        // Delete image button
        document.querySelectorAll('.btn-combo-delete-image').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.stopPropagation();
                e.preventDefault();
                
                // L·∫•y combo ID t·ª´ button
                const button = e.currentTarget;
                const comboId = button.getAttribute('data-combo-id');
                
                const combo = this.combinations.find(c => c.id === comboId);
                if (!combo) return;
                
                const cloudinaryUrl = combo.image && !combo.image.startsWith('data:') ? combo.image : null;
                
                // Hi·ªÉn th·ªã confirm dialog
                const result = await Swal.fire({
                    title: 'X√°c nh·∫≠n x√≥a ·∫£nh',
                    text: 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh n√†y? ·∫¢nh s·∫Ω ƒë∆∞·ª£c x√≥a kh·ªèi variant v√† x√≥a vƒ©nh vi·ªÖn khi b·∫°n l∆∞u s·∫£n ph·∫©m.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'X√≥a',
                    cancelButtonText: 'H·ªßy',
                    customClass: {
                        confirmButton: 'btn btn-danger',
                        cancelButton: 'btn btn-secondary'
                    }
                });

                if (result.isConfirmed) {
                    // ƒê√°nh d·∫•u ·∫£nh variant c·∫ßn x√≥a (s·∫Ω x√≥a khi Save)
                    if (cloudinaryUrl) {
                        if (!window.simpleImageUploadManager.imagesToDelete) {
                            window.simpleImageUploadManager.imagesToDelete = [];
                        }
                        window.simpleImageUploadManager.imagesToDelete.push(cloudinaryUrl);
                        console.log('üìù Marked variant image for deletion on save:', cloudinaryUrl);
                    }
                    
                    // Remove from product images preview
                    if (combo.imageFile) {
                        const idx = window.simpleImageUploadManager.productImages.findIndex(img => img.file === combo.imageFile);
                        if (idx !== -1) {
                            window.simpleImageUploadManager.productImages.splice(idx, 1);
                            console.log('üóëÔ∏è Removed variant file from preview');
                        }
                    } else if (combo.image) {
                        const idx = window.simpleImageUploadManager.productImages.findIndex(img => img.url === combo.image);
                        if (idx !== -1) {
                            window.simpleImageUploadManager.productImages.splice(idx, 1);
                            console.log('üóëÔ∏è Removed variant image URL from preview');
                        }
                    }
                    
                    // Update preview
                    window.simpleImageUploadManager.renderProductImagesPreview();
                    
                    combo.image = '';
                    combo.imageFile = null;
                    console.log(`üóëÔ∏è Image removed from variant ${combo.sku}`);
                    this.renderCombinations();
                    window.simpleImageUploadManager.showSuccess('ƒê√£ x√≥a ·∫£nh kh·ªèi variant. Nh·ªõ l∆∞u ƒë·ªÉ x√≥a vƒ©nh vi·ªÖn.');
                }
            });
        });

        // Update Active
        document.querySelectorAll('.combo-active').forEach(input => {
            input.addEventListener('change', (e) => {
                const comboId = e.target.getAttribute('data-combo-id');
                const combo = this.combinations.find(c => c.id === comboId);
                if (combo) {
                    combo.active = e.target.checked;
                }
            });
        });

        // Remove combination
        document.querySelectorAll('.btn-remove-combo').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const comboId = e.currentTarget.getAttribute('data-combo-id');
                this.combinations = this.combinations.filter(c => c.id !== comboId);
                this.renderCombinations();
            });
        });
    }

    getVariantsData() {
        console.log('üì¶ Getting variants data...');
        console.log('üìä Current variantTypes:', this.variantTypes);
        console.log('üìä Current combinations:', this.combinations);
        
        // L·∫•y t√™n s·∫£n ph·∫©m t·ª´ form
        const productName = document.getElementById('productName')?.value?.trim() || '';
        
        // Tr·∫£ v·ªÅ c·∫•u tr√∫c m·ªõi: variant_options + variant_combinations (flat array v·ªõi field vung)
        const variantOptions = this.variantTypes
            .filter(v => v.name && v.name.trim() !== '' && v.values.length > 0)
            .map(v => ({
                name: v.name.trim(),
                values: v.values
            }));

        // T·∫°o flat array v·ªõi field vung thay v√¨ nh√≥m theo regional_variants
        const variantCombinations = this.combinations.map(c => ({
            sql_variant_id: c.sql_variant_id || null,  // ID t·ª´ product_variants table (SQL)
            sku: c.sku,
            name: productName ? `${productName} ${c.name}` : c.name,  // Th√™m t√™n s·∫£n ph·∫©m v√†o tr∆∞·ªõc
            price: c.price,
            original_price: c.original_price || 0,
            stock: c.stock,
            vung: c.site_origin || 'bac',  // L∆∞u v√πng tr·ª±c ti·∫øp trong m·ªói combination
            link_anh: (c.image && c.image.startsWith('data:')) ? null : (c.image || null),  // Link ·∫£nh Cloudinary
            active: c.active,
            attributes: c.attributes
        }));

        const result = {
            variant_options: variantOptions,
            variant_combinations: variantCombinations
        };
        
        console.log('‚úÖ Variants data to return (flat array):', JSON.stringify(result, null, 2));
        
        return result;
    }

    loadVariantsData(variantsData) {
        console.log('üì• Loading variants data:', JSON.stringify(variantsData, null, 2));
        
        if (!variantsData) {
            console.warn('‚ö†Ô∏è No variants data provided');
            return;
        }

        // Check if variantsData is an object
        if (typeof variantsData !== 'object') {
            console.error('‚ùå Invalid variants data type:', typeof variantsData);
            return;
        }

        // ∆Øu ti√™n load t·ª´ c·∫•u tr√∫c m·ªõi: flat array v·ªõi field vung
        if (variantsData.variant_options && Array.isArray(variantsData.variant_options)) {
            console.log('üìä Loading from flat array structure with vung field');
            
            // Load variant_options
            console.log(`üìã Loading ${variantsData.variant_options.length} variant options...`);
            this.variantTypes = [];
            variantsData.variant_options.forEach((variant, index) => {
                if (variant.name && variant.values) {
                    console.log(`‚ûï [${index}] Adding variant type: "${variant.name}" with values:`, variant.values);
                    this.addVariantType(variant.name, variant.values);
                }
            });
            
            // Load variant_combinations t·ª´ flat array
            this.combinations = [];
            const productName = document.getElementById('productName')?.value?.trim() || '';
            
            if (variantsData.variant_combinations && Array.isArray(variantsData.variant_combinations)) {
                console.log(`üîó Loading ${variantsData.variant_combinations.length} combinations...`);
                
                // Filter out default variants
                const realVariants = variantsData.variant_combinations.filter(combo => !combo.is_default);
                
                realVariants.forEach((combo, index) => {
                    // Lo·∫°i b·ªè t√™n s·∫£n ph·∫©m kh·ªèi combo.name n·∫øu c√≥
                    let variantName = combo.name || '';
                    if (productName && variantName.startsWith(productName)) {
                        variantName = variantName.substring(productName.length).trim();
                    }
                    
                    const mapped = {
                        id: 'comb_' + Date.now() + '_' + (combo.vung || 'bac') + '_' + index,
                        sql_variant_id: combo.sql_variant_id || null,  // L∆∞u SQL variant ID
                        sku: combo.sku || '',
                        name: variantName,
                        price: combo.price || 0,
                        original_price: combo.original_price || 0,
                        stock: combo.stock || 0,
                        site_origin: combo.vung || 'bac',  // L·∫•y v√πng t·ª´ field vung
                        image: combo.link_anh || combo.image || '',  // ∆Øu ti√™n link_anh, fallback sang image
                        active: combo.active !== undefined ? combo.active : true,
                        attributes: combo.attributes || {}
                    };
                    console.log(`üîó [${combo.vung || 'bac'}-${index}] Loaded combination:`, mapped);
                    this.combinations.push(mapped);
                });
            }
            
            this.renderCombinations();
            return;
        }
        
        // Fallback: Load t·ª´ regional_variants (c·∫•u tr√∫c c≈©) n·∫øu c√≥
        if (variantsData.regional_variants && typeof variantsData.regional_variants === 'object') {
            console.log('üìä Loading from old regional_variants structure (fallback)');
            
            // Load variant_options t·ª´ v√πng ƒë·∫ßu ti√™n (t·∫•t c·∫£ v√πng c√≥ c√πng options)
            const firstRegion = Object.keys(variantsData.regional_variants)[0];
            if (firstRegion) {
                const regionData = variantsData.regional_variants[firstRegion];
                if (regionData.variant_options && Array.isArray(regionData.variant_options)) {
                    console.log(`üìã Loading ${regionData.variant_options.length} variant options from region ${firstRegion}...`);
                    this.variantTypes = [];
                    regionData.variant_options.forEach((variant, index) => {
                        if (variant.name && variant.values) {
                            console.log(`‚ûï [${index}] Adding variant type: "${variant.name}" with values:`, variant.values);
                            this.addVariantType(variant.name, variant.values);
                        }
                    });
                }
            }
            
            // Load variant_combinations t·ª´ t·∫•t c·∫£ c√°c v√πng
            this.combinations = [];
            const productName = document.getElementById('productName')?.value?.trim() || '';
            
            Object.keys(variantsData.regional_variants).forEach(region => {
                const regionData = variantsData.regional_variants[region];
                if (regionData.variant_combinations && Array.isArray(regionData.variant_combinations)) {
                    console.log(`üîó Loading ${regionData.variant_combinations.length} combinations from region ${region}...`);
                    
                    // Filter out default variants
                    const realVariants = regionData.variant_combinations.filter(combo => !combo.is_default);
                    
                    realVariants.forEach((combo, index) => {
                        // Lo·∫°i b·ªè t√™n s·∫£n ph·∫©m kh·ªèi combo.name n·∫øu c√≥
                        let variantName = combo.name || '';
                        if (productName && variantName.startsWith(productName)) {
                            variantName = variantName.substring(productName.length).trim();
                        }
                        
                        const mapped = {
                            id: 'comb_' + Date.now() + '_' + region + '_' + index,
                            sql_variant_id: combo.sql_variant_id || null,  // L∆∞u SQL variant ID
                            sku: combo.sku || '',
                            name: variantName,
                            price: combo.price || 0,
                            original_price: combo.original_price || 0,
                            stock: combo.stock || 0,
                            site_origin: region,  // G√°n v√πng cho combo
                            image: combo.link_anh || combo.image || '',  // ∆Øu ti√™n link_anh, fallback sang image
                            active: combo.active !== undefined ? combo.active : true,
                            attributes: combo.attributes || {}
                        };
                        console.log(`üîó [${region}-${index}] Loaded combination:`, mapped);
                        this.combinations.push(mapped);
                    });
                }
            });
            
            this.renderCombinations();
            return;
        }

        // Fallback to old structure
        // Load variant options
        if (variantsData.variant_options && Array.isArray(variantsData.variant_options)) {
            console.log(`üìã Loading ${variantsData.variant_options.length} variant options...`);
            this.variantTypes = [];
            variantsData.variant_options.forEach((variant, index) => {
                if (variant.name && variant.values) {
                    console.log(`‚ûï [${index}] Adding variant type: "${variant.name}" with values:`, variant.values);
                    this.addVariantType(variant.name, variant.values);
                }
            });
        } else {
            console.warn('‚ö†Ô∏è No variant_options found or not an array');
        }

        // Load variant combinations
        if (variantsData.variant_combinations && Array.isArray(variantsData.variant_combinations)) {
            console.log(`üîó Loading ${variantsData.variant_combinations.length} variant combinations...`);
            
            // L·∫•y t√™n s·∫£n ph·∫©m ƒë·ªÉ lo·∫°i b·ªè kh·ªèi combo.name
            const productName = document.getElementById('productName')?.value?.trim() || '';
            
            // Filter out default variants (is_default: true)
            const realVariants = variantsData.variant_combinations.filter(combo => !combo.is_default);
            console.log(`üîó After filtering default variants: ${realVariants.length} real variants`);
            
            this.combinations = realVariants.map((combo, index) => {
                // Lo·∫°i b·ªè t√™n s·∫£n ph·∫©m kh·ªèi combo.name n·∫øu c√≥
                let variantName = combo.name || '';
                if (productName && variantName.startsWith(productName)) {
                    variantName = variantName.substring(productName.length).trim();
                }
                
                const mapped = {
                    id: 'comb_' + Date.now() + '_' + index,
                    sql_variant_id: combo.sql_variant_id || null,  // L∆∞u SQL variant ID
                    sku: combo.sku || '',
                    name: variantName,  // Ch·ªâ l∆∞u ph·∫ßn variant (ƒêen - 128GB)
                    price: combo.price || 0,
                    original_price: combo.original_price || 0,  // Th√™m original_price
                    stock: combo.stock || 0,
                    site_origin: combo.site_origin || 'bac',  // Th√™m site_origin v·ªõi default
                    image: combo.link_anh || combo.image || '',  // ∆Øu ti√™n link_anh, fallback sang image
                    active: combo.active !== undefined ? combo.active : true,
                    attributes: combo.attributes || {}
                };
                console.log(`üîó [${index}] Loaded combination:`, mapped);
                return mapped;
            });
            
            this.renderCombinations();
        } else {
            console.warn('‚ö†Ô∏è No variant_combinations found or not an array');
        }
        
        console.log('‚úÖ Loaded variants data');
        console.log('üìä Final variantTypes:', this.variantTypes);
        console.log('üìä Final combinations:', this.combinations);
    }

    async syncVariantStatusFromSQL(productId) {
        try {
            console.log('üîÑ Syncing variant status from SQL for product:', productId);
            
            // Fetch all variants from SQL
            const response = await fetch(`/api/variants?san_pham_id=${productId}`);
            if (!response.ok) {
                console.warn('‚ö†Ô∏è Could not fetch variants from SQL');
                return;
            }
            
            const data = await response.json();
            const sqlVariants = data.data || [];
            
            console.log('üì• Found', sqlVariants.length, 'SQL variants');
            
            // Map SQL variants to combinations by sql_variant_id or SKU
            this.combinations.forEach(combo => {
                let sqlVariant = null;
                
                // T√¨m by sql_variant_id tr∆∞·ªõc
                if (combo.sql_variant_id) {
                    sqlVariant = sqlVariants.find(v => v.id === combo.sql_variant_id);
                }
                
                // N·∫øu kh√¥ng t√¨m th·∫•y, th·ª≠ t√¨m by SKU
                if (!sqlVariant && combo.sku) {
                    sqlVariant = sqlVariants.find(v => v.ma_sku === combo.sku);
                }
                
                // Update active status from SQL trang_thai
                if (sqlVariant) {
                    combo.active = sqlVariant.trang_thai == 1 || sqlVariant.trang_thai === true;
                    console.log(`‚úÖ Synced combo ${combo.sku}: active=${combo.active} (from SQL trang_thai=${sqlVariant.trang_thai})`);
                }
            });
            
            // Re-render combinations with updated status
            this.renderCombinations();
            
        } catch (error) {
            console.error('‚ùå Error syncing variant status from SQL:', error);
        }
    }

    clearVariants() {
        this.variantTypes = [];
        this.combinations = [];
        this.renderVariantOptionsTable();
        this.renderCombinations(); // This will call togglePriceFields()
        
        console.log('üßπ Cleared all variants');
    }
}

// =============================================
// ADDITIONAL INFO MANAGER CLASS
// =============================================

class AdditionalInfoManager {
    constructor() {
        this.infoItems = [];
        this.nextId = 1;
        this.init();
    }

    init() {
        console.log('üìã Initializing AdditionalInfoManager...');
        this.bindEvents();
        this.renderEmpty();
    }

    // H√†m auto-resize textarea
    autoResizeTextarea(textarea) {
        // Reset v·ªÅ 0 tr∆∞·ªõc ƒë·ªÉ t√≠nh to√°n ch√≠nh x√°c
        textarea.style.height = '0px';
        textarea.style.height = 'auto';
        
        // T√≠nh chi·ªÅu cao d·ª±a tr√™n scrollHeight (bao g·ªìm t·∫•t c·∫£ n·ªôi dung)
        const scrollHeight = textarea.scrollHeight;
        const minHeight = 42; // Chi·ªÅu cao t·ªëi thi·ªÉu
        textarea.style.height = Math.max(scrollHeight, minHeight) + 'px';
    }

    bindEvents() {
        const addBtn = document.getElementById('addAdditionalInfoBtn');
        if (addBtn) {
            addBtn.addEventListener('click', () => this.addInfoItem());
        }
    }

    addInfoItem(key = '', value = '') {
        const id = this.nextId++;
        this.infoItems.push({ id, key, value });
        this.render();
        console.log('‚ûï Added info item:', { id, key, value });
    }

    removeInfoItem(id) {
        const index = this.infoItems.findIndex(item => item.id === id);
        if (index === -1) return;

        const item = this.infoItems[index];
        
        Swal.fire({
            title: 'X√≥a th√¥ng tin?',
            text: item.key || 'Th√¥ng tin n√†y',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'X√≥a',
            cancelButtonText: 'H·ªßy',
            confirmButtonColor: '#e53e3e'
        }).then((result) => {
            if (result.isConfirmed) {
                this.infoItems.splice(index, 1);
                this.render();
                console.log('üóëÔ∏è Removed info item:', item);
            }
        });
    }

    updateInfoItem(id, key, value) {
        const item = this.infoItems.find(i => i.id === id);
        if (item) {
            item.key = key;
            item.value = value;
        }
    }

    render() {
        const container = document.getElementById('additionalInfoContainer');
        if (!container) return;

        if (this.infoItems.length === 0) {
            this.renderEmpty();
            return;
        }

        container.innerHTML = this.infoItems.map(item => {
            return '<div class="additional-info-item" data-id="' + item.id + '">' +
                '<textarea class="info-key-input auto-resize" data-id="' + item.id + '" rows="1" ' +
                    'placeholder="Nh·∫≠p t√™n (VD: B·∫£o h√†nh)">' + (item.key || '') + '</textarea>' +
                '<textarea class="info-value-input auto-resize" data-id="' + item.id + '" rows="1" ' +
                    'placeholder="Nh·∫≠p gi√° tr·ªã (VD: 12 th√°ng)">' + (item.value || '') + '</textarea>' +
                '<button type="button" class="btn-remove-info" data-id="' + item.id + '" title="X√≥a">' +
                    '<i class="fas fa-trash"></i>' +
                '</button>' +
            '</div>';
        }).join('');

        this.bindItemEvents();
        
        // Auto-resize t·∫•t c·∫£ textarea sau khi render
        requestAnimationFrame(() => {
            container.querySelectorAll('.auto-resize').forEach(textarea => {
                this.autoResizeTextarea(textarea);
            });
        });
    }

    bindItemEvents() {
        // Input events
        document.querySelectorAll('.info-key-input').forEach(input => {
            input.addEventListener('input', (e) => {
                const id = parseInt(e.target.getAttribute('data-id'));
                const valueInput = document.querySelector(`.info-value-input[data-id="${id}"]`);
                this.updateInfoItem(id, e.target.value, valueInput ? valueInput.value : '');
                
                // Auto-resize
                this.autoResizeTextarea(e.target);
            });
        });

        document.querySelectorAll('.info-value-input').forEach(input => {
            input.addEventListener('input', (e) => {
                const id = parseInt(e.target.getAttribute('data-id'));
                const keyInput = document.querySelector(`.info-key-input[data-id="${id}"]`);
                this.updateInfoItem(id, keyInput ? keyInput.value : '', e.target.value);
                
                // Auto-resize
                this.autoResizeTextarea(e.target);
            });
        });

        // Remove button events
        document.querySelectorAll('.btn-remove-info').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = parseInt(e.currentTarget.getAttribute('data-id'));
                this.removeInfoItem(id);
            });
        });
    }

    renderEmpty() {
        const container = document.getElementById('additionalInfoContainer');
        if (!container) return;

        container.innerHTML = '<div class="additional-info-empty">' +
            '<i class="fas fa-info-circle"></i>' +
            '<p>Ch∆∞a c√≥ th√¥ng tin b·ªï sung n√†o</p>' +
            '<p style="font-size: 0.85rem; margin-top: 8px; color: var(--gray-500);">Nh·∫•n n√∫t "Th√™m th√¥ng tin" ƒë·ªÉ th√™m</p>' +
        '</div>';
    }

    getInfoData() {
        console.log('üì¶ Getting additional info data...');
        const data = {};
        this.infoItems.forEach(item => {
            if (item.key && item.key.trim()) {
                data[item.key.trim()] = item.value || '';
            }
        });
        console.log('‚úÖ Additional info data:', data);
        return data;
    }

    loadInfoData(data) {
        console.log('üì• Loading additional info data:', data);
        
        if (!data || typeof data !== 'object') {
            console.warn('‚ö†Ô∏è Invalid additional info data:', data);
            return;
        }

        const entries = Object.entries(data);
        if (entries.length === 0) {
            console.log('‚ÑπÔ∏è Additional info data is empty');
            return;
        }

        this.infoItems = [];
        this.nextId = 1;

        entries.forEach(([key, value]) => {
            console.log('‚ûï Adding info:', key, '=', value);
            // Chuy·ªÉn ƒë·ªïi value v·ªÅ string n·∫øu l√† object ho·∫∑c array
            let displayValue = value;
            if (typeof value === 'object' && value !== null) {
                if (Array.isArray(value)) {
                    displayValue = value.join(', ');
                } else {
                    displayValue = JSON.stringify(value);
                }
            }
            this.infoItems.push({
                id: this.nextId++,
                key: key,
                value: displayValue
            });
        });

        this.render();
        
        // ƒê·∫£m b·∫£o auto-resize sau khi load xong
        setTimeout(() => {
            const container = document.getElementById('additionalInfoContainer');
            if (container) {
                container.querySelectorAll('.auto-resize').forEach(textarea => {
                    this.autoResizeTextarea(textarea);
                });
            }
        }, 100);
        
        console.log('‚úÖ Loaded additional info:', this.infoItems);
    }

    clearInfo() {
        this.infoItems = [];
        this.nextId = 1;
        this.renderEmpty();
        console.log('üßπ Cleared all additional info');
    }
}

// =============================================
// VIDEO LINKS MANAGER CLASS
// =============================================

class VideoLinksManager {
    constructor() {
        this.videoLinks = [];
        this.init();
    }

    init() {
        console.log('üé¨ Initializing VideoLinksManager...');
        this.bindEvents();
        this.render(); // G·ªçi render thay v√¨ renderEmpty ƒë·ªÉ x·ª≠ l√Ω ƒë√∫ng logic
    }

    bindEvents() {
        const addBtn = document.getElementById('addVideoLinkBtn');
        const input = document.getElementById('videoLinkInput');

        if (addBtn) {
            addBtn.addEventListener('click', () => this.addVideoLink());
        }

        if (input) {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.addVideoLink();
                }
            });
        }
    }

    addVideoLink() {
        const input = document.getElementById('videoLinkInput');
        const url = input.value.trim();

        if (!url) {
            Swal.fire({
                icon: 'warning',
                title: 'Thi·∫øu th√¥ng tin',
                text: 'Vui l√≤ng nh·∫≠p link video',
                confirmButtonText: 'OK'
            });
            return;
        }

        if (!this.isValidUrl(url)) {
            Swal.fire({
                icon: 'error',
                title: 'Link kh√¥ng h·ª£p l·ªá',
                text: 'Vui l√≤ng nh·∫≠p m·ªôt URL h·ª£p l·ªá',
                confirmButtonText: 'OK'
            });
            return;
        }

        const platform = this.detectPlatform(url);
        const linkData = {
            id: Date.now(),
            url: url,
            platform: platform
        };

        this.videoLinks.push(linkData);
        input.value = '';
        this.render();

        console.log('‚úÖ Added video link:', linkData);
    }

    removeVideoLink(id) {
        const index = this.videoLinks.findIndex(link => link.id === id);
        if (index === -1) return;

        const link = this.videoLinks[index];

        Swal.fire({
            title: 'X√≥a link video?',
            html: '<div style="word-break: break-all; margin-top: 10px; font-size: 0.9rem; color: #666;">' + link.url + '</div>',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'X√≥a',
            cancelButtonText: 'H·ªßy',
            confirmButtonColor: '#e53e3e'
        }).then((result) => {
            if (result.isConfirmed) {
                this.videoLinks.splice(index, 1);
                this.render();
                console.log('üóëÔ∏è Removed video link:', link);
            }
        });
    }

    isValidUrl(string) {
        try {
            new URL(string);
            return true;
        } catch (_) {
            return false;
        }
    }

    detectPlatform(url) {
        const lowerUrl = url.toLowerCase();
        
        if (lowerUrl.includes('youtube.com') || lowerUrl.includes('youtu.be')) {
            return 'YouTube';
        } else if (lowerUrl.includes('vimeo.com')) {
            return 'Vimeo';
        } else if (lowerUrl.includes('tiktok.com')) {
            return 'TikTok';
        } else if (lowerUrl.includes('facebook.com') || lowerUrl.includes('fb.watch')) {
            return 'Facebook';
        } else if (lowerUrl.includes('instagram.com')) {
            return 'Instagram';
        } else if (lowerUrl.includes('dailymotion.com')) {
            return 'Dailymotion';
        } else {
            return 'Video';
        }
    }

    getPlatformIcon(platform) {
        const icons = {
            'YouTube': 'fab fa-youtube',
            'Vimeo': 'fab fa-vimeo-v',
            'TikTok': 'fab fa-tiktok',
            'Facebook': 'fab fa-facebook',
            'Instagram': 'fab fa-instagram',
            'Dailymotion': 'fas fa-video',
            'Video': 'fas fa-link'
        };
        return icons[platform] || 'fas fa-link';
    }

    render() {
        const container = document.getElementById('videoLinksList');
        const emptyState = document.getElementById('videoLinksEmpty');

        if (!container) {
            console.warn('‚ö†Ô∏è Video links container not found');
            return;
        }

        console.log(`üîó Rendering ${this.videoLinks.length} video links`);

        // ·∫®n empty state n·∫øu c√≥ links, hi·ªán n·∫øu kh√¥ng c√≥
        if (this.videoLinks.length === 0) {
            container.innerHTML = '';
            container.style.display = 'none';
            if (emptyState) {
                emptyState.classList.remove('hidden');
                emptyState.style.display = ''; // Reset inline style
            }
            console.log('üì≠ No links - showing empty state');
            return;
        }

        // C√≥ links - hi·ªán container, ·∫©n empty state
        container.style.display = 'block';
        if (emptyState) {
            emptyState.classList.add('hidden');
            emptyState.style.display = 'none'; // Force hide with inline style
        }
        console.log('‚úÖ Has links - hiding empty state');

        container.innerHTML = this.videoLinks.map(link => {
            const icon = this.getPlatformIcon(link.platform);
            return '<div class="video-link-item" data-id="' + link.id + '">' +
                '<div class="video-link-icon">' +
                    '<i class="' + icon + '"></i>' +
                '</div>' +
                '<div class="video-link-content">' +
                    '<div class="video-link-platform">' + link.platform + '</div>' +
                    '<div class="video-link-url" title="' + link.url + '">' + link.url + '</div>' +
                '</div>' +
                '<div class="video-link-actions">' +
                    '<button type="button" class="btn-open-link" onclick="window.open(\\\'' + link.url + '\\\', \\\'_blank\\\')" title="M·ªü link">' +
                        '<i class="fas fa-external-link-alt"></i>' +
                    '</button>' +
                    '<button type="button" class="btn-remove-link" data-id="' + link.id + '" title="X√≥a link">' +
                        '<i class="fas fa-trash"></i>' +
                    '</button>' +
                '</div>' +
            '</div>';
        }).join('');

        this.bindItemEvents();
    }

    bindItemEvents() {
        document.querySelectorAll('.btn-remove-link').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = parseInt(e.currentTarget.getAttribute('data-id'));
                this.removeVideoLink(id);
            });
        });
    }

    renderEmpty() {
        const emptyState = document.getElementById('videoLinksEmpty');
        if (emptyState) {
            emptyState.classList.remove('hidden');
        }
    }

    getVideoLinksData() {
        console.log('üì¶ Getting video links data...');
        const links = this.videoLinks.map(link => link.url);
        console.log('‚úÖ Video links:', links);
        return links;
    }

    loadVideoLinksData(linksData) {
        console.log('üì• Loading video links data:', linksData);
        
        if (!linksData || !Array.isArray(linksData)) {
            console.warn('‚ö†Ô∏è Invalid video links data:', linksData);
            this.videoLinks = [];
            this.render(); // Render empty state
            return;
        }
        
        if (linksData.length === 0) {
            console.log('‚ÑπÔ∏è Video links data is empty array');
            this.videoLinks = [];
            this.render(); // Render empty state
            return;
        }
        
        this.videoLinks = linksData.map((url, index) => {
            console.log('‚ûï Adding video link:', url);
            return {
                id: Date.now() + index,
                url: url,
                platform: this.detectPlatform(url)
            };
        });
        
        this.render();
        console.log('‚úÖ Loaded video links:', this.videoLinks);
    }

    clearVideoLinks() {
        this.videoLinks = [];
        this.render();
        console.log('üßπ Cleared all video links');
    }
}

// Kh·ªüi t·∫°o khi DOM s·∫µn s√†ng
document.addEventListener('DOMContentLoaded', function() {
    window.productSpecsManager = new ProductSpecsManager();
    window.productVariantsManager = new ProductVariantsManager();
    window.additionalInfoManager = new AdditionalInfoManager();
    window.videoLinksManager = new VideoLinksManager();
    
    // C·∫≠p nh·∫≠t ProductManager ƒë·ªÉ t√≠ch h·ª£p v·ªõi th√¥ng s·ªë v√† bi·∫øn th·ªÉ
    const originalSaveProduct = ProductManager.prototype.saveProduct;
    ProductManager.prototype.saveProduct = async function() {
        try {
            const formData = this.getProductFormData();
            
            // Th√™m th√¥ng s·ªë k·ªπ thu·∫≠t v√†o formData
            if (window.productSpecsManager) {
                formData.chi_tiet = window.productSpecsManager.getSpecsData();
            }
            
            // Th√™m bi·∫øn th·ªÉ v√†o formData
            if (window.productVariantsManager) {
                formData.variants = window.productVariantsManager.getVariantsData();
            }
            
            // Th√™m th√¥ng tin kh√°c v√†o formData
            if (window.additionalInfoManager) {
                formData.thong_tin_khac = window.additionalInfoManager.getInfoData();
            }
            
            // Th√™m video links v√†o formData
            if (window.videoLinksManager) {
                formData.video_links = window.videoLinksManager.getVideoLinksData();
            }
            
            // Ph·∫ßn c√≤n l·∫°i c·ªßa logic l∆∞u s·∫£n ph·∫©m...
            if (!this.validateProductForm(formData)) {
                return;
            }
            
            // G·ªçi h√†m save g·ªëc
            return await originalSaveProduct.call(this);
        } catch (error) {
            console.error('Error saving product with specs:', error);
            throw error;
        }
    };
    
    // C·∫≠p nh·∫≠t khi m·ªü modal ch·ªânh s·ª≠a
    const originalFillProductForm = ProductManager.prototype.fillProductForm;
    ProductManager.prototype.fillProductForm = function(product) {
        originalFillProductForm.call(this, product);
        
        // Load th√¥ng s·ªë k·ªπ thu·∫≠t n·∫øu c√≥
        if (window.productSpecsManager && product.chi_tiet) {
            window.productSpecsManager.loadSpecsData(product.chi_tiet);
        }
        
        // Load bi·∫øn th·ªÉ n·∫øu c√≥
        if (window.productVariantsManager && product.variants) {
            window.productVariantsManager.loadVariantsData(product.variants);
        }

        // Load th√¥ng tin kh√°c n·∫øu c√≥
        if (window.additionalInfoManager && product.thong_tin_khac) {
            window.additionalInfoManager.loadInfoData(product.thong_tin_khac);
        }

        // Load video links n·∫øu c√≥
        if (window.videoLinksManager && product.video_links) {
            window.videoLinksManager.loadVideoLinksData(product.video_links);
        }
    };
    
    // Reset th√¥ng s·ªë v√† bi·∫øn th·ªÉ khi m·ªü modal th√™m m·ªõi
    const originalResetProductForm = ProductManager.prototype.resetProductForm;
    ProductManager.prototype.resetProductForm = function() {
        originalResetProductForm.call(this);
        
        if (window.productSpecsManager) {
            window.productSpecsManager.clearSpecs();
        }
        
        if (window.productVariantsManager) {
            window.productVariantsManager.clearVariants();
        }

        if (window.additionalInfoManager) {
            window.additionalInfoManager.clearInfo();
        }

        if (window.videoLinksManager) {
            window.videoLinksManager.clearVideoLinks();
        }
    };
});

// ƒê√ÇY L√Ä PH·∫¶N CODE C·∫¶N TH√äM V√ÄO FILE CH√çNH C·ª¶A B·∫†N
// Th∆∞·ªùng n·∫±m ·ªü cu·ªëi file, trong ph·∫ßn DOMContentLoaded

document.addEventListener('DOMContentLoaded', function() {
    // ... code hi·ªán t·∫°i c·ªßa b·∫°n (kh·ªüi t·∫°o ProductManager, BrandManager, CategoryManager) ...
    
    // ==================== TH√äM PH·∫¶N N√ÄY V√ÄO ====================
    
    // Kh·ªüi t·∫°o upload manager n·∫øu ch∆∞a c√≥
    if (!window.simpleImageUploadManager) {
        window.simpleImageUploadManager = new SimpleImageUploadManager();
    }
    
    // Reinitialize khi product modal m·ªü
    const productModal = document.getElementById('productModal');
    if (productModal) {
        productModal.addEventListener('show.bs.modal', () => {
            console.log('üì¶ Product modal opened - reinitializing upload events');
            setTimeout(() => {
                if (window.simpleImageUploadManager) {
                    // ƒê·∫£m b·∫£o events ƒë∆∞·ª£c bind l·∫°i
                    window.simpleImageUploadManager.productEventsBound = false;
                    window.simpleImageUploadManager.bindProductEvents();
                }
            }, 100);
        });
        
        // Reset khi modal ƒë√≥ng (tu·ª≥ ch·ªçn)
        productModal.addEventListener('hidden.bs.modal', () => {
            console.log('üì¶ Product modal closed');
            // C√≥ th·ªÉ reset ·∫£nh ·ªü ƒë√¢y n·∫øu mu·ªën
            // if (window.simpleImageUploadManager) {
            //     window.simpleImageUploadManager.resetProductImages();
            // }
        });
    }
    
    // Reinitialize khi brand modal m·ªü (n·∫øu c·∫ßn)
    const brandModal = document.getElementById('brandModal');
    if (brandModal) {
        brandModal.addEventListener('show.bs.modal', () => {
            setTimeout(() => {
                if (window.simpleImageUploadManager) {
                    window.simpleImageUploadManager.brandEventsBound = false;
                    window.simpleImageUploadManager.bindBrandEvents();
                }
            }, 100);
        });
    }
    
    // Reinitialize khi category modal m·ªü (n·∫øu c·∫ßn)
    const categoryModal = document.getElementById('categoryModal');
    if (categoryModal) {
        categoryModal.addEventListener('show.bs.modal', () => {
            setTimeout(() => {
                if (window.simpleImageUploadManager) {
                    window.simpleImageUploadManager.categoryEventsBound = false;
                    window.simpleImageUploadManager.bindCategoryEvents();
                }
            }, 100);
        });
    }
});
</script>


<style>
    /* Modern CSS Reset and Base Styles */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    :root {
        --primary: #667eea;
        --primary-dark: #5a6fd8;
        --secondary: #764ba2;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --dark: #1f2937;
        --light: #f8fafc;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --border-radius: 12px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --transition: all 0.3s ease;
    }

    body {
        font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
        background: var(--light);
        color: var(--gray-800);
        line-height: 1.6;
    }

    .main-content {
        min-height: 100vh;
        padding: 24px;
        max-width: 100%;
    }

    /* Header Styles */
    .dashboard-header {
        background: white;
        border-radius: var(--border-radius);
        padding: 28px 32px;
        margin-bottom: 24px;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        position: relative;
        overflow: hidden;
    }

    .dashboard-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
    }

    .header-title {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .title-icon {
        font-size: 2.75rem;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .header-title h1 {
        margin: 0;
        font-size: 1.875rem;
        font-weight: 700;
        color: var(--gray-800);
    }

    .header-title p {
        margin: 4px 0 0 0;
        color: var(--gray-500);
        font-size: 1rem;
    }

    .header-actions {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
    }

    /* Button Styles */
    .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 0.95rem;
        transition: var(--transition);
        box-shadow: var(--shadow);
        text-decoration: none;
        position: relative;
        overflow: hidden;
    }

    .btn-primary::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s;
    }


    /* Brand-specific: stack upload area above preview */
    .brand-file-upload {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }

    .brand-file-upload > .file-upload-area {
        width: 100%;
    }

    .brand-file-upload > .logo-preview-container {
        width: 100%;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
        background: white;
        color: var(--gray-700);
        border: 2px solid var(--gray-300);
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        font-size: 0.9rem;
        transition: var(--transition);
    }

    .btn-secondary:hover {
        background: var(--gray-100);
        border-color: var(--gray-400);
        transform: translateY(-1px);
    }

    /* Stats Overview */
    .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 24px;
        display: flex;
        align-items: center;
        gap: 20px;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(to bottom, var(--primary), var(--secondary));
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
    }

    .stat-icon {
        width: 70px;
        height: 70px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
        box-shadow: var(--shadow);
    }

    .stat-icon.total {
        background: linear-gradient(135deg, #fed7d7, #feb2b2);
        color: #e53e3e;
    }

    .stat-icon.available {
        background: linear-gradient(135deg, #c6f6d5, #9ae6b4);
        color: #38a169;
    }

    .stat-icon.busy {
        background: linear-gradient(135deg, #fef5e7, #fbd38d);
        color: #ed8936;
    }

    .stat-icon.premium {
        background: linear-gradient(135deg, #e9d8fd, #d6bcfa);
        color: #805ad5;
    }

    .stat-info h3 {
        margin: 0;
        font-size: 2rem;
        color: var(--gray-800);
        font-weight: 700;
    }

    .stat-info p {
        margin: 4px 0 0 0;
        color: var(--gray-500);
        font-weight: 500;
    }

    /* Search and Filter */
    .search-filter-bar {
        background: white;
        border-radius: var(--border-radius);
        padding: 24px;
        margin-bottom: 24px;
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
    }

    .search-box {
        display: flex;
        align-items: center;
        background: var(--gray-100);
        border-radius: 10px;
        padding: 12px 20px;
        flex: 1;
        min-width: 400px;
        border: 2px solid var(--gray-200);
        transition: var(--transition);
    }

    .search-box:focus-within {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .search-box i {
        color: var(--gray-400);
        margin-right: 12px;
    }

    .search-box input {
        border: none;
        background: none;
        outline: none;
        flex: 1;
        padding: 4px 0;
        font-size: 0.95rem;
        color: var(--gray-800);
    }

    .search-btn {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 8px;
        cursor: pointer;
        margin-left: 12px;
        font-weight: 600;
        transition: var(--transition);
    }

    .search-btn:hover {
        transform: translateY(-1px);
    }

    .filter-controls {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
    }

    .filter-select {
        padding: 10px 16px;
        border: 2px solid var(--gray-200);
        border-radius: 8px;
        background: white;
        color: var(--gray-700);
        min-width: 160px;
        cursor: pointer;
        transition: var(--transition);
        font-size: 0.9rem;
    }

    .filter-select:focus {
        border-color: var(--primary);
        outline: none;
    }

    .clear-filters {
        background: none;
        border: 2px solid var(--gray-200);
        color: var(--gray-600);
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: var(--transition);
    }

    .clear-filters:hover {
        background: var(--gray-100);
        border-color: var(--gray-300);
    }

    /* Table Styles */
    .table-container {
        background: white;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow);
        margin-bottom: 5px;
    }

    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid var(--gray-200);
        background: var(--gray-50);
    }

    .table-header h3 {
        margin: 0;
        color: var(--gray-800);
        font-size: 1.25rem;
        font-weight: 600;
    }

    .table-actions {
        display: flex;
        gap: 12px;
    }

    .btn-export {
        background: white;
        color: var(--gray-700);
        border: 2px solid var(--gray-300);
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 500;
        font-size: 0.9rem;
        transition: var(--transition);
    }

    .btn-export:hover {
        background: var(--gray-100);
        border-color: var(--gray-400);
    }

    .table-responsive {
        overflow-x: auto;
    }

    .products-table {
        width: 100%;
        border-collapse: collapse;
    }

    .products-table th {
        background: var(--gray-50);
        padding: 16px 12px;
        text-align: left;
        font-weight: 600;
        color: var(--gray-700);
        border-bottom: 1px solid var(--gray-200);
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .products-table td {
        padding: 16px 12px;
        border-bottom: 1px solid var(--gray-200);
        vertical-align: middle;
    }

    .products-table tbody tr {
        transition: var(--transition);
    }

    .products-table tbody tr:hover {
        background: var(--gray-50);
    }

    .products-table tbody tr:last-child td {
        border-bottom: none;
    }

    /* Table Column Styles */
    {{!-- .col-checkbox {
        width: 40px;
        text-align: center;
    } --}}

    .col-image {
        width: 80px;
    }

    .col-name {
        min-width: 200px;
    }

    .col-sku {
        width: 120px;
    }

    .col-price {
        width: 120px;
    }

    .col-category,
    .col-brand {
        width: 120px;
    }

    .col-status {
        width: 140px;
    }

    {{!-- .col-featured {
        width: 80px;
        text-align: center;
    } --}}

    .col-actions {
        width: 100px;
    }

    /* Table Content Styles */
    .product-table-image {
        width: 50px;
        height: 50px;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--gray-100);
    }

    .product-table-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .product-name {
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: 4px;
    }

    .price-info {
        display: flex;
        flex-direction: column;
    }

    .current-price {
        font-weight: 600;
        color: var(--primary);
        font-size: 0.95rem;
    }

    .original-price {
        font-size: 0.85rem;
        color: var(--gray-400);
        text-decoration: line-through;
    }

    .category-badge,
    .brand-badge {
        background: var(--gray-100);
        color: var(--gray-700);
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .status-badge {
        padding: 6px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
    }

    .status-badge.active {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
    }

    .status-badge.inactive {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
    }

    .featured-icon {
        color: var(--warning);
    }

    .action-buttons {
        display: flex;
        gap: 8px;
        justify-content: center;
        align-items: center;
    }

    /* Bootstrap Button Customization */
    .btn-action-modern {
        font-weight: 600;
        font-size: 0.813rem;
        padding: 0.5rem;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: none;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-action-modern::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s;
    }

    .btn-action-modern:hover::before {
        left: 100%;
    }

    .btn-action-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }

    .btn-action-modern:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }

    .btn-action-modern i {
        font-size: 1rem;
    }

    /* Primary Button - Edit */
    .btn-action-modern.btn-primary {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        color: white;
    }

    .btn-action-modern.btn-primary:hover {
        background: linear-gradient(135deg, #0a58ca 0%, #084298 100%);
        color: white;
    }

    /* Warning Button - Toggle */
    .btn-action-modern.btn-warning {
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        color: #000;
        font-weight: 700;
    }

    .btn-action-modern.btn-warning:hover {
        background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        color: #000;
    }

    /* Danger Button - Delete */
    .btn-action-modern.btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #bb2d3b 100%);
        color: white;
    }

    .btn-action-modern.btn-danger:hover {
        background: linear-gradient(135deg, #bb2d3b 0%, #9a2530 100%);
        color: white;
    }

    /* Icon Animation on Hover */
    .btn-edit:hover i {
        animation: editBounce 0.5s ease;
    }

    .btn-toggle-status:hover i {
        animation: toggleFlip 0.4s ease;
    }

    .btn-delete-product:hover i {
        animation: deleteShake 0.4s ease;
    }

    @keyframes editBounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-3px); }
    }

    @keyframes toggleFlip {
        0% { transform: rotateY(0deg); }
        100% { transform: rotateY(360deg); }
    }

    @keyframes deleteShake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-2px) rotate(-5deg); }
        75% { transform: translateX(2px) rotate(5deg); }
    }

    /* Responsive - Buttons already icon-only */
    @media (max-width: 768px) {
        .btn-action-modern {
            width: 32px;
            height: 32px;
            padding: 0.4rem;
        }
        .btn-action-modern i {
            font-size: 0.875rem;
        }
    }

    /* Fallback for old btn-action class (for other sections) */
    .btn-action {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        color: white;
        font-size: 0.9rem;
    }

    .btn-action.btn-edit {
        background: var(--primary);
    }

    .btn-action.btn-edit:hover {
        background: var(--primary-dark);
        transform: scale(1.05);
    }

    .btn-action.btn-delete {
        background: var(--danger);
    }

    .btn-action.btn-delete:hover {
        background: #dc2626;
        transform: scale(1.05);
    }

    /* Table Footer */
    .table-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        border-top: 1px solid var(--gray-200);
        background: var(--gray-50);
    }

    .table-info {
        color: var(--gray-600);
        font-size: 0.9rem;
    }

    .table-pagination {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .pagination-btn {
        width: 32px;
        height: 32px;
        border: 1px solid var(--gray-300);
        background: white;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        color: var(--gray-600);
    }

    .pagination-btn:hover:not(:disabled) {
        background: var(--gray-100);
        border-color: var(--gray-400);
    }

    .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pagination-info {
        font-size: 0.9rem;
        color: var(--gray-600);
    }

    /* Empty State */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 80px 40px;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        text-align: center;
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.7;
    }

    .empty-content h3 {
        margin: 0 0 8px 0;
        color: var(--gray-800);
        font-size: 1.5rem;
    }

    .empty-content p {
        margin: 0 0 24px 0;
        color: var(--gray-500);
    }

    /* Loading State */
    .loading-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--gray-200);
        border-left: 4px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Modal Styles */
    .modal-premium .modal-content {
        border: none;
        border-radius: 16px;
        box-shadow: var(--shadow-lg);
        overflow: hidden;
    }

    .modal-premium .modal-header {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border-bottom: none;
        padding: 24px 28px;
    }

    .modal-premium .modal-title {
        font-weight: 700;
        font-size: 1.4rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-premium .modal-body {
        padding: 0;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-premium .modal-footer {
        border-top: 1px solid var(--gray-200);
        padding: 5px 28px;
        background: white;
    }

    /* Technical Specifications Modal Styles */
    /* Form Styles */
    .form-sections {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .form-section {
        background: var(--gray-50);
        border-radius: 12px;
        padding: 0 20px;
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
        color: var(--gray-700);
        font-size: 1.1rem;
        font-weight: 600;
    }

    .section-title i {
        color: var(--primary);
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .form-group {
        margin-bottom: 0;
    }

    .form-label {
        font-weight: 600;
        color: var(--gray-700);
        margin: 8px 0px 3px 0px;
        font-size: 0.95rem;
        display: block;
    }

    .form-control,
    .form-select {
        border: 2px solid var(--gray-200);
        border-radius: 8px;
        padding: 12px;
        font-size: 0.95rem;
        transition: var(--transition);
        background: white;
        width: 100%;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        outline: none;
    }

    .input-group {
        display: flex;
        border-radius: 8px;
        overflow: hidden;
    }

    .input-group .form-control {
        border-radius: 8px 0 0 8px;
    }

    .input-group .input-group-text {
        background: var(--gray-100);
        border: 2px solid var(--gray-200);
        border-left: none;
        color: var(--gray-600);
        padding: 12px;
        border-radius: 0 8px 8px 0;
    }

    .image-preview-container {
        margin-top: 12px;
    }

    .image-preview {
        border: 2px dashed var(--gray-300);
        border-radius: 12px;
        padding: 40px;
        text-align: center;
        color: var(--gray-500);
        background: white;
        transition: var(--transition);
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .image-preview.has-image {
        border-color: var(--primary);
        background: var(--gray-50);
        padding: 20px;
    }

    .image-preview img {
        max-width: 100%;
        max-height: 160px;
        border-radius: 8px;
    }

    .preview-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .preview-placeholder i {
        font-size: 3rem;
        color: var(--gray-300);
    }

    .checkbox-group {
        margin-top: 8px;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-weight: 500;
        color: var(--gray-700);
    }

    .checkbox-label input[type="checkbox"] {
        display: none;
    }

    .checkmark {
        width: 20px;
        height: 20px;
        border: 2px solid var(--gray-300);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }

    .checkbox-label input[type="checkbox"]:checked+.checkmark {
        background: var(--primary);
        border-color: var(--primary);
    }

    .checkbox-label input[type="checkbox"]:checked+.checkmark::after {
        content: '‚úì';
        color: white;
        font-size: 12px;
        font-weight: bold;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .table-responsive {
            overflow-x: auto;
        }

        .products-table {
            min-width: 1000px;
        }
    }

    @media (max-width: 768px) {
        .main-content {
            padding: 16px;
        }

        .header-content {
            flex-direction: column;
            text-align: center;
        }

        .header-actions {
            justify-content: center;
            width: 100%;
        }

        .search-filter-bar {
            flex-direction: column;
        }

        .search-box {
            min-width: auto;
            width: 100%;
        }

        .filter-controls {
            width: 100%;
            justify-content: space-between;
        }

        .filter-select {
            flex: 1;
            min-width: auto;
        }

        .table-header {
            flex-direction: column;
            gap: 16px;
            align-items: flex-start;
        }

        .table-footer {
            flex-direction: column;
            gap: 16px;
            align-items: flex-start;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .stats-overview {
            grid-template-columns: 1fr;
        }

        .specs-list-header {
            flex-direction: column;
            gap: 12px;
            align-items: flex-start;
        }
    }

    @media (max-width: 480px) {
        .header-actions {
            flex-direction: column;
            width: 100%;
        }

        .btn-primary,
        .btn-secondary {
            width: 100%;
            justify-content: center;
        }

        .modal-premium .modal-footer {
            flex-direction: column;
            gap: 8px;
        }

        .modal-premium .btn {
            width: 100%;
            justify-content: center;
        }
    }

    /* Additional styles for management modals */
    .management-modal .modal-content {
        max-height: 80vh;
        overflow-y: auto;
    }

    .management-modal .table-container {
        margin-top: 20px;
    }

    .management-modal .form-section {
        background: var(--gray-50);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .management-modal .section-title {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
        color: var(--gray-700);
        font-size: 1.1rem;
        font-weight: 600;
    }

    /* TH√äM V√ÄO CU·ªêI FILE CSS */
    .modal-premium .modal-dialog {
        max-height: 600px;
        max-width: none;
        margin: 1.75rem auto;
    }

    .modal-premium .modal-xl {
        max-width: 1140px;
    }

    .modal-premium .modal-xxl {
        max-width: 1400px;
    }

    .modal-premium .modal-lg {
        max-width: 800px;
    }

    /* ƒê·∫£m b·∫£o modal content kh√¥ng b·ªã ·∫£nh h∆∞·ªüng b·ªüi c√°c style kh√°c */
    .modal-premium .modal-content {
        border: none !important;
        box-shadow: var(--shadow-lg) !important;
    }

    .modal-premium .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
    }

    @media (max-width: 1400px) {
        .modal-premium .modal-xxl {
            max-width: 95%;
            margin: 1rem auto;
        }
    }

    @media (max-width: 1200px) {
        .modal-premium .modal-xl {
            max-width: 95%;
        }
    }

    .form-grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    @media (max-width: 768px) {
        .form-grid-2 {
            grid-template-columns: 1fr;
        }
    }

    /* ƒê·∫£m b·∫£o form controls trong modal kh√¥ng b·ªã ·∫£nh h∆∞·ªüng */
    .modal-premium .form-control,
    .modal-premium .form-select {
        border: 2px solid var(--gray-200);
        border-radius: 8px;
        padding: 12px;
        font-size: 0.95rem;
        background: white;
    }

    .modal-premium .form-control:focus,
    .modal-premium .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        outline: none;
    }

    .modal-premium .table-responsive {
        border: 1px solid var(--gray-200);
        border-radius: 8px;
    }

    .modal-premium .products-table {
        margin-bottom: 0;
    }

    .modal-premium .products-table th {
        background: var(--gray-50);
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .logo-preview-container {
        border: 2px dashed var(--gray-300);
        border-radius: 12px;
        padding: 20px;
        background: white;
        transition: var(--transition);
    }

    .logo-preview-container.has-logo {
        border-color: var(--primary);
        background: var(--gray-50);
    }

    .logo-preview {
        text-align: center;
        min-height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .logo-preview img {
        max-width: 100%;
        max-height: 70%;
        border-radius: 8px;
    }

    .preview-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        color: var(--gray-500);
    }

    .preview-placeholder i {
        font-size: 2rem;
        color: var(--gray-300);
    }

    .char-count-warning {
        color: var(--warning);
    }

    .char-count-error {
        color: var(--danger);
    }

    /* ===== BRAND MANAGEMENT MODAL STYLES ===== */
    .modal-premium .modal-xxl {
        max-width: 1400px;
    }

    .modal-premium .modal-xl {
        max-width: 1140px;
    }

    .modal-premium .modal-lg {
        max-width: 800px;
    }

    @media (max-width: 1400px) {
        .modal-premium .modal-xxl {
            max-width: 95%;
            margin: 1rem auto;
        }
    }

    @media (max-width: 1200px) {
        .modal-premium .modal-xl {
            max-width: 95%;
        }
    }

    /* Form Grid System */
    .form-grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .form-grid-3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 16px;
    }

    @media (max-width: 768px) {

        .form-grid-2,
        .form-grid-3 {
            grid-template-columns: 1fr;
        }
    }

    /* Form Section Containers */
    .form-section-container {
        background: var(--gray-50);
        border-radius: 12px;
        padding: 0;
        height: fit-content;
        position: sticky;
        top: 0;
    }

    .table-section-container {
        background: white;
        border-radius: 12px;
        padding: 0;
        border: 1px solid var(--gray-200);
        overflow: hidden;
    }

    .table-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 14px;
        border-bottom: 1px solid var(--gray-200);
        background: var(--gray-50);
    }

    .table-section-header .section-title {
        margin: 0;
        font-size: 1.1rem;
    }

    .table-controls {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .search-box-sm {
        display: flex;
        align-items: center;
        background: white;
        border: 1px solid var(--gray-300);
        border-radius: 6px;
        padding: 8px 12px;
        min-width: 200px;
    }

    .search-box-sm i {
        color: var(--gray-400);
        margin-right: 8px;
        font-size: 0.9rem;
    }

    .search-box-sm input {
        border: none;
        background: none;
        outline: none;
        flex: 1;
        font-size: 0.85rem;
        color: var(--gray-800);
    }

    /* Logo Preview Styles */
    .logo-preview-container {
        flex: 1;
        min-height: 280px;
        border: 3px dashed var(--gray-400);
        border-radius: 12px;
        background: var(--gray-50);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        box-sizing: border-box;
        transition: all 0.3s ease;
    }

    .logo-preview-container.has-logo {
        border-color: var(--success);
        border-style: solid;
        background: var(--success-light);
    }

    .logo-preview {
        text-align: center;
        min-height: 190px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }

    .logo-preview img {
        max-width: 100%;
        max-height: 70%;
        border-radius: 8px;
        object-fit: contain;
    }

    /* File upload + preview layout (brand & category) */
    .file-upload-container {
        display: flex;
        gap: 20px;
        align-items: stretch;
        width: 100%;
        min-height: 300px;
        margin: 15px 0;
        padding: 0;
        box-sizing: border-box;
    }

    .brand-file-upload .file-upload-container {
        min-height: 320px;
    }

    .file-upload-area {
        flex: 1;
        min-height: 280px;
        border: 3px dashed var(--gray-400);
        border-radius: 12px;
        background: var(--gray-50);
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 30px;
        text-align: center;
        position: relative;
        box-sizing: border-box;
    }

    .file-upload-area .choose-btn {
        background: var(--primary);
        color: #fff;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .overlay-choose-btn {
        position: absolute;
        right: 10px;
        bottom: 10px;
        background: rgba(0,0,0,0.6);
        color: #fff;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .upload-preview {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .upload-preview img,
    .logo-preview img {
        max-width: 100%;
        max-height: 100%;
        border-radius: 6px;
        object-fit: cover;
    }

    .logo-preview {
        position: relative;
        width: 100%;
        max-width: 360px;
        min-height: 160px;
        border-radius: 8px;
        overflow: hidden;
        background: var(--gray-50);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px;
    }

    /* specific container for category preview to match brand */
    #categoryImagePreviewContainer {
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        padding: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        min-height: 140px;
        background: white;
    }

    /* When a logo exists, slightly highlight the container */
    .logo-preview-container.has-logo #categoryImagePreviewContainer,
    .logo-preview-container.has-logo .logo-preview {
        border-color: var(--primary);
        box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    }

    .preview-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        color: var(--gray-500);
    }

    .preview-placeholder i {
        font-size: 2rem;
        color: var(--gray-300);
    }

    .preview-placeholder span {
        font-size: 0.9rem;
    }

    /* Character Counter */
    .char-counter {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.85rem;
        color: var(--gray-500);
        margin-top: 4px;
    }

    .char-count-warning {
        color: var(--warning);
    }

    .char-count-error {
        color: var(--danger);
    }

    /* Form Actions */
    .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding-top: 16px;
        border-top: 1px solid var(--gray-200);
    }

    .form-actions .btn {
        min-width: 140px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    /* Empty State Styles */
    .empty-state-sm {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        text-align: center;
        color: var(--gray-500);
    }

    .empty-state-sm .empty-icon {
        font-size: 3rem;
        margin-bottom: 16px;
        opacity: 0.7;
    }

    .empty-state-sm .empty-content h5 {
        margin: 0 0 8px 0;
        color: var(--gray-600);
        font-size: 1.1rem;
    }

    .empty-state-sm .empty-content p {
        margin: 0;
        font-size: 0.9rem;
    }

    /* Hide empty state when there's data */
    .table-container:has(tbody tr:first-child)+.empty-state-sm,
    .table-section-container:has(.table-responsive table tbody tr:first-child) .empty-state-sm {
        display: none !important;
    }

    /* Show empty state when no data */
    .table-container:not(:has(tbody tr:first-child))+.empty-state-sm,
    .table-section-container:not(:has(.table-responsive table tbody tr:first-child)) .empty-state-sm {
        display: flex !important;
    }

    /* Modal Footer Info */
    .modal-footer-info {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--gray-500);
        font-size: 0.9rem;
    }

    .modal-footer-info i {
        color: var(--primary);
    }

    /* Enhanced Table Styles for Management Modals */
    .management-table {
        width: 100%;
        border-collapse: collapse;
    }

    .management-table th {
        background: var(--gray-50);
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        color: var(--gray-700);
        border-bottom: 1px solid var(--gray-200);
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .management-table td {
        padding: 12px 16px;
        border-bottom: 1px solid var(--gray-200);
        vertical-align: middle;
    }

    .management-table tbody tr {
        transition: var(--transition);
    }

    .management-table tbody tr:hover {
        background: var(--gray-50);
    }

    .management-table tbody tr:last-child td {
        border-bottom: none;
    }

    /* Compact Action Buttons */
    .compact-actions {
        display: flex;
        gap: 4px;
        justify-content: center;
    }

    .btn-compact {
        width: 28px;
        height: 28px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        color: white;
        font-size: 0.8rem;
    }

    .btn-compact-edit {
        background: var(--primary);
    }

    .btn-compact-edit:hover {
        background: var(--primary-dark);
        transform: scale(1.05);
    }

    .btn-compact-delete {
        background: var(--danger);
    }

    .btn-compact-delete:hover {
        background: #dc2626;
        transform: scale(1.05);
    }

    /* Status Badge Variants */
    .status-badge-sm {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
    }

    .status-badge-sm.active {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
    }

    .status-badge-sm.inactive {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
    }

    /* Form Text Improvements */
    .form-text {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.70rem;
        color: var(--gray-500);
        margin-top: 4px;
    }

    .form-text .char-count {
        font-weight: 500;
    }

    /* Input Group Enhancements */
    .input-group .btn-outline-secondary {
        border: 2px solid var(--gray-200);
        border-left: none;
        background: white;
        color: var(--gray-600);
        transition: var(--transition);
    }

    .input-group .btn-outline-secondary:hover {
        background: var(--gray-100);
        color: var(--gray-700);
    }

    /* Responsive Improvements for Brand Modal */
    @media (max-width: 992px) {
        .modal-premium .modal-body .row {
            flex-direction: column;
        }

        .modal-premium .modal-body .col-lg-5,
        .modal-premium .modal-body .col-lg-7 {
            width: 100%;
            max-width: 100%;
        }

        .form-section-container {
            position: static;
            margin-bottom: 24px;
        }
    }

    /* Loading State for Tables */
    .table-loading {
        position: relative;
        min-height: 200px;
    }

    .table-loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 30px;
        height: 30px;
        border: 3px solid var(--gray-200);
        border-left: 3px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    /* Animation for smooth transitions */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .table-section-container .table-responsive {
        animation: fadeIn 0.3s ease-out;
    }

    /* Scrollbar Styling for Tables */
    .table-responsive::-webkit-scrollbar {
        height: 8px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: var(--gray-100);
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: var(--gray-300);
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: var(--gray-400);
    }

    /* Focus States for Accessibility */
    .form-control:focus,
    .form-select:focus,
    .search-box-sm:focus-within {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        outline: none;
    }

    /* Button States */
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    .btn:disabled:hover {
        transform: none !important;
    }

    /* Text Truncation for Table Cells */
    .text-truncate {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .max-width-200 {
        max-width: 200px;
    }

    .max-width-150 {
        max-width: 150px;
    }

    /* Badge Styles for Tables */
    .badge-sm {
        padding: 4px 8px;
        font-size: 0.75rem;
        border-radius: 6px;
        font-weight: 500;
    }

    .badge-outline {
        background: transparent;
        border: 1px solid currentColor;
    }

    /* Custom Checkbox Alignment */
    {{!-- .col-checkbox {
        width: 40px;
        text-align: center;
        vertical-align: middle;
    }

    .col-checkbox input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
    } --}}

    /* Image Cell Styles */
    .col-image {
        width: 60px;
        text-align: center;
    }

    .image-cell {
        width: 40px;
        height: 40px;
        border-radius: 6px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--gray-100);
        margin: 0 auto;
    }

    .image-cell img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* Action Column Styles */
    .col-actions {
        width: 100px;
        text-align: center;
    }

    /* Ensure modal content fits properly */
    .modal-premium .modal-body {
        padding: 10px;
    }

    .modal-premium .container-fluid {
        padding: 0;
    }

    /* Fix for modal header in management modals */
    .modal-premium .modal-header {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border-bottom: none;
        padding: 20px 24px;
    }

    .modal-premium .modal-title {
        font-weight: 600;
        font-size: 1.3rem;
    }

    /* Responsive text sizes */
    @media (max-width: 768px) {
        .modal-premium .modal-title {
            font-size: 1.1rem;
        }

        .section-title {
            font-size: 1rem;
        }

        .form-actions {
            flex-direction: column;
        }

        .form-actions .btn {
            width: 100%;
        }
    }

    /* Print Styles */
    @media print {

        .modal-premium .modal-header,
        .modal-premium .modal-footer,
        .table-controls,
        .form-section-container {
            display: none !important;
        }

        .modal-premium .modal-body {
            padding: 0;
        }

        .table-section-container {
            border: none;
            box-shadow: none;
        }
    }

    /* Loading state improvements */
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    .fa-spinner {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Table loading state */
    .table-loading {
        text-align: center;
        color: var(--gray-500);
    }

    .table-loading .loading-spinner {
        margin: 0 auto 16px auto;
    }

    /* Empty state improvements */
    .empty-state-sm {
        transition: var(--transition);
    }

    /* Th√™m v√†o cu·ªëi file CSS */
    .search-box-sm {
        display: flex;
        align-items: center;
        background: white;
        border: 1px solid var(--gray-300);
        border-radius: 6px;
        padding: 8px 12px;
        min-width: 200px;
        transition: var(--transition);
        position: relative;
    }

    .search-box-sm:focus-within {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }

    .search-box-sm i {
        color: var(--gray-400);
        margin-right: 8px;
        font-size: 0.9rem;
    }

    .search-box-sm input {
        border: none;
        background: none;
        outline: none;
        flex: 1;
        font-size: 0.85rem;
        color: var(--gray-800);
        width: 100%;
    }

    .search-box-sm input::placeholder {
        color: var(--gray-400);
    }

    /* Clear button cho search */
    .search-box-sm .clear-search {
        position: absolute;
        right: 8px;
        background: none;
        border: none;
        color: var(--gray-400);
        cursor: pointer;
        padding: 4px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }

    .search-box-sm .clear-search:hover {
        background: var(--gray-200);
        color: var(--gray-600);
    }

    /* Search results info */
    .search-results-info {
        font-size: 0.8rem;
        color: var(--gray-500);
        margin-top: 4px;
    }

    .search-results-info.has-results {
        color: var(--primary);
    }

    /* Th√™m v√†o cu·ªëi file CSS */
    /* CƒÉn gi·ªØa header cho t·∫•t c·∫£ c√°c b·∫£ng */
    .products-table th {
        text-align: center !important;
        vertical-align: middle !important;
    }

    /* CƒÉn gi·ªØa n·ªôi dung trong c√°c c·ªôt */
    .products-table td {
        text-align: center;
        vertical-align: middle;
    }

    /* Ri√™ng c·ªôt t√™n s·∫£n ph·∫©m v√† m√¥ t·∫£ c√≥ th·ªÉ cƒÉn tr√°i ƒë·ªÉ d·ªÖ ƒë·ªçc */
    .products-table .col-name,
    .products-table .col-name .product-name,
    .products-table .col-name .product-sku {
        text-align: left;
    }

    /* CƒÉn gi·ªØa cho b·∫£ng th∆∞∆°ng hi·ªáu */
    #brandsTable th,
    #brandsTable td {
        text-align: center;
        vertical-align: middle;
    }

    /* Ri√™ng c·ªôt t√™n th∆∞∆°ng hi·ªáu v√† m√¥ t·∫£ cƒÉn tr√°i */
    #brandsTable td:first-child {
        text-align: left;
    }

    /* CƒÉn gi·ªØa cho b·∫£ng danh m·ª•c */
    #categoriesTable th,
    #categoriesTable td {
        text-align: center;
        vertical-align: middle;
    }

    /* Ri√™ng c·ªôt t√™n danh m·ª•c cƒÉn tr√°i */
    #categoriesTable td:first-child {
        text-align: left;
    }

    /* CƒÉn gi·ªØa cho b·∫£ng s·∫£n ph·∫©m ch√≠nh */
    #productsTable th,
    #productsTable td {
        text-align: center;
        vertical-align: middle;
    }

    /* Ri√™ng c√°c c·ªôt c·∫ßn cƒÉn tr√°i trong b·∫£ng s·∫£n ph·∫©m */
    #productsTable .col-name,
    #productsTable .col-name .product-name,
    #productsTable .col-sku .product-sku {
        text-align: left;
    }

    /* CƒÉn gi·ªØa cho c√°c icon v√† badge */
    .status-badge,
    .category-badge,
    .brand-badge {
        display: inline-block;
        text-align: center;
    }

    /* CƒÉn gi·ªØa cho h√¨nh ·∫£nh */
    .product-table-image {
        margin: 0 auto;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* CƒÉn gi·ªØa cho action buttons */
    .action-buttons {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 6px;
    }

    /* CƒÉn gi·ªØa cho checkbox */
    {{!-- .col-checkbox {
        display: flex;
        justify-content: center;
        align-items: center;
    } --}}

    /* CƒÉn gi·ªØa cho featured icon */
    {{!-- .col-featured {
        display: flex;
        justify-content: center;
        align-items: center;
    } --}}

    /* CƒÉn gi·ªØa cho n√∫t xem th√¥ng s·ªë */
    /* ƒê·∫£m b·∫£o price info c≈©ng ƒë∆∞·ª£c cƒÉn gi·ªØa */
    .price-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {

        .products-table th,
        .products-table td {
            text-align: center;
        }

        /* Tr√™n mobile, c√≥ th·ªÉ cƒÉn tr√°i t·∫•t c·∫£ cho d·ªÖ ƒë·ªçc */
        .products-table .col-name,
        .products-table .col-name .product-name,
        .products-table .col-sku .product-sku {
            text-align: center;
        }
    }
    
    
/* File Upload Styles */
    .file-upload-container {
        margin-bottom: 16px;
    }

    .file-upload-area {
        border: 2px dashed var(--gray-300);
        border-radius: 12px;
        padding: 30px 20px;
        text-align: center;
        background: var(--gray-50);
        transition: var(--transition);
        cursor: pointer;
        position: relative;
    }

    .file-upload-area:hover {
        border-color: var(--primary);
        background: var(--primary-light);
        transform: translateY(-2px);
    }

    .file-upload-area.dragover {
        border-color: var(--primary);
        background: var(--primary-light);
        transform: scale(1.02);
    }

    .upload-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        color: var(--gray-600);
        padding: 20px;
    }

    .upload-placeholder i {
        font-size: 3rem !important;
        color: var(--gray-400);
    }

    .upload-placeholder span {
        font-size: 1.1rem;
        font-weight: 500;
    }

    .upload-placeholder small {
        font-size: 0.9rem;
        color: var(--gray-500);
        max-width: 200px;
        line-height: 1.4;
    }

    /* Main Image Preview */
    .upload-preview {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 15px;
    }

    .upload-preview img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        object-fit: contain;
    }

    .btn-change-image {
        background: var(--primary);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: var(--transition);
    }

    .btn-change-image:hover {
        background: var(--primary-dark);
    }

    /* Additional Images Preview */
    .additional-images-preview {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 12px;
        margin-top: 16px;
    }

    .additional-image-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid var(--gray-200);
    }

    .additional-image-item img {
        width: 100%;
        height: 80px;
        object-fit: cover;
    }

    .remove-image-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 24px;
        height: 24px;
        background: var(--danger);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        opacity: 0;
        transition: var(--transition);
    }

    .additional-image-item:hover .remove-image-btn {
        opacity: 1;
    }

    /* Videos Preview */
    .videos-preview {
        margin-top: 16px;
    }

    .video-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background: var(--gray-100);
        border-radius: 8px;
        margin-bottom: 8px;
        border: 1px solid var(--gray-200);
    }

    .video-info {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
    }

    .video-icon {
        color: var(--primary);
        font-size: 1.5rem;
    }

    .video-details {
        flex: 1;
    }

    .video-name {
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 4px;
    }

    .video-size {
        color: var(--gray-500);
        font-size: 0.85rem;
    }

    .remove-video-btn {
        background: var(--danger);
        color: white;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }

    .remove-video-btn:hover {
        background: #dc2626;
    }

    /* Upload Progress */
    .upload-progress {
        margin-top: 8px;
    }

    .progress-bar {
        width: 100%;
        height: 6px;
        background: var(--gray-200);
        border-radius: 3px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: var(--success);
        transition: width 0.3s ease;
    }

    .progress-text {
        font-size: 0.8rem;
        color: var(--gray-500);
        margin-top: 4px;
        text-align: center;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .additional-images-preview {
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        }

        .video-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .video-info {
            width: 100%;
        }

        .remove-video-btn {
            align-self: flex-end;
        }
    }
    /* Container ch√≠nh cho upload - FIXED */
.file-upload-container {
    display: flex;
    gap: 20px;
    align-items: stretch;
    width: 100%;
    min-height: 300px;
    margin: 15px 0;
    padding: 0;
    box-sizing: border-box;
}

/* ƒê·∫∑c bi·ªát cho brand upload */
.brand-file-upload .file-upload-container {
    min-height: 320px;
}

/* V√πng upload file */
.file-upload-area {
    flex: 1;
    min-height: 280px;
    border: 3px dashed var(--gray-400);
    border-radius: 12px;
    background: var(--gray-50);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 30px;
    text-align: center;
    position: relative;
    box-sizing: border-box;
}

.file-upload-area:hover {
    border-color: var(--primary);
    background: var(--primary-light);
    transform: translateY(-2px);
}

.file-upload-area.dragover {
    border-color: var(--primary);
    background: var(--primary-light);
    transform: scale(1.02);
}

/* V√πng preview ·∫£nh */
.logo-preview-container {
    flex: 1;
    min-height: 280px;
    border: 3px dashed var(--gray-400);
    border-radius: 12px;
    background: var(--gray-50);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    box-sizing: border-box;
    transition: all 0.3s ease;
}

.logo-preview-container.has-logo {
    border-color: var(--success);
    border-style: solid;
    background: var(--success-light);
}

/* Placeholder styling */
.upload-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    color: var(--gray-600);
    padding: 20px;
}

.upload-placeholder i {
    font-size: 3rem !important;
    color: var(--gray-400);
}

.upload-placeholder span {
    font-size: 1.1rem;
    font-weight: 500;
}

.upload-placeholder small {
    font-size: 0.9rem;
    color: var(--gray-500);
    max-width: 200px;
    line-height: 1.4;
}

/* Preview image styling */
.upload-preview {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 15px;
}

.upload-preview img {
    max-width: 100%;
    max-height: 200px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    object-fit: contain;
}

/* N√∫t ch·ªçn ·∫£nh l·ªõn h∆°n */
#chooseBrandLogoBtn,
#chooseCategoryImageBtn {
    pointer-events: all !important;
    padding: 12px 24px !important;
    font-size: 1rem !important;
    border-radius: 8px !important;
    background: var(--primary) !important;
    color: white !important;
    border: none !important;
    font-weight: 500 !important;
    transition: all 0.3s ease !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
}

#chooseBrandLogoBtn:hover,
#chooseCategoryImageBtn:hover {
    background: var(--primary-dark) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
}

/* N√∫t thay ƒë·ªïi ·∫£nh */
.btn-change-image {
    background: var(--primary);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.btn-change-image:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

/* Preview container content */
.logo-preview {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
    box-sizing: border-box;
}

.logo-preview img {
    max-width: 100%;
    max-height: 240px;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    object-fit: contain;
}

/* Placeholder trong preview container */
.preview-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    color: var(--gray-500);
    text-align: center;
    padding: 30px;
}

.preview-placeholder i {
    font-size: 3.5rem !important;
    color: var(--gray-300);
}

.preview-placeholder span {
    font-size: 1.1rem;
    font-weight: 500;
}

/* Responsive design */
@media (max-width: 1200px) {
    .file-upload-container {
        flex-direction: column;
        min-height: auto;
    }
    
    .file-upload-area,
    .logo-preview-container {
        min-height: 250px;
        width: 100%;
    }
}

@media (max-width: 768px) {
    .file-upload-area,
    .logo-preview-container {
        min-height: 200px;
        padding: 20px;
    }
    
    .upload-placeholder i,
    .preview-placeholder i {
        font-size: 2.5rem !important;
    }
    
    #chooseBrandLogoBtn,
    #chooseCategoryImageBtn {
        padding: 10px 20px !important;
        font-size: 0.9rem !important;
    }
}

/* Animation */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.file-upload-area,
.logo-preview-container {
    animation: fadeIn 0.5s ease-out;
}

/* Focus states for accessibility */
.file-upload-area:focus-within {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* Text trong form group */
.form-group .form-text {
    font-size: 0.85rem;
    color: var(--gray-600);
    margin-top: 8px;
}

/* ƒê·∫£m b·∫£o c√°c ph·∫ßn t·ª≠ con kh√¥ng b·ªã ·∫£nh h∆∞·ªüng b·ªüi pointer-events */
.file-upload-area *:not(.btn-change-image):not(#chooseBrandLogoBtn):not(#chooseCategoryImageBtn) {
    pointer-events: none;
}

/* Style cho brand v√† category c·ª• th·ªÉ */
.brand-file-upload .file-upload-area {
    border-color: var(--info);
}

.brand-file-upload .file-upload-area:hover {
    border-color: var(--info-dark);
}

.category-file-upload .file-upload-area {
    border-color: var(--success);
}

.category-file-upload .file-upload-area:hover {
    border-color: var(--success-dark);
}
/* CSS cho Modal S·∫£n ph·∫©m m·ªõi */

.modal-premium .modal-content {
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    border: none;
    /* Th√™m d√≤ng n√†y ƒë·ªÉ ƒëi·ªÅu ch·ªânh chi·ªÅu cao t·ªëi ƒëa */
    max-height: 90vh; /* Ho·∫∑c gi√° tr·ªã b·∫°n mu·ªën */
}

.modal-premium .modal-body {
    padding: 1.5rem;
    /* ƒêi·ªÅu ch·ªânh chi·ªÅu cao t·ªëi ƒëa cho ph·∫ßn body */
    max-height: calc(90vh - 120px); /* Tr·ª´ ƒëi chi·ªÅu cao header v√† footer */
    overflow-y: auto;
}

.modal-premium .modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px 12px 0 0;
    padding: 1.2rem 1.5rem;
    border-bottom: none;
}

.modal-premium .modal-title {
    font-weight: 600;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.modal-premium .modal-body {
    padding: 1.5rem;
    max-height: 75vh;
    overflow-y: auto;
}

.modal-premium .modal-footer {
    border-top: 1px solid #e9ecef;
    padding: 1rem 1.5rem;
}

/* Form Sections */
.form-sections {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.form-section {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    border: 1px solid #f1f3f4;
}

.section-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1.2rem;
    color: #2d3748;
    display: flex;
    align-items: center;
    gap: 8px;
    padding-bottom: 0.8rem;
    border-bottom: 1px solid #e9ecef;
}

.section-title small {
    font-size: 0.8rem;
    font-weight: 400;
    margin-left: auto;
}

.section-title i {
    color: #667eea;
}

/* Form Grid Layouts */
.form-grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.form-grid-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1rem;
}

@media (max-width: 768px) {
    .form-grid-2,
    .form-grid-3 {
        grid-template-columns: 1fr;
    }
}

/* Form Controls */
.form-group {
    margin-bottom: 0;
}

.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: #4a5568;
    font-size: 0.9rem;
}

.form-control, .form-select {
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    padding: 0.6rem 0.75rem;
    font-size: 0.9rem;
    transition: all 0.2s;
}

.form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.input-group-text {
    background-color: #f8f9fa;
    border: 1px solid #e2e8f0;
    color: #718096;
}

/* Technical Specifications */
.specs-management {
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    overflow: hidden;
}

.specs-table-container {
    max-height: 850px;
    overflow-y: auto;
    border-bottom: 1px solid #e2e8f0;
}

.specs-table {
    width: 100%;
    margin-bottom: 0;
    border-collapse: collapse;
    table-layout: auto;
}

.specs-table th {
    background-color: #f8fafc;
    padding: 0.75rem;
    font-weight: 600;
    font-size: 0.85rem;
    color: #4a5568;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
    position: sticky;
    top: 0;
}

.specs-table tr {
    height: auto;
}

.specs-table td {
    padding: 0.75rem;
    border-bottom: 1px solid #f1f5f9;
    vertical-align: top;
    height: auto;
}

.specs-table tr:last-child td {
    border-bottom: none;
}

.specs-table tr:hover {
    background-color: #f8fafc;
}

.specs-table textarea,
.specs-table input {
    width: 100%;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    font-size: 0.85rem;
    resize: none;
    overflow: hidden;
    overflow-y: hidden;
    min-height: 38px;
    max-height: none;
    height: auto;
    font-family: inherit;
    line-height: 1.5;
    box-sizing: border-box;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.specs-table textarea:focus,
.specs-table input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* Auto-resize textarea */
.auto-resize {
    overflow: hidden !important;
    overflow-y: hidden !important;
    resize: none !important;
    height: auto;
}

/* Drag and Drop Styles */
.drag-handle {
    cursor: grab;
    color: #a0aec0;
    text-align: center;
    transition: color 0.2s;
    padding: 0.5rem;
}

.drag-handle:hover {
    color: #667eea;
}

.drag-handle:active {
    cursor: grabbing;
}

.sortable-ghost {
    opacity: 0.6;
    background-color: #f0f4ff;
}

.sortable-chosen {
    background-color: #f8fafc;
}

.sortable-drag {
    opacity: 0.8;
    transform: rotate(2deg);
}

.specs-actions {
    padding: 0.75rem;
    background-color: #f8fafc;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.specs-hint {
    font-size: 0.8rem;
    color: #718096;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.specs-hint i {
    color: #667eea;
}

/* File Upload Areas */
.file-upload-container {
    margin-bottom: 1rem;
}

.file-upload-area {
    border: 2px dashed #cbd5e0;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background-color: #f8fafc;
}

.file-upload-area:hover {
    border-color: #667eea;
    background-color: #f0f4ff;
}

.file-upload-area.dragover {
    border-color: #667eea;
    background-color: #e6eeff;
}

.upload-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    color: #718096;
}

.upload-placeholder i {
    font-size: 2rem;
    color: #a0aec0;
}

.upload-placeholder span {
    font-weight: 500;
}

.upload-placeholder small {
    font-size: 0.8rem;
}

.upload-preview {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
}

.upload-preview img {
    max-width: 100%;
    max-height: 200px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.btn-change-image {
    background: #667eea;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: background 0.2s;
}

.btn-change-image:hover {
    background: #5a6fd8;
}

/* Checkbox Styling */
.checkbox-group {
    margin-top: 0.5rem;
}

.checkbox-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-weight: 500;
    gap: 0.5rem;
}

.checkbox-label input {
    display: none;
}

.checkmark {
    width: 20px;
    height: 20px;
    border: 2px solid #cbd5e0;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.checkbox-label input:checked + .checkmark {
    background-color: #667eea;
    border-color: #667eea;
}

.checkbox-label input:checked + .checkmark:after {
    content: "‚úì";
    color: white;
    font-size: 0.8rem;
}

/* Buttons */
.btn {
    border-radius: 8px;
    padding: 0.6rem 1.2rem;
    font-weight: 500;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.btn-secondary {
    background-color: #f7fafc;
    border: 1px solid #e2e8f0;
    color: #4a5568;
}

.btn-secondary:hover {
    background-color: #edf2f7;
    border-color: #cbd5e0;
}

/* Action buttons in table - Unified Modern Style */
.btn-action {
    font-weight: 600;
    font-size: 0.813rem;
    padding: 0.5rem;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border: none;
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

.btn-action::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s;
}

.btn-action:hover::before {
    left: 100%;
}

.btn-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
}

.btn-action:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
}

.btn-action i {
    font-size: 1rem;
}

/* Edit Button - Blue */
.btn-action.btn-edit {
    background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
    color: white;
}

.btn-action.btn-edit:hover {
    background: linear-gradient(135deg, #0a58ca 0%, #084298 100%);
    color: white;
}

/* Delete Button - Red */
.btn-action.btn-delete {
    background: linear-gradient(135deg, #dc3545 0%, #bb2d3b 100%);
    color: white;
}

.btn-action.btn-delete:hover {
    background: linear-gradient(135deg, #bb2d3b 0%, #9a2530 100%);
    color: white;
}

/* Scrollbar styling */
.modal-premium .modal-body::-webkit-scrollbar {
    width: 6px;
}

.modal-premium .modal-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.modal-premium .modal-body::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

.modal-premium .modal-body::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Empty state for specs table */
.specs-empty-state {
    text-align: center;
    padding: 2rem;
    color: #a0aec0;
}

.specs-empty-state i {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

/* Animation for drag and drop */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

.sortable-drag {
    animation: pulse 0.5s ease-in-out infinite;
}
    
/* Product Image Upload Styles */
#mainImageUploadArea, #additionalImagesUploadArea {
    border: 2px dashed var(--gray-300);
    border-radius: 10px;
    padding: 20px;
    background: var(--gray-50);
    transition: var(--transition);
    cursor: pointer;
    min-height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
}

#mainImageUploadArea:hover, #additionalImagesUploadArea:hover {
    border-color: var(--primary);
    background: var(--gray-100);
}

#mainImageUploadArea.dragover, #additionalImagesUploadArea.dragover {
    border-color: var(--primary);
    background: var(--primary-light);
}

.upload-placeholder i {
    font-size: 2rem;
    color: var(--gray-400);
    margin-bottom: 10px;
}

.upload-placeholder span {
    display: block;
    font-weight: 500;
    color: var(--dark);
    margin-bottom: 5px;
}

.upload-placeholder small {
    color: var(--gray-500);
    font-size: 0.85rem;
}

/* Additional Images Preview */
.additional-images-preview {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 10px;
    padding: 10px;
}

.additional-image-item {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.additional-image-item img {
    width: 100%;
    height: 80px;
    object-fit: cover;
}

.remove-image-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 0.8rem;
}

.remove-image-btn:hover {
    background: rgb(239, 68, 68);
}
/* Product Choose Buttons - gi·ªëng brand/category */
#chooseMainImageBtn, #chooseAdditionalImagesBtn {
    pointer-events: all !important;
    padding: 6px 8px;
    font-size: 0.85rem;
    border-radius: 6px;
    background: var(--gray-100);
    color: var(--dark);
    border: 1px solid var(--gray-300);
    white-space: nowrap;
}

#chooseMainImageBtn i, #chooseAdditionalImagesBtn i {
    font-size: 0.85rem;
}

/* Fix pointer events for product upload areas */
#mainImageUploadArea *, #additionalImagesUploadArea * {
    pointer-events: none;
}

#chooseMainImageBtn, #chooseAdditionalImagesBtn, 
#changeMainImageBtn, .remove-image-btn {
    pointer-events: all !important;
}
/* ===============================================
   SEPARATED FILE UPLOAD UI STYLES
   =============================================== */

/* File Selector Section - Ch·ªâ ch·ª©a n√∫t ch·ªçn file */
.file-selector-section {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
    padding: 20px;
    background: white;
    border: 2px solid var(--gray-200);
    border-radius: 10px;
    margin-bottom: 20px;
}

.btn-select-files {
    padding: 12px 24px;
    font-size: 1rem;
    font-weight: 600;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.btn-select-files:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
}

.btn-select-files i {
    font-size: 1.1rem;
}

.file-info-text {
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-size: 0.85rem;
    color: var(--gray-600);
}

.file-info-text small {
    color: var(--gray-500);
}

/* Preview Section - Ch·ªâ hi·ªÉn th·ªã preview */
.preview-section {
    background: white;
    border: 2px solid var(--gray-200);
    border-radius: 10px;
    padding: 20px;
    min-height: 200px;
}

.preview-section.hidden {
    display: none;
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--gray-200);
}

.preview-title {
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--gray-800);
    display: flex;
    align-items: center;
    gap: 8px;
}

.preview-title i {
    color: var(--primary);
    font-size: 1.2rem;
}

.preview-hint {
    font-size: 0.85rem;
    color: var(--gray-500);
    font-style: italic;
}

.preview-content {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 16px;
}

.preview-empty {
    text-align: center;
    padding: 60px 20px;
    color: var(--gray-400);
}

.preview-empty.hidden {
    display: none;
}

.preview-empty i {
    font-size: 3.5rem;
    color: var(--gray-300);
    margin-bottom: 16px;
    display: block;
}

.preview-empty p {
    font-size: 1rem;
    color: var(--gray-500);
    margin: 0;
}

/* Image/Video Preview Items */
.image-preview-item,
.video-preview-item {
    position: relative;
    border: 2px solid var(--gray-200);
    border-radius: 10px;
    padding: 8px;
    background: white;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
}

.image-preview-item:hover,
.video-preview-item:hover {
    border-color: var(--primary);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    transform: translateY(-2px);
}

.image-preview-item.main-image {
    border-color: var(--success);
    border-width: 3px;
    background: rgba(16, 185, 129, 0.05);
}

.image-preview-item img {
    width: 100%;
    height: 240px;
    object-fit: contain;
    border-radius: 8px;
}

.video-preview-item video {
    width: 100%;
    height: 240px;
    object-fit: contain;
    border-radius: 8px;
    background: black;
}

/* Preview Actions */
.image-preview-actions,
.video-preview-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    padding-top: 8px;
    border-top: 1px solid var(--gray-200);
}

.action-buttons {
    display: flex;
    gap: 6px;
}

.btn-view-image,
.btn-view-video,
.btn-remove-image,
.btn-remove-video {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    transition: all 0.2s ease;
}

.btn-view-image,
.btn-view-video {
    background: var(--primary);
    color: white;
}

.btn-view-image:hover,
.btn-view-video:hover {
    background: var(--primary-dark);
    transform: scale(1.1);
}

.btn-remove-image,
.btn-remove-video {
    background: var(--danger);
    color: white;
}

.btn-remove-image:hover,
.btn-remove-video:hover {
    background: #dc2626;
    transform: scale(1.1);
}

/* Main Image Checkbox */
.form-check {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 6px;
}

.form-check-input {
    cursor: pointer;
    width: 18px;
    height: 18px;
}

.form-check-label {
    font-size: 0.8rem;
    color: var(--gray-600);
    cursor: pointer;
    margin: 0;
}

/* Main Image Badge */
.main-image-badge {
    position: absolute;
    top: 8px;
    left: 8px;
    background: var(--success);
    color: white;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    z-index: 10;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

/* Video Badge */
.video-badge {
    position: absolute;
    bottom: 8px;
    right: 8px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    gap: 4px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .preview-content {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
    }

    .btn-select-files {
        width: 100%;
        justify-content: center;
    }

    .file-selector-section {
        padding: 16px;
    }

    .preview-section {
        padding: 16px;
    }

    .image-preview-item img,
    .video-preview-item video {
        height: 200px;
    }
}

@media (max-width: 480px) {
    .preview-content {
        grid-template-columns: 1fr 1fr;
    }
    
    .preview-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
}

/* ===============================================
   ADDITIONAL INFO (TH√îNG TIN KH√ÅC) STYLES
   =============================================== */

.additional-info-management {
    margin-top: 16px;
}

.additional-info-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding: 12px;
    background: var(--gray-50);
    border-radius: 8px;
}

.additional-info-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.additional-info-item {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 12px;
    padding: 16px;
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 8px;
    transition: all 0.2s ease;
    align-items: start;
}

.additional-info-item:hover {
    border-color: var(--primary);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
}

.additional-info-item textarea,
.additional-info-item input {
    padding: 10px 12px;
    border: 1px solid var(--gray-300);
    border-radius: 6px;
    font-size: 0.9rem;
    transition: all 0.2s ease;
    resize: none;
    overflow: hidden;
    overflow-y: hidden;
    min-height: 42px;
    max-height: none;
    height: auto;
    font-family: inherit;
    line-height: 1.5;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.additional-info-item textarea:focus,
.additional-info-item input:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.additional-info-item textarea::placeholder,
.additional-info-item input::placeholder {
    color: var(--gray-400);
}

.btn-remove-info {
    width: 36px;
    height: 36px;
    background: var(--gray-100);
    color: var(--danger);
    border: none;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    align-self: center;
}

.btn-remove-info:hover {
    background: var(--danger);
    color: white;
    transform: scale(1.1);
}

.additional-info-empty {
    text-align: center;
    padding: 40px;
    color: var(--gray-400);
    background: var(--gray-50);
    border-radius: 8px;
    border: 2px dashed var(--gray-300);
}

.additional-info-empty i {
    font-size: 3rem;
    margin-bottom: 12px;
    display: block;
}

.additional-info-empty p {
    font-size: 0.95rem;
    margin: 0;
}

/* ===============================================
   PRODUCT VARIANTS STYLES
   =============================================== */

.variants-management {
    margin-top: 16px;
}

.variants-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding: 12px;
    background: var(--gray-50);
    border-radius: 8px;
}

.variants-hint {
    font-size: 0.85rem;
    color: var(--gray-600);
    display: flex;
    align-items: center;
    gap: 6px;
}

.variants-hint i {
    color: var(--primary);
}

/* Variant Options Table */
.variant-options-table-wrapper {
    margin-bottom: 20px;
    border: 1px solid var(--gray-200);
    border-radius: 8px;
    overflow: hidden;
}

.variant-options-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}

.variant-options-table thead {
    background: var(--gray-50);
}

.variant-options-table th {
    padding: 10px 12px;
    text-align: center;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--gray-700);
    border-bottom: 2px solid var(--gray-200);
}

.variant-options-table td {
    padding: 12px;
    border-bottom: 1px solid var(--gray-100);
}

.variant-options-table tr:last-child td {
    border-bottom: none;
}

/* Variant Chips Container (like input with tags inside) */
.variant-chips-container {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 6px;
    padding: 6px 8px;
    min-height: 38px;
    border: 1px solid var(--gray-300);
    border-radius: 6px;
    background: white;
    cursor: text;
    transition: all 0.2s;
}

.variant-chips-container:focus-within {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.variant-chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 8px;
    background: linear-gradient(135deg, var(--primary), #667eea);
    color: white;
    border-radius: 14px;
    font-size: 0.8rem;
    font-weight: 500;
    transition: all 0.2s;
    max-width: 200px;
}

.variant-chip:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
}

.variant-chip .chip-text {
    outline: none;
    border: none;
    background: transparent;
    color: white;
    padding: 2px 4px;
    border-radius: 3px;
    cursor: text;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 150px;
}

.variant-chip .chip-text:focus {
    background: rgba(255, 255, 255, 0.2);
    outline: 1px solid rgba(255, 255, 255, 0.4);
}

.variant-chip .chip-remove {
    background: transparent;
    border: none;
    color: white;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    transition: all 0.2s;
    opacity: 0.8;
}

.variant-chip .chip-remove:hover {
    background: rgba(255, 255, 255, 0.3);
    opacity: 1;
    transform: scale(1.15);
}

.variant-chip .chip-remove i {
    font-size: 0.65rem;
}

.chip-input {
    flex: 1;
    min-width: 120px;
    border: none;
    outline: none;
    padding: 4px;
    font-size: 0.85rem;
    background: transparent;
}

.chip-input::placeholder {
    color: var(--gray-400);
}

.btn-remove-variant-type {
    background: transparent;
    border: none;
    color: var(--danger);
    cursor: pointer;
    font-size: 0.85rem;
    padding: 4px 8px;
    transition: all 0.2s;
}

.btn-remove-variant-type:hover {
    color: #c53030;
    background: rgba(220, 38, 38, 0.1);
    border-radius: 4px;
}

/* Variant Combinations Section */
.variant-combinations-section {
    margin-top: 20px;
    border: 2px solid var(--primary);
    border-radius: 8px;
    padding: 16px;
    background: linear-gradient(to bottom, rgba(102, 126, 234, 0.03), transparent);
}

.combinations-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--gray-200);
}

.combinations-header h5 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--gray-700);
    display: flex;
    align-items: center;
    gap: 8px;
}

.combinations-count {
    background: var(--primary);
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
}

/* Variant Combinations Table */
    background: var(--gray-50);
    border-radius: 8px;
}

.variant-combinations-table-wrapper {
    overflow-x: auto;
    border: 1px solid var(--gray-200);
    border-radius: 8px;
}

.variant-combinations-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}

.variant-combinations-table thead {
    background: var(--gray-100);
}

.variant-combinations-table th {
    padding: 12px;
    text-align: center;
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--gray-700);
    border-bottom: 2px solid var(--gray-300);
}

.variant-combinations-table td {
    padding: 12px;
    border-bottom: 1px solid var(--gray-200);
    vertical-align: middle;
}

.variant-combinations-table tbody tr:hover {
    background: var(--gray-50);
}

.combo-name {
    font-weight: 600;
    color: var(--gray-800);
    margin-bottom: 4px;
}

.combo-attributes {
    font-size: 0.75rem;
    color: var(--gray-500);
}

.variant-combinations-table input[type="text"],
.variant-combinations-table input[type="number"] {
    width: 100%;
    padding: 6px 10px;
    border: 1px solid var(--gray-300);
    border-radius: 4px;
    font-size: 0.85rem;
}

.variant-combinations-table input:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
}

.variants-empty-state p {
    font-size: 0.95rem;
    margin: 0;
}

/* Responsive */
@media (max-width: 768px) {
    .variants-toolbar {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
    }

    .variant-type-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }

    .variant-type-name {
        margin-right: 0;
        width: 100%;
    }

    .variant-input-group {
        flex-direction: column;
    }

    .btn-add-value {
        width: 100%;
        justify-content: center;
    }
}

/* =============================================
   VIDEO LINKS SECTION STYLES
   ============================================= */

.video-links-section {
    margin-top: 24px;
    padding: 20px;
    background: var(--gray-50);
    border-radius: 12px;
    border: 1px solid var(--gray-200);
}

.video-links-header {
    margin-bottom: 16px;
}

.section-subtitle {
    font-size: 1rem;
    font-weight: 600;
    color: var(--gray-800);
    margin: 0 0 6px 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.section-subtitle i {
    color: var(--primary);
}

.section-description {
    font-size: 0.85rem;
    color: var(--gray-500);
    margin: 0;
}

.video-link-input-group {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
}

.video-link-input {
    flex: 1;
    padding: 10px 14px;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    font-size: 0.9rem;
    transition: all 0.2s ease;
}

.video-link-input:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.video-link-input::placeholder {
    color: var(--gray-400);
}

.btn-add-link {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.btn-add-link:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.video-links-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.video-link-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 8px;
    transition: all 0.2s ease;
}

.video-link-item:hover {
    border-color: var(--primary);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
}

.video-link-icon {
    width: 40px;
    height: 40px;
    background: var(--primary);
    color: white;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    flex-shrink: 0;
}

.video-link-content {
    flex: 1;
    min-width: 0;
}

.video-link-platform {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--primary);
    text-transform: uppercase;
    margin-bottom: 4px;
}

.video-link-url {
    font-size: 0.85rem;
    color: var(--gray-600);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.video-link-actions {
    display: flex;
    gap: 6px;
    flex-shrink: 0;
}

.btn-open-link,
.btn-remove-link {
    width: 36px;
    height: 36px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.95rem;
    transition: all 0.2s ease;
}

.btn-open-link {
    background: var(--gray-100);
    color: var(--gray-600);
}

.btn-open-link:hover {
    background: var(--primary);
    color: white;
}

.btn-remove-link {
    background: var(--gray-100);
    color: var(--danger);
}

.btn-remove-link:hover {
    background: var(--danger);
    color: white;
}

.video-links-empty {
    text-align: center;
    padding: 30px;
    color: var(--gray-400);
    background: white;
    border-radius: 8px;
    border: 2px dashed var(--gray-300);
}

.video-links-empty i {
    font-size: 2.5rem;
    margin-bottom: 10px;
    display: block;
    opacity: 0.5;
}

.video-links-empty p {
    font-size: 0.9rem;
    margin: 0;
}

/* Responsive */
@media (max-width: 768px) {
    .video-link-input-group {
        flex-direction: column;
    }

    .btn-add-link {
        width: 100%;
        justify-content: center;
    }

    .video-link-item {
        flex-wrap: wrap;
    }

    .video-link-content {
        flex-basis: 100%;
        order: 2;
    }

    .video-link-actions {
        order: 3;
    }
}

/* SweetAlert2 z-index override */
.swal-high-z-index {
    z-index: 999999 !important;
}

.swal2-container {
    z-index: 999999 !important;
}

.swal2-popup {
    z-index: 999999 !important;
}

/* Override Bootstrap modal z-index when SweetAlert is shown */
.modal-backdrop {
    z-index: 1040 !important;
}

.modal {
    z-index: 1050 !important;
}

/* Auto-calculated price fields styling */
input.auto-calculated {
    background-color: #f3f4f6 !important;
    cursor: not-allowed !important;
    opacity: 0.7 !important;
    font-style: italic !important;
}

input.auto-calculated::placeholder {
    color: #6b7280 !important;
    font-style: italic !important;
}

/* Product meta info styling */
.product-meta {
    margin-top: 4px;
    font-size: 0.8rem;
}

.product-meta small {
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.product-meta i {
    font-size: 0.75rem;
}

/* Variant count badge */
.variant-count-badge {
    display: inline-block;
    padding: 2px 8px;
    background: var(--primary);
    color: white;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

/* Variant image upload styling */
.combo-upload-wrapper {
    flex: 0;
}

.combo-upload-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    padding: 0;
    font-size: 1rem;
    color: white;
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2);
    margin: 0;
}

.combo-upload-btn:hover {
    background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
    box-shadow: 0 3px 6px rgba(0, 123, 255, 0.3);
    transform: translateY(-1px);
}

.combo-upload-btn:active {
    background: #004085;
    box-shadow: 0 1px 2px rgba(0, 123, 255, 0.2);
    transform: translateY(0);
}

.combo-upload-btn i {
    margin: 0;
}

.combo-image-upload {
    display: none;
}

</style>