<!-- CellphoneS Style Header - One Line Compact -->
<header class="cps-header">
    <div class="container-fluid">
        <div class="row align-items-center py-2">
            <!-- Logo -->
            <div class="col-auto">
                <a href="/" class="cps-logo">
                    {{!-- <img src="/icon/logo.png" alt="WebPhones"> --}}
                    <span class="cps-logo-text">NDK Shop</span>
                </a>
            </div>

            <!-- Location Selector -->
            <div class="col-auto d-none d-lg-block">
                <div class="cps-location">
                    <i class="fas fa-map-marker-alt text-danger"></i>
                    <select id="locationSelect" class="form-select form-select-sm">
                        <option value="" selected>Ch·ªçn v√πng mi·ªÅn</option>
                        {{#each regions}}
                        <option value="{{this.id}}">{{this.ten_vung}}</option>
                        {{/each}}
                    </select>
                </div>
            </div>

            <!-- Categories Dropdown -->
            <div class="col-auto">
                <div class="dropdown cps-categories-dropdown">
                    <button class="btn btn-danger btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-bars"></i>
                        <span class="d-none d-md-inline ms-2">Danh m·ª•c</span>
                    </button>
                    <ul class="dropdown-menu cps-mega-dropdown">
                        <li class="row g-0">
                            {{#each categories}}
                            {{#unless this.danh_muc_cha_id}}
                            <div class="col-md-3">
                                <h6 class="dropdown-header">
                                    <i class="fas fa-{{#if (eq this.ten_danh_muc 'ƒêi·ªán tho·∫°i')}}mobile-alt{{else if (eq this.ten_danh_muc 'Laptop')}}laptop{{else if (eq this.ten_danh_muc 'M√°y t√≠nh b·∫£ng')}}tablet-alt{{else}}th{{/if}}"></i>
                                    {{this.ten_danh_muc}}
                                </h6>
                                {{#each ../categories}}
                                {{#if (eq this.danh_muc_cha_id ../this.id)}}
                                <a class="dropdown-item" href="/category/{{this.slug}}">{{this.ten_danh_muc}}</a>
                                {{/if}}
                                {{/each}}
                            </div>
                            {{/unless}}
                            {{/each}}
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="col">
                <div class="cps-search-wrapper position-relative">
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" id="searchInput" placeholder="B·∫°n c·∫ßn t√¨m g√¨?" autocomplete="off">
                        <button class="btn btn-danger" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <!-- Search Suggestions -->
                    <div class="cps-search-suggestions position-absolute w-100 d-none" id="searchSuggestions">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-2">
                                <small class="text-muted d-block mb-1">T√¨m ki·∫øm g·∫ßn ƒë√¢y</small>
                                <div class="d-flex flex-wrap gap-1 mb-2">
                                    <span class="badge bg-light text-dark cps-history-item">iPhone 15</span>
                                    <span class="badge bg-light text-dark cps-history-item">Samsung S24</span>
                                </div>
                                <small class="text-muted d-block mb-1">T·ª´ kh√≥a ph·ªï bi·∫øn</small>
                                <div class="d-flex flex-wrap gap-1">
                                    <span class="badge bg-danger cps-trending-item">iPhone 15 Pro</span>
                                    <span class="badge bg-danger cps-trending-item">Galaxy S24 Ultra</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hotline -->
            <div class="col-auto d-none d-lg-block">
                <a href="tel:1800.2097" class="text-decoration-none">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-phone-alt text-danger me-2"></i>
                        <div>
                            <small class="text-muted d-block" style="font-size: 10px;">G·ªçi mua h√†ng</small>
                            <strong class="text-dark" style="font-size: 13px;">1800.2097</strong>
                        </div>
                    </div>
                </a>
            </div>

            <!-- User Account -->
            <div class="col-auto">
                <div class="dropdown cps-user-dropdown">
                    <button class="btn btn-link text-decoration-none p-0" type="button" id="userDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-user text-danger me-2"></i>
                            <div class="text-start d-none d-md-block">
                                <small class="text-muted d-block" style="font-size: 10px;">T√†i kho·∫£n</small>
                                <strong class="text-dark" style="font-size: 13px;" id="userDisplayName">ƒêƒÉng nh·∫≠p</strong>
                            </div>
                        </div>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdownBtn">
                        <!-- Not logged in menu -->
                        <li class="cps-user-not-logged">
                            <a class="dropdown-item" href="/login">
                                <i class="fas fa-sign-in-alt me-2"></i>ƒêƒÉng nh·∫≠p
                            </a>
                        </li>
                        <li class="cps-user-not-logged">
                            <a class="dropdown-item" href="/register">
                                <i class="fas fa-user-plus me-2"></i>ƒêƒÉng k√Ω
                            </a>
                        </li>
                        
                        <!-- Logged in menu -->
                        <li class="cps-user-logged d-none">
                            <h6 class="dropdown-header">
                                <i class="fas fa-user-circle me-2"></i>T√†i kho·∫£n
                            </h6>
                        </li>
                        <li class="cps-user-logged d-none">
                            <a class="dropdown-item fw-bold" href="/profile" style="color: #d70018 !important;">
                                <i class="fas fa-id-card me-2"></i>Th√¥ng tin c√° nh√¢n
                            </a>
                        </li>
                        <li class="cps-user-logged d-none">
                            <a class="dropdown-item" href="/donhang">
                                <i class="fas fa-shopping-bag me-2"></i>ƒê∆°n h√†ng c·ªßa t√¥i
                            </a>
                        </li>
                        <li class="cps-user-logged d-none">
                            <a class="dropdown-item" href="/wishlist">
                                <i class="fas fa-heart me-2"></i>Y√™u th√≠ch
                            </a>
                        </li>
                        <li class="cps-user-logged d-none">
                            <hr class="dropdown-divider">
                        </li>
                        <li class="cps-user-logged d-none">
                            <a class="dropdown-item text-danger" href="#" id="btnLogout">
                                <i class="fas fa-sign-out-alt me-2"></i>ƒêƒÉng xu·∫•t
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Cart -->
            <div class="col-auto">
                <a href="/cart" class="position-relative text-decoration-none" id="cartIcon">
                    <i class="fas fa-shopping-cart text-danger fs-5"></i>
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cartBadge" style="font-size: 9px; display: none;">
                        0
                    </span>
                    <div class="d-none d-md-block">
                        <small class="text-muted d-block" style="font-size: 10px;">Gi·ªè h√†ng</small>
                    </div>
                </a>
            </div>
        </div>
    </div>
</header>


<style>
/* Animate badge */
@keyframes bounceIn {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.badge-animate {
    animation: bounceIn 0.5s ease;
}
</style>

<script>
// Cart Management
(function() {
    const CartManager = {
        // Get cart count from database
        getCartCount: async function() {
            try {
                // Check if user is logged in
                if (!AuthManager || !AuthManager.isLoggedIn()) {
                    return 0;
                }
                
                const userId = AuthManager.getCurrentUser()?.id;
                
                if (!userId) {
                    return 0;
                }
                
                const response = await fetch('/api/cart?userId=' + userId, {
                    method: 'GET'
                });
                
                if (!response.ok) {
                    return 0;
                }
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    return result.data.count || 0;
                }
                
                return 0;
            } catch (error) {
                console.error('Error loading cart count:', error);
                return 0;
            }
        },

        // Add item to cart via API
        addToCart: async function(productData) {
            try {
                // Check if user is logged in
                if (!AuthManager || !AuthManager.isLoggedIn()) {
                    // Redirect to login
                    window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                
                const userId = AuthManager.getCurrentUser()?.id;
                
                if (!userId) {
                    window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                
                const response = await fetch('/api/cart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        san_pham_id: productData.id,
                        so_luong: 1,
                        userId: userId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    this.showAddToCartNotification(productData.name);
                    this.updateCartBadge();
                } else {
                    alert(result.message || 'Kh√¥ng th·ªÉ th√™m v√†o gi·ªè h√†ng');
                }
            } catch (error) {
                console.error('Error adding to cart:', error);
                alert('Kh√¥ng th·ªÉ th√™m v√†o gi·ªè h√†ng');
            }
        },

        // Update cart badge
        updateCartBadge: async function() {
            const totalItems = await this.getCartCount();
            const badge = document.getElementById('cartBadge');
            
            if (badge) {
                if (totalItems > 0) {
                    badge.textContent = totalItems > 99 ? '99+' : totalItems;
                    badge.style.display = 'block';
                    badge.classList.add('badge-animate');
                    setTimeout(() => badge.classList.remove('badge-animate'), 500);
                } else {
                    badge.style.display = 'none';
                }
            }
        },

        // Format currency
        formatCurrency: function(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        },

        // Show notification
        showAddToCartNotification: function(productName) {
            const notification = document.createElement('div');
            notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                <strong>ƒê√£ th√™m v√†o gi·ªè h√†ng!</strong>
                <p class="mb-0 small">${productName}</p>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        },

        // Initialize
        init: function() {
            // Update cart badge after auth is ready
            setTimeout(() => {
                this.updateCartBadge();
            }, 200);
        }
    };

    // Make CartManager globally available
    window.CartManager = CartManager;

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => CartManager.init());
    } else {
        CartManager.init();
    }

    // Update cart buttons to use CartManager
    document.addEventListener('click', function(e) {
        const cartBtn = e.target.closest('.cps-btn-cart');
        if (cartBtn) {
            e.preventDefault();
            e.stopPropagation();
            
            const productCard = cartBtn.closest('.cps-product-card');
            if (productCard) {
                const productId = cartBtn.getAttribute('data-product-id');
                const productName = productCard.querySelector('.cps-product-name')?.textContent || '';
                const productImage = productCard.querySelector('.cps-product-image img')?.src || '';
                const priceText = productCard.querySelector('.cps-current-price')?.textContent || '0';
                const price = parseInt(priceText.replace(/[^0-9]/g, '')) || 0;
                
                CartManager.addToCart({
                    id: productId,
                    name: productName,
                    image: productImage,
                    price: price
                });
                
                // Animation
                const originalHTML = cartBtn.innerHTML;
                cartBtn.innerHTML = '<i class="fas fa-check"></i>';
                cartBtn.style.background = '#28a745';
                cartBtn.style.borderColor = '#28a745';
                cartBtn.style.color = '#fff';
                
                setTimeout(() => {
                    cartBtn.innerHTML = originalHTML;
                    cartBtn.style.background = '';
                    cartBtn.style.borderColor = '';
                    cartBtn.style.color = '';
                }, 1500);
            }
        }
    });
})();

// User Authentication Management
(function() {
    const AuthManager = {
        // Get current user session (only id and email)
        getCurrentUser: function() {
            try {
                const userSession = localStorage.getItem('user_session') || sessionStorage.getItem('user_session');
                return userSession ? JSON.parse(userSession) : null;
            } catch (error) {
                console.error('Error loading user session:', error);
                return null;
            }
        },

        // Get auth token
        getAuthToken: function() {
            return localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
        },

        // Check if user is logged in
        isLoggedIn: function() {
            return this.getCurrentUser() !== null && this.getAuthToken() !== null;
        },

        // Logout
        logout: async function() {
            try {
                // Call logout API
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + this.getAuthToken()
                    }
                });
            } catch (error) {
                console.error('Logout API error:', error);
            }
            
            // Clear local data
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_session');
            sessionStorage.removeItem('auth_token');
            sessionStorage.removeItem('user_session');
            
            // Reload page
            window.location.href = '/';
        },

        // Update UI based on auth state
        updateUI: function() {
            console.log('üîÑ AuthManager: Updating UI...');
            
            const userSession = this.getCurrentUser();
            const token = this.getAuthToken();
            
            console.log('üë§ Current user session:', userSession);
            console.log('üîë Has token:', !!token);
            
            const userDisplayName = document.getElementById('userDisplayName');
            const userNotLoggedElements = document.querySelectorAll('.cps-user-not-logged');
            const userLoggedElements = document.querySelectorAll('.cps-user-logged');
            
            console.log('üéØ DOM elements:', {
                userDisplayName: !!userDisplayName,
                userNotLoggedCount: userNotLoggedElements.length,
                userLoggedCount: userLoggedElements.length
            });
            
            if (userSession && token) {
                // User is logged in
                console.log('‚úÖ User is logged in:', userSession.email);
                
                if (userDisplayName) {
                    // Only have email, show username part
                    const displayName = userSession.email.split('@')[0];
                    const shortName = displayName.length > 15 
                        ? displayName.substring(0, 15) + '...' 
                        : displayName;
                    userDisplayName.textContent = shortName;
                    console.log('üìù Updated display name to:', shortName);
                }
                
                // Hide all not-logged elements
                userNotLoggedElements.forEach(el => {
                    el.classList.add('d-none');
                });
                console.log('üëÅÔ∏è Hidden', userNotLoggedElements.length, 'login buttons');
                
                // Show all logged elements
                userLoggedElements.forEach(el => {
                    el.classList.remove('d-none');
                });
                console.log('üëÅÔ∏è Shown', userLoggedElements.length, 'user menu items');
            } else {
                // User is not logged in
                console.log('‚ùå User not logged in');
                
                if (userDisplayName) {
                    userDisplayName.textContent = 'ƒêƒÉng nh·∫≠p';
                }
                
                // Show all not-logged elements
                userNotLoggedElements.forEach(el => {
                    el.classList.remove('d-none');
                });
                
                // Hide all logged elements
                userLoggedElements.forEach(el => {
                    el.classList.add('d-none');
                });
            }
            
            console.log('‚úÖ UI update complete');
        },

        // Initialize
        init: function() {
            console.log('üöÄ AuthManager: Initializing...');
            console.log('üìç Document ready state:', document.readyState);
            
            // Wait a bit for DOM to be fully ready
            setTimeout(() => {
                console.log('‚è∞ Running delayed UI update...');
                this.updateUI();
            }, 100);
            
            // Also update immediately
            this.updateUI();
            
            // Handle logout button
            const btnLogout = document.getElementById('btnLogout');
            if (btnLogout) {
                console.log('üîò Logout button found, attaching listener');
                btnLogout.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                        this.logout();
                    }
                });
            } else {
                console.warn('‚ö†Ô∏è Logout button not found');
            }
            
            // Listen for auth changes from other tabs
            window.addEventListener('storage', (e) => {
                if (e.key === 'user_session' || e.key === 'auth_token') {
                    console.log('üîÑ Storage changed, updating UI');
                    this.updateUI();
                }
            });
            
            console.log('‚úÖ AuthManager initialized');
        }
    };

    // Make AuthManager globally available
    window.AuthManager = AuthManager;

    // Initialize when DOM is ready - with multiple fallbacks
    console.log('üì¶ AuthManager script loaded, readyState:', document.readyState);
    
    if (document.readyState === 'loading') {
        console.log('‚è≥ Waiting for DOMContentLoaded...');
        document.addEventListener('DOMContentLoaded', () => {
            console.log('‚úÖ DOMContentLoaded fired');
            AuthManager.init();
        });
    } else {
        console.log('‚ö° DOM already ready, initializing now');
        AuthManager.init();
    }
    
    // Also try on window load as final fallback
    window.addEventListener('load', () => {
        console.log('üîÑ Window load event, re-checking auth state');
        AuthManager.updateUI();
    });
})();
</script>