<!-- CellphoneS Style Header - One Line Compact -->
<header class="cps-header">
    <div class="container-fluid">
        <div class="row align-items-center py-2">
            <!-- Logo -->
            <div class="col-auto">
                <a href="/" class="cps-logo">
                    <img src="/icon/logo.png" alt="WebPhones" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                    <span class="cps-logo-text">WebPhones</span>
                </a>
            </div>

            <!-- Location Selector -->
            <div class="col-auto d-none d-lg-block">
                <div class="cps-location">
                    <i class="fas fa-map-marker-alt text-danger"></i>
                    <select id="locationSelect" class="form-select form-select-sm">
                        <option value="" selected>Chọn vùng miền</option>
                        {{#each regions}}
                        <option value="{{this.id}}">{{this.ten_vung}}</option>
                        {{/each}}
                    </select>
                </div>
            </div>

            <!-- Categories Dropdown -->
            <div class="col-auto">
                <div class="dropdown cps-categories-dropdown">
                    <button class="btn btn-danger btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-bars"></i>
                        <span class="d-none d-md-inline ms-2">Danh mục</span>
                    </button>
                    <ul class="dropdown-menu cps-mega-dropdown">
                        <li class="row g-0">
                            {{#each categories}}
                            {{#unless this.danh_muc_cha_id}}
                            <div class="col-md-3">
                                <h6 class="dropdown-header">
                                    <i class="fas fa-{{#if (eq this.ten_danh_muc 'Điện thoại')}}mobile-alt{{else if (eq this.ten_danh_muc 'Laptop')}}laptop{{else if (eq this.ten_danh_muc 'Máy tính bảng')}}tablet-alt{{else}}th{{/if}}"></i>
                                    {{this.ten_danh_muc}}
                                </h6>
                                {{#each ../categories}}
                                {{#if (eq this.danh_muc_cha_id ../this.id)}}
                                <a class="dropdown-item" href="/category/{{this.slug}}">{{this.ten_danh_muc}}</a>
                                {{/if}}
                                {{/each}}
                            </div>
                            {{/unless}}
                            {{/each}}
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="col">
                <div class="cps-search-wrapper position-relative">
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" id="searchInput" placeholder="Bạn cần tìm gì?" autocomplete="off">
                        <button class="btn btn-danger" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <!-- Search Suggestions -->
                    <div class="cps-search-suggestions position-absolute w-100 d-none" id="searchSuggestions">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-2">
                                <small class="text-muted d-block mb-1">Tìm kiếm gần đây</small>
                                <div class="d-flex flex-wrap gap-1 mb-2">
                                    <span class="badge bg-light text-dark cps-history-item">iPhone 15</span>
                                    <span class="badge bg-light text-dark cps-history-item">Samsung S24</span>
                                </div>
                                <small class="text-muted d-block mb-1">Từ khóa phổ biến</small>
                                <div class="d-flex flex-wrap gap-1">
                                    <span class="badge bg-danger cps-trending-item">iPhone 15 Pro</span>
                                    <span class="badge bg-danger cps-trending-item">Galaxy S24 Ultra</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hotline -->
            <div class="col-auto d-none d-lg-block">
                <a href="tel:1800.2097" class="text-decoration-none">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-phone-alt text-danger me-2"></i>
                        <div>
                            <small class="text-muted d-block" style="font-size: 10px;">Gọi mua hàng</small>
                            <strong class="text-dark" style="font-size: 13px;">1800.2097</strong>
                        </div>
                    </div>
                </a>
            </div>

            <!-- User Account -->
            <div class="col-auto">
                <div class="dropdown cps-user-dropdown">
                    <button class="btn btn-link text-decoration-none p-0" type="button" data-bs-toggle="dropdown">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-user text-danger me-2"></i>
                            <div class="text-start d-none d-md-block">
                                <small class="text-muted d-block" style="font-size: 10px;">Tài khoản</small>
                                <strong class="text-dark" style="font-size: 13px;" id="userDisplayName">Đăng nhập</strong>
                            </div>
                        </div>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li class="cps-user-not-logged">
                            <a class="dropdown-item" href="/login" id="btnLogin">
                                <i class="fas fa-sign-in-alt me-2"></i>Đăng nhập
                            </a>
                            <a class="dropdown-item" href="/register" id="btnRegister">
                                <i class="fas fa-user-plus me-2"></i>Đăng ký
                            </a>
                        </li>
                        <li class="cps-user-logged d-none">
                            <a class="dropdown-item" href="/profile">
                                <i class="fas fa-user-circle me-2"></i>Thông tin tài khoản
                            </a>
                            <a class="dropdown-item" href="/orders">
                                <i class="fas fa-shopping-bag me-2"></i>Đơn hàng của tôi
                            </a>
                            <a class="dropdown-item" href="/wishlist">
                                <i class="fas fa-heart me-2"></i>Yêu thích
                            </a>
                            <hr class="dropdown-divider">
                            <a class="dropdown-item text-danger" href="#" id="btnLogout">
                                <i class="fas fa-sign-out-alt me-2"></i>Đăng xuất
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Cart -->
            <div class="col-auto">
                <a href="/cart" class="position-relative text-decoration-none" id="cartIcon">
                    <i class="fas fa-shopping-cart text-danger fs-5"></i>
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cartBadge" style="font-size: 9px; display: none;">
                        0
                    </span>
                    <div class="d-none d-md-block">
                        <small class="text-muted d-block" style="font-size: 10px;">Giỏ hàng</small>
                    </div>
                </a>
            </div>
        </div>
    </div>
</header>


<style>
/* Animate badge */
@keyframes bounceIn {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.badge-animate {
    animation: bounceIn 0.5s ease;
}
</style>

<script>
// Cart Management
(function() {
    const CartManager = {
        // Get cart from localStorage
        getCart: function() {
            try {
                const cart = localStorage.getItem('webphones_cart');
                return cart ? JSON.parse(cart) : [];
            } catch (error) {
                console.error('Error loading cart:', error);
                return [];
            }
        },

        // Save cart to localStorage
        saveCart: function(cart) {
            try {
                localStorage.setItem('webphones_cart', JSON.stringify(cart));
                this.updateCartBadge();
            } catch (error) {
                console.error('Error saving cart:', error);
            }
        },

        // Add item to cart
        addToCart: function(productData) {
            let cart = this.getCart();
            
            // Check if product already in cart
            const existingIndex = cart.findIndex(item => item.id === productData.id);
            
            if (existingIndex >= 0) {
                // Increase quantity
                cart[existingIndex].quantity = (cart[existingIndex].quantity || 1) + 1;
            } else {
                // Add new item
                cart.push({
                    id: productData.id,
                    name: productData.name,
                    image: productData.image,
                    price: productData.price,
                    quantity: 1
                });
            }
            
            this.saveCart(cart);
            this.showAddToCartNotification(productData.name);
        },

        // Remove item from cart
        removeFromCart: function(productId) {
            let cart = this.getCart();
            cart = cart.filter(item => item.id !== productId);
            this.saveCart(cart);
        },

        // Update cart badge
        updateCartBadge: function() {
            const cart = this.getCart();
            const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
            const badge = document.getElementById('cartBadge');
            
            if (badge) {
                if (totalItems > 0) {
                    badge.textContent = totalItems > 99 ? '99+' : totalItems;
                    badge.style.display = 'block';
                    badge.classList.add('badge-animate');
                    setTimeout(() => badge.classList.remove('badge-animate'), 500);
                } else {
                    badge.style.display = 'none';
                }
            }
        },

        // Format currency
        formatCurrency: function(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        },

        // Show notification
        showAddToCartNotification: function(productName) {
            const notification = document.createElement('div');
            notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                <strong>Đã thêm vào giỏ hàng!</strong>
                <p class="mb-0 small">${productName}</p>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        },

        // Initialize
        init: function() {
            this.updateCartBadge();
            
            // Listen for cart updates from other tabs
            window.addEventListener('storage', (e) => {
                if (e.key === 'webphones_cart') {
                    this.updateCartBadge();
                }
            });
        }
    };

    // Make CartManager globally available
    window.CartManager = CartManager;

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => CartManager.init());
    } else {
        CartManager.init();
    }

    // Update cart buttons to use CartManager
    document.addEventListener('click', function(e) {
        const cartBtn = e.target.closest('.cps-btn-cart');
        if (cartBtn) {
            e.preventDefault();
            e.stopPropagation();
            
            const productCard = cartBtn.closest('.cps-product-card');
            if (productCard) {
                const productId = cartBtn.getAttribute('data-product-id');
                const productName = productCard.querySelector('.cps-product-name')?.textContent || '';
                const productImage = productCard.querySelector('.cps-product-image img')?.src || '';
                const priceText = productCard.querySelector('.cps-current-price')?.textContent || '0';
                const price = parseInt(priceText.replace(/[^0-9]/g, '')) || 0;
                
                CartManager.addToCart({
                    id: productId,
                    name: productName,
                    image: productImage,
                    price: price
                });
                
                // Animation
                const originalHTML = cartBtn.innerHTML;
                cartBtn.innerHTML = '<i class="fas fa-check"></i>';
                cartBtn.style.background = '#28a745';
                cartBtn.style.borderColor = '#28a745';
                cartBtn.style.color = '#fff';
                
                setTimeout(() => {
                    cartBtn.innerHTML = originalHTML;
                    cartBtn.style.background = '';
                    cartBtn.style.borderColor = '';
                    cartBtn.style.color = '';
                }, 1500);
            }
        }
    });
})();
</script>