<div class="main-content">
    <div class="admin-dashboard">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-content">
                <div class="header-title">
                    <div class="title-icon">‚ö°</div>
                    <div>
                        <h1>QU·∫¢N L√ù FLASH SALE</h1>
                        <p>Theo d√µi v√† qu·∫£n l√Ω c√°c ch∆∞∆°ng tr√¨nh Flash Sale</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn-primary" id="addFlashSaleBtn">
                        <i class="fas fa-plus"></i>
                        <span>T·∫°o Flash Sale</span>
                    </button>
                    <button class="btn-secondary" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i>
                        <span>L√†m m·ªõi</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-icon total">
                    <i class="fas fa-bolt"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalFlashSales">0</h3>
                    <p>T·ªïng Flash Sale</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon available">
                    <i class="fas fa-play-circle"></i>
                </div>
                <div class="stat-info">
                    <h3 id="activeFlashSales">0</h3>
                    <p>ƒêang di·ªÖn ra</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon busy">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-info">
                    <h3 id="upcomingFlashSales">0</h3>
                    <p>S·∫Øp di·ªÖn ra</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon premium">
                    <i class="fas fa-box"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalProducts">0</h3>
                    <p>T·ªïng s·∫£n ph·∫©m</p>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="search-filter-bar">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm flash sale theo t√™n...">
            </div>
            <div class="filter-controls">
                <select class="filter-select" id="statusFilter">
                    <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                    <option value="ƒêang di·ªÖn ra">üü¢ ƒêang di·ªÖn ra</option>
                    <option value="S·∫Øp di·ªÖn ra">üü° S·∫Øp di·ªÖn ra</option>
                    <option value="ƒê√£ k·∫øt th√∫c">‚ö´ ƒê√£ k·∫øt th√∫c</option>
                </select>
                <button class="clear-filters" id="clearFilters">
                    <i class="fas fa-times"></i>
                    X√≥a l·ªçc
                </button>
            </div>
        </div>

        <!-- Products Table -->
        <div class="content-card">
            <div class="table-header">
                <h2>Danh s√°ch Flash Sale</h2>
                <div class="table-info">
                    <span class="total-count">T·ªïng: <strong id="displayCount">0</strong></span>
                </div>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 60px;">STT</th>
                            <th>T√™n Flash Sale</th>
                            <th style="width: 160px;">Ng√†y b·∫Øt ƒë·∫ßu</th>
                            <th style="width: 160px;">Ng√†y k·∫øt th√∫c</th>
                            <th style="width: 140px;">Tr·∫°ng th√°i</th>
                            <th style="width: 100px;">S·ªë SP</th>
                            <th style="width: 180px;">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="flashSaleTableBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Flash Sale Modal -->
<div class="modal fade modal-premium" id="flashSaleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-bolt"></i>
                    <span id="modalTitle">T·∫°o Flash Sale M·ªõi</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="flashSaleForm">
                    <input type="hidden" id="flashSaleId">

                    <div class="form-sections">
                        <!-- Basic Information -->
                        <div class="form-section">
                            <h4 class="section-title">
                                <i class="fas fa-info-circle"></i>
                                Th√¥ng tin c∆° b·∫£n
                            </h4>
                            <div class="form-grid-2">
                                <div class="form-group">
                                    <label for="tenFlashSale" class="form-label">T√™n Flash Sale *</label>
                                    <input type="text" class="form-control" id="tenFlashSale" required
                                        placeholder="VD: Flash Sale T·∫øt 2025">
                                </div>
                                <div class="form-group">
                                    <label for="trangThai" class="form-label">Tr·∫°ng th√°i *</label>
                                    <select class="form-select" id="trangThai" required>
                                        <option value="cho">S·∫Øp di·ªÖn ra</option>
                                        <option value="dang_dien_ra">ƒêang di·ªÖn ra</option>
                                        <option value="da_ket_thuc">ƒê√£ k·∫øt th√∫c</option>
                                        <option value="huy">H·ªßy</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="ngayBatDau" class="form-label">Ng√†y b·∫Øt ƒë·∫ßu *</label>
                                    <input type="datetime-local" class="form-control" id="ngayBatDau" required>
                                </div>
                                <div class="form-group">
                                    <label for="ngayKetThuc" class="form-label">Ng√†y k·∫øt th√∫c *</label>
                                    <input type="datetime-local" class="form-control" id="ngayKetThuc" required>
                                </div>
                        <!-- Product Selection -->
                        <div class="form-section">
                            <h4 class="section-title">
                                <i class="fas fa-box-open"></i>
                                Th√™m s·∫£n ph·∫©m v√†o Flash Sale
                            </h4>
                            
                            <!-- Product Search & Select -->
                            <div class="form-group">
                                <label class="form-label">T√¨m ki·∫øm s·∫£n ph·∫©m</label>
                                <div class="input-group mb-3">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" id="productSearchInput" class="form-control" 
                                           placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m theo t√™n, SKU...">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Ch·ªçn s·∫£n ph·∫©m</label>
                                <select id="productSelect" class="form-select" size="6">
                                    <option value="">-- Ch·ªçn s·∫£n ph·∫©m ƒë·ªÉ xem variants --</option>
                                </select>
                            </div>

                            <!-- Variants Table -->
                            <div id="variantsSection" style="display: none; margin-top: 1.5rem;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0">
                                        <i class="fas fa-layer-group"></i>
                                        Ch·ªçn phi√™n b·∫£n s·∫£n ph·∫©m
                                    </h5>
                                    <button type="button" class="btn btn-primary btn-sm" id="addSelectedVariants">
                                        <i class="fas fa-plus-circle"></i>
                                        Th√™m variants ƒë√£ ch·ªçn
                                    </button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 50px;">
                                                    <input type="checkbox" id="selectAllVariants" class="form-check-input">
                                                </th>
                                                <th>T√™n + Phi√™n b·∫£n</th>
                                                <th style="width: 140px;">Gi√° g·ªëc</th>
                                                <th style="width: 160px;">Gi√° Flash Sale</th>
                                                <th style="width: 120px;">Gi·ªõi h·∫°n mua</th>
                                            </tr>
                                        </thead>
                                        <tbody id="variantsTableBody">
                                            <!-- Variants will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Selected Products List -->
                            <div style="margin-top: 1.5rem;">
                                <h5 class="mb-3">
                                    <i class="fas fa-check-circle text-success"></i>
                                    Danh s√°ch ƒë√£ ch·ªçn (<span id="selectedCount">0</span>)
                                </h5>
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 80px;">H√¨nh ·∫£nh</th>
                                                <th>S·∫£n ph·∫©m + Phi√™n b·∫£n</th>
                                                <th style="width: 140px;">Gi√° g·ªëc</th>
                                                <th style="width: 140px;">Gi√° Flash Sale</th>
                                                <th style="width: 100px;">Gi·ªõi h·∫°n</th>
                                                <th style="width: 80px;">X√≥a</th>
                                            </tr>
                                        </thead>
                                        <tbody id="selectedProductsTable">
                                            <tr class="empty-row">
                                                <td colspan="6" class="text-center text-muted py-4">
                                                    <i class="fas fa-inbox fa-2x mb-2" style="opacity: 0.3;"></i>
                                                    <p>Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                    H·ªßy
                </button>
                <button type="submit" form="flashSaleForm" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    L∆∞u Flash Sale
                </button>
            </div>
        </div>
    </div>
</div>


<!-- View Products Modal -->
<div class="modal fade modal-premium" id="viewProductsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye"></i>
                    <span>S·∫£n ph·∫©m trong Flash Sale</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 60px;">STT</th>
                                <th>T√™n s·∫£n ph·∫©m</th>
                                <th style="width: 120px;">M√†u s·∫Øc</th>
                                <th style="width: 120px;">Dung l∆∞·ª£ng</th>
                                <th style="width: 140px;">Gi√° g·ªëc</th>
                                <th style="width: 140px;">Gi√° Flash Sale</th>
                                <th style="width: 100px;">T·ªìn kho</th>
                                <th style="width: 100px;">ƒê√£ b√°n</th>
                                <th style="width: 100px;">Gi·ªõi h·∫°n</th>
                            </tr>
                        </thead>
                        <tbody id="viewProductsTableBody">
                            <!-- Products will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                    ƒê√≥ng
                </button>
            </div>
        </div>
    </div>
</div>


<style>
    /* Modern CSS Reset and Base Styles */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    :root {
        --primary: #667eea;
        --primary-dark: #5a6fd8;
        --secondary: #764ba2;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --dark: #1f2937;
        --light: #f8fafc;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --border-radius: 12px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --transition: all 0.3s ease;
    }

    body {
        font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
        background: var(--light);
        color: var(--gray-800);
        line-height: 1.6;
    }

    .main-content {
        min-height: 100vh;
        padding: 24px;
        max-width: 100%;
    }

    /* Header Styles */
    .dashboard-header {
        background: white;
        border-radius: var(--border-radius);
        padding: 28px 32px;
        margin-bottom: 24px;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        position: relative;
        overflow: hidden;
    }

    .dashboard-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
    }

    .header-title {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .title-icon {
        font-size: 2.75rem;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .header-title h1 {
        margin: 0;
        font-size: 1.875rem;
        font-weight: 700;
        color: var(--gray-800);
    }

    .header-title p {
        margin: 4px 0 0 0;
        color: var(--gray-500);
        font-size: 1rem;
    }

    .header-actions {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
    }

    /* Button Styles */
    .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 0.95rem;
        transition: var(--transition);
        box-shadow: var(--shadow);
        text-decoration: none;
        position: relative;
        overflow: hidden;
    }

    .btn-primary::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
        background: white;
        color: var(--gray-700);
        border: 2px solid var(--gray-300);
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        font-size: 0.9rem;
        transition: var(--transition);
    }

    .btn-secondary:hover {
        background: var(--gray-100);
        border-color: var(--gray-400);
        transform: translateY(-1px);
    }

    /* Stats Overview */
    .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 24px;
        display: flex;
        align-items: center;
        gap: 20px;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(to bottom, var(--primary), var(--secondary));
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
    }

    .stat-icon {
        width: 70px;
        height: 70px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
        box-shadow: var(--shadow);
    }

    .stat-icon.total {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #f59e0b;
    }

    .stat-icon.available {
        background: linear-gradient(135deg, #c6f6d5, #9ae6b4);
        color: #38a169;
    }

    .stat-icon.busy {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #3b82f6;
    }

    .stat-icon.premium {
        background: linear-gradient(135deg, #e9d8fd, #d6bcfa);
        color: #805ad5;
    }

    .stat-info h3 {
        margin: 0;
        font-size: 2rem;
        color: var(--gray-800);
        font-weight: 700;
    }

    .stat-info p {
        margin: 4px 0 0 0;
        color: var(--gray-500);
        font-weight: 500;
    }

    /* Search and Filter */
    .search-filter-bar {
        background: white;
        border-radius: var(--border-radius);
        padding: 24px;
        margin-bottom: 24px;
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
    }

    .search-box {
        display: flex;
        align-items: center;
        background: var(--gray-100);
        border-radius: 10px;
        padding: 12px 20px;
        flex: 1;
        min-width: 400px;
        border: 2px solid var(--gray-200);
        transition: var(--transition);
    }

    .search-box:focus-within {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .search-box i {
        color: var(--gray-400);
        margin-right: 12px;
    }

    .search-box input {
        border: none;
        background: none;
        outline: none;
        flex: 1;
        padding: 4px 0;
        font-size: 0.95rem;
        color: var(--gray-800);
    }

    .search-btn {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 8px;
        cursor: pointer;
        margin-left: 12px;
        font-weight: 600;
        transition: var(--transition);
    }

    .search-btn:hover {
        transform: translateY(-1px);
    }

    .filter-controls {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
    }

    .filter-select {
        padding: 10px 16px;
        border: 2px solid var(--gray-200);
        border-radius: 8px;
        background: white;
        color: var(--gray-700);
        min-width: 160px;
        cursor: pointer;
        transition: var(--transition);
        font-size: 0.9rem;
    }

    .filter-select:focus {
        border-color: var(--primary);
        outline: none;
    }

    .clear-filters {
        background: none;
        border: 2px solid var(--gray-200);
        color: var(--gray-600);
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: var(--transition);
    }

    .clear-filters:hover {
        background: var(--gray-100);
        border-color: var(--gray-300);
    }

    /* Table Styles */
    .table-container {
        background: white;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow);
        margin-bottom: 5px;
    }

    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid var(--gray-200);
        background: var(--gray-50);
    }

    .table-header h3 {
        margin: 0;
        color: var(--gray-800);
        font-size: 1.25rem;
        font-weight: 600;
    }

    .table-header h2 {
        margin: 0;
        color: var(--gray-800);
        font-size: 1.25rem;
        font-weight: 600;
    }

    .table-actions {
        display: flex;
        gap: 12px;
    }

    .table-info {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .total-count {
        color: var(--gray-600);
        font-size: 0.9rem;
    }

    .total-count strong {
        color: var(--primary);
        font-weight: 700;
    }

    .btn-export {
        background: white;
        color: var(--gray-700);
        border: 2px solid var(--gray-300);
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 500;
        font-size: 0.9rem;
        transition: var(--transition);
    }

    .btn-export:hover {
        background: var(--gray-100);
        border-color: var(--gray-400);
    }

    .table-responsive {
        overflow-x: auto;
    }

    .products-table {
        width: 100%;
        border-collapse: collapse;
    }

    .products-table th {
        background: var(--gray-50);
        padding: 16px 12px;
        text-align: left;
        font-weight: 600;
        color: var(--gray-700);
        border-bottom: 1px solid var(--gray-200);
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .products-table td {
        padding: 16px 12px;
        border-bottom: 1px solid var(--gray-200);
        vertical-align: middle;
    }

    .products-table tbody tr {
        transition: var(--transition);
    }

    .products-table tbody tr:hover {
        background: var(--gray-50);
    }

    .products-table tbody tr:last-child td {
        border-bottom: none;
    }

    /* Legacy table support */
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table thead {
        background: var(--gray-50);
    }

    .data-table th {
        padding: 16px 12px;
        text-align: left;
        font-weight: 600;
        color: var(--gray-700);
        border-bottom: 2px solid var(--gray-200);
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .data-table td {
        padding: 16px 12px;
        border-bottom: 1px solid var(--gray-200);
        vertical-align: middle;
    }

    .data-table tbody tr {
        transition: var(--transition);
    }

    .data-table tbody tr:hover {
        background: var(--gray-50);
    }

    .data-table tbody tr:last-child td {
        border-bottom: none;
    }

    /* Table Column Styles */
    .col-image {
        width: 80px;
    }

    .col-name {
        min-width: 200px;
    }

    .col-sku {
        width: 120px;
    }

    .col-price {
        width: 120px;
    }

    .col-category,
    .col-brand {
        width: 120px;
    }

    .col-status {
        width: 140px;
    }

    .col-actions {
        width: 100px;
    }

    /* Table Content Styles */
    .product-table-image {
        width: 50px;
        height: 50px;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--gray-100);
    }

    .product-table-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .product-name {
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: 4px;
    }

    .price-info {
        display: flex;
        flex-direction: column;
    }

    .current-price {
        font-weight: 600;
        color: var(--primary);
        font-size: 0.95rem;
    }

    .original-price {
        font-size: 0.85rem;
        color: var(--gray-400);
        text-decoration: line-through;
    }

    .category-badge,
    .brand-badge {
        background: var(--gray-100);
        color: var(--gray-700);
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .status-badge {
        padding: 6px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
    }

    .status-badge.active {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
    }

    .status-badge.inactive {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
    }

    /* Legacy badge support */
    .badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .badge-success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
    }

    .badge-warning {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
    }

    .badge-secondary {
        background: rgba(107, 114, 128, 0.1);
        color: var(--gray-600);
    }

    .featured-icon {
        color: var(--warning);
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 6px;
        justify-content: center;
    }

    .btn-action {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        color: white;
        font-size: 0.9rem;
    }

    .btn-edit {
        background: var(--primary);
    }

    .btn-edit:hover {
        background: var(--primary-dark);
        transform: scale(1.1);
    }

    .btn-toggle-status {
        background: var(--warning);
    }

    .btn-toggle-status:hover {
        background: #e58e0b;
        transform: scale(1.1);
    }

    .btn-delete {
        background: var(--danger);
    }

    .btn-delete:hover {
        background: #dc2626;
        transform: scale(1.1);
    }

    .btn-info {
        background: #3b82f6;
    }

    .btn-info:hover {
        background: #2563eb;
        transform: scale(1.1);
    }

    .btn-warning {
        background: var(--warning);
    }

    .btn-warning:hover {
        background: #d97706;
        transform: scale(1.1);
    }

    .btn-danger {
        background: var(--danger);
    }

    .btn-danger:hover {
        background: #dc2626;
        transform: scale(1.1);
    }

    /* Table Footer */
    .table-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        border-top: 1px solid var(--gray-200);
        background: var(--gray-50);
    }

    .table-pagination {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .pagination-btn {
        width: 32px;
        height: 32px;
        border: 1px solid var(--gray-300);
        background: white;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        color: var(--gray-600);
    }

    .pagination-btn:hover:not(:disabled) {
        background: var(--gray-100);
        border-color: var(--gray-400);
    }

    .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pagination-info {
        font-size: 0.9rem;
        color: var(--gray-600);
    }

    /* Empty State */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 80px 40px;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        text-align: center;
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.7;
    }

    .empty-content h3 {
        margin: 0 0 8px 0;
        color: var(--gray-800);
        font-size: 1.5rem;
    }

    .empty-content p {
        margin: 0 0 24px 0;
        color: var(--gray-500);
    }

    /* Loading State */
    .loading-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--gray-200);
        border-left: 4px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Modal Styles */
    .modal-premium .modal-content {
        border: none;
        border-radius: 16px;
        box-shadow: var(--shadow-lg);
        overflow: hidden;
    }

    .modal-premium .modal-header {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border-bottom: none;
        padding: 24px 28px;
    }

    .modal-premium .modal-title {
        font-weight: 700;
        font-size: 1.4rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-premium .modal-body {
        padding: 0;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-premium .modal-footer {
        border-top: 1px solid var(--gray-200);
        padding: 5px 28px;
        background: white;
    }

    /* Form Styles */
    .form-sections {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .form-section {
        background: var(--gray-50);
        border-radius: 12px;
        padding: 0 20px;
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
        color: var(--gray-700);
        font-size: 1.1rem;
        font-weight: 600;
    }

    .section-title i {
        color: var(--primary);
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .form-grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .form-grid-3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 16px;
    }

    .form-group {
        margin-bottom: 0;
    }

    .form-label {
        font-weight: 600;
        color: var(--gray-700);
        margin: 8px 0px 3px 0px;
        font-size: 0.95rem;
        display: block;
    }

    .form-control,
    .form-select {
        border: 2px solid var(--gray-200);
        border-radius: 8px;
        padding: 12px;
        font-size: 0.95rem;
        transition: var(--transition);
        background: white;
        width: 100%;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        outline: none;
    }

    .input-group {
        display: flex;
        border-radius: 8px;
        overflow: hidden;
    }

    .input-group .form-control {
        border-radius: 8px 0 0 8px;
    }

    .input-group .input-group-text {
        background: var(--gray-100);
        border: 2px solid var(--gray-200);
        border-left: none;
        color: var(--gray-600);
        padding: 12px;
        border-radius: 0 8px 8px 0;
    }

    .image-preview-container {
        margin-top: 12px;
    }

    .image-preview {
        border: 2px dashed var(--gray-300);
        border-radius: 12px;
        padding: 40px;
        text-align: center;
        color: var(--gray-500);
        background: white;
        transition: var(--transition);
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .image-preview.has-image {
        border-color: var(--primary);
        background: var(--gray-50);
        padding: 20px;
    }

    .image-preview img {
        max-width: 100%;
        max-height: 160px;
        border-radius: 8px;
    }

    .preview-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .preview-placeholder i {
        font-size: 3rem;
        color: var(--gray-300);
    }

    .checkbox-group {
        margin-top: 8px;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-weight: 500;
        color: var(--gray-700);
    }

    .checkbox-label input[type="checkbox"] {
        display: none;
    }

    .checkmark {
        width: 20px;
        height: 20px;
        border: 2px solid var(--gray-300);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }

    .checkbox-label input[type="checkbox"]:checked+.checkmark {
        background: var(--primary);
        border-color: var(--primary);
    }

    .checkbox-label input[type="checkbox"]:checked+.checkmark::after {
        content: '‚úì';
        color: white;
        font-size: 12px;
        font-weight: bold;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .table-responsive {
            overflow-x: auto;
        }

        .products-table {
            min-width: 1000px;
        }
    }

    @media (max-width: 768px) {
        .main-content {
            padding: 16px;
        }

        .header-content {
            flex-direction: column;
            text-align: center;
        }

        .header-actions {
            justify-content: center;
            width: 100%;
        }

        .search-filter-bar {
            flex-direction: column;
        }

        .search-box {
            min-width: auto;
            width: 100%;
        }

        .filter-controls {
            width: 100%;
            justify-content: space-between;
        }

        .filter-select {
            flex: 1;
            min-width: auto;
        }

        .table-header {
            flex-direction: column;
            gap: 16px;
            align-items: flex-start;
        }

        .table-footer {
            flex-direction: column;
            gap: 16px;
            align-items: flex-start;
        }

        .form-grid,
        .form-grid-2,
        .form-grid-3 {
            grid-template-columns: 1fr;
        }

        .stats-overview {
            grid-template-columns: 1fr;
        }

        .dashboard-header {
            padding: 20px;
        }

        .title-icon {
            font-size: 2rem;
        }

        .header-title h1 {
            font-size: 1.5rem;
        }
    }

    @media (max-width: 480px) {
        .header-actions {
            flex-direction: column;
            width: 100%;
        }

        .btn-primary,
        .btn-secondary {
            width: 100%;
            justify-content: center;
        }

        .modal-premium .modal-footer {
            flex-direction: column;
            gap: 8px;
        }

        .modal-premium .btn {
            width: 100%;
            justify-content: center;
        }
    }

    /* Additional styles for management modals */
    .management-modal .modal-content {
        max-height: 80vh;
        overflow-y: auto;
    }

    .management-modal .table-container {
        margin-top: 20px;
    }

    .management-modal .form-section {
        background: var(--gray-50);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .management-modal .section-title {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
        color: var(--gray-700);
        font-size: 1.1rem;
        font-weight: 600;
    }

    .modal-premium .modal-dialog {
        max-height: 600px;
        max-width: none;
        margin: 1.75rem auto;
    }

    .modal-premium .modal-xl {
        max-width: 1140px;
    }

    .modal-premium .modal-xxl {
        max-width: 1400px;
    }

    .modal-premium .modal-lg {
        max-width: 800px;
    }

    .modal-premium .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
    }

    @media (max-width: 1400px) {
        .modal-premium .modal-xxl {
            max-width: 95%;
            margin: 1rem auto;
        }
    }

    @media (max-width: 1200px) {
        .modal-premium .modal-xl {
            max-width: 95%;
        }
    }

    .modal-premium .table-responsive {
        border: 1px solid var(--gray-200);
        border-radius: 8px;
    }

    .modal-premium .products-table {
        margin-bottom: 0;
    }

    .modal-premium .products-table th {
        background: var(--gray-50);
        position: sticky;
        top: 0;
        z-index: 10;
    }

    /* Table Utilities */
    .text-center {
        text-align: center;
    }

    .text-end {
        text-align: right;
    }

    .fw-bold {
        font-weight: 700;
    }

    .text-muted {
        color: var(--gray-500);
    }

    /* ===== FLASH SALE MODAL & VIEW PRODUCTS MODAL ENHANCEMENTS ===== */
    
    /* Modal Body Padding */
    .modal-premium .modal-body {
        padding: 28px;
    }

    /* Form Sections in Modal */
    .modal-premium .form-section {
        background: var(--gray-50);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        border: 1px solid var(--gray-200);
    }

    .modal-premium .form-section:last-child {
        margin-bottom: 0;
    }

    .modal-premium .section-title {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--gray-800);
        padding-bottom: 12px;
        border-bottom: 2px solid var(--gray-200);
    }

    .modal-premium .section-title i {
        color: var(--primary);
        font-size: 1.2rem;
    }

    /* Product Search Input Group */
    .modal-premium .input-group {
        box-shadow: var(--shadow);
        border-radius: 8px;
        overflow: hidden;
    }

    .modal-premium .input-group-text {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border: none;
        padding: 12px 16px;
    }

    .modal-premium .input-group .form-control {
        border: 2px solid var(--gray-200);
        border-left: none;
    }

    /* Product Select Dropdown */
    .modal-premium select[size] {
        min-height: 180px;
        border: 2px solid var(--gray-200);
        border-radius: 8px;
        padding: 8px;
        background: white;
    }

    .modal-premium select[size]:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        outline: none;
    }

    .modal-premium select[size] option {
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 4px;
        cursor: pointer;
    }

    .modal-premium select[size] option:hover {
        background: var(--gray-100);
    }

    /* Variants Section */
    #variantsSection {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: 12px;
        padding: 20px;
        box-shadow: var(--shadow);
    }

    #variantsSection h5 {
        color: var(--gray-800);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    #variantsSection h5 i {
        color: var(--primary);
    }

    /* Table Enhancements in Modals */
    .modal-premium .table-responsive {
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: var(--shadow);
    }

    .modal-premium .table {
        margin-bottom: 0;
    }

    .modal-premium .table thead {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
    }

    .modal-premium .table thead th {
        color: var(--gray-800);
        font-weight: 600;
        font-size: 0.9rem;
        padding: 14px 12px;
        border-bottom: 2px solid var(--gray-300);
        white-space: nowrap;
    }

    .modal-premium .table tbody td {
        padding: 12px;
        vertical-align: middle;
        border-bottom: 1px solid var(--gray-200);
    }

    .modal-premium .table tbody tr:hover {
        background: var(--gray-50);
    }

    .modal-premium .table tbody tr:last-child td {
        border-bottom: none;
    }

    /* Table Bordered Style */
    .modal-premium .table-bordered {
        border: 1px solid var(--gray-200);
    }

    .modal-premium .table-bordered th,
    .modal-premium .table-bordered td {
        border: 1px solid var(--gray-200);
    }

    /* Empty Row Styling */
    .modal-premium .empty-row td {
        background: var(--gray-50);
        color: var(--gray-500);
        padding: 40px 20px !important;
    }

    .modal-premium .empty-row i {
        display: block;
        font-size: 3rem;
        margin-bottom: 12px;
        color: var(--gray-300);
    }

    .modal-premium .empty-row p {
        margin: 0;
        font-size: 0.95rem;
    }

    /* Selected Products List */
    #selectedProductsTable tbody tr:not(.empty-row) {
        background: white;
    }

    #selectedProductsTable tbody tr:not(.empty-row):hover {
        background: rgba(102, 126, 234, 0.05);
    }

    /* Button Styling in Modal */
    .modal-premium .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: var(--transition);
        box-shadow: var(--shadow);
    }

    .modal-premium .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .modal-premium .btn-secondary {
        background: white;
        border: 2px solid var(--gray-300);
        padding: 10px 20px;
        border-radius: 8px;
        color: var(--gray-700);
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: var(--transition);
    }

    .modal-premium .btn-secondary:hover {
        background: var(--gray-100);
        border-color: var(--gray-400);
        transform: translateY(-1px);
    }

    .modal-premium .btn-sm {
        padding: 8px 16px;
        font-size: 0.875rem;
    }

    /* Checkbox Styling in Tables */
    .modal-premium .form-check-input {
        width: 18px;
        height: 18px;
        border: 2px solid var(--gray-300);
        border-radius: 4px;
        cursor: pointer;
        transition: var(--transition);
    }

    .modal-premium .form-check-input:checked {
        background-color: var(--primary);
        border-color: var(--primary);
    }

    .modal-premium .form-check-input:focus {
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        outline: none;
    }

    /* Selected Count Badge */
    #selectedCount {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 2px 10px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 0.9rem;
    }

    /* Price Input Styling */
    .modal-premium input[type="number"],
    .modal-premium input[type="text"].price-input {
        text-align: right;
        font-weight: 600;
        color: var(--primary);
    }

    /* Flash Sale Specific Icons */
    .modal-premium .fa-bolt {
        color: #f59e0b;
    }

    .modal-premium .fa-box-open {
        color: var(--primary);
    }

    .modal-premium .fa-check-circle {
        color: var(--success);
    }

    .modal-premium .fa-eye {
        color: #3b82f6;
    }

    /* Action Buttons in Tables */
    .modal-premium .btn-danger {
        background: var(--danger);
        border: none;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.875rem;
        transition: var(--transition);
    }

    .modal-premium .btn-danger:hover {
        background: #dc2626;
        transform: scale(1.05);
    }

    /* Variants Table Specific */
    #variantsTableBody input[type="number"] {
        border: 2px solid var(--gray-200);
        border-radius: 6px;
        padding: 8px;
        font-size: 0.9rem;
        width: 100%;
    }

    #variantsTableBody input[type="number"]:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        outline: none;
    }

    /* Price Display Formatting */
    .modal-premium .price-display {
        font-weight: 600;
        color: var(--gray-800);
    }

    .modal-premium .price-flash {
        font-weight: 700;
        color: var(--danger);
        font-size: 1.05rem;
    }

    /* Modal Footer Enhancement */
    .modal-premium .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding: 20px 28px;
        background: var(--gray-50);
        border-top: 1px solid var(--gray-200);
    }

    /* Table Header Actions */
    .modal-premium .d-flex.justify-content-between {
        margin-bottom: 16px;
    }

    .modal-premium .mb-3 h5 {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--gray-800);
    }

    /* Table Light Background */
    .modal-premium .table-light {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
    }

    /* Bootstrap Utility Classes */
    .modal-premium .mb-3 {
        margin-bottom: 1rem;
    }

    .modal-premium .mb-0 {
        margin-bottom: 0;
    }

    .modal-premium .py-4 {
        padding-top: 1.5rem;
        padding-bottom: 1.5rem;
    }

    .modal-premium .fa-2x {
        font-size: 2em;
    }

    /* Responsive Modal Adjustments */
    @media (max-width: 992px) {
        .modal-premium .modal-xl {
            max-width: 95%;
        }

        .modal-premium .form-grid-2 {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .modal-premium .modal-body {
            padding: 20px;
        }

        .modal-premium .form-section {
            padding: 16px;
        }

        .modal-premium .table-responsive {
            font-size: 0.85rem;
        }

        .modal-premium .modal-footer {
            flex-direction: column;
        }

        .modal-premium .modal-footer .btn {
            width: 100%;
            justify-content: center;
        }
    }

        .filter-select {
            width: 100%;
        }
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
/**
 * ==========================================
 * FLASH SALE MANAGEMENT SYSTEM
 * Qu·∫£n l√Ω Flash Sale - T·ªëi ∆∞u v√† s·∫°ch s·∫Ω
 * ==========================================
 */

document.addEventListener('DOMContentLoaded', function() {
    'use strict';

    // ==========================================
    // GLOBAL STATE
    // ==========================================
    let flashSalesData = [];
    let filteredFlashSales = [];
    let currentProductVariants = [];
    let tempProductList = [];
    let currentFlashSaleId = null;
    let currentProduct = null;

    // ==========================================
    // DOM ELEMENTS
    // ==========================================
    const modal = new bootstrap.Modal(document.getElementById('flashSaleModal'));
    const viewModal = new bootstrap.Modal(document.getElementById('viewProductsModal'));
    const form = document.getElementById('flashSaleForm');
    const addFlashSaleBtn = document.getElementById('addFlashSaleBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const clearFiltersBtn = document.getElementById('clearFilters');
    
    const productSearchInput = document.getElementById('productSearchInput');
    const productSelect = document.getElementById('productSelect');
    const variantsSection = document.getElementById('variantsSection');
    const variantsTableBody = document.getElementById('variantsTableBody');
    const selectAllVariants = document.getElementById('selectAllVariants');
    const addSelectedVariants = document.getElementById('addSelectedVariants');

    // ==========================================
    // INITIALIZATION
    // ==========================================
    init();

    function init() {
        loadFlashSalesData();
        loadProducts();
        attachEventListeners();
    }

    // ==========================================
    // EVENT LISTENERS SETUP
    // ==========================================
    function attachEventListeners() {
        // Main actions
        addFlashSaleBtn?.addEventListener('click', () => openFlashSaleModal());
        refreshBtn?.addEventListener('click', handleRefresh);
        
        // Search and filters
        searchInput?.addEventListener('input', filterFlashSales);
        statusFilter?.addEventListener('change', filterFlashSales);
        clearFiltersBtn?.addEventListener('click', handleClearFilters);

        // Product search and selection
        productSearchInput?.addEventListener('input', handleProductSearch);
        productSelect?.addEventListener('change', handleProductSelect);
        selectAllVariants?.addEventListener('change', handleSelectAllVariants);
        addSelectedVariants?.addEventListener('click', addVariantsToList);

        // Form submission
        form?.addEventListener('submit', saveFlashSale);
    }

    // ==========================================
    // EVENT HANDLERS
    // ==========================================
    function handleRefresh() {
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i><span>ƒêang t·∫£i...</span>';
        loadFlashSalesData().finally(() => {
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i><span>L√†m m·ªõi</span>';
        });
    }

    function handleClearFilters() {
        if (searchInput) searchInput.value = '';
        if (statusFilter) statusFilter.value = '';
        filterFlashSales();
    }

    function handleProductSearch(e) {
        const searchTerm = e.target.value.toLowerCase();
        const options = productSelect.options;
        
        for (let i = 1; i < options.length; i++) {
            const text = options[i].textContent.toLowerCase();
            options[i].style.display = text.includes(searchTerm) ? '' : 'none';
        }
    }

    async function handleProductSelect(e) {
        const productId = e.target.value;
        
        if (!productId) {
            variantsSection.style.display = 'none';
            return;
        }
        
        const selectedOption = productSelect.options[productSelect.selectedIndex];
        const productData = JSON.parse(selectedOption.dataset.product || '{}');
        await loadProductVariants(productData);
    }

    function handleSelectAllVariants(e) {
        const checkboxes = variantsTableBody.querySelectorAll('.variant-checkbox');
        checkboxes.forEach(cb => cb.checked = e.target.checked);
    }

    // ==========================================
    // DATA LOADING FUNCTIONS
    // ==========================================
    async function loadFlashSalesData() {
        try {
            const response = await fetch('/api/flash-sales');
            if (!response.ok) throw new Error('Failed to load flash sales');
            
            flashSalesData = await response.json();
            filteredFlashSales = [...flashSalesData];
            
            renderFlashSalesTable();
            updateStatistics();
        } catch (error) {
            console.error('Error loading flash sales:', error);
            Swal.fire({
                icon: 'error',
                title: 'L·ªói',
                text: 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu flash sales'
            });
        }
    }

    async function loadProducts() {
        try {
            const response = await fetch('/api/sanpham');
            if (!response.ok) throw new Error('Failed to load products');
            
            const data = await response.json();
            const products = data.data?.sanphams || data.sanphams || data;
            
            productSelect.innerHTML = '<option value="">-- Ch·ªçn s·∫£n ph·∫©m ƒë·ªÉ xem variants --</option>';
            
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.ten_san_pham} (${product.ma_sku || 'N/A'})`;
                option.dataset.product = JSON.stringify(product);
                productSelect.appendChild(option);
            });
            
        } catch (error) {
            console.error('Error loading products:', error);
            Swal.fire({
                icon: 'error',
                title: 'L·ªói',
                text: 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch s·∫£n ph·∫©m'
            });
        }
    }

    async function loadProductVariants(product) {
        try {
            currentProduct = product;
            
            if (!product.mongo_detail_id) {
                Swal.fire({
                    icon: 'info',
                    title: 'Th√¥ng b√°o',
                    text: `S·∫£n ph·∫©m "${product.ten_san_pham}" ch∆∞a c√≥ th√¥ng tin MongoDB`
                });
                variantsSection.style.display = 'none';
                return;
            }

            const mongoResponse = await fetch(`/api/mongodb-details/${product.mongo_detail_id}`);
            if (!mongoResponse.ok) throw new Error('Failed to fetch MongoDB details');
            
            const mongoData = await mongoResponse.json();
            
            // Debug: Log to√†n b·ªô response structure
            console.log('üì¶ Full MongoDB Response:', mongoData);
            
            const mongoDetails = mongoData.data || mongoData;
            const variantCombinations = mongoData.variant_combinations || mongoDetails.variants?.variant_combinations || [];
            
            console.log('üì¶ Extracted Details:', {
                hasData: !!mongoData.data,
                link_avatar: mongoDetails.link_avatar,
                hinh_anh: mongoDetails.hinh_anh,
                hinhAnhArray: Array.isArray(mongoData.hinh_anh) ? mongoData.hinh_anh : 'not an array',
                variants: mongoDetails.variants,
                variantCount: variantCombinations.length,
                firstVariant: variantCombinations[0],
                firstVariantKeys: variantCombinations[0] ? Object.keys(variantCombinations[0]) : []
            });
            
            if (variantCombinations.length === 0) {
                Swal.fire({
                    icon: 'info',
                    title: 'Th√¥ng b√°o',
                    text: `S·∫£n ph·∫©m "${product.ten_san_pham}" ch∆∞a c√≥ variant combinations`
                });
                variantsSection.style.display = 'none';
                return;
            }

            // Get product-level link_avatar as fallback
            const productAvatar = mongoDetails.link_avatar || mongoDetails.hinh_anh?.[0] || '/image/default-product.png';

            currentProductVariants = variantCombinations.map((v, index) => {
                // Try multiple fields for variant image
                const variantAvatar = v.image || v.link_avatar || v.hinh_anh || productAvatar;
                
                console.log(`üñºÔ∏è Variant ${index} (${v.name}): image=${v.image}, link_avatar=${v.link_avatar}, hinh_anh=${v.hinh_anh}, productAvatar=${productAvatar}, final=${variantAvatar}`);
                
                return {
                    index: index,
                    variantId: v.variant_id || `${product.id}-${index}`,
                    productId: product.id,
                    productName: product.ten_san_pham,
                    variantName: v.name || `Variant ${index + 1}`,
                    price: v.price || v.gia || 0,
                    stock: v.stock || v.ton_kho || 0,
                    link_avatar: variantAvatar
                };
            });

            renderVariantsTable();
            variantsSection.style.display = 'block';
            
        } catch (error) {
            console.error('Error loading product variants:', error);
            Swal.fire({
                icon: 'error',
                title: 'L·ªói',
                text: 'Kh√¥ng th·ªÉ t·∫£i variant c·ªßa s·∫£n ph·∫©m'
            });
        }
    }

    async function loadFlashSaleData(id) {
        try {
            const response = await fetch(`/api/flashsales/${id}`);
            if (!response.ok) throw new Error('Failed to load flash sale');
            
            const data = await response.json();
            const flashSale = data.data || data;

            document.getElementById('flashSaleId').value = flashSale.id;
            document.getElementById('tenFlashSale').value = flashSale.ten_flash_sale;
            document.getElementById('ngayBatDau').value = formatDateTimeLocal(flashSale.ngay_bat_dau);
            document.getElementById('ngayKetThuc').value = formatDateTimeLocal(flashSale.ngay_ket_thuc);
            document.getElementById('trangThai').value = flashSale.trang_thai;

            const itemsResponse = await fetch(`/api/flashsales/${id}/items`);
            if (itemsResponse.ok) {
                const items = await itemsResponse.json();
                tempProductList = items.map(item => ({
                    productId: item.san_pham_id,
                    productName: item.ten_san_pham,
                    variantName: item.variant_name || `${item.mau_sac} - ${item.dung_luong}`,
                    fullName: `${item.ten_san_pham} + ${item.variant_name || item.mau_sac + ' - ' + item.dung_luong}`,
                    gia_goc: item.gia_goc,
                    gia_flash_sale: item.gia_flash_sale,
                    gioi_han_mua: item.gioi_han_mua,
                    link_avatar: item.link_avatar || '/image/default-product.png'
                }));
                renderTempProductList();
                updateSelectedCount();
            }
        } catch (error) {
            console.error('Error loading flash sale data:', error);
            Swal.fire({
                icon: 'error',
                title: 'L·ªói',
                text: 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin flash sale'
            });
        }
    }

    // Event Listeners
    addFlashSaleBtn.addEventListener('click', () => openFlashSaleModal());
    
    refreshBtn.addEventListener('click', () => {
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i><span>ƒêang t·∫£i...</span>';
        loadFlashSalesData().finally(() => {
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i><span>L√†m m·ªõi</span>';
        });
    });

    // Search filter for product select
    productSearchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const options = productSelect.options;
        
        for (let i = 1; i < options.length; i++) {
            const text = options[i].textContent.toLowerCase();
            options[i].style.display = text.includes(searchTerm) ? '' : 'none';
        }
    });

    // Product select change
    productSelect.addEventListener('change', async (e) => {
        const productId = e.target.value;
        
        if (!productId) {
            variantsSection.style.display = 'none';
            return;
        }
        
        const selectedOption = productSelect.options[productSelect.selectedIndex];
        const productData = JSON.parse(selectedOption.dataset.product || '{}');
        await loadProductVariants(productData);
    });

    // Select all variants checkbox
    selectAllVariants.addEventListener('change', (e) => {
        const checkboxes = variantsTableBody.querySelectorAll('.variant-checkbox');
        checkboxes.forEach(cb => cb.checked = e.target.checked);
    });

    // Add selected variants button
    addSelectedVariants.addEventListener('click', addVariantsToList);

    form.addEventListener('submit', saveFlashSale);

    // Functions
    async function loadFlashSalesData() {
        try {
            const response = await fetch('/api/flash-sales');
            if (!response.ok) throw new Error('Failed to load flash sales');
            flashSalesData = await response.json();
            renderFlashSalesTable();
            updateStatistics();
        } catch (error) {
            console.error('Error loading flash sales:', error);
            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu flash sales', 'error');
        }
    }

    // ==========================================
    // FILTER & SEARCH FUNCTIONS
    // ==========================================
    function filterFlashSales() {
        const searchTerm = searchInput?.value.toLowerCase() || '';
        const statusValue = statusFilter?.value || '';

        filteredFlashSales = flashSalesData.filter(fs => {
            const matchesSearch = fs.ten_flash_sale.toLowerCase().includes(searchTerm);
            const matchesStatus = !statusValue || fs.trang_thai === statusValue;
            return matchesSearch && matchesStatus;
        });

        renderFlashSalesTable();
        updateDisplayCount();
    }

    function updateDisplayCount() {
        const countElement = document.getElementById('displayCount');
        if (countElement) {
            countElement.textContent = filteredFlashSales.length || flashSalesData.length;
        }
    }

    function updateStatistics() {
        const total = flashSalesData.length;
        const active = flashSalesData.filter(fs => fs.trang_thai === 'dang_dien_ra').length;
        const upcoming = flashSalesData.filter(fs => fs.trang_thai === 'cho').length;
        const totalProducts = flashSalesData.reduce((sum, fs) => sum + (fs.product_count || 0), 0);

        document.getElementById('totalFlashSales').textContent = total;
        document.getElementById('activeFlashSales').textContent = active;
        document.getElementById('upcomingFlashSales').textContent = upcoming;
        document.getElementById('totalProducts').textContent = totalProducts;
    }

    function renderFlashSalesTable() {
        const tbody = document.getElementById('flashSaleTableBody');
        const dataToRender = filteredFlashSales.length > 0 ? filteredFlashSales : flashSalesData;
        
        if (!dataToRender || dataToRender.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3" style="display: block; opacity: 0.3;"></i>
                        <p class="text-muted">Ch∆∞a c√≥ flash sale n√†o</p>
                    </td>
                </tr>`;
            updateDisplayCount();
            return;
        }

        tbody.innerHTML = dataToRender.map((fs, index) => {
            const statusClass = getStatusClass(fs.trang_thai);
            const statusIcon = getStatusIcon(fs.trang_thai);
            
            return `
                <tr>
                    <td>${index + 1}</td>
                    <td style="text-align: left; font-weight: 600;">${fs.ten_flash_sale}</td>
                    <td>${formatDateTime(fs.ngay_bat_dau)}</td>
                    <td>${formatDateTime(fs.ngay_ket_thuc)}</td>
                    <td>
                        <span class="badge badge-${statusClass}">
                            <i class="${statusIcon}"></i>
                            ${getStatusText(fs.trang_thai)}
                        </span>
                    </td>
                    <td><strong>${fs.product_count || 0}</strong></td>
                    <td>
                        <div class="action-buttons" style="gap: 0.375rem;">
                            <button class="btn btn-action btn-info" data-action="view" data-id="${fs.id}" title="Xem chi ti·∫øt">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-action btn-warning" data-action="edit" data-id="${fs.id}" title="Ch·ªânh s·ª≠a">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-action btn-danger" data-action="delete" data-id="${fs.id}" title="X√≥a">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        // Bind action buttons
        tbody.querySelectorAll('[data-action]').forEach(btn => {
            btn.addEventListener('click', handleAction);
        });
        
        updateDisplayCount();
    }

    function handleAction(e) {
        const action = e.currentTarget.dataset.action;
        const id = e.currentTarget.dataset.id;

        switch(action) {
            case 'view':
                viewFlashSaleProducts(id);
                break;
            case 'edit':
                openFlashSaleModal(id);
                break;
            case 'delete':
                deleteFlashSale(id);
                break;
        }
    }

    async function openFlashSaleModal(id = null) {
        currentFlashSaleId = id;
        tempProductList = [];
        currentProductVariants = [];
        currentProduct = null;

        // Reset form
        form.reset();
        document.getElementById('selectedProductsTable').innerHTML = '<tr class="empty-row"><td colspan="5" class="text-center text-muted py-4"><i class="fas fa-inbox fa-2x mb-2" style="opacity: 0.3;"></i><p>Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn</p></td></tr>';
        productSearchInput.value = '';
        productSelect.value = '';
        Array.from(productSelect.options).forEach(opt => opt.style.display = '');
        variantsSection.style.display = 'none';
        variantsTableBody.innerHTML = '';
        selectAllVariants.checked = false;
        updateSelectedCount();

        if (id) {
            document.querySelector('#modalTitle').textContent = 'Ch·ªânh s·ª≠a Flash Sale';
            await loadFlashSaleData(id);
        } else {
            document.querySelector('#modalTitle').textContent = 'T·∫°o Flash Sale M·ªõi';
            document.getElementById('flashSaleId').value = '';
        }

        modal.show();
    }

    // Load all products into select box
    async function loadProducts() {
        try {
            const response = await fetch(`/api/sanpham`);
            if (!response.ok) throw new Error('Failed to load products');
            
            const data = await response.json();
            const products = data.data?.sanphams || data.sanphams || data;
            
            // Clear and populate select box
            productSelect.innerHTML = '<option value="">-- Ch·ªçn s·∫£n ph·∫©m ƒë·ªÉ xem variants --</option>';
            
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.ten_san_pham} (${product.ma_sku})`;
                option.dataset.product = JSON.stringify(product);
                productSelect.appendChild(option);
            });
            
        } catch (error) {
            console.error('Error loading products:', error);
            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch s·∫£n ph·∫©m', 'error');
        }
    }

    // Load variant_combinations from MongoDB
    async function loadProductVariants(product) {
        try {
            currentProduct = product;
            
            // Check if product has mongo_detail_id
            if (!product.mongo_detail_id) {
                Swal.fire('Th√¥ng b√°o', `S·∫£n ph·∫©m "${product.ten_san_pham}" ch∆∞a c√≥ th√¥ng tin MongoDB`, 'info');
                variantsSection.style.display = 'none';
                return;
            }

            // Fetch MongoDB details using mongo_detail_id
            const mongoResponse = await fetch(`/api/mongodb-details/${product.mongo_detail_id}`);
            if (!mongoResponse.ok) throw new Error('Failed to fetch MongoDB details');
            
            const mongoDetails = await mongoResponse.json();
            
            // Get variant_combinations
            let variantCombinations = [];
            if (mongoDetails.variant_combinations && Array.isArray(mongoDetails.variant_combinations)) {
                variantCombinations = mongoDetails.variant_combinations;
            }
            
            // If no variants, show info (backend should auto-create default variant)
            if (variantCombinations.length === 0) {
                Swal.fire('Th√¥ng b√°o', `S·∫£n ph·∫©m "${product.ten_san_pham}" ch∆∞a c√≥ variant. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·∫°o variant m·∫∑c ƒë·ªãnh khi b·∫°n l∆∞u s·∫£n ph·∫©m n√†y.`, 'info');
                variantsSection.style.display = 'none';
                return;
            }

            // Map variants with product info and use variant_id from MongoDB
            currentProductVariants = variantCombinations.map((v, index) => {
                // Use variant_id from MongoDB (should already exist after backend processing)
                const variantId = v.variant_id || product.id; // Fallback to product ID if missing
                const isDefault = v.is_default === true;
                const avatarUrl = v.image || v.link_avatar || mongoDetails.link_avatar || '/image/default-product.png';
                
                console.log(`üñºÔ∏è Variant ${index}: image=${v.image}, link_avatar=${v.link_avatar}, product_avatar=${mongoDetails.link_avatar}, final=${avatarUrl}`);
                
                return {
                    index: index,
                    variantId: variantId,  // MongoDB variant_id to save in flash_sale_items.san_pham_id
                    productId: product.id,
                    productName: product.ten_san_pham,
                    variantName: v.name || (isDefault ? 'M·∫∑c ƒë·ªãnh' : `Variant ${index + 1}`),
                    price: v.price || product.gia_ban || 0,
                    stock: v.stock || product.ton_kho || 0,
                    isDefault: isDefault,
                    link_avatar: avatarUrl
                };
            }).filter(v => !v.isDefault); // Filter out default variants from display
            
            // If no real variants (only default), don't show variants section
            if (currentProductVariants.length === 0) {
                Swal.fire('Th√¥ng b√°o', `S·∫£n ph·∫©m "${product.ten_san_pham}" ch·ªâ c√≥ variant m·∫∑c ƒë·ªãnh. Vui l√≤ng th√™m variants ƒë·ªÉ ch·ªçn.`, 'info');
                variantsSection.style.display = 'none';
                return;
            }

            renderVariantsTable();
            variantsSection.style.display = 'block';
            
        } catch (error) {
            console.error('Error loading product variants:', error);
            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ t·∫£i variant c·ªßa s·∫£n ph·∫©m', 'error');
        }
    }

    // Render variants table with checkboxes
    function renderVariantsTable() {
        if (currentProductVariants.length === 0) {
            variantsTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Kh√¥ng c√≥ variant</td></tr>';
            return;
        }

        variantsTableBody.innerHTML = currentProductVariants.map((variant) => {
            const fullName = `${variant.productName} - ${variant.variantName}`;
            const formattedPrice = new Intl.NumberFormat('vi-VN').format(variant.price);
            
            // Check if this variant is already in tempProductList (for edit mode)
            const existingItem = tempProductList.find(p => p.variantId === variant.variantId);
            const isChecked = existingItem ? 'checked' : '';
            const flashPrice = existingItem ? existingItem.gia_flash_sale : '';
            const limitQty = existingItem ? existingItem.gioi_han_mua : 1;
            
            return `
                <tr>
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input variant-checkbox" 
                               data-index="${variant.index}" ${isChecked}>
                    </td>
                    <td>${fullName}</td>
                    <td class="text-end fw-bold">${formattedPrice}‚Ç´</td>
                    <td>
                        <input type="number" 
                               class="form-control form-control-sm flash-price-input" 
                               data-index="${variant.index}"
                               min="0" 
                               max="${variant.price}"
                               value="${flashPrice}"
                               placeholder="Nh·∫≠p gi√°">
                    </td>
                    <td>
                        <input type="number" 
                               class="form-control form-control-sm limit-qty-input" 
                               data-index="${variant.index}"
                               min="1" 
                               value="${limitQty}">
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Add selected variants to temp list
    function addVariantsToList() {
        const checkedBoxes = variantsTableBody.querySelectorAll('.variant-checkbox:checked');
        
        if (checkedBoxes.length === 0) {
            Swal.fire('Th√¥ng b√°o', 'Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 variant', 'info');
            return;
        }

        let addedCount = 0;
        let updatedCount = 0;
        let errors = [];

        checkedBoxes.forEach(checkbox => {
            const index = parseInt(checkbox.dataset.index);
            const variant = currentProductVariants.find(v => v.index === index);
            
            if (!variant) return;

            const flashPriceInput = variantsTableBody.querySelector(`.flash-price-input[data-index="${index}"]`);
            const limitQtyInput = variantsTableBody.querySelector(`.limit-qty-input[data-index="${index}"]`);
            
            const flashPrice = parseFloat(flashPriceInput.value);
            const limitQty = parseInt(limitQtyInput.value) || 1;

            // Validation
            if (!flashPrice || flashPrice <= 0) {
                errors.push(`${variant.variantName}: Ch∆∞a nh·∫≠p gi√° flash sale`);
                return;
            }

            if (flashPrice >= variant.price) {
                errors.push(`${variant.variantName}: Gi√° flash sale ph·∫£i nh·ªè h∆°n gi√° g·ªëc`);
                return;
            }

            // Get link_avatar from variant (already loaded from MongoDB in currentProductVariants)
            const avatarUrl = variant.link_avatar || '/image/default-product.png';
            
            console.log(`üì∏ Adding variant ${variant.variantName}: link_avatar = ${avatarUrl}`);

            // Check if already exists in tempProductList
            const existingIndex = tempProductList.findIndex(p => p.variantId === variant.variantId);

            if (existingIndex !== -1) {
                // Update existing item
                tempProductList[existingIndex] = {
                    variantId: variant.variantId,
                    productId: variant.productId,
                    productName: variant.productName,
                    variantName: variant.variantName,
                    fullName: `${variant.productName} + ${variant.variantName}`,
                    gia_goc: variant.price,
                    gia_flash_sale: flashPrice,
                    gioi_han_mua: limitQty,
                    stock: variant.stock,
                    link_avatar: avatarUrl
                };
                updatedCount++;
            } else {
                // Add new item
                tempProductList.push({
                    variantId: variant.variantId,  // MongoDB variant_id (will be saved as san_pham_id)
                    productId: variant.productId,
                    productName: variant.productName,
                    variantName: variant.variantName,
                    fullName: `${variant.productName} + ${variant.variantName}`,
                    gia_goc: variant.price,
                    gia_flash_sale: flashPrice,
                    gioi_han_mua: limitQty,
                    stock: variant.stock,
                    link_avatar: avatarUrl
                });
                addedCount++;
            }
        });

        if (errors.length > 0) {
            Swal.fire('L·ªói', errors.join('<br>'), 'error');
        }

        if (addedCount > 0 || updatedCount > 0) {
            renderTempProductList();
            updateSelectedCount();
            
            // Reset
            variantsSection.style.display = 'none';
            productSearchInput.value = '';
            productSelect.value = '';
            selectAllVariants.checked = false;
            
            const message = [];
            if (addedCount > 0) message.push(`ƒê√£ th√™m ${addedCount} variant`);
            if (updatedCount > 0) message.push(`ƒê√£ c·∫≠p nh·∫≠t ${updatedCount} variant`);
            
            Swal.fire({
                icon: 'success',
                title: 'Th√†nh c√¥ng',
                text: message.join(', '),
                timer: 2000,
                showConfirmButton: false
            });
        }
    }

    // Render temp product list
    function renderTempProductList() {
        const tbody = document.getElementById('selectedProductsTable');
        
        if (tempProductList.length === 0) {
            tbody.innerHTML = '<tr class="empty-row"><td colspan="6" class="text-center"><i class="fas fa-inbox fa-3x text-muted mb-3" style="display: block; opacity: 0.3;"></i><p class="text-muted">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn</p></td></tr>';
            return;
        }

        tbody.innerHTML = tempProductList.map((product, index) => {
            const formattedOriginal = new Intl.NumberFormat('vi-VN').format(product.gia_goc);
            const formattedFlash = new Intl.NumberFormat('vi-VN').format(product.gia_flash_sale);
            const discount = Math.round(((product.gia_goc - product.gia_flash_sale) / product.gia_goc) * 100);
            const imageUrl = product.link_avatar || '/image/default-product.png';
            
            return `
                <tr>
                    <td style="text-align: center;">
                        <img src="${imageUrl}" alt="${product.productName}" 
                             style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid var(--gray-200);">
                    </td>
                    <td style="text-align: left;">
                        <strong>${product.fullName}</strong>
                        <br><small class="text-muted">Gi·∫£m ${discount}%</small>
                    </td>
                    <td style="text-align: right;">${formattedOriginal}‚Ç´</td>
                    <td style="text-align: right; color: var(--danger); font-weight: 700;">${formattedFlash}‚Ç´</td>
                    <td style="text-align: center;"><strong>${product.gioi_han_mua}</strong></td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeFromTempList(${index})" 
                                style="padding: 0.375rem 0.75rem;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Remove from temp list
    window.removeFromTempList = function(index) {
        tempProductList.splice(index, 1);
        renderTempProductList();
        updateSelectedCount();
    };

    // Update selected count
    function updateSelectedCount() {
        const countSpan = document.getElementById('selectedCount');
        if (countSpan) {
            countSpan.textContent = tempProductList.length;
        }
    }

    // Save flash sale
    async function saveFlashSale(e) {
        e.preventDefault();

        const formData = {
            ten_flash_sale: document.getElementById('tenFlashSale').value,
            ngay_bat_dau: document.getElementById('ngayBatDau').value,
            ngay_ket_thuc: document.getElementById('ngayKetThuc').value,
            trang_thai: document.getElementById('trangThai').value,
            products: tempProductList
        };

        if (tempProductList.length === 0) {
            Swal.fire('L·ªói', 'Vui l√≤ng th√™m √≠t nh·∫•t 1 s·∫£n ph·∫©m', 'error');
            return;
        }

        try {
            const url = currentFlashSaleId 
                ? `/api/flashsales/${currentFlashSaleId}` 
                : '/api/flashsales';
            
            const method = currentFlashSaleId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (!response.ok) throw new Error('Failed to save flash sale');

            await Swal.fire({
                icon: 'success',
                title: 'Th√†nh c√¥ng',
                text: 'Flash sale ƒë√£ ƒë∆∞·ª£c l∆∞u',
                timer: 2000,
                showConfirmButton: false
            });
            
            modal.hide();
            loadFlashSalesData();
        } catch (error) {
            console.error('Error saving flash sale:', error);
            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ l∆∞u flash sale', 'error');
        }
    }

    // Load flash sale data for editing
    async function loadFlashSaleData(id) {
        try {
            const response = await fetch(`/api/flashsales/${id}`);
            if (!response.ok) throw new Error('Failed to load flash sale');
            
            const data = await response.json();
            const flashSale = data.data || data;

            document.getElementById('flashSaleId').value = flashSale.id;
            document.getElementById('tenFlashSale').value = flashSale.ten_flash_sale;
            document.getElementById('ngayBatDau').value = formatDateTimeLocal(flashSale.ngay_bat_dau);
            document.getElementById('ngayKetThuc').value = formatDateTimeLocal(flashSale.ngay_ket_thuc);
            document.getElementById('trangThai').value = flashSale.trang_thai;

            // Load products
            const itemsResponse = await fetch(`/api/flashsales/${id}/items`);
            if (itemsResponse.ok) {
                const itemsData = await itemsResponse.json();
                const items = Array.isArray(itemsData) ? itemsData : (itemsData.data || itemsData.items || []);
                
                tempProductList = items.map(item => ({
                    productId: item.san_pham_id,
                    productName: item.ten_san_pham,
                    variantName: `${item.mau_sac || ''} - ${item.dung_luong || ''}`,
                    fullName: `${item.ten_san_pham} + ${item.mau_sac || ''} - ${item.dung_luong || ''}`,
                    gia_goc: item.gia_goc,
                    gia_flash_sale: item.gia_flash_sale,
                    gioi_han_mua: item.gioi_han_mua,
                    link_avatar: item.link_avatar || '/image/default-product.png'
                }));
                renderTempProductList();
                updateSelectedCount();
            }
        } catch (error) {
            console.error('Error loading flash sale data:', error);
            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin flash sale', 'error');
        }
    }

    // View flash sale products
    async function viewFlashSaleProducts(id) {
        try {
            const response = await fetch(`/api/flashsales/${id}/items`);
            
            let items = [];
            if (response.ok) {
                const data = await response.json();
                // Handle different response structures
                items = Array.isArray(data) ? data : (data.data || data.items || []);
            } else {
                console.warn('API returned non-OK status:', response.status);
                // If API fails, try to continue with empty array
                items = [];
            }
            
            const tbody = document.getElementById('viewProductsTableBody');

            if (!items || items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center py-5"><i class="fas fa-inbox fa-3x text-muted mb-3" style="display: block; opacity: 0.3;"></i><p class="text-muted mt-3">Ch∆∞a c√≥ s·∫£n ph·∫©m</p></td></tr>';
            } else {
                tbody.innerHTML = items.map((item, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="text-align: left; font-weight: 600;">${escapeHtml(item.ten_san_pham || '')}</td>
                        <td>${escapeHtml(item.mau_sac || '-')}</td>
                        <td>${escapeHtml(item.dung_luong || '-')}</td>
                        <td style="text-align: right;">${formatCurrency(item.gia_goc || 0)}</td>
                        <td style="text-align: right; color: var(--danger); font-weight: 700;">${formatCurrency(item.gia_flash_sale || 0)}</td>
                        <td style="text-align: center;">${item.so_luong_ton || 0}</td>
                        <td style="text-align: center;"><strong>${item.da_ban || 0}</strong></td>
                        <td style="text-align: center;">${item.gioi_han_mua || 1}</td>
                    </tr>
                `).join('');
            }

            viewModal.show();
        } catch (error) {
            console.error('Error loading flash sale products:', error);
            // Still show modal with empty message instead of error alert
            const tbody = document.getElementById('viewProductsTableBody');
            tbody.innerHTML = '<tr><td colspan="9" class="text-center py-5"><i class="fas fa-exclamation-triangle fa-3x text-warning mb-3" style="display: block; opacity: 0.3;"></i><p class="text-muted mt-3">Kh√¥ng th·ªÉ t·∫£i danh s√°ch s·∫£n ph·∫©m</p></td></tr>';
            viewModal.show();
        }
    }

    // ==========================================
    // MODAL FUNCTIONS
    // ==========================================
    async function openFlashSaleModal(id = null) {
        currentFlashSaleId = id;
        tempProductList = [];
        currentProductVariants = [];
        currentProduct = null;

        // Reset form
        form.reset();
        document.getElementById('selectedProductsTable').innerHTML = `
            <tr class="empty-row">
                <td colspan="5" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2" style="opacity: 0.3;"></i>
                    <p>Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn</p>
                </td>
            </tr>`;
        
        if (productSearchInput) productSearchInput.value = '';
        if (productSelect) productSelect.value = '';
        if (productSelect) Array.from(productSelect.options).forEach(opt => opt.style.display = '');
        if (variantsSection) variantsSection.style.display = 'none';
        if (variantsTableBody) variantsTableBody.innerHTML = '';
        if (selectAllVariants) selectAllVariants.checked = false;
        updateSelectedCount();

        if (id) {
            document.getElementById('modalTitle').textContent = 'Ch·ªânh s·ª≠a Flash Sale';
            await loadFlashSaleData(id);
        } else {
            document.getElementById('modalTitle').textContent = 'T·∫°o Flash Sale M·ªõi';
            const flashSaleIdInput = document.getElementById('flashSaleId');
            if (flashSaleIdInput) flashSaleIdInput.value = '';
        }

        modal.show();
    }

    async function loadFlashSaleData(id) {
        try {
            const response = await fetch(`/api/flashsales/${id}`);
            if (!response.ok) throw new Error('Failed to load flash sale');
            
            const data = await response.json();
            const flashSale = data.data || data;

            const flashSaleIdInput = document.getElementById('flashSaleId');
            if (flashSaleIdInput) flashSaleIdInput.value = flashSale.id;
            document.getElementById('tenFlashSale').value = flashSale.ten_flash_sale;
            document.getElementById('ngayBatDau').value = formatDateTimeLocal(flashSale.ngay_bat_dau);
            document.getElementById('ngayKetThuc').value = formatDateTimeLocal(flashSale.ngay_ket_thuc);
            document.getElementById('trangThai').value = flashSale.trang_thai;

            const itemsResponse = await fetch(`/api/flashsales/${id}/items`);
            if (itemsResponse.ok) {
                const itemsData = await itemsResponse.json();
                const items = Array.isArray(itemsData) ? itemsData : (itemsData.data || itemsData.items || []);
                
                console.log('üì¶ Loaded flash sale items:', items);
                
                tempProductList = items.map(item => {
                    return {
                        variantId: item.variant_id || item.san_pham_id,
                        productId: item.sql_product_id,
                        productName: item.ten_san_pham,
                        variantName: item.variant_name || 'M·∫∑c ƒë·ªãnh',
                        fullName: `${item.ten_san_pham} - ${item.variant_name || 'M·∫∑c ƒë·ªãnh'}`,
                        gia_goc: item.gia_goc,
                        gia_flash_sale: item.gia_flash_sale,
                        gioi_han_mua: item.gioi_han_mua,
                        link_avatar: item.link_avatar || '/image/default-product.png'
                    };
                });
                
                console.log('üìù Mapped to tempProductList:', tempProductList);
                renderTempProductList();
                updateSelectedCount();
            }
        } catch (error) {
            console.error('Error loading flash sale data:', error);
            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin flash sale', 'error');
        }
    }

    function renderTempProductList() {
        const tbody = document.getElementById('selectedProductsTable');
        
        if (tempProductList.length === 0) {
            tbody.innerHTML = `
                <tr class="empty-row">
                    <td colspan="6" class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-2" style="opacity: 0.3;"></i>
                        <p>Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn</p>
                    </td>
                </tr>`;
            return;
        }

        tbody.innerHTML = tempProductList.map((product, index) => {
            const formattedOriginal = formatCurrency(product.gia_goc);
            const formattedFlash = formatCurrency(product.gia_flash_sale);
            const discount = Math.round(((product.gia_goc - product.gia_flash_sale) / product.gia_goc) * 100);
            const imageUrl = product.link_avatar || '/image/default-product.png';
            
            return `
                <tr>
                    <td style="text-align: center;">
                        <img src="${imageUrl}" alt="${escapeHtml(product.productName)}" 
                             style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid var(--gray-200);">
                    </td>
                    <td style="text-align: left;">
                        <strong>${escapeHtml(product.fullName)}</strong>
                        <br><small class="text-muted">Gi·∫£m ${discount}%</small>
                    </td>
                    <td style="text-align: right;">${formattedOriginal}</td>
                    <td style="text-align: right; color: var(--danger); font-weight: 700;">${formattedFlash}</td>
                    <td style="text-align: center;"><strong>${product.gioi_han_mua}</strong></td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeFromTempList(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    window.removeFromTempList = function(index) {
        tempProductList.splice(index, 1);
        renderTempProductList();
        updateSelectedCount();
    };

    function updateSelectedCount() {
        const countSpan = document.getElementById('selectedCount');
        if (countSpan) {
            countSpan.textContent = tempProductList.length;
        }
    }

    // Delete flash sale
    async function deleteFlashSale(id) {
        const result = await Swal.fire({
            title: 'X√°c nh·∫≠n x√≥a?',
            text: 'Flash sale s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'X√≥a',
            cancelButtonText: 'H·ªßy',
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#6b7280'
        });

        if (!result.isConfirmed) return;

        try {
            const response = await fetch(`/api/flashsales/${id}`, {
                method: 'DELETE'
            });

            if (!response.ok) throw new Error('Failed to delete flash sale');

            await Swal.fire({
                icon: 'success',
                title: 'ƒê√£ x√≥a',
                text: 'Flash sale ƒë√£ ƒë∆∞·ª£c x√≥a',
                timer: 2000,
                showConfirmButton: false
            });
            
            loadFlashSalesData();
        } catch (error) {
            console.error('Error deleting flash sale:', error);
            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ x√≥a flash sale', 'error');
        }
    }

    // ==========================================
    // UTILITY FUNCTIONS
    // ==========================================
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDateTime(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleString('vi-VN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function formatDateTimeLocal(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN').format(amount) + '‚Ç´';
    }

    function getStatusText(status) {
        switch(status) {
            case 'cho': return 'S·∫Øp di·ªÖn ra';
            case 'dang_dien_ra': return 'ƒêang di·ªÖn ra';
            case 'da_ket_thuc': return 'ƒê√£ k·∫øt th√∫c';
            case 'huy': return 'ƒê√£ h·ªßy';
            default: return status;
        }
    }

    function getStatusClass(status) {
        switch(status) {
            case 'dang_dien_ra': return 'success';
            case 'cho': return 'warning';
            case 'da_ket_thuc': return 'secondary';
            case 'huy': return 'danger';
            default: return 'secondary';
        }
    }

    function getStatusIcon(status) {
        switch(status) {
            case 'dang_dien_ra': return 'fas fa-play-circle';
            case 'cho': return 'fas fa-clock';
            case 'da_ket_thuc': return 'fas fa-check-circle';
            case 'huy': return 'fas fa-ban';
            default: return 'fas fa-circle';
        }
    }
});
</script>
