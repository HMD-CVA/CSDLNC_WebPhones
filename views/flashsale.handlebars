<div class="main-content">
    <div class="admin-dashboard">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-content">
                <div class="header-title">
                    <div class="title-icon">⚡</div>
                    <div>
                        <h1>QUẢN LÝ FLASH SALE</h1>
                        <p>Quản lý các đợt flash sale và sản phẩm khuyến mãi</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn-primary" onclick="openFlashSaleModal()">
                        <i class="fas fa-plus"></i>
                        <span>Tạo Flash Sale</span>
                    </button>
                    <button class="btn-secondary" onclick="loadData()">
                        <i class="fas fa-sync-alt"></i>
                        <span>Làm mới</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-icon total">
                    <i class="fas fa-bolt"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalFlashSales">0</h3>
                    <p>Tổng Flash Sale</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon available">
                    <i class="fas fa-fire"></i>
                </div>
                <div class="stat-info">
                    <h3 id="activeFlashSales">0</h3>
                    <p>Đang diễn ra</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon busy">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-info">
                    <h3 id="waitingFlashSales">0</h3>
                    <p>Sắp diễn ra</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon premium">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                    <h3 id="endedFlashSales">0</h3>
                    <p>Đã kết thúc</p>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="search-filter-bar">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Tìm kiếm flash sale...">
            </div>
            <div class="filter-controls">
                <select id="statusFilter" class="filter-select">
                    <option value="">Tất cả trạng thái</option>
                    <option value="cho">Chờ diễn ra</option>
                    <option value="dang_dien_ra">Đang diễn ra</option>
                    <option value="da_ket_thuc">Đã kết thúc</option>
                    <option value="huy">Đã hủy</option>
                </select>
            </div>
        </div>

        <!-- Flash Sales Table -->
        <div class="table-container">
            <div class="table-header">
                <h3><i class="fas fa-list"></i> Danh sách Flash Sale</h3>
            </div>
            <div class="table-responsive">
                <table class="simple-table">
                    <thead>
                        <tr>
                            <th>Tên Flash Sale</th>
                            <th>Thời gian</th>
                            <th>Sản phẩm</th>
                            <th>Đã bán</th>
                            <th>Trạng thái</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="flashSalesTableBody">
                        <tr>
                            <td colspan="6" class='text-center'>Đang tải dữ liệu...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Flash Sale Modal (Add/Edit) -->
    <div class="modal fade" id="flashSaleModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="flashSaleModalTitle">Thêm Flash Sale</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="flashSaleForm">
                        <input type="hidden" id="flashSaleId">
                        
                        <!-- Thông tin Flash Sale -->
                        <div class="section-box mb-4">
                            <h6 class="section-title"><i class="fas fa-info-circle"></i> Thông tin Flash Sale</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Tên Flash Sale <span class='text-danger'>*</span></label>
                                        <input type="text" class="form-control" id="flashSaleName" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Trạng thái</label>
                                        <select class="form-control" id="flashSaleStatus">
                                            <option value="cho">Chờ diễn ra</option>
                                            <option value="dang_dien_ra">Đang diễn ra</option>
                                            <option value="da_ket_thuc">Đã kết thúc</option>
                                            <option value="huy">Hủy</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mb-3">
                                <label class="form-label">Mô tả</label>
                                <textarea class="form-control" id="flashSaleDesc" rows="2"></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Thời gian bắt đầu <span class='text-danger'>*</span></label>
                                        <input type="datetime-local" class="form-control" id="flashSaleStart" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Thời gian kết thúc <span class='text-danger'>*</span></label>
                                        <input type="datetime-local" class="form-control" id="flashSaleEnd" required>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Danh sách sản phẩm -->
                        <div class="section-box">
                            <h6 class="section-title"><i class="fas fa-box"></i> Sản phẩm Flash Sale</h6>
                            
                            <!-- Form thêm sản phẩm -->
                            <div class="add-product-form mb-3 p-3" style="background: #f8f9fa; border-radius: 8px;">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-group mb-2">
                                            <label class="form-label">Sản phẩm</label>
                                            <select class="form-control form-control-sm" id="modalProductSelect">
                                                <option value="">Chọn sản phẩm</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group mb-2">
                                            <label class="form-label">Giá gốc</label>
                                            <input type="number" class="form-control form-control-sm" id="modalOriginalPrice" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group mb-2">
                                            <label class="form-label">Giá sale</label>
                                            <input type="number" class="form-control form-control-sm" id="modalFlashSalePrice">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group mb-2">
                                            <label class="form-label">SL tồn kho</label>
                                            <input type="number" class="form-control form-control-sm" id="modalAvailableQty" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group mb-2">
                                            <label class="form-label">SL sale</label>
                                            <input type="number" class="form-control form-control-sm" id="modalSaleQty">
                                        </div>
                                    </div>
                                    <div class="col-md-1">
                                        <div class="form-group mb-2">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="button" class="btn btn-primary btn-sm w-100" onclick="addProductToTempList()">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Bảng sản phẩm đã thêm -->
                            <div class="table-responsive">
                                <table class="simple-table" id="tempProductsTable">
                                    <thead>
                                        <tr>
                                            <th>STT</th>
                                            <th>Sản phẩm</th>
                                            <th>Giá gốc</th>
                                            <th>Giá sale</th>
                                            <th>Giảm</th>
                                            <th>SL sale</th>
                                            <th>Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tempProductsTableBody">
                                        <tr>
                                            <td colspan="7" class='text-center'>Chưa có sản phẩm</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn-primary" onclick="saveFlashSale()">
                        <i class="fas fa-save"></i> Lưu Flash Sale
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Modal -->
    <div class="modal fade" id="productsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productsModalTitle">Quản lý sản phẩm Flash Sale</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="currentFlashSaleId">
                    
                    <!-- Add Product Form -->
                    <div class="mb-4 p-3" style="background: #f8f9fa; border-radius: 8px;">
                        <h6 class="mb-3"><i class="fas fa-plus-circle"></i> Thêm sản phẩm</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label class="form-label">Sản phẩm</label>
                                    <select class="form-control" id="productSelect">
                                        <option value="">Chọn sản phẩm</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group mb-3">
                                    <label class="form-label">Giá gốc</label>
                                    <input type="number" class="form-control" id="originalPrice" readonly>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group mb-3">
                                    <label class="form-label">Giá Flash Sale</label>
                                    <input type="number" class="form-control" id="flashSalePrice">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group mb-3">
                                    <label class="form-label">Số lượng</label>
                                    <input type="number" class="form-control" id="itemQuantity">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="button" class="btn-primary w-100" onclick="addProductToFlashSale()">
                                        <i class="fas fa-plus"></i> Thêm
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Products List -->
                    <div class="table-responsive">
                        <table class="simple-table">
                            <thead>
                                <tr>
                                    <th>Sản phẩm</th>
                                    <th>Giá gốc</th>
                                    <th>Giá Flash Sale</th>
                                    <th>Giảm</th>
                                    <th>Số lượng</th>
                                    <th>Đã bán</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <tr>
                                    <td colspan="7" class='text-center'>Chưa có sản phẩm</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --primary: #f59e0b;
    --primary-dark: #d97706;
    --secondary: #764ba2;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --dark: #1f2937;
    --light: #f8fafc;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --border-radius: 12px;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

body {
    font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--light);
    color: var(--gray-800);
    line-height: 1.6;
}

.main-content {
    min-height: 100vh;
    padding: 24px;
    max-width: 100%;
}

/* Header Styles */
.dashboard-header {
    background: white;
    border-radius: var(--border-radius);
    padding: 28px 32px;
    margin-bottom: 24px;
    box-shadow: var(--shadow);
    border: 1px solid var(--gray-200);
    position: relative;
    overflow: hidden;
}

.dashboard-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
}

.header-title {
    display: flex;
    align-items: center;
    gap: 16px;
}

.title-icon {
    font-size: 2.75rem;
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.header-title h1 {
    margin: 0;
    font-size: 1.875rem;
    font-weight: 700;
    color: var(--gray-800);
}

.header-title p {
    margin: 4px 0 0 0;
    color: var(--gray-500);
    font-size: 1rem;
}

.header-actions {
    display: flex;
    gap: 12px;
    align-items: center;
}

/* Button Styles */
.btn-primary {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    box-shadow: var(--shadow);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-secondary {
    background: white;
    color: var(--gray-700);
    border: 2px solid var(--gray-300);
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.3s ease;
}

.btn-secondary:hover {
    background: var(--gray-100);
    border-color: var(--gray-400);
}

.btn-action {
    background: transparent;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.9rem;
}

.btn-view {
    color: #3b82f6;
}

.btn-view:hover {
    background: #eff6ff;
}

.btn-edit {
    color: #10b981;
}

.btn-edit:hover {
    background: #d1fae5;
}

.btn-delete {
    color: #ef4444;
}

.btn-delete:hover {
    background: #fee2e2;
}

/* Stats Overview */
.stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
}

.stat-card {
    background: white;
    border-radius: var(--border-radius);
    padding: 24px;
    display: flex;
    align-items: center;
    gap: 20px;
    box-shadow: var(--shadow);
    border: 1px solid var(--gray-200);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(to bottom, #fbbf24, #f59e0b);
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

.stat-icon {
    width: 70px;
    height: 70px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
    box-shadow: var(--shadow);
}

.stat-icon.total {
    background: linear-gradient(135deg, #fed7aa, #fdba74);
    color: #ea580c;
}

.stat-icon.available {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    color: #d97706;
}

.stat-icon.busy {
    background: linear-gradient(135deg, #ddd6fe, #c4b5fd);
    color: #7c3aed;
}

.stat-icon.premium {
    background: linear-gradient(135deg, #a7f3d0, #6ee7b7);
    color: #059669;
}

.stat-info h3 {
    font-size: 1.875rem;
    font-weight: 700;
    color: var(--gray-800);
    margin: 0;
}

.stat-info p {
    color: var(--gray-500);
    margin: 4px 0 0 0;
}

/* Search and Filter */
.search-filter-bar {
    background: white;
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: var(--shadow);
    display: flex;
    gap: 16px;
    align-items: center;
    flex-wrap: wrap;
}

.search-box {
    flex: 1;
    min-width: 250px;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--gray-100);
    border-radius: 8px;
    transition: all 0.3s ease;
}

.search-box:focus-within {
    background: white;
    box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
}

.search-box i {
    color: var(--gray-400);
}

.search-box input {
    flex: 1;
    border: none;
    background: transparent;
    outline: none;
    font-size: 0.95rem;
    color: var(--gray-800);
}

.filter-controls {
    display: flex;
    gap: 12px;
}

.filter-select {
    padding: 10px 16px;
    border: 2px solid var(--gray-300);
    border-radius: 8px;
    background: white;
    color: var(--gray-700);
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.filter-select:focus {
    outline: none;
    border-color: var(--primary);
}

/* Table Styles */
.table-container {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    overflow: hidden;
}

.table-header {
    padding: 20px 24px;
    border-bottom: 2px solid var(--gray-200);
    background: linear-gradient(135deg, #fef3c7, #fde68a);
}

.table-header h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--gray-800);
    display: flex;
    align-items: center;
    gap: 10px;
}

.table-responsive {
    overflow-x: auto;
}

.simple-table {
    width: 100%;
    border-collapse: collapse;
}

.simple-table th {
    background: var(--gray-100);
    padding: 16px;
    text-align: left;
    font-weight: 600;
    color: var(--gray-700);
    font-size: 0.9rem;
    border-bottom: 2px solid var(--gray-200);
}

.simple-table td {
    padding: 16px;
    border-bottom: 1px solid var(--gray-200);
    color: var(--gray-700);
}

.simple-table tbody tr {
    transition: all 0.2s ease;
}

.simple-table tbody tr:hover {
    background: var(--gray-50);
}

.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 500;
}

.status-cho {
    background: #ddd6fe;
    color: #7c3aed;
}

.status-dang_dien_ra {
    background: #d1fae5;
    color: #059669;
}

.status-da_ket_thuc {
    background: #e5e7eb;
    color: #6b7280;
}

.status-huy {
    background: #fee2e2;
    color: #dc2626;
}

.text-danger {
    color: #ef4444;
}

.text-center {
    text-align: center;
}

/* Modal Styles */
.modal-content {
    border-radius: var(--border-radius);
    border: none;
    box-shadow: var(--shadow-lg);
}

.modal-header {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    border-bottom: 2px solid var(--gray-200);
    padding: 20px 24px;
}

.modal-title {
    font-weight: 600;
    color: var(--gray-800);
}

.modal-body {
    padding: 24px;
}

.modal-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--gray-200);
}

.form-group {
    margin-bottom: 16px;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--gray-700);
}

.form-control {
    width: 100%;
    padding: 10px 14px;
    border: 2px solid var(--gray-300);
    border-radius: 8px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
}

.form-control-sm {
    padding: 6px 10px;
    font-size: 0.875rem;
}

.section-box {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 8px;
    padding: 16px;
}

.section-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--gray-800);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--gray-200);
    display: flex;
    align-items: center;
    gap: 8px;
}

.add-product-form {
    border: 1px dashed var(--gray-300);
}

/* Responsive */
@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .stats-overview {
        grid-template-columns: 1fr;
    }
    
    .search-filter-bar {
        flex-direction: column;
    }
    
    .search-box {
        width: 100%;
    }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Global state
let flashSalesData = [];
let flashSaleItemsData = [];
let inventoryData = [];
let tempProductsList = []; // Danh sách sản phẩm tạm khi tạo flash sale

// Utils object
const Utils = {
    showLoading: function(message = 'Đang xử lý...') {
        Swal.fire({
            title: message,
            allowOutsideClick: false,
            showConfirmButton: false,
            willOpen: () => {
                Swal.showLoading();
            }
        });
    },
    
    showSuccess: function(message) {
        Swal.fire({
            icon: 'success',
            title: 'Thành công',
            text: message,
            timer: 2000,
            showConfirmButton: false
        });
    },
    
    showError: function(message) {
        Swal.fire({
            icon: 'error',
            title: 'Lỗi',
            text: message
        });
    },
    
    showConfirm: async function(message) {
        const result = await Swal.fire({
            title: 'Xác nhận',
            text: message,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Đồng ý',
            cancelButtonText: 'Hủy',
            confirmButtonColor: '#f59e0b'
        });
        return result.isConfirmed;
    },
    
    formatNumber: function(num) {
        return new Intl.NumberFormat('vi-VN').format(num || 0);
    },
    
    formatCurrency: function(num) {
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(num || 0);
    },
    
    formatDateTime: function(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleString('vi-VN');
    }
};

// API object
const API = {
    get: async function(url) {
        const response = await fetch(url);
        const data = await response.json();
        if (!response.ok) {
            console.error('API Error:', response.status, data);
            throw new Error(data.message || 'Network error');
        }
        return data;
    },
    
    post: async function(url, data) {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (!response.ok) {
            console.error('API POST Error:', response.status, result);
            throw new Error(result.message || 'Network error');
        }
        return result;
    },
    
    put: async function(url, data) {
        const response = await fetch(url, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (!response.ok) {
            console.error('API PUT Error:', response.status, result);
            throw new Error(result.message || 'Network error');
        }
        return result;
    },
    
    delete: async function(url) {
        const response = await fetch(url, {
            method: 'DELETE'
        });
        const result = await response.json();
        if (!response.ok) {
            console.error('API DELETE Error:', response.status, result);
            throw new Error(result.message || 'Network error');
        }
        return result;
    }
};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadData();
    setupEventListeners();
});

// Setup event listeners
function setupEventListeners() {
    document.getElementById('searchInput')?.addEventListener('input', applyFilters);
    document.getElementById('statusFilter')?.addEventListener('change', applyFilters);
    document.getElementById('productSelect')?.addEventListener('change', handleProductSelect);
    document.getElementById('flashSalePrice')?.addEventListener('input', updateDiscount);
    document.getElementById('modalProductSelect')?.addEventListener('change', handleModalProductSelect);
    document.getElementById('modalFlashSalePrice')?.addEventListener('input', updateModalDiscount);
}

// Load data
async function loadData() {
    try {
        Utils.showLoading('Đang tải dữ liệu...');
        
        // Load flash sales
        const fsRes = await API.get('/api/flashsales');
        if (Array.isArray(fsRes)) {
            flashSalesData = fsRes;
        } else if (fsRes && fsRes.data) {
            flashSalesData = Array.isArray(fsRes.data) ? fsRes.data : (fsRes.data.flashsales || []);
        } else {
            flashSalesData = [];
        }
        
        // Load inventory - đã bao gồm thông tin sản phẩm và số lượng tồn kho
        const invRes = await API.get('/api/inventory');
        if (Array.isArray(invRes)) {
            inventoryData = invRes;
        } else if (invRes && invRes.data) {
            inventoryData = Array.isArray(invRes.data) ? invRes.data : (invRes.data.inventory || []);
        } else {
            inventoryData = [];
        }
        
        updateStats();
        renderFlashSales();
        
        Swal.close();
    } catch (error) {
        console.error(error);
        Utils.showError('Không thể tải dữ liệu');
    }
}

// Update stats
function updateStats() {
    const total = flashSalesData.length;
    const active = flashSalesData.filter(fs => fs.trang_thai === 'dang_dien_ra').length;
    const waiting = flashSalesData.filter(fs => fs.trang_thai === 'cho').length;
    const ended = flashSalesData.filter(fs => fs.trang_thai === 'da_ket_thuc').length;
    
    document.getElementById('totalFlashSales').textContent = Utils.formatNumber(total);
    document.getElementById('activeFlashSales').textContent = Utils.formatNumber(active);
    document.getElementById('waitingFlashSales').textContent = Utils.formatNumber(waiting);
    document.getElementById('endedFlashSales').textContent = Utils.formatNumber(ended);
}

// Render flash sales table
function renderFlashSales(data = flashSalesData) {
    const tbody = document.getElementById('flashSalesTableBody');
    
    if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan='6' class='text-center'>Không có dữ liệu</td></tr>`;
        return;
    }
    
    tbody.innerHTML = data.map(fs => `
        <tr>
            <td>
                <strong>${fs.ten_flash_sale || 'N/A'}</strong>
                ${fs.mo_ta ? `<br><small style='color: var(--gray-500)'>${fs.mo_ta}</small>` : ''}
            </td>
            <td>
                <div>${Utils.formatDateTime(fs.ngay_bat_dau)}</div>
                <div>${Utils.formatDateTime(fs.ngay_ket_thuc)}</div>
            </td>
            <td class='text-center'>${Utils.formatNumber(fs.total_products || 0)}</td>
            <td class='text-center'>${Utils.formatNumber(fs.total_sold || 0)}</td>
            <td>
                <span class='status-badge status-${fs.trang_thai}'>${getStatusText(fs.trang_thai)}</span>
            </td>
            <td>
                <button class='btn-action btn-edit' onclick="openFlashSaleModal('${fs.id}')" title='Sửa'>
                    <i class='fas fa-edit'></i>
                </button>
                <button class='btn-action btn-view' onclick="manageProducts('${fs.id}', '${fs.ten_flash_sale}')" title='Quản lý sản phẩm'>
                    <i class='fas fa-box'></i>
                </button>
                <button class='btn-action btn-delete' onclick="deleteFlashSale('${fs.id}')" title='Xóa'>
                    <i class='fas fa-trash'></i>
                </button>
            </td>
        </tr>
    `).join('');
}

// Apply filters
function applyFilters() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const status = document.getElementById('statusFilter').value;
    
    let filtered = flashSalesData;
    
    if (search) {
        filtered = filtered.filter(fs => 
            (fs.ten_flash_sale || '').toLowerCase().includes(search) ||
            (fs.mo_ta || '').toLowerCase().includes(search)
        );
    }
    
    if (status) {
        filtered = filtered.filter(fs => fs.trang_thai === status);
    }
    
    renderFlashSales(filtered);
}

// Open flash sale modal
function openFlashSaleModal(id = null) {
    const modal = new bootstrap.Modal(document.getElementById('flashSaleModal'));
    const title = document.getElementById('flashSaleModalTitle');
    const form = document.getElementById('flashSaleForm');
    
    form.reset();
    document.getElementById('flashSaleId').value = '';
    tempProductsList = [];
    
    // Populate product dropdown
    populateModalProductDropdown();
    
    if (id) {
        title.textContent = 'Sửa Flash Sale';
        const fs = flashSalesData.find(f => f.id === id);
        if (fs) {
            document.getElementById('flashSaleId').value = fs.id;
            document.getElementById('flashSaleName').value = fs.ten_flash_sale || '';
            document.getElementById('flashSaleDesc').value = fs.mo_ta || '';
            document.getElementById('flashSaleStart').value = formatDateTimeLocal(fs.ngay_bat_dau);
            document.getElementById('flashSaleEnd').value = formatDateTimeLocal(fs.ngay_ket_thuc);
            document.getElementById('flashSaleStatus').value = fs.trang_thai || 'cho';
            
            // Load existing products
            loadExistingProducts(id);
        }
    } else {
        title.textContent = 'Thêm Flash Sale';
        renderTempProductsTable();
    }
    
    modal.show();
}

// Populate modal product dropdown
function populateModalProductDropdown() {
    const select = document.getElementById('modalProductSelect');
    if (!select) return;
    
    select.innerHTML = '<option value="">-- Chọn sản phẩm --</option>';
    
    if (!Array.isArray(inventoryData) || inventoryData.length === 0) {
        return;
    }
    
    // Gộp inventory theo sản phẩm và tính tổng tồn kho
    const productMap = new Map();
    
    inventoryData.forEach(inv => {
        if (!inv.san_pham_id || !inv.ten_san_pham) return;
        
        if (!productMap.has(inv.san_pham_id)) {
            productMap.set(inv.san_pham_id, {
                id: inv.san_pham_id,
                ten_san_pham: inv.ten_san_pham,
                gia_ban: inv.gia_ban || 0,
                totalStock: 0
            });
        }
        
        const product = productMap.get(inv.san_pham_id);
        product.totalStock += (inv.so_luong_kha_dung || 0);
    });
    
    // Chuyển Map thành array và sort theo tên
    const products = Array.from(productMap.values())
        .sort((a, b) => a.ten_san_pham.localeCompare(b.ten_san_pham));
    
    products.forEach(product => {
        const option = document.createElement('option');
        option.value = product.id;
        option.setAttribute('data-name', product.ten_san_pham);
        option.setAttribute('data-price', product.gia_ban);
        option.setAttribute('data-stock', product.totalStock);
        option.textContent = `${product.ten_san_pham} (Tồn: ${product.totalStock})`;
        select.appendChild(option);
    });
}

// Handle modal product select
function handleModalProductSelect(e) {
    const selectedOption = e.target.options[e.target.selectedIndex];
    const price = selectedOption.getAttribute('data-price');
    const stock = selectedOption.getAttribute('data-stock');
    
    if (price) {
        document.getElementById('modalOriginalPrice').value = price;
        document.getElementById('modalAvailableQty').value = stock;
        document.getElementById('modalFlashSalePrice').value = '';
        document.getElementById('modalSaleQty').value = '';
    }
}

// Update modal discount display
function updateModalDiscount() {
    const giaGoc = parseFloat(document.getElementById('modalOriginalPrice').value) || 0;
    const giaFlashSale = parseFloat(document.getElementById('modalFlashSalePrice').value) || 0;
    
    if (giaGoc > 0 && giaFlashSale > 0 && giaFlashSale < giaGoc) {
        const discount = Math.round((1 - giaFlashSale / giaGoc) * 100);
        console.log(`Giảm ${discount}%`);
    }
}

// Add product to temporary list
function addProductToTempList() {
    const selectElement = document.getElementById('modalProductSelect');
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const productId = selectElement.value;
    const productName = selectedOption.getAttribute('data-name');
    const giaGoc = parseFloat(selectedOption.getAttribute('data-price'));
    const availableStock = parseInt(selectedOption.getAttribute('data-stock'));
    const giaFlashSale = parseFloat(document.getElementById('modalFlashSalePrice').value);
    const soLuong = parseInt(document.getElementById('modalSaleQty').value);
    
    // Validate
    if (!productId) {
        Utils.showError('Vui lòng chọn sản phẩm');
        return;
    }
    if (!giaFlashSale || giaFlashSale <= 0) {
        Utils.showError('Vui lòng nhập giá flash sale');
        return;
    }
    if (!soLuong || soLuong <= 0) {
        Utils.showError('Vui lòng nhập số lượng');
        return;
    }
    if (giaFlashSale >= giaGoc) {
        Utils.showError('Giá flash sale phải nhỏ hơn giá gốc');
        return;
    }
    if (soLuong > availableStock) {
        Utils.showError(`Số lượng sale không được vượt quá tồn kho (${availableStock})`);
        return;
    }
    
    // Check duplicate
    if (tempProductsList.find(p => p.san_pham_id === productId)) {
        Utils.showError('Sản phẩm đã có trong danh sách');
        return;
    }
    
    // Add to temp list
    tempProductsList.push({
        san_pham_id: productId,
        ten_san_pham: productName,
        gia_goc: giaGoc,
        gia_flash_sale: giaFlashSale,
        so_luong_ton: soLuong,
        available_stock: availableStock
    });
    
    renderTempProductsTable();
    
    // Reset form
    document.getElementById('modalProductSelect').value = '';
    document.getElementById('modalOriginalPrice').value = '';
    document.getElementById('modalFlashSalePrice').value = '';
    document.getElementById('modalAvailableQty').value = '';
    document.getElementById('modalSaleQty').value = '';
}

// Render temporary products table
function renderTempProductsTable() {
    const tbody = document.getElementById('tempProductsTableBody');
    
    if (tempProductsList.length === 0) {
        tbody.innerHTML = `<tr><td colspan='7' class='text-center'>Chưa có sản phẩm</td></tr>`;
        return;
    }
    
    tbody.innerHTML = tempProductsList.map((product, index) => {
        const discount = product.gia_goc > 0 ? Math.round((1 - product.gia_flash_sale / product.gia_goc) * 100) : 0;
        return `
            <tr>
                <td class='text-center'>${index + 1}</td>
                <td>${product.ten_san_pham}</td>
                <td class='text-center'>${Utils.formatCurrency(product.gia_goc)}</td>
                <td class='text-center'>${Utils.formatCurrency(product.gia_flash_sale)}</td>
                <td class='text-center'><span class='status-badge status-dang_dien_ra'>-${discount}%</span></td>
                <td class='text-center'>${Utils.formatNumber(product.so_luong_ton)}</td>
                <td class='text-center'>
                    <button class='btn-action btn-delete' onclick="removeFromTempList(${index})" title='Xóa'>
                        <i class='fas fa-trash'></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Remove from temporary list
function removeFromTempList(index) {
    tempProductsList.splice(index, 1);
    renderTempProductsTable();
}

// Load existing products when editing
async function loadExistingProducts(flashSaleId) {
    try {
        const res = await API.get(`/api/flashsales/${flashSaleId}/items`);
        if (Array.isArray(res)) {
            tempProductsList = res.map(item => ({
                id: item.id,
                san_pham_id: item.san_pham_id,
                ten_san_pham: item.ten_san_pham,
                gia_goc: item.gia_goc,
                gia_flash_sale: item.gia_flash_sale,
                so_luong_ton: item.so_luong_ton || item.so_luong,
                available_stock: 0
            }));
        } else if (res && res.data) {
            const items = Array.isArray(res.data) ? res.data : (res.data.items || []);
            tempProductsList = items.map(item => ({
                id: item.id,
                san_pham_id: item.san_pham_id,
                ten_san_pham: item.ten_san_pham,
                gia_goc: item.gia_goc,
                gia_flash_sale: item.gia_flash_sale,
                so_luong_ton: item.so_luong_ton || item.so_luong,
                available_stock: 0
            }));
        }
        renderTempProductsTable();
    } catch (error) {
        console.error('Error loading existing products:', error);
    }
}

// Save flash sale
async function saveFlashSale() {
    const id = document.getElementById('flashSaleId').value;
    const startDate = document.getElementById('flashSaleStart').value;
    const endDate = document.getElementById('flashSaleEnd').value;
    
    // Validate
    if (!document.getElementById('flashSaleName').value || !startDate || !endDate) {
        Utils.showError('Vui lòng điền đầy đủ thông tin bắt buộc');
        return;
    }
    
    if (new Date(startDate) >= new Date(endDate)) {
        Utils.showError('Ngày kết thúc phải sau ngày bắt đầu');
        return;
    }
    
    const data = {
        ten_flash_sale: document.getElementById('flashSaleName').value,
        mo_ta: document.getElementById('flashSaleDesc').value,
        ngay_bat_dau: new Date(startDate).toISOString(),
        ngay_ket_thuc: new Date(endDate).toISOString(),
        trang_thai: document.getElementById('flashSaleStatus').value
    };
    
    console.log('Sending data:', data);
    
    try {
        Utils.showLoading('Đang lưu...');
        
        let result;
        if (id) {
            result = await API.put(`/api/flashsales/${id}`, data);
            
            // Nếu có sản phẩm mới, xóa hết cũ và thêm mới
            if (tempProductsList.length > 0) {
                // Delete old items (optional - có thể để API tự xử lý)
                // Sau đó thêm các sản phẩm mới
                await saveFlashSaleProducts(id);
            }
        } else {
            result = await API.post('/api/flashsales', data);
            
            // Sau khi tạo flash sale, thêm sản phẩm
            if (result.success && result.data && result.data.id && tempProductsList.length > 0) {
                await saveFlashSaleProducts(result.data.id);
            }
        }
        
        console.log('Server response:', result);
        
        Utils.showSuccess('Lưu thành công');
        bootstrap.Modal.getInstance(document.getElementById('flashSaleModal')).hide();
        tempProductsList = [];
        loadData();
    } catch (error) {
        console.error('Save error:', error);
        Utils.showError('Không thể lưu flash sale: ' + (error.message || 'Lỗi server'));
    }
}

// Save flash sale products
async function saveFlashSaleProducts(flashSaleId) {
    try {
        const savePromises = tempProductsList.map(product => {
            const itemData = {
                san_pham_id: product.san_pham_id,
                gia_goc: product.gia_goc,
                gia_flash_sale: product.gia_flash_sale,
                so_luong_ton: product.so_luong_ton
            };
            
            return API.post(`/api/flashsales/${flashSaleId}/items`, itemData);
        });
        
        await Promise.all(savePromises);
        console.log(`Đã thêm ${tempProductsList.length} sản phẩm vào flash sale`);
    } catch (error) {
        console.error('Error saving products:', error);
        throw error;
    }
}

// Delete flash sale
async function deleteFlashSale(id) {
    const confirmed = await Utils.showConfirm('Bạn có chắc muốn xóa flash sale này?');
    if (!confirmed) return;
    
    try {
        Utils.showLoading('Đang xóa...');
        await API.delete(`/api/flashsales/${id}`);
        Utils.showSuccess('Xóa thành công');
        loadData();
    } catch (error) {
        console.error(error);
        Utils.showError('Không thể xóa flash sale');
    }
}

// Manage products
async function manageProducts(flashSaleId, flashSaleName) {
    document.getElementById('currentFlashSaleId').value = flashSaleId;
    document.getElementById('productsModalTitle').textContent = `Quản lý sản phẩm - ${flashSaleName}`;
    
    // Populate product dropdown từ inventory
    const select = document.getElementById('productSelect');
    
    if (!Array.isArray(inventoryData) || inventoryData.length === 0) {
        select.innerHTML = '<option value="">-- Không có sản phẩm --</option>';
    } else {
        // Gộp inventory theo sản phẩm
        const productMap = new Map();
        
        inventoryData.forEach(inv => {
            if (!inv.san_pham_id || !inv.ten_san_pham) return;
            
            if (!productMap.has(inv.san_pham_id)) {
                productMap.set(inv.san_pham_id, {
                    id: inv.san_pham_id,
                    ten_san_pham: inv.ten_san_pham,
                    gia_ban: inv.gia_ban || 0,
                    totalStock: 0
                });
            }
            
            const product = productMap.get(inv.san_pham_id);
            product.totalStock += (inv.so_luong_kha_dung || 0);
        });
        
        const products = Array.from(productMap.values())
            .sort((a, b) => a.ten_san_pham.localeCompare(b.ten_san_pham));
        
        select.innerHTML = '<option value="">Chọn sản phẩm</option>' +
            products.map(p => `<option value="${p.id}" data-price="${p.gia_ban}">${p.ten_san_pham} (Tồn: ${p.totalStock})</option>`).join('');
    }
    
    // Load flash sale items
    await loadFlashSaleItems(flashSaleId);
    
    const modal = new bootstrap.Modal(document.getElementById('productsModal'));
    modal.show();
}

// Load flash sale items
async function loadFlashSaleItems(flashSaleId) {
    try {
        const res = await API.get(`/api/flashsales/${flashSaleId}/items`);
        if (Array.isArray(res)) {
            flashSaleItemsData = res;
        } else if (res && res.data) {
            flashSaleItemsData = Array.isArray(res.data) ? res.data : (res.data.items || []);
        } else {
            flashSaleItemsData = [];
        }
        
        renderFlashSaleItems();
    } catch (error) {
        console.error(error);
        flashSaleItemsData = [];
        renderFlashSaleItems();
    }
}

// Render flash sale items
function renderFlashSaleItems() {
    const tbody = document.getElementById('productsTableBody');
    
    if (!flashSaleItemsData || flashSaleItemsData.length === 0) {
        tbody.innerHTML = `<tr><td colspan='7' class='text-center'>Chưa có sản phẩm</td></tr>`;
        return;
    }
    
    tbody.innerHTML = flashSaleItemsData.map(item => {
        const discount = item.gia_goc > 0 ? Math.round((1 - item.gia_flash_sale / item.gia_goc) * 100) : 0;
        return `
            <tr>
                <td>${item.ten_san_pham || 'N/A'}</td>
                <td>${Utils.formatCurrency(item.gia_goc)}</td>
                <td>${Utils.formatCurrency(item.gia_flash_sale)}</td>
                <td><span class='status-badge status-dang_dien_ra'>-${discount}%</span></td>
                <td class='text-center'>${Utils.formatNumber(item.so_luong)}</td>
                <td class='text-center'>${Utils.formatNumber(item.da_ban || 0)}</td>
                <td>
                    <button class='btn-action btn-delete' onclick="deleteFlashSaleItem('${item.id}')" title='Xóa'>
                        <i class='fas fa-trash'></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Handle product select
function handleProductSelect(e) {
    const selectedOption = e.target.options[e.target.selectedIndex];
    const price = selectedOption.getAttribute('data-price');
    
    if (price) {
        document.getElementById('originalPrice').value = price;
    }
}

// Update discount display
function updateDiscount() {
    const original = parseFloat(document.getElementById('originalPrice').value) || 0;
    const flashSale = parseFloat(document.getElementById('flashSalePrice').value) || 0;
    
    if (original > 0 && flashSale > 0) {
        const discount = Math.round((1 - flashSale / original) * 100);
        console.log(`Giảm ${discount}%`);
    }
}

// Add product to flash sale
async function addProductToFlashSale() {
    const flashSaleId = document.getElementById('currentFlashSaleId').value;
    const productId = document.getElementById('productSelect').value;
    const giaGoc = parseFloat(document.getElementById('originalPrice').value) || 0;
    const giaFlashSale = parseFloat(document.getElementById('flashSalePrice').value) || 0;
    const soLuong = parseInt(document.getElementById('itemQuantity').value) || 0;
    
    if (!productId || !giaFlashSale || !soLuong) {
        Utils.showError('Vui lòng điền đầy đủ thông tin');
        return;
    }
    
    if (giaFlashSale >= giaGoc) {
        Utils.showError('Giá flash sale phải nhỏ hơn giá gốc');
        return;
    }
    
    // Kiểm tra số lượng tồn kho từ inventory
    const totalStock = inventoryData
        .filter(inv => inv.san_pham_id === productId)
        .reduce((sum, inv) => sum + (inv.so_luong_kha_dung || 0), 0);
    
    if (soLuong > totalStock) {
        Utils.showError(`Số lượng không được vượt quá tồn kho (${totalStock})`);
        return;
    }
    
    const data = {
        san_pham_id: productId,
        gia_goc: giaGoc,
        gia_flash_sale: giaFlashSale,
        so_luong_ton: soLuong
    };
    
    try {
        Utils.showLoading('Đang thêm sản phẩm...');
        await API.post(`/api/flashsales/${flashSaleId}/items`, data);
        Utils.showSuccess('Thêm sản phẩm thành công');
        
        // Reset form
        document.getElementById('productSelect').value = '';
        document.getElementById('originalPrice').value = '';
        document.getElementById('flashSalePrice').value = '';
        document.getElementById('itemQuantity').value = '';
        
        // Reload items
        loadFlashSaleItems(flashSaleId);
    } catch (error) {
        console.error(error);
        Utils.showError('Không thể thêm sản phẩm');
    }
}

// Delete flash sale item
async function deleteFlashSaleItem(itemId) {
    const confirmed = await Utils.showConfirm('Bạn có chắc muốn xóa sản phẩm này?');
    if (!confirmed) return;
    
    try {
        Utils.showLoading('Đang xóa...');
        await API.delete(`/api/flashsales/items/${itemId}`);
        Utils.showSuccess('Xóa thành công');
        
        const flashSaleId = document.getElementById('currentFlashSaleId').value;
        loadFlashSaleItems(flashSaleId);
    } catch (error) {
        console.error(error);
        Utils.showError('Không thể xóa sản phẩm');
    }
}

// Helper functions
function getStatusText(status) {
    const map = {
        'cho': 'Chờ diễn ra',
        'dang_dien_ra': 'Đang diễn ra',
        'da_ket_thuc': 'Đã kết thúc',
        'huy': 'Đã hủy'
    };
    return map[status] || status;
}

function formatDateTimeLocal(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day}T${hours}:${minutes}`;
}
</script>
